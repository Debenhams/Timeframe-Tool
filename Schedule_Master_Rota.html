<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Professional Team Rota System ‚Äî Master (Calabrio style)</title>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>

<style>
  :root{
    /* Brand */
    --brand:#0d47a1; --ink:#0f172a; --muted:#64748b; --accent:#00c853;
    --bg:#f5f7fb; --card:#ffffff; --line:#e6ebf3;

    /* Timeline */
    --start:6;   /* 06:00 */
    --end:20;   /* 20:00 */
    --row-height:34px;
    --bar-height:14px;

    /* Codes */
    --email:#2ecc71; --mirakl:#b1b51e; --social:#5e35b1; --meeting:#ffd700;
    --overtime:#e53935; --break:#cfd8dc; --lunch:#b0bec5; --absence:#b0c4de; --shrink:#ffd166;
  }

  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:13px/1.35 Inter,Segoe UI,Roboto,system-ui,Arial,sans-serif}

  /* Top bar */
  .topbar{background:var(--brand);color:#fff;display:flex;align-items:center;gap:12px;padding:12px 16px;box-shadow:0 4px 12px rgba(13,71,161,.20)}
  .topbar h1{margin:0;font-size:16px;font-weight:800}
  .topbar .filters{display:flex;gap:8px;flex-wrap:wrap;margin-left:12px}
  .chip{background:#eaf1ff;color:#113a8f;border-radius:999px;padding:5px 8px;font-weight:700}

  /* Inputs / buttons */
  .in{border:1px solid var(--line);border-radius:8px;padding:7px 9px;background:#fff}
  .btn{border:1px solid var(--line);background:#fff;border-radius:8px;padding:7px 10px;cursor:pointer}
  .btn.primary{background:var(--accent);color:#fff;border:0}
  .btn.ghost{background:#fff}
  .btn.icon{padding:6px 8px}
  .btn[disabled]{opacity:.6;cursor:not-allowed}

  /* Layout */
  .wrap{max-width:1500px;margin:16px auto;padding:0 14px;display:grid;grid-template-columns:1fr 320px;gap:14px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:0 8px 22px rgba(20,30,70,.06)}
  .card .hd{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--line)}
  .card .bd{padding:10px 12px}
  .muted{color:var(--muted)}
  .spacer{flex:1}

  /* Schedules (right) */
  .tree-search{display:flex;gap:8px;margin-bottom:8px}
  .tree{border:1px solid var(--line);border-radius:10px;max-height:68vh;overflow:auto;background:#fff}
  .tree details{padding:4px}
  .tree summary{list-style:none;cursor:pointer;display:flex;align-items:center;gap:6px;font-weight:700}
  .tree summary::-webkit-details-marker{display:none}
  .twisty{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border:1px solid var(--line);border-radius:4px;background:#f0f5ff}
  .node{display:flex;align-items:center;gap:6px;padding:3px 2px}
  .node-actions button{border:1px solid var(--line);background:#fff;border-radius:6px;padding:2px 6px;cursor:pointer;font-size:11px}
  .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px}
  .chip.small{padding:3px 6px;font-size:12px}

  /* Assignment table (horizontal team grid header) */
  .table-wrap{border:1px solid var(--line);border-radius:12px;overflow:auto}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid var(--line);padding:6px;text-align:center}
  thead th{background:#f0f5ff;color:#0d47a1;font-weight:800}
  td.name{position:sticky;left:0;background:#f7fbff;font-weight:800;text-align:left;min-width:150px}
  td.name .sub{display:block;font-size:11px;color:var(--muted);font-weight:600}
  .selector{width:100%;height:28px;border:1px solid var(--line);border-radius:6px;background:#fff;padding:2px 6px}

  /* Compact horizontal timeline (Calabrio style) */
  .timeline{--cols: 15; /* 06:00..20:00 -> 14 columns of hours + first column for 06:00 label */ }
  .timeline .grid{display:grid;grid-template-columns:150px repeat(calc(var(--cols)),1fr)}
  .hr-head{height:32px;background:#fbfdff;border-bottom:1px solid var(--line);display:grid;grid-template-columns:150px repeat(calc(var(--cols)),1fr)}
  .hr-head .label{display:flex;align-items:center;justify-content:center;font-weight:800;color:#51607a}
  .row{display:contents}
  .cell{height:var(--row-height);position:relative;background:
    repeating-linear-gradient(90deg,#0000 0 1px,#0000 1px, #0000 calc(100%/1 - 1px)),
    linear-gradient(#fff,#fff)}
  .cell.hour{border-left:1px solid var(--line)}
  .row:nth-child(even) .cell{background:
    repeating-linear-gradient(90deg,#0000 0 1px,#0000 1px, #0000 calc(100%/1 - 1px)),
    linear-gradient(#fbfcff,#fbfcff)}

  .bar{position:absolute;top:calc((var(--row-height) - var(--bar-height))/2);height:var(--bar-height);left:0;right:0;border-radius:6px;color:#fff;font-weight:800;display:flex;align-items:center;justify-content:space-between;padding:0 6px;font-size:11px;box-shadow:0 1px 2px rgba(0,0,0,.12)}
  .bar .t{opacity:.9}
  .b-email{background:var(--email)} .b-mirakl{background:var(--mirakl)}
  .b-social{background:var(--social)} .b-meeting{background:var(--meeting);color:#333}
  .b-overtime{background:var(--overtime)} .b-break{background:var(--break);color:#123}
  .b-lunch{background:var(--lunch);color:#123} .b-absence{background:var(--absence)}
  .b-shrink{background:var(--shrink);color:#123}

  .legend{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid var(--line);border-radius:999px;background:#fff}
  .dot{width:10px;height:10px;border-radius:50%}

  /* Small utilities */
  .row-empty{color:var(--muted);font-style:italic}
  .note{background:#fff8d7;border:1px solid #ffe48f;color:#8a6d3b;padding:8px;border-radius:10px}
  .danger{background:#ffe7e7;border:1px solid #ffb0b0;color:#902d2d}
  .ok{background:#e7f6ec;border:1px solid #b4e2c5;color:#155c2d}
</style>
</head>
<body>
  <div class="topbar">
    <h1>Professional Team Rota System</h1>
    <div class="filters">
      <select id="siteFilter" class="in"></select>
      <select id="leaderFilter" class="in"></select>
      <select id="viewFilter" class="in"></select>
      <input type="date" id="weekStart" class="in" />
      <button class="btn icon" id="prevWeek">‚óÄ</button>
      <button class="btn icon" id="nextWeek">‚ñ∂</button>
      <button class="btn" id="btnGenerate">Generate</button>
      <button class="btn primary" id="btnPublish">Publish</button>
    </div>
    <span class="spacer"></span>
    <span class="chip" id="rangeLabel"></span>
  </div>

  <div class="wrap">
    <!-- LEFT: Team grid + legend -->
    <div class="card" id="teamCard">
      <div class="hd">
        <strong id="teamTitle">Team Week</strong>
        <div style="display:flex;align-items:center;gap:8px">
          <button class="btn" id="btnSaveJSON">üíæ Save JSON</button>
          <input type="file" id="file" accept=".json" style="display:none" />
          <button class="btn" id="btnLoadJSON">üìÇ Load JSON</button>
          <button class="btn ghost" id="btnPrint">üñ®Ô∏è Print</button>
        </div>
      </div>
      <div class="bd">
        <!-- Compact horizontal grid -->
        <div id="hGrid"></div>

        <div class="legend">
          <span class="pill"><span class="dot" style="background:var(--email)"></span> Email</span>
          <span class="pill"><span class="dot" style="background:var(--mirakl)"></span> Mirakl</span>
          <span class="pill"><span class="dot" style="background:var(--social)"></span> Social</span>
          <span class="pill"><span class="dot" style="background:var(--meeting)"></span> Meeting</span>
          <span class="pill"><span class="dot" style="background:var(--overtime)"></span> Overtime</span>
          <span class="pill"><span class="dot" style="background:var(--break)"></span> Break</span>
          <span class="pill"><span class="dot" style="background:var(--lunch)"></span> Lunch</span>
        </div>
      </div>
    </div>

    <!-- RIGHT: Schedules tree -->
    <div class="card">
      <div class="hd"><strong>Schedules</strong></div>
      <div class="bd">
        <div class="tree-search">
          <input id="treeSearch" class="in" placeholder="Search leaders/advisors‚Ä¶" style="flex:1" />
          <button id="btnClearSel" class="btn">Clear</button>
        </div>
        <div class="tree" id="tree"></div>
        <div class="chips" id="activeChips"></div>
        <div id="panelNote" class="note" style="margin-top:10px">Tip: select a Leader to include their whole team, or tick names individually. ‚ÄúView ‚ñ∏ Team (Selected)‚Äù shows only those rows.</div>
      </div>
    </div>
  </div>
<script>
/* =============================
   SUPABASE CONFIG
============================= */
const SUPABASE_URL = "https://oypdnjxhjpgpwmkltzmk.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95cGRuanhoanBncHdta2x0em1rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4Nzk0MTEsImV4cCI6MjA3NTQ1NTQxMX0.Hqf1L4RHpIPUD4ut2uVsiGDsqKXvAjdwKuotmme4_Is";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* =============================
   STATE
============================= */
const DAYS = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
let ORG = { sites:{} };                 // sites -> leaders -> advisors
let ADVISORS = [];                      // flat list
let ADVISOR_BY_ID = new Map();
let TEMPLATES = {};                     // { name: {start_time, finish_time, ...} }
let ROTAS = new Map();                  // key: `${advisorId}|${weekISO}` -> { Monday:{segments:[]}, ... }
let SELECTED = new Set();               // set of advisor names (for "Team (Selected)")
let monday = toMonday(new Date());

/* =============================
   UTILS
============================= */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const pad = n => String(n).padStart(2,'0');
const toISO = d => d.toISOString().slice(0,10);
function toMonday(d){
  const x=new Date(d); const w=x.getDay(); const delta=(w===0?-6:1)-w; x.setDate(x.getDate()+delta); x.setHours(0,0,0,0); return x;
}
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function hhmm2min(t){ if(!t) return null; const [h,m] = t.split(':').map(Number); return h*60+m; }
function min2hhmm(m){ return `${pad(Math.floor(m/60))}:${pad(m%60)}`; }
function between(n,a,b){ return Math.max(a, Math.min(b, n)); }
function dayKey(d){ return DAYS[d]; }

/* =============================
   LOAD ORG + TEMPLATES
============================= */
async function loadOrg(){
  const [sitesRes, leadersRes, advisorsRes] = await Promise.all([
    sb.from('sites').select('*').order('name'),
    sb.from('leaders').select('*'),
    sb.from('advisors').select('*')
  ]);

  ORG = { sites:{} };
  (sitesRes.data||[]).forEach(s=> ORG.sites[s.name] = { id:s.id, leaders:{} });
  (leadersRes.data||[]).forEach(l=>{
    for(const site of Object.values(ORG.sites)){
      if(site.id===l.site_id){ site.leaders[l.name] = { id:l.id, advisors:[] }; break; }
    }
  });
  ADVISORS = (advisorsRes.data||[]).map(a=>({id:a.id,name:a.name,leader_id:a.leader_id,email:a.email||''}));
  ADVISOR_BY_ID = new Map(ADVISORS.map(a=>[a.id,a.name]));
  for(const a of ADVISORS){
    const leaderNode = Object.values(ORG.sites).flatMap(s=>Object.values(s.leaders)).find(l=>l.id===a.leader_id);
    if(leaderNode) leaderNode.advisors.push({id:a.id,name:a.name});
  }

  // Templates
  const tRes = await sb.from('templates').select('*');
  TEMPLATES = {};
  (tRes.data||[]).forEach(t=>{
    TEMPLATES[t.name] = {
      name:t.name,
      work_code:t.work_code || 'Admin',
      start_time:(t.start_time||'').slice(0,5) || '',
      finish_time:(t.finish_time||'').slice(0,5) || '',
      break1:(t.break1||'')?.slice(0,5)||'',
      lunch:(t.lunch||'')?.slice(0,5)||'',
      break2:(t.break2||'')?.slice(0,5)||'',
    };
  });
}

/* =============================
   FILTERS (top bar)
============================= */
function rebuildFilters(){
  const siteSel = $('#siteFilter');
  const leaderSel = $('#leaderFilter');
  const viewSel = $('#viewFilter');

  // Sites
  const sites = Object.keys(ORG.sites).sort();
  siteSel.innerHTML = `<option value="all">All sites</option>` + sites.map(n=>`<option value="${n}">${n}</option>`).join('');

  // Leaders (all across sites)
  const leaders = Object.entries(ORG.sites)
    .flatMap(([sn,so])=>Object.entries(so.leaders).map(([ln,lo])=>({name:ln,id:lo.id,site:sn})))
    .sort((a,b)=>a.name.localeCompare(b.name));

  leaderSel.innerHTML = `<option value="all">All leaders</option>` +
    leaders.map(l=>`<option value="${l.id}">${l.name} ‚Äî ${l.site}</option>`).join('');

  // View
  viewSel.innerHTML = `
    <option value="TEAM_ALL">Team (All)</option>
    <option value="TEAM_SELECTED">Team (Selected)</option>
  `;

  // default labels / values
  $('#weekStart').value = toISO(monday);
  $('#rangeLabel').textContent = labelForWeek(monday);
}
function labelForWeek(m){
  const end = addDays(m,6);
  const fmt = d => d.toLocaleDateString('en-GB',{day:'2-digit',month:'short'});
  return `${fmt(m)} ‚Äì ${fmt(end)} (${toISO(m)})`;
}

/* =============================
   SCHEDULES TREE (right)
============================= */
function rebuildTree(){
  const t = $('#tree');
  const q = ($('#treeSearch').value||'').trim().toLowerCase();

  function advRow(a){
    const checked = SELECTED.has(a.name) ? 'checked' : '';
    return `<div class="node">
      <input type="checkbox" data-adv="${a.id}" data-name="${a.name}" ${checked}/>
      <span>${a.name}</span>
      <span class="muted" style="margin-left:auto;font-size:11px">${a.id.slice(0,8)}</span>
    </div>`;
  }

  function leaderBlock(ln, lo){
    const team = (lo.advisors||[]).sort((a,b)=>a.name.localeCompare(b.name));
    const showLeader = !q || ln.toLowerCase().includes(q) || team.some(a=>a.name.toLowerCase().includes(q));
    if(!showLeader) return '';
    const allSelected = team.length && team.every(a=>SELECTED.has(a.name));
    return `<details open>
      <summary><span class="twisty">‚àí</span>
        <label style="display:flex;gap:6px;align-items:center;margin-left:4px">
          <input type="checkbox" data-leader="${lo.id}" ${allSelected?'checked':''}/>
          <strong>${ln}</strong> <span class="muted">(${team.length})</span>
        </label>
      </summary>
      ${team.map(advRow).join('')}
    </details>`;
  }

  function siteBlock(sn, so){
    const leaf = Object.entries(so.leaders).map(([ln,lo])=>leaderBlock(ln,lo)).filter(Boolean).join('');
    if(!leaf) return '';
    return `<details open>
      <summary><span class="twisty">‚àí</span><strong>üìÅ ${sn}</strong></summary>
      ${leaf}
    </details>`;
  }

  t.innerHTML = Object.entries(ORG.sites).sort((a,b)=>a[0].localeCompare(b[0])).map(([sn,so])=>siteBlock(sn,so)).join('') || `<div class="muted">No data.</div>`;

  // Toggle icons
  $$('#tree details').forEach(d=>{
    const icon = d.querySelector('.twisty');
    const upd = ()=> icon.textContent = d.open ? '‚àí' : '+';
    d.addEventListener('toggle',upd); upd();
  });

  // Leader select-all
  $$('#tree [data-leader]').forEach(cb=>{
    cb.onchange = ()=>{
      const id = cb.dataset.leader;
      const leader = Object.values(ORG.sites).flatMap(s=>Object.values(s.leaders)).find(l=>l.id===id);
      (leader?.advisors||[]).forEach(a=> cb.checked ? SELECTED.add(a.name) : SELECTED.delete(a.name));
      refreshChips();
      renderGrid();
      rebuildTree(); // refresh check states
    };
  });

  // Advisor ticks
  $$('#tree [data-adv]').forEach(cb=>{
    cb.onchange = ()=>{ const n=cb.dataset.name; cb.checked?SELECTED.add(n):SELECTED.delete(n); refreshChips(); renderGrid(); };
  });
}

function refreshChips(){
  const box = $('#activeChips');
  const items = [...SELECTED].sort();
  box.innerHTML = items.map(n=>`<span class="chip small">${n} <button data-x="${n}" class="btn icon" title="remove">‚úï</button></span>`).join('');
  $$('#activeChips [data-x]').forEach(b=> b.onclick = ()=>{ SELECTED.delete(b.dataset.x); refreshChips(); renderGrid(); rebuildTree(); });
}

/* =============================
   DATA ‚Äî GET ROTAS (DRAFT) + PUBLISHED SNAPSHOT
============================= */
async function loadRotasFor(advisorIds, weekISO){
  if(!advisorIds.length) return;
  const { data, error } = await sb
    .from('rotas')
    .select('advisor_id, week_start, data')
    .in('advisor_id', advisorIds)
    .eq('week_start', weekISO);
  if(error){ console.warn(error); return; }
  for(const r of data||[]){
    ROTAS.set(`${r.advisor_id}|${weekISO}`, r.data || {});
  }
}
/* =============================
   RENDER ‚Äî CALABRIO STYLE GRID
============================= */
function codeToClass(code){
  const k=(code||'').toLowerCase();
  if(k.includes('email')) return 'b-email';
  if(k.includes('mirakl')) return 'b-mirakl';
  if(k.includes('social')) return 'b-social';
  if(k.includes('meeting')||k.includes('coach')) return 'b-meeting';
  if(k.includes('overtime')) return 'b-overtime';
  if(k.includes('break')) return 'b-break';
  if(k.includes('lunch')) return 'b-lunch';
  if(['al','sick','rdo','maternity','lts'].some(w=>k.includes(w))) return 'b-absence';
  if(['121','atl','huddle','iti','projects','team meeting','training'].some(w=>k.includes(w))) return 'b-shrink';
  return 'b-email';
}

function renderGrid(){
  const weekISO = toISO(monday);
  const siteVal = $('#siteFilter').value;
  const leaderVal = $('#leaderFilter').value;
  const viewVal = $('#viewFilter').value;

  // Who to show?
  let advisors = ADVISORS;
  if(siteVal!=='all'){
    const site = ORG.sites[siteVal];
    const leaderIds = Object.values(site?.leaders||{}).map(l=>l.id);
    advisors = advisors.filter(a=> leaderIds.includes(a.leader_id));
  }
  if(leaderVal!=='all'){
    advisors = advisors.filter(a=> a.leader_id===leaderVal);
  }
  advisors = advisors.sort((a,b)=>a.name.localeCompare(b.name));

  if(viewVal==='TEAM_SELECTED'){
    const wanted = new Set(SELECTED);
    advisors = advisors.filter(a=> wanted.has(a.name));
  }

  // Build hourly head 06..20 (labels at each full hour)
  const start = +getComputedStyle(document.documentElement).getPropertyValue('--start') || 6;
  const end   = +getComputedStyle(document.documentElement).getPropertyValue('--end') || 20;
  const cols = end-start;
  const h = $('#hGrid');
  h.innerHTML = `
    <div class="hr-head" style="--cols:${cols}">
      <div class="label" style="justify-content:flex-start;padding-left:10px">Name</div>
      ${Array.from({length:cols+1}, (_,i)=> `<div class="label">${pad(start+i)}:00</div>`).join('')}
    </div>
    <div class="timeline">
      <div class="grid" style="--cols:${cols}">
        ${advisors.map(a=> renderRow(a, weekISO, start, end)).join('')}
      </div>
    </div>
  `;
}

function renderRow(a, weekISO, startHour, endHour){
  const key = `${a.id}|${weekISO}`;
  const json = ROTAS.get(key) || {};
  const minutesPerHour = 60;
  const totalMinutes = (endHour-startHour)*minutesPerHour;

  // Build 1 name cell + N hour cells as grid
  const nameHTML = `<div class="cell name" style="grid-column:1/2"><strong>${a.name}</strong><span class="sub">${a.id.slice(0,8)}</span></div>`;
  const hoursHTML = Array.from({length:(endHour-startHour)+1}, ()=> `<div class="cell hour"></div>`).join('');

  // Bars (segments) ‚Äì we place them within a single overlay cell spanning the hour range
  const overlay = `<div class="cell" style="grid-column:2 / ${2+(endHour-startHour)+1}">
    ${DAYS.map((day,idx)=> {
      const d = json[day]?.segments || [];
      if(!d.length) return '';
      return d.map(seg=>{
        const s = between(hhmm2min(seg.start||'07:00') - startHour*60, 0, totalMinutes);
        const e = between(hhmm2min(seg.end||'07:10')   - startHour*60, 0, totalMinutes);
        const left = (s/totalMinutes)*100;
        const width = Math.max(1, (e-s)/totalMinutes*100);
        return `<div class="bar ${codeToClass(seg.code)}" style="top:calc(${idx}*var(--row-height) + (var(--row-height) - var(--bar-height))/2); left:${left}%; width:${width}%">
          <span>${(seg.code||'').toUpperCase()}</span><span class="t">${(seg.start||'')} ‚Äì ${(seg.end||'')}</span>
        </div>`;
      }).join('');
    }).join('')}
  </div>`;

  // One "row" is 1 name cell + all hourly cells + overlay bars
  const hourlyCells = Array.from({length:(endHour-startHour)+1}, ()=> `<div class="cell hour"></div>`).join('');
  return `
    <div class="row" style="grid-template-columns:150px repeat(${(endHour-startHour)+1},1fr)">
      ${nameHTML}
      ${hourlyCells}
      ${overlay}
    </div>
  `;
}

/* =============================
   PUBLISH ‚Äî from rotas ‚Üí rotas_published
   (keeps just the selected / filtered advisors for this week)
============================= */
async function publishCurrent(){
  const weekISO = toISO(monday);
  const siteVal = $('#siteFilter').value;
  const leaderVal = $('#leaderFilter').value;
  const viewVal = $('#viewFilter').value;

  let advisors = ADVISORS;
  if(siteVal!=='all'){
    const site = ORG.sites[siteVal];
    const leaderIds = Object.values(site?.leaders||{}).map(l=>l.id);
    advisors = advisors.filter(a=> leaderIds.includes(a.leader_id));
  }
  if(leaderVal!=='all'){
    advisors = advisors.filter(a=> a.leader_id===leaderVal);
  }
  if(viewVal==='TEAM_SELECTED'){
    const wanted = new Set(SELECTED);
    advisors = advisors.filter(a=> wanted.has(a.name));
  }

  if(!advisors.length){ alert('Nothing to publish (no advisors in view).'); return; }

  const rows = advisors.map(a=>{
    const data = ROTAS.get(`${a.id}|${weekISO}`) || {};
    return { advisor_id:a.id, week_start:weekISO, data, published_at: new Date().toISOString() };
  });

  // Upsert by (advisor_id, week_start)
  const { error } = await sb.from('rotas_published').upsert(rows, { onConflict:'advisor_id,week_start' });
  if(error){ alert('Publish failed: '+error.message); return; }
  alert('Published to Advisor Portal (rotas_published).');
}

/* =============================
   EVENTS
============================= */
$('#prevWeek').onclick = ()=>{ monday = addDays(monday,-7); $('#weekStart').value = toISO(monday); $('#rangeLabel').textContent = labelForWeek(monday); bootstrapRender(); };
$('#nextWeek').onclick = ()=>{ monday = addDays(monday, 7); $('#weekStart').value = toISO(monday); $('#rangeLabel').textContent = labelForWeek(monday); bootstrapRender(); };
$('#weekStart').onchange = ()=>{ monday = toMonday(new Date($('#weekStart').value)); $('#rangeLabel').textContent = labelForWeek(monday); bootstrapRender(); };
$('#siteFilter').onchange = ()=>{ renderGrid(); };
$('#leaderFilter').onchange = ()=>{ renderGrid(); };
$('#viewFilter').onchange = ()=>{ renderGrid(); };
$('#treeSearch').oninput = ()=> rebuildTree();
$('#btnClearSel').onclick = ()=>{ SELECTED.clear(); refreshChips(); rebuildTree(); renderGrid(); };
$('#btnGenerate').onclick = ()=> alert('Generate: (hook up your generator here ‚Äî this UI keeps the grid compact)');
$('#btnPublish').onclick = publishCurrent;
$('#btnPrint').onclick = ()=> window.print();
$('#btnLoadJSON').onclick = ()=> $('#file').click();
$('#file').addEventListener('change', async ev=>{
  const f = ev.target.files[0]; if(!f) return;
  const text = await f.text();
  const data = JSON.parse(text);
  // expecting shape: { rotas: [ {advisor_id, week_start, data}, ... ] }
  (data.rotas||[]).forEach(r => ROTAS.set(`${r.advisor_id}|${r.week_start}`, r.data||{}));
  renderGrid();
});
$('#btnSaveJSON').onclick = ()=>{
  const weekISO = toISO(monday);
  const rotas = [...ROTAS.entries()].filter(([k])=>k.endsWith('|'+weekISO)).map(([k,v])=>{
    const advisor_id = k.split('|')[0];
    return { advisor_id, week_start:weekISO, data:v };
  });
  const blob = new Blob([JSON.stringify({rotas},null,2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `rotas_${weekISO}.json`; a.click();
  URL.revokeObjectURL(a.href);
};

/* =============================
   BOOT
============================= */
async function bootstrapRender(){
  const weekISO = toISO(monday);

  // Which advisors to load rotas for? (match the current filter to avoid extra traffic)
  let advisors = ADVISORS;
  const siteVal = $('#siteFilter').value;
  const leaderVal = $('#leaderFilter').value;
  const viewVal = $('#viewFilter').value;

  if(siteVal!=='all'){
    const site = ORG.sites[siteVal];
    const leaderIds = Object.values(site?.leaders||{}).map(l=>l.id);
    advisors = advisors.filter(a=> leaderIds.includes(a.leader_id));
  }
  if(leaderVal!=='all') advisors = advisors.filter(a=> a.leader_id===leaderVal);
  if(viewVal==='TEAM_SELECTED') advisors = advisors.filter(a=> SELECTED.has(a.name));

  const ids = advisors.map(a=>a.id);
  await loadRotasFor(ids, weekISO);
  renderGrid();
}

async function init(){
  await loadOrg();
  rebuildFilters();
  rebuildTree();
  refreshChips();
  await bootstrapRender();
}
init();
</script>
</body>
</html>

