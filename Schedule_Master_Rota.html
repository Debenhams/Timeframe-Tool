<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Professional Team Rota System</title>
<style>
  /* --- PROFESSIONAL THEME & VARIABLES --- */
  :root {
    /* Aesthetic Theme: Navy, Charcoal, and Accent Green */
    --primary-color: #0d47a1; /* Navy Blue (Professional) */
    --secondary-color: #fafafa; /* Clean White/Off-White */
    --background-dark: #263238; /* Charcoal Grey */
    --accent-color: #00c853; /* Success Green */
    --text-dark: #212121;
    --text-light: #ffffff;
    --border-color: #e0e0e0;

    /* Timeline config */
    --timeline-start: 7;  /* Hour (7 AM) */
    --timeline-end: 20;   /* Hour (8 PM) */
    --timeline-height: 1000px;

    /* Activity Colors (Editable via Settings) */
    --color-emails: #2ecc71;
    --color-mirakl: #ffb300; /* Darker Amber */
    --color-social: #5e35b1; /* Deep Purple */
    --color-overtime: #e53935; /* Deep Red */
    --color-meeting: #ffd700; /* Gold Yellow */
    --color-break: #90a4ae; /* Light Blue-Grey */
    --color-lunch: #ff8f00; /* Dark Orange */
    --color-dayoff: #f4f4f4;
  }

  /* --- BASE & LAYOUT --- */
  html, body { height: 100%; }
  body {
    font-family: "Roboto", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 0;
    background-color: var(--secondary-color);
    color: var(--text-dark);
  }
  .header {
    background-color: var(--primary-color);
    color: var(--text-light);
    padding: 30px 40px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
  }
  .header h1 {
    margin: 0;
    font-size: 2.4em;
    font-weight: 700;
  }
  .container {
    padding: 24px 40px 40px;
    max-width: 1400px;
    margin: auto;
  }
  h2 {
    border-bottom: 2px solid var(--border-color);
    padding-bottom: 10px;
    margin-top: 30px;
    color: var(--primary-color);
  }

  /* --- CONTROLS & DATA --- */
  .controls-panel {
    background-color: var(--text-light);
    padding: 16px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    margin-bottom: 20px;
    display: flex;
    flex-wrap: wrap;
    gap: 12px 16px;
    align-items: center;
    justify-content: space-between;
  }
  .controls-panel .row {
    display: flex; gap: 12px; align-items: center; flex-wrap: wrap;
  }
  label { font-weight: 700; }
  input[type="date"], input[type="text"], input[type="time"], select {
    padding: 8px 10px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    box-sizing: border-box;
    transition: border-color 0.2s, box-shadow 0.2s;
    background: #fff;
  }
  input:focus, select:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 2px rgba(13,71,161,0.15); }
  button {
    background-color: var(--accent-color);
    color: var(--text-light);
    border: none;
    padding: 10px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 700;
    transition: transform 0.04s ease, background-color 0.15s ease;
  }
  button:hover { background-color: #00a040; }
  button:active { transform: translateY(1px); }
  .button-group { display: flex; gap: 10px; flex-wrap: wrap; }
  .subtle { background: #eceff1; color: #263238; }
  .hidden { display: none !important; }

  /* --- TEMPLATE EDITOR --- */
  .template-row {
    display: grid;
    grid-template-columns: auto 120px auto 1fr auto;
    gap: 10px 14px;
    align-items: center;
    padding: 10px;
    border: 1px solid #cfd8dc;
    background-color: var(--secondary-color);
    border-radius: 8px;
    margin-bottom: 10px;
  }
  .template-row .time-block { display: flex; gap: 6px; flex-wrap: wrap; }
  .template-row .danger { background: #dc3545; }
  .template-row select { padding: 6px; }
  .key-row { display: grid; grid-template-columns: 18px 90px 1fr; gap: 8px; align-items: center; margin-bottom: 8px; }
  .swatch { width: 18px; height: 18px; border-radius: 3px; border: 1px solid #cfd8dc; }

  /* --- MASTER ROTA GRID --- */
  .master-table-container { overflow-x: auto; background-color: var(--text-light); border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); margin-bottom: 30px; }
  .master-table { width: 100%; border-collapse: collapse; min-width: 860px; }
  .master-table th, .master-table td { border: 1px solid var(--border-color); padding: 8px; text-align: center; }
  .master-table th { background-color: var(--primary-color); color: var(--text-light); font-weight: 600; }
  .master-table td.advisor-name-cell { text-align: left; font-weight: 700; background-color: #e3f2fd; color: var(--text-dark); position: sticky; left: 0; z-index: 5; }
  .master-table thead th:first-child { position: sticky; left: 0; z-index: 6; }
  .master-table select { width: 100%; padding: 6px; }

  /* --- TIMELINE GRID --- */
  #team-timeline-container { background-color: var(--text-light); padding: 10px; border-radius: 8px; box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1); overflow: auto; }
  .master-timeline-grid { display: grid; position: relative; grid-auto-rows: auto; }
  /* Time Axis */
  .time-axis { grid-column: 1; padding-right: 10px; text-align: right; border-right: 1px solid var(--border-color); height: var(--timeline-height); position: relative; z-index: 10; background-color: var(--text-light); }
  .time-label { position: absolute; font-size: 0.8em; transform: translateY(-50%); left: 0; width: 100%; padding-right: 5px; color: #757575; border-bottom: 1px dashed #cfd8dc; }
  /* Advisor/Day */
  .advisor-header { grid-row: 1; padding: 10px 0; text-align: center; font-weight: 700; background-color: var(--primary-color); color: var(--text-light); border: 1px solid var(--border-color); border-left: none; position: sticky; top: 0; z-index: 20; }
  .day-heading { text-align: center; font-weight: 700; background: var(--secondary-color); border-right: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); padding: 6px 0; }
  .day-cell { position: relative; border: 1px solid var(--border-color); border-top: none; height: var(--timeline-height); overflow: hidden; }
  .activity-block { position: absolute; width: 90%; left: 5%; color: var(--text-light); padding: 5px; box-sizing: border-box; border-radius: 6px; font-size: 0.75em; overflow: hidden; text-shadow: 0 0 1px rgba(0,0,0,0.5); cursor: help; box-shadow: 0 1px 3px rgba(0,0,0,0.2); font-weight: 700; z-index: 5; display: flex; flex-direction: column; justify-content: center; align-items: center; }
  .activity-time { font-size: 0.7em; font-weight: 500; display: block; }
  .day-off-label { position: absolute; top: 50%; transform: translateY(-50%); width: 100%; text-align: center; color: #bdbdbd; font-size: 1.2em; font-weight: 700; }

  /* Print Styles */
  @media print {
    .header, .controls-panel, .master-table-container, button { display: none !important; }
    .container { padding: 0 !important; }
    .master-timeline-grid { page-break-inside: avoid; }
    .time-axis { height: auto !important; }
    .day-cell { height: 1000px !important; page-break-inside: avoid; }
    body { background-color: white !important; }
  }
</style>
</head>
<body>
  <div class="header">
    <h1>Professional Team Rota System</h1>
  </div>

  <div class="container">
    <!-- Controls -->
    <div class="controls-panel">
      <div class="row">
        <label for="start-date-input">Week Start Date (Monday):</label>
        <input type="date" id="start-date-input" />
      </div>
      <div class="button-group">
        <button id="btn-save-download">üíæ Save & Download Data</button>
        <button class="subtle" id="btn-toggle-settings">‚öôÔ∏è Toggle Settings/Templates</button>
        <button id="btn-generate">üöÄ Generate Timeline View</button>
      </div>
    </div>

    <!-- Settings / Templates -->
    <div id="settings-area" class="controls-panel hidden">
      <div style="flex: 1 1 58%; min-width: 440px;">
        <h2 style="color: var(--text-dark);">üõ†Ô∏è Shift Template Builder (Flexible shifts)</h2>
        <div id="template-editor" style="padding: 10px;"></div>
        <div class="button-group">
          <button id="btn-add-template">‚ûï Add New Shift Template</button>
          <button id="btn-add-defaults" class="subtle">‚Ü∫ Load Sample Templates</button>
        </div>
      </div>
      <div style="flex: 1 1 38%; min-width: 320px;">
        <h2 style="color: var(--text-dark);">üé® Activity Color Key</h2>
        <div id="color-key" style="padding: 10px; background-color: var(--secondary-color); border-radius: 8px;"></div>
        <div class="button-group" style="margin-top: 10px;">
          <input type="file" id="load-file" accept=".json" style="display:none;" />
          <button id="btn-load-file">üìÇ Load Data from File</button>
          <button id="btn-reset" class="subtle">üßπ Clear Local Data</button>
        </div>
      </div>
    </div>

    <!-- Master Table -->
    <h2>üìÖ Master Rota Assignment Grid</h2>
    <div class="master-table-container">
      <table class="master-table" id="master-rota-table" aria-label="Master rota table">
        <thead>
          <tr>
            <th rowspan="2" class="advisor-name-cell" style="width: 200px;">Advisor</th>
            <th colspan="7">Select Shift Template</th>
          </tr>
          <tr id="date-headers"></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <button id="btn-generate-2" style="margin-top: 10px;">üöÄ Generate Timeline View</button>

    <!-- Timeline -->
    <h2 style="margin-top: 32px;">üìä Team Weekly Timeline Schedule</h2>
    <div id="team-timeline-container">
      <div class="master-timeline-grid" id="master-timeline-grid">
        <p style="padding: 20px; text-align: center; color: var(--text-dark);">Select your shifts in the grid above and click 'Generate Timeline View' to see the schedule.</p>
      </div>
    </div>

    <div class="button-group" style="margin-top: 16px;">
      <button id="btn-print">üñ®Ô∏è Download Team Rota (PDF)</button>
    </div>
  </div>

<script>
  // === CONFIGURATION ===
  const ADVISOR_NAMES = [
    'Luke Pashley', 'Ameena Malik', 'Carrie-Ann Raw', 'Danielle Smith',
    'Farwa Shaheen', 'Gemma Emmett', 'Laura Stockburn', 'Millie Walsh', 'Tunis Foley'
  ];
  const DAYS_FULL = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
  const PLATFORM_ACTIVITIES = ['Emails', 'Mirakl', 'Social', 'Overtime', 'Meeting'];
  const BREAK_SLOTS = ['Break1', 'Lunch', 'Break2'];
  const STORAGE_KEY = 'ultraFastRotasV4';

  // Timeline constants derived from CSS vars
  const START_HOUR = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--timeline-start')) || 7;
  const END_HOUR = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--timeline-end')) || 20;
  const TOTAL_HOURS = END_HOUR - START_HOUR;
  const TIMELINE_HEIGHT_PX = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--timeline-height')) || 1000;
  const HEIGHT_PER_HOUR = TIMELINE_HEIGHT_PX / TOTAL_HOURS;
  const HEIGHT_PER_MINUTE = HEIGHT_PER_HOUR / 60;

  // App State
  let masterRotaData = {}; // { [advisor]: { [day]: { template: string } } }
  let shiftTemplates = {}; // { [templateName]: { name, Start, Finish, Break1, Lunch, Break2, Platform } }

  // === HELPERS ===
  const $$ = (sel, ctx = document) => Array.from(ctx.querySelectorAll(sel));
  const $ = (sel, ctx = document) => ctx.querySelector(sel);

  function pad2(n) { return String(n).padStart(2, '0'); }

  // Parse HH:MM to minutes since midnight
  function toMinutes(t) {
    if (!t || !/^\d{2}:\d{2}$/.test(t)) return null;
    const [h, m] = t.split(':').map(Number);
    return h * 60 + m;
  }

  function minutesToTime(mins) {
    const h = Math.floor(mins / 60);
    const m = mins % 60;
    return `${pad2(h)}:${pad2(m)}`;
  }

  function timeToPosition(time) {
    const mins = toMinutes(time);
    if (mins == null) return -9999;
    const startMinutes = START_HOUR * 60;
    const offset = mins - startMinutes;
    return offset * HEIGHT_PER_MINUTE;
  }

  function getColorMap() {
    const inputs = $$('#color-key input[type="text"]');
    const map = {};
    inputs.forEach(inp => {
      const key = inp.dataset.key;
      if (key) map[key] = inp.value || '#343a40';
    });
    return map;
  }

  function setCSSVar(name, val) {
    document.documentElement.style.setProperty(name, val);
  }

  function updateColors(refresh = true) {
    const map = getColorMap();
    Object.keys(map).forEach(k => setCSSVar(`--color-${k}`, map[k]));
    if (refresh) generateAllSchedules();
    saveToLocalStorage();
  }

  // === TEMPLATE LOGIC ===
  function addTemplate() {
    const newName = `Shift${Object.keys(shiftTemplates).length + 1}`;
    shiftTemplates[newName] = {
      name: newName,
      Start: '', Finish: '', Break1: '', Lunch: '', Break2: '',
      Platform: 'Emails'
    };
    populateTemplateEditor();
    populateMasterTable();
    saveToLocalStorage();
  }

  function addDefaultTemplates() {
    const defaults = [
      { name: 'Early',   Start: '08:00', Finish: '16:00', Break1: '10:30', Lunch: '12:30', Break2: '15:00', Platform: 'Emails' },
      { name: 'Core',    Start: '09:00', Finish: '17:30', Break1: '11:00', Lunch: '13:00', Break2: '16:00', Platform: 'Mirakl' },
      { name: 'Late',    Start: '11:00', Finish: '19:00', Break1: '12:15', Lunch: '14:30', Break2: '17:00', Platform: 'Social' },
      { name: 'Meeting', Start: '10:00', Finish: '18:00', Break1: '11:30', Lunch: '13:30', Break2: '16:30', Platform: 'Meeting' }
    ];
    defaults.forEach(t => { shiftTemplates[t.name] = { ...t }; });
    populateTemplateEditor();
    populateMasterTable();
    saveToLocalStorage();
  }

  function deleteTemplate(name) {
    delete shiftTemplates[name];
    populateTemplateEditor();
    populateMasterTable();
    saveToLocalStorage();
  }

  function updateTemplate(oldName, key, value) {
    const t = shiftTemplates[oldName];
    if (!t) return;
    if (key === 'name') {
      const newName = value.trim();
      if (!newName || newName === oldName) return;
      // Rename key & update references in rota
      shiftTemplates[newName] = { ...t, name: newName };
      delete shiftTemplates[oldName];
      ADVISOR_NAMES.forEach(a => {
        DAYS_FULL.forEach(d => {
          if (masterRotaData[a][d].template === oldName) {
            masterRotaData[a][d].template = newName;
          }
        });
      });
    } else {
      t[key] = value;
    }
    populateTemplateEditor();
    populateMasterTable();
    saveToLocalStorage();
  }

  function templateRowHTML(t, key) {
    const options = PLATFORM_ACTIVITIES.map(p => `<option value="${p}" ${t.Platform === p ? 'selected' : ''}>${p}</option>`).join('');
    return `
      <div class="template-row" data-key="${key}">
        <label>Name:</label>
        <input type="text" value="${t.name}" data-field="name" style="width: 120px;" />
        <label>Shift:</label>
        <div class="time-block">
          <input type="time" value="${t.Start || ''}" data-field="Start" title="Start Time" />
          <input type="time" value="${t.Finish || ''}" data-field="Finish" title="Finish Time" />
        </div>
        <label>Breaks:</label>
        <div class="time-block">
          <input type="time" value="${t.Break1 || ''}" data-field="Break1" title="Break 1 (15m)" />
          <input type="time" value="${t.Lunch || ''}" data-field="Lunch" title="Lunch (45m)" />
          <input type="time" value="${t.Break2 || ''}" data-field="Break2" title="Break 2 (15m)" />
        </div>
        <label>Platform:</label>
        <select data-field="Platform" style="width: 120px;">
          <option value="">-- Main --</option>
          ${options}
        </select>
        <button class="danger" data-action="delete">Delete</button>
      </div>`;
  }

  function populateTemplateEditor() {
    const editor = $('#template-editor');
    if (!editor) return;
    const keys = Object.keys(shiftTemplates);
    if (keys.length === 0) {
      editor.innerHTML = `<p style="margin:8px 0; color:#546e7a;">No templates yet. Click <b>"Add New Shift Template"</b> to create one, or load <b>Sample Templates</b>.</p>`;
      return;
    }
    editor.innerHTML = keys.map(k => templateRowHTML(shiftTemplates[k], k)).join('');

    // Wire inputs
    $$('#template-editor .template-row').forEach(row => {
      const key = row.dataset.key;
      $$("input, select", row).forEach(inp => {
        const field = inp.dataset.field;
        if (!field) return;
        inp.addEventListener('input', () => updateTemplate(key, field, inp.value));
        if (field === 'Platform') inp.value = shiftTemplates[key].Platform || '';
      });
      const delBtn = $('[data-action="delete"]', row);
      delBtn.addEventListener('click', () => deleteTemplate(key));
    });
  }

  // === MASTER GRID ===
  function populateMasterTable() {
    const dateHeadersRow = $('#date-headers');
    const tbody = $('#master-rota-table tbody');
    if (!dateHeadersRow || !tbody) return;

    // Date headers
    dateHeadersRow.innerHTML = DAYS_FULL
      .map(day => `<th class="day-col" data-day="${day}">${day.substring(0,3)}<br><span class="date-display">Date N/A</span></th>`) 
      .join('');

    // Template options
    const templateOptions = Object.keys(shiftTemplates)
      .map(name => `<option value="${name}">${name}</option>`) 
      .join('');

    // Rows
    tbody.innerHTML = '';
    ADVISOR_NAMES.forEach(name => {
      const tr = document.createElement('tr');
      const nameTd = document.createElement('td');
      nameTd.className = 'advisor-name-cell';
      nameTd.textContent = name;
      tr.appendChild(nameTd);

      DAYS_FULL.forEach(day => {
        const td = document.createElement('td');
        const sel = document.createElement('select');
        sel.innerHTML = `<option value="">-- DAY OFF --</option>${templateOptions}`;
        const current = masterRotaData[name][day].template || '';
        sel.value = current;
        sel.addEventListener('change', () => saveAssignment(name, day, sel.value));
        td.appendChild(sel);
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  }

  function saveAssignment(advisorName, day, templateName) {
    masterRotaData[advisorName][day].template = templateName;
    saveToLocalStorage();
    // Live update timeline for instant feedback
    generateAllSchedules();
  }

  // === WORKFLOW / SLICING ===
  // Turn a template into sequential activities with breaks
  function processDayWorkflow(templateData) {
    if (!templateData) return [];
    const { Start, Finish } = templateData;
    const startM = toMinutes(Start);
    const endM = toMinutes(Finish);
    if (startM == null || endM == null || startM === endM) return [];

    // Collect break events
    const events = [
      { t: startM, kind: 'start' },
      { t: endM,   kind: 'end' }
    ];
    BREAK_SLOTS.forEach(slot => {
      const val = templateData[slot];
      if (!val) return;
      const t = toMinutes(val);
      if (t == null) return;
      const dur = (slot === 'Lunch') ? 45 : 15;
      events.push({ t, kind: 'break', label: slot.replace(/\d/g, ''), dur });
    });

    // Sort by time, then end before break/start to avoid zero segments
    events.sort((a, b) => a.t - b.t || (a.kind === 'end') - (b.kind === 'end'));

    let cursor = startM;
    const out = [];
    const platform = templateData.Platform || 'Emails';

    for (const ev of events) {
      if (ev.t > cursor) {
        out.push({ activity: platform, start: minutesToTime(cursor), end: minutesToTime(ev.t) });
      }
      if (ev.kind === 'break') {
        const breakEnd = ev.t + ev.dur;
        out.push({ activity: ev.label, start: minutesToTime(ev.t), end: minutesToTime(breakEnd) });
        cursor = breakEnd;
      } else if (ev.kind === 'start') {
        cursor = ev.t;
      } else if (ev.kind === 'end') {
        cursor = ev.t; // finished
      }
    }

    // Filter out-of-range items and zero/negative heights
    return out.filter(a => timeToPosition(a.end) > timeToPosition(a.start));
  }

  // === DATE HEADERS ===
  function updateDates() {
    const inp = $('#start-date-input');
    if (!inp || !inp.value) return;
    const startDate = new Date(`${inp.value}T00:00:00`);
    if (startDate.getDay() !== 1) { // Monday = 1
      alert('Please select a Monday as the start date.');
      inp.value = '';
      return;
    }
    DAYS_FULL.forEach((day, i) => {
      const d = new Date(startDate);
      d.setDate(d.getDate() + i);
      const formatted = d.toLocaleDateString('en-GB', { month: 'short', day: 'numeric' });
      const header = $(`th[data-day="${day}"] .date-display`);
      if (header) header.textContent = formatted;
    });
    generateAllSchedules();
    saveToLocalStorage();
  }

  // === TIMELINE RENDER ===
  function generateAllSchedules() {
    const grid = $('#master-timeline-grid');
    if (!grid) return;
    grid.innerHTML = '';

    const colors = getColorMap();
    const advisors = ADVISOR_NAMES.length;

    // Grid columns: time axis (80px) + N advisors (min 220px each)
    const firstColWidth = 80;
    const colWidth = 220;
    grid.style.gridTemplateColumns = `${firstColWidth}px repeat(${advisors}, ${colWidth}px)`;
    grid.style.gridTemplateRows = `auto auto ${TIMELINE_HEIGHT_PX}px`;
    grid.style.minWidth = `${firstColWidth + advisors * colWidth}px`;

    // Time axis
    const axis = document.createElement('div');
    axis.className = 'time-axis';
    axis.style.height = `${TIMELINE_HEIGHT_PX}px`;
    for (let h = START_HOUR; h <= END_HOUR; h++) {
      const y = timeToPosition(`${pad2(h)}:00`);
      if (y >= 0 && y <= TIMELINE_HEIGHT_PX) {
        const lbl = document.createElement('div');
        lbl.className = 'time-label';
        lbl.style.top = `${y}px`;
        lbl.textContent = `${pad2(h)}:00`;
        axis.appendChild(lbl);
      }
    }
    grid.appendChild(axis);

    // Advisor headers (row 1)
    ADVISOR_NAMES.forEach((name, i) => {
      const head = document.createElement('div');
      head.className = 'advisor-header';
      head.style.gridColumn = String(i + 2);
      head.textContent = name;
      grid.appendChild(head);
    });

    // Day row (row 2)
    DAYS_FULL.forEach((day, i) => {
      const dHead = document.createElement('div');
      dHead.className = 'day-heading';
      dHead.style.gridColumn = String(i + 2);
      const dateSpan = $(`th[data-day="${day}"] .date-display`);
      const dateTxt = dateSpan ? dateSpan.textContent : '‚Äî';
      dHead.innerHTML = `${day.substring(0,3)}<br>${dateTxt}`;
      grid.appendChild(dHead);
    });

    // Day cells (row 3) for each advisor & day
    ADVISOR_NAMES.forEach((advisor, colIdx) => {
      DAYS_FULL.forEach(day => {
        const cell = document.createElement('div');
        cell.className = 'day-cell';
        cell.style.gridColumn = String(colIdx + 2);
        cell.style.gridRow = '3';

        const tplName = masterRotaData[advisor][day].template;
        const tpl = shiftTemplates[tplName];
        const activities = processDayWorkflow(tpl);

        if (!tpl || activities.length === 0) {
          const off = document.createElement('div');
          off.className = 'day-off-label';
          off.textContent = 'DAY OFF';
          cell.appendChild(off);
        } else {
          activities.forEach(a => {
            const top = timeToPosition(a.start);
            const bottom = timeToPosition(a.end);
            const height = Math.max(10, bottom - top);
            const key = (a.activity || '').toLowerCase();
            const bg = colors[key] || '#37474f';

            const block = document.createElement('div');
            block.className = 'activity-block';
            block.style.top = `${top}px`;
            block.style.height = `${height}px`;
            block.style.backgroundColor = bg;
            block.title = `${a.activity} (${a.start} - ${a.end})`;
            block.innerHTML = `${a.activity.toUpperCase()}<span class="activity-time">${a.start} - ${a.end}</span>`;
            cell.appendChild(block);
          });
        }
        grid.appendChild(cell);
      });
    });
  }

  // === DATA PERSISTENCE ===
  function collectFullData() {
    return {
      dates: $('#start-date-input').value || '',
      colors: getColorMap(),
      rotas: masterRotaData,
      templates: shiftTemplates
    };
  }

  function saveToLocalStorage() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(collectFullData()));
    } catch (e) { console.warn('localStorage save failed', e); }
  }

  function loadDataFromStorage() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return null;
      return JSON.parse(raw);
    } catch (e) { console.warn('localStorage load failed', e); return null; }
  }

  function applyData(data) {
    if (!data) return;
    // Colors
    if (data.colors) {
      Object.entries(data.colors).forEach(([k, v]) => {
        const input = $(`#color-key input[data-key="${k}"]`);
        if (input) input.value = v;
        setCSSVar(`--color-${k}`, v);
      });
    }

    // Templates
    if (data.templates) {
      shiftTemplates = data.templates;
    }

    // Dates
    if (data.dates) {
      const inp = $('#start-date-input');
      inp.value = data.dates;
      // updateDates() will be called after table render to have headers ready
    }

    // Rotas
    if (data.rotas) {
      Object.assign(masterRotaData, data.rotas);
    }

    populateTemplateEditor();
    populateMasterTable();
    updateDates();
    generateAllSchedules();
  }

  function downloadData(data) {
    const json = JSON.stringify(data, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'team_schedule_data.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // === ACTIONS ===
  function handleLoadFile(e) {
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      try {
        const data = JSON.parse(ev.target.result);
        applyData(data);
        alert('Schedule data loaded successfully!');
      } catch (err) {
        alert('Error loading file: Invalid JSON.');
      }
    };
    reader.readAsText(file);
  }

  function clearAllData() {
    if (!confirm('Clear all local data and reset the app?')) return;
    try { localStorage.removeItem(STORAGE_KEY); } catch {}
    // Reset state
    masterRotaData = {};
    shiftTemplates = {};
    initEmptyState();
    populateTemplateEditor();
    populateMasterTable();
    $('#start-date-input').value = '';
    $('#master-timeline-grid').innerHTML = '<p style="padding:20px; text-align:center; color:var(--text-dark);">Cleared. Add templates and assignments to begin.</p>';
  }

  function printGeneratedSchedule() { window.print(); }

  // === INIT ===
  function buildColorKey() {
    const colors = [
      ['emails', 'Emails', getComputedStyle(document.documentElement).getPropertyValue('--color-emails').trim() || '#2ecc71'],
      ['mirakl', 'Mirakl', getComputedStyle(document.documentElement).getPropertyValue('--color-mirakl').trim() || '#ffb300'],
      ['social', 'Social', getComputedStyle(document.documentElement).getPropertyValue('--color-social').trim() || '#5e35b1'],
      ['meeting', 'Meeting/Coach', getComputedStyle(document.documentElement).getPropertyValue('--color-meeting').trim() || '#ffd700'],
      ['overtime', 'Overtime', getComputedStyle(document.documentElement).getPropertyValue('--color-overtime').trim() || '#e53935'],
      ['break', 'Break', getComputedStyle(document.documentElement).getPropertyValue('--color-break').trim() || '#90a4ae'],
      ['lunch', 'Lunch', getComputedStyle(document.documentElement).getPropertyValue('--color-lunch').trim() || '#ff8f00']
    ];
    const key = $('#color-key');
    key.innerHTML = colors.map(([k, label, val]) => `
      <div class="key-row">
        <span class="swatch" style="background:${val};" data-activity="${k}"></span>
        <strong>${label}:</strong>
        <input type="text" value="${val}" data-key="${k}" />
      </div>`).join('');

    // Wire updates
    $$('#color-key input[type="text"]').forEach(inp => inp.addEventListener('input', updateColors));
  }

  function initEmptyState() {
    // Rota data skeleton
    ADVISOR_NAMES.forEach(name => {
      masterRotaData[name] = {};
      DAYS_FULL.forEach(day => { masterRotaData[name][day] = { template: '' }; });
    });
  }

  function initApp() {
    buildColorKey();
    initEmptyState();
    populateTemplateEditor();
    populateMasterTable();

    // Buttons
    $('#btn-toggle-settings').addEventListener('click', () => $('#settings-area').classList.toggle('hidden'));
    $('#btn-add-template').addEventListener('click', addTemplate);
    $('#btn-add-defaults').addEventListener('click', addDefaultTemplates);

    $('#btn-save-download').addEventListener('click', () => { saveToLocalStorage(); downloadData(collectFullData()); });
    $('#btn-generate').addEventListener('click', generateAllSchedules);
    $('#btn-generate-2').addEventListener('click', generateAllSchedules);
    $('#btn-print').addEventListener('click', printGeneratedSchedule);

    $('#load-file').addEventListener('change', handleLoadFile);
    $('#btn-load-file').addEventListener('click', () => $('#load-file').click());
    $('#btn-reset').addEventListener('click', clearAllData);

    $('#start-date-input').addEventListener('change', updateDates);

    // Load stored data
    const stored = loadDataFromStorage();
    if (stored) {
      applyData(stored);
    } else {
      // Provide a couple of defaults so the grid is usable immediately
      addDefaultTemplates();
      generateAllSchedules();
    }
  }

  document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>

