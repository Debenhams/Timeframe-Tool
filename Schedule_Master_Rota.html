<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Professional Team Rota System</title>
<style>
  :root{
    --brand:#0d47a1; --accent:#00c853; --ink:#1f2937; --paper:#ffffff; --wash:#f5f7fb; --line:#e4e9f2;
    --timeline-start:7; --timeline-end:20; --timeline-height:800px;
    --color-emails:#2ecc71; --color-mirakl:#b1b51e; --color-social:#5e35b1; --color-overtime:#e53935; --color-meeting:#ffd700; --color-break:#cfd8dc; --color-lunch:#b0bec5;
  }
  html,body{height:100%}
  body{margin:0;background:#eef2f6;color:var(--ink);font-family:Inter,Roboto,Segoe UI,system-ui,Arial,Helvetica,sans-serif}
  .topbar{background:var(--brand);color:#fff;padding:14px 18px;display:flex;align-items:center;gap:14px;box-shadow:0 4px 14px rgba(13,71,161,.18)}
  .topbar h1{margin:0;font-size:18px;font-weight:800}
  .layout{display:grid;grid-template-columns:1fr 320px;gap:18px;max-width:1500px;margin:18px auto;padding:0 16px}
  .panel{background:var(--paper);border:1px solid var(--line);border-radius:12px;box-shadow:0 8px 20px rgba(12,27,74,.06)}
  .panel-header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid var(--line)}
  .panel-header h2{margin:0;font-size:15px}
  .panel-body{padding:12px 14px}
  .muted{color:#64748b}
  .btn{background:var(--accent);color:#fff;border:0;border-radius:10px;padding:9px 12px;font-weight:800;cursor:pointer}
  .btn:hover{filter:brightness(.95)}
  .btn.subtle{background:#e9eef6;color:#0f172a}
  .btn.icon{padding:7px 9px}
  .seg{display:inline-flex;border:1px solid var(--line);border-radius:10px;overflow:hidden}
  .seg button{background:#fff;border:0;padding:8px 12px;cursor:pointer}
  .seg button.active{background:#1e5fe0;color:#fff}
  .input, select, input[type=date]{padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#fff}
  .collapsible[open] .chev{transform:rotate(90deg)} .chev{transition:transform .2s}
  .template-row{display:grid;grid-template-columns:auto 140px auto 1fr auto;gap:10px 14px;align-items:center;padding:10px;border:1px solid var(--line);border-radius:10px;background:#fafcff;margin-bottom:10px}
  .time-block{display:flex;gap:6px;flex-wrap:wrap}
  .danger{background:#dc3545;color:#fff;border:0;border-radius:8px;padding:6px 10px;cursor:pointer}
  .key-row{display:grid;grid-template-columns:18px 100px 1fr;gap:8px;align-items:center;margin-bottom:8px}
  .swatch{width:18px;height:18px;border-radius:3px;border:1px solid var(--line)}
  .list{display:flex;flex-direction:column;gap:6px}
  .pill{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#fff}
  .table-wrap{overflow:auto}
  table{width:100%;border-collapse:collapse;min-width:900px}
  th,td{border:1px solid var(--line);padding:8px;text-align:center}
  thead th{background:#0d47a1;color:#fff;font-weight:800}
  td.name{position:sticky;left:0;background:#e8f1ff;font-weight:800}

  /* Calendar */
  .calendar{border-top:1px solid var(--line)}
  .cal-grid{
    display:grid;
    grid-template-columns:80px repeat(7,1fr);
    grid-auto-flow: column;
    overflow:auto;
  }
  .hour-col{border-right:1px solid var(--line);background:#fafcfe}
  .hour{height:calc(var(--timeline-height)/(var(--timeline-end)-var(--timeline-start)));border-bottom:1px solid var(--line);font-size:12px;color:#748099;text-align:right;padding-right:6px;position:relative;box-sizing:border-box}
  .hour span{position:absolute;top:-7px;right:6px;background:#fafcfe;padding:0 4px}
  .day-col{border-left:1px solid var(--line)}
  .day-head{height:56px;border-bottom:1px solid var(--line);display:flex;flex-direction:column;justify-content:center;padding:6px 10px;background:#f6f8fb;font-weight:800}
  .day-head small{font-weight:700;color:#8792a6}
  .day-summary{display:flex;align-items:center;gap:8px;padding:6px 10px;border-bottom:1px solid var(--line)}
  .badge{background:#2a5934;color:#fff;border-radius:6px;padding:4px 6px;font-weight:800;white-space:nowrap}
  .summary-right{margin-left:auto;color:#5b6b7f;font-size:12px}
  .day-actions{display:flex;gap:6px;border-bottom:1px solid var(--line);padding:6px 10px}
  .iconbtn{border:1px solid var(--line);background:#fff;border-radius:6px;padding:6px 8px;cursor:pointer}
  .off{height:40px;border-bottom:1px solid var(--line);padding:8px 10px;background:repeating-linear-gradient(45deg,#f2f3f7,#f2f3f7 8px,#e8ecf4 8px,#e8ecf4 16px);font-weight:800;color:#8892a0}
  .timeline-cell{position:relative;height:var(--timeline-height);background:
    linear-gradient(#0000,#0000),
    repeating-linear-gradient(180deg,#0000,#0000 calc(100%/(var(--timeline-end) - var(--timeline-start))), var(--line) 0, var(--line) calc(100%/(var(--timeline-end) - var(--timeline-start)) + 1px));}
  .block{position:absolute;left:10px;right:10px;border-radius:6px;padding:3px 6px;font-size:11px;font-weight:800;color:#fff;box-shadow:0 1px 3px rgba(0,0,0,.12);line-height:1.1;cursor:pointer}
  .block .time{display:block;font-weight:700;font-size:10px;opacity:.95}
  .c-emails{background:var(--color-emails)} .c-mirakl{background:var(--color-mirakl)} .c-social{background:var(--color-social)}
  .c-meeting{background:var(--color-meeting);color:#213} .c-break{background:var(--color-break);color:#213} .c-lunch{background:var(--color-lunch);color:#213}
  .c-overtime{background:var(--color-overtime)}
  @media print{.no-print{display:none} .panel{box-shadow:none}}

  /* Split editor / Block editor */
  .row{display:flex;gap:8px;align-items:center;margin:6px 0}
  .row .del{background:#ffe2e2;color:#b42318;border:1px solid #f2b8b5;border-radius:6px;padding:4px 8px;cursor:pointer}
  .modebar{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  .tag{display:inline-block;background:#eef2ff;border:1px solid #d6dcff;border-radius:6px;padding:3px 6px;font-size:12px;color:#334155}
  .overlaybar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:8px 0;padding:8px;border:1px dashed var(--line);border-radius:8px;background:#f9fbff}

  dialog{max-width:740px;width:95%}
</style>
</head>
<body>
  <div class="topbar">
    <h1>Professional Team Rota System</h1>
    <div class="seg" style="margin-left:auto">
      <button class="active" id="segWeek">Week</button>
      <button id="segMonth" disabled class="muted">Month</button>
    </div>
    <button class="btn subtle no-print" id="btnPrint">üñ®Ô∏è Print</button>
  </div>

  <div class="layout">
    <!-- Main column -->
    <div style="display:flex;flex-direction:column;gap:18px">
      <!-- Rota controls -->
      <div class="panel">
        <div class="panel-body" style="display:flex;flex-wrap:wrap;gap:10px 12px;align-items:center">
          <label>Week start (Monday)</label>
          <input type="date" id="weekStart" class="input"/>
          <label>Advisor</label>
          <select id="advisorSelect" class="input"></select>
          <!-- Team (All) day selector appears only when Team is chosen -->
          <label id="lblTeamDay" class="muted" style="display:none">Team Day</label>
          <select id="teamDay" class="input" style="display:none">
            <option>Monday</option><option>Tuesday</option><option>Wednesday</option><option>Thursday</option>
            <option>Friday</option><option>Saturday</option><option>Sunday</option>
          </select>
          <button class="btn" id="btnGenerate">Generate</button>
          <span class="muted" id="rangeLabel" style="margin-left:auto"></span>
        </div>
      </div>

      <!-- Collapsible Settings / Templates / Assignment -->
      <details class="panel collapsible no-print" id="settingsBox" open>
        <summary class="panel-header" style="cursor:pointer">
          <h2>Settings / Templates</h2><span class="chev">‚ñ∂</span>
        </summary>
        <div class="panel-body">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:18px;align-items:start">
            <div>
              <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
                <button class="btn subtle" id="btnAddTemplate">‚ûï Add Template</button>
                <button class="btn subtle" id="btnLoadDefaults">‚Ü∫ Load Sample Templates</button>
              </div>
              <div id="templateEditor"></div>
            </div>
            <div>
              <h3 style="margin:6px 0">üé® Activity Colours</h3>
              <div id="colorKey"></div>
              <div style="display:flex;gap:8px;margin-top:8px">
                <button class="btn subtle" id="btnSave">üíæ Save JSON</button>
                <input type="file" id="file" accept=".json" style="display:none"/>
                <button class="btn subtle" id="btnLoad">üìÇ Load JSON</button>
                <button class="btn danger" id="btnReset">üßπ Clear</button>
              </div>
            </div>
          </div>

          <div style="margin-top:16px">
            <h3 style="margin:6px 0">üìÖ Master Assignment (Team)</h3>
            <div class="table-wrap">
              <table id="assignTable">
                <thead>
                  <tr><th rowspan="2">Advisor</th><th colspan="7">Select Shift Template</th></tr>
                  <tr id="dateHeaders"></tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div class="muted" style="margin-top:8px">
              Tip: if a day is set via <span class="tag">Split Segments</span>, the table won‚Äôt show it (it‚Äôs custom). Use the day‚Äôs ‚úé button to edit those segments.
            </div>
          </div>
        </div>
      </details>

      <!-- Advisor Week Calendar (single rota view) OR Team (All) Day -->
      <div class="panel">
        <div class="panel-header"><h2 id="calTitle">Advisor Week (Calendar)</h2>
          <div style="display:flex;gap:6px;align-items:center">
            <button class="btn subtle icon" id="prevWeek">‚óÄ</button>
            <button class="btn subtle icon" id="btnToday">Today</button>
            <button class="btn subtle icon" id="nextWeek">‚ñ∂</button>
          </div>
        </div>
        <div class="panel-body calendar">
          <div class="cal-grid" id="calGrid">
            <div class="hour-col"><div id="hours"></div></div>
            <!-- day or advisor columns injected here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Right sidebar: Advisors -->
    <div class="panel">
      <div class="panel-header"><h2>Advisors</h2></div>
      <div class="panel-body">
        <div style="display:flex;gap:6px;margin-bottom:8px">
          <input id="newAdvisor" class="input" placeholder="Add advisor name‚Ä¶"/>
          <button class="btn subtle" id="addAdvisor">Add</button>
        </div>
        <div class="list" id="advisorList"></div>
      </div>
    </div>
  </div>

  <!-- Assign / Split dialog -->
  <dialog id="assignDlg" style="border:1px solid var(--line);border-radius:12px;padding:12px 14px;">
    <div style="font-weight:800;margin-bottom:6px">
      <span id="assignTitle">Assign</span>
    </div>

    <div class="modebar">
      <label><input type="radio" name="mode" value="template" id="modeTemplate"> Use template</label>
      <label><input type="radio" name="mode" value="split" id="modeSplit"> Use split segments</label>
      <span class="muted" id="modeHint" style="margin-left:6px"></span>
    </div>

    <div id="templateMode">
      <select id="assignSelect" style="width:100%"></select>
      <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
        <button class="btn subtle" id="btnConvertToSplit">Convert this template to editable segments</button>
        <span class="muted">Fast way to tweak just part of the shift.</span>
      </div>
    </div>

    <div id="splitMode" style="display:none">
      <div class="overlaybar">
        <strong>Pick block to split:</strong>
        <select id="ovBlock" style="min-width:220px"></select>
        <strong>Insert override:</strong>
        <select id="ovActivity">
          <option>Emails</option><option>Mirakl</option><option>Social</option>
          <option>Meeting</option><option>Overtime</option><option>Break</option><option>Lunch</option>
        </select>
        <input type="time" id="ovStart" value="13:00">
        <span>‚Äì</span>
        <input type="time" id="ovEnd" value="13:30">
        <button class="btn subtle" id="btnInsertOverlay">Insert</button>
        <span class="muted">Splits the chosen block and drops your override in place.</span>
      </div>

      <div id="segmentsWrap"></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn subtle" id="addSegment">Ôºã Add segment</button>
        <span class="muted">Edit rows directly, or use ‚ÄúPick block to split‚Äù + ‚ÄúInsert override‚Äù.</span>
      </div>
    </div>

    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:14px">
      <button id="assignOK" class="btn">Save</button>
      <button onclick="assignDlg.close()" class="btn subtle">Cancel</button>
    </div>
  </dialog>

  <!-- NEW: Click-a-block Editor -->
  <dialog id="blockDlg" style="border:1px solid var(--line);border-radius:12px;padding:12px 14px;">
    <div style="font-weight:800;margin-bottom:6px">
      <span id="blockTitle">Edit block</span>
    </div>

    <div class="modebar">
      <label><input type="radio" name="blockmode" value="whole" id="bmWhole"> Edit block</label>
      <label><input type="radio" name="blockmode" value="sub" id="bmSub"> Change part of block</label>
      <span class="muted" id="blockHint" style="margin-left:6px"></span>
    </div>

    <div id="blockWhole">
      <div class="row">
        <label style="min-width:90px">Activity</label>
        <select id="bwActivity">
          <option>Emails</option><option>Mirakl</option><option>Social</option>
          <option>Meeting</option><option>Overtime</option><option>Break</option><option>Lunch</option>
        </select>
      </div>
      <div class="row">
        <label style="min-width:90px">Start‚ÄìEnd</label>
        <input type="time" id="bwStart"> <span>‚Äì</span> <input type="time" id="bwEnd">
      </div>
      <div class="muted">You can‚Äôt extend beyond the original block. If you shrink it, we‚Äôll keep the before/after time with the original activity so no gaps appear.</div>
    </div>

    <div id="blockSub" style="display:none">
      <div class="row">
        <label style="min-width:90px">New activity</label>
        <select id="bsActivity">
          <option>Emails</option><option>Mirakl</option><option>Social</option>
          <option>Meeting</option><option>Overtime</option><option>Break</option><option>Lunch</option>
        </select>
      </div>
      <div class="row">
        <label style="min-width:90px">Sub-range</label>
        <input type="time" id="bsStart"> <span>‚Äì</span> <input type="time" id="bsEnd">
      </div>
      <div class="muted">We‚Äôll split the original block into left remainder + your new activity + right remainder. Neighbours stay the same.</div>
    </div>

    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:14px">
      <button id="blockOK" class="btn">Save</button>
      <button onclick="blockDlg.close()" class="btn subtle">Cancel</button>
    </div>
  </dialog>

<script>
/* ========= DATA & CONSTANTS ========= */
const DAYS=['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
let ADVISORS=['Luke Pashley','Ameena Malik','Carrie-Ann Raw','Danielle Smith','Farwa Shaheen','Gemma Emmett','Laura Stockburn','Millie Walsh','Tunis Foley'];
let templates={};
let rotas={};
const STORAGE='rota_single_v10_block_click_edit';

const css=getComputedStyle(document.documentElement);
const START=+css.getPropertyValue('--timeline-start')||7;
const END=+css.getPropertyValue('--timeline-end')||20;
const HEIGHT=+css.getPropertyValue('--timeline-height').replace('px','')||800;
const PX_PER_MIN=HEIGHT/((END-START)*60);

const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const pad=n=>String(n).padStart(2,'0');
const toMin=t=>{ if(!t) return null; const [h,m]=t.split(':').map(Number); return h*60+m; };
const m2t=m=>`${pad(Math.floor(m/60))}:${pad(m%60)}`;

function save(){ localStorage.setItem(STORAGE, JSON.stringify({advisors:ADVISORS,templates,rotas,weekStart:$('#weekStart').value})); }
function load(){ try{ const d=JSON.parse(localStorage.getItem(STORAGE)||'null'); if(!d) return; ADVISORS=d.advisors||ADVISORS; templates=d.templates||templates; rotas=d.rotas||rotas; if(d.weekStart) $('#weekStart').value=d.weekStart; }catch{} }

/* ========= GRID RESET ========= */
function resetGrid(){
  const grid = document.getElementById('calGrid');
  grid.innerHTML = '<div class="hour-col"><div id="hours"></div></div>';
}

/* ========= COLOR KEY ========= */
function buildColorKey(){
  const defs=[['emails','Emails','--color-emails'],['mirakl','Mirakl','--color-mirakl'],['social','Social','--color-social'],['meeting','Meeting/Coach','--color-meeting'],['overtime','Overtime','--color-overtime'],['break','Break','--color-break'],['lunch','Lunch','--color-lunch']];
  const el=$('#colorKey');
  el.innerHTML = defs.map(([k,l,cssVar])=>{
    const v=getComputedStyle(document.documentElement).getPropertyValue(cssVar).trim();
    return `<div class="key-row"><span class="swatch" style="background:${v}"></span><strong>${l}</strong><input type="text" data-k="${cssVar}" value="${v}"></div>`;
  }).join('');
  $$('#colorKey input').forEach(inp=>inp.addEventListener('input',()=>{ document.documentElement.style.setProperty(inp.dataset.k, inp.value); save(); renderCalendar(); }));
}

/* ========= TEMPLATES ========= */
function seedDefaults(){
  templates={
    'Early':  {name:'Early',  Start:'07:00', Finish:'16:00', Break1:'09:15', Lunch:'12:00', Break2:'15:15', Platform:'Emails'},
    'Middle': {name:'Middle', Start:'11:00', Finish:'20:00', Break1:'11:30', Lunch:'15:30', Break2:'17:45', Platform:'Mirakl'},
    'Late':   {name:'Late',   Start:'12:00', Finish:'21:00', Break1:'13:15', Lunch:'17:00', Break2:'19:15', Platform:'Social'},
    'Coach':  {name:'Coach',  Start:'10:00', Finish:'18:00', Break1:'11:30', Lunch:'13:30', Break2:'16:00', Platform:'Meeting'}
  };
  ADVISORS.forEach(a=>{ if(!rotas[a]) rotas[a]={}; DAYS.forEach(d=>{ if(!(d in rotas[a])) rotas[a][d]=''; }); });
}

function templateRow(t,key){
  const opts=['Emails','Mirakl','Social','Overtime','Meeting'].map(p=>`<option ${t.Platform===p?'selected':''}>${p}</option>`).join('');
  return `<div class="template-row" data-k="${key}">
    <label>Name</label><input data-f="name" type="text" value="${t.name}" style="width:140px">
    <label>Shift</label><div class="time-block">
      <input data-f="Start" type="time" value="${t.Start||''}" title="Start">
      <input data-f="Finish" type="time" value="${t.Finish||''}" title="Finish">
    </div>
    <label>Breaks</label><div class="time-block">
      <input data-f="Break1" type="time" value="${t.Break1||''}" title="Break 1 (15m)">
      <input data-f="Lunch"  type="time" value="${t.Lunch||''}"  title="Lunch (45m)">
      <input data-f="Break2" type="time" value="${t.Break2||''}" title="Break 2 (15m)">
    </div>
    <label>Platform</label><select data-f="Platform" style="width:140px"><option value="">--</option>${opts}</select>
    <button class="danger" data-act="del">Delete</button>
  </div>`;
}
function populateTemplateEditor(){
  const ed=$('#templateEditor'); const keys=Object.keys(templates);
  ed.innerHTML = keys.length? keys.map(k=>templateRow(templates[k],k)).join('') : '<div class="muted">No templates. Add or load samples.</div>';
  $$('#templateEditor .template-row').forEach(row=>{
    const key=row.dataset.k;
    $$('input,select',row).forEach(inp=>{
      const f=inp.dataset.f; if(!f) return;
      inp.addEventListener('input',()=>{
        if(f==='name'){
          const nn=inp.value.trim(); if(!nn||nn===key) return;
          templates[nn]={...templates[key],name:nn}; delete templates[key];
          ADVISORS.forEach(a=>DAYS.forEach(d=>{ if(rotas[a][d]===key) rotas[a][d]=nn; }));
          populateTemplateEditor(); populateAssignTable(); save(); renderCalendar();
        } else { templates[key][f]=inp.value; save(); renderCalendar(); }
      });
    });
    row.querySelector('[data-act="del"]').onclick=()=>{ delete templates[key]; populateTemplateEditor(); populateAssignTable(); save(); renderCalendar(); };
  });
}

/* ========= ASSIGNMENT TABLE ========= */
function populateAssignTable(){
  const head=$('#dateHeaders'), body=$('#assignTable tbody');
  head.innerHTML=DAYS.map(d=>`<th data-day="${d}">${d.slice(0,3)}<br><span class="muted" data-date></span></th>`).join('');
  const opts=Object.keys(templates).map(n=>`<option value="${n}">${n}</option>`).join('');
  body.innerHTML='';
  ADVISORS.forEach(a=>{
    const tr=document.createElement('tr'); const name=document.createElement('td'); name.className='name'; name.textContent=a; tr.appendChild(name);
    DAYS.forEach(d=>{
      const td=document.createElement('td'); const sel=document.createElement('select');
      sel.innerHTML=`<option value="">-- Day Off --</option>${opts}`;
      const val = (rotas[a] && typeof rotas[a][d]==='string') ? rotas[a][d] : '';
      sel.value = val;
      sel.onchange=()=>{ if(!rotas[a]) rotas[a]={}; rotas[a][d]=sel.value; save(); renderCalendar(); };
      td.appendChild(sel); tr.appendChild(td);
    });
    body.appendChild(tr);
  });
}

/* ========= ADVISOR SIDEBAR & DROPDOWN ========= */
function rebuildAdvisorUI(){
  $('#advisorSelect').innerHTML = `<option value="__TEAM__">Team (All)</option>` + ADVISORS.map(a=>`<option>${a}</option>`).join('');
  const list=$('#advisorList'); list.innerHTML='';
  ADVISORS.forEach(a=>{
    const div=document.createElement('div'); div.className='pill';
    div.innerHTML=`<span>${a}</span><div><button class="btn subtle icon" data-a="${a}">‚úé</button> <button class="btn subtle icon" data-r="${a}">üóëÔ∏è</button></div>`;
    list.appendChild(div);
  });
  $$('#advisorList [data-r]').forEach(b=>b.onclick=()=>{ const name=b.dataset.r; if(!confirm(`Remove ${name}?`)) return; ADVISORS=ADVISORS.filter(x=>x!==name); delete rotas[name]; rebuildAdvisorUI(); populateAssignTable(); save(); renderCalendar(); });
  $$('#advisorList [data-a]').forEach(b=>b.onclick=()=>{ const old=b.dataset.a; const nn=prompt('Rename advisor', old); if(!nn||nn===old) return; const i=ADVISORS.indexOf(old); ADVISORS[i]=nn; rotas[nn]=rotas[old]||{}; delete rotas[old]; rebuildAdvisorUI(); populateAssignTable(); save(); renderCalendar(); });
}

/* ========= HOUR GRID ========= */
function hoursHTML(){ let h=''; for(let i=START;i<=END;i++){ h+=`<div class="hour"><span>${pad(i)}:00</span></div>`; } return h; }

/* ========= TEMPLATE EXPANSION ========= */
function processTemplate(t){
  if(!t||!t.Start||!t.Finish) return [];
  const s=toMin(t.Start), e=toMin(t.Finish); if(e<=s) return [];
  const ev=[{t:s,type:'start'},{t:e,type:'end'}];
  [['Break1',15,'Break'],['Lunch',45,'Lunch'],['Break2',15,'Break']].forEach(([k,d,label])=>{ if(t[k]) ev.push({t:toMin(t[k]),type:'pause',d,label}); });
  ev.sort((a,b)=>a.t-b.t||((a.type==='end')-(b.type==='end')));
  const out=[]; let cur=s; const main=t.Platform||'Emails';
  for(const evi of ev){ if(evi.t>cur) out.push({name:main,start:cur,end:evi.t});
    if(evi.type==='pause'){ out.push({name:evi.label,start:evi.t,end:evi.t+evi.d}); cur=evi.t+evi.d; } }
  return out;
}
function colorClass(name){
  const k=(name||'').toLowerCase();
  if(k.includes('email')) return 'c-emails';
  if(k.includes('mirakl')) return 'c-mirakl';
  if(k.includes('social')) return 'c-social';
  if(k.includes('meeting')||k.includes('coach')) return 'c-meeting';
  if(k.includes('break')) return 'c-break';
  if(k.includes('lunch')) return 'c-lunch';
  if(k.includes('overtime')) return 'c-overtime';
  return 'c-emails';
}

/* ========= SEGMENTS ========= */
function dayHasSegments(v){ return v && typeof v==='object' && Array.isArray(v.segments); }
function processDayValue(dayValue, templateMap){
  if(dayHasSegments(dayValue)){
    return dayValue.segments
      .filter(s=>s.activity && s.start && s.end)
      .map(s=>({name:s.activity,start:toMin(s.start),end:toMin(s.end)}))
      .filter(b=>b.end>b.start)
      .sort((a,b)=>a.start-b.start);
  }
  if(typeof dayValue==='string' && templateMap[dayValue]) return processTemplate(templateMap[dayValue]);
  return [];
}

/* Convert to editable segments */
function toEditableSegments(dayValue){
  if(dayHasSegments(dayValue)) return JSON.parse(JSON.stringify(dayValue.segments));
  if(typeof dayValue==='string' && templates[dayValue]){
    const blocks=processTemplate(templates[dayValue]);
    return blocks.map(b=>({activity:b.name, start:m2t(b.start), end:m2t(b.end)}));
  }
  return [];
}

/* Merge adjacent same-activity segments */
function mergeAdjacent(segs){
  const s=[...segs].sort((a,b)=>toMin(a.start)-toMin(b.start));
  const out=[];
  for(const x of s){
    if(!out.length){ out.push({...x}); continue; }
    const p=out[out.length-1];
    if(p.activity===x.activity && toMin(p.end)===toMin(x.start)){ p.end=x.end; }
    else out.push({...x});
  }
  return out;
}

/* Insert an overlay sub-range */
function insertOverlay(segments, newSeg){
  const ns = { activity:newSeg.activity, start:toMin(newSeg.start), end:toMin(newSeg.end) };
  if(!(ns.activity && ns.start!=null && ns.end!=null && ns.end>ns.start)) return segments;

  const out=[];
  for(const s of segments){
    const a=toMin(s.start), b=toMin(s.end);
    if(b<=ns.start || a>=ns.end){ out.push({...s}); continue; }
    if(a<ns.start){ out.push({activity:s.activity,start:m2t(a),end:m2t(ns.start)}); }
    if(b>ns.end){ out.push({activity:s.activity,start:m2t(ns.end),end:m2t(b)}); }
  }
  out.push({activity:ns.activity,start:m2t(ns.start),end:m2t(ns.end)});
  return mergeAdjacent(out);
}

/* ========= RENDERERS ========= */
function updateRangeLabel(){
  const ws=$('#weekStart').value; const adv=$('#advisorSelect').value;
  if(!ws){ $('#rangeLabel').textContent=''; return; }
  const s=new Date(ws+'T00:00:00'); const e=new Date(s); e.setDate(e.getDate()+6);
  const f=d=>d.toLocaleDateString('en-GB',{day:'2-digit',month:'2-digit',year:'numeric'});
  if(adv==='__TEAM__'){
    const idx=DAYS.indexOf($('#teamDay').value||'Monday'); const d=new Date(s); d.setDate(d.getDate()+idx);
    $('#rangeLabel').textContent=d.toLocaleDateString('en-GB',{weekday:'long',day:'2-digit',month:'2-digit',year:'numeric'});
    $('#calTitle').textContent='Team (All) ‚Äì Single Day';
  } else {
    $('#rangeLabel').textContent=`${f(s)} ‚Äì ${f(e)}`;
    $('#calTitle').textContent='Advisor Week (Calendar)';
  }
  $$('#dateHeaders [data-date]').forEach((span,i)=>{ const d=new Date(s); d.setDate(d.getDate()+i); span.textContent=d.toLocaleDateString('en-GB',{month:'short',day:'numeric'}); });
}

function renderCalendar(){
  resetGrid();
  document.getElementById('hours').innerHTML=hoursHTML();

  const advVal=$('#advisorSelect').value||ADVISORS[0];
  if(advVal==='__TEAM__'){ renderTeamDayCalendar(); return; }

  const grid=$('#calGrid'); const ws=$('#weekStart').value; const s=ws?new Date(ws+'T00:00:00'):null; const adv=advVal;

  DAYS.forEach((day,idx)=>{
    const col=document.createElement('div'); col.className='day-col';
    let month='‚Äî', num=''; if(s){ const d=new Date(s); d.setDate(d.getDate()+idx); month=d.toLocaleDateString('en-GB',{month:'long'}); num=d.getDate(); }
    col.insertAdjacentHTML('beforeend',`<div class="day-head"><small>${month}</small>${day}<span style="float:right">${num}</span></div>`);

    const dayVal = rotas[adv]?.[day];
    if(dayHasSegments(dayVal)){
      const totalMins = processDayValue(dayVal, templates).reduce((acc,b)=>acc+(b.end-b.start),0);
      col.insertAdjacentHTML('beforeend',`<div class="day-summary"><span class="badge">Split</span> custom segments<span class="summary-right">${(totalMins/60).toFixed(1)}h</span></div>`);
    } else {
      const tplName = typeof dayVal==='string' ? dayVal : '';
      const tpl=templates[tplName];
      if(!tplName){ col.insertAdjacentHTML('beforeend',`<div class="off">Roster Day Off</div>`); }
      else { col.insertAdjacentHTML('beforeend',`<div class="day-summary"><span class="badge">${tplName}</span> ${tpl.Start} ‚Äì ${tpl.Finish}<span class="summary-right">${((toMin(tpl.Finish)-toMin(tpl.Start))/60)}h</span></div>`); }
    }

    col.insertAdjacentHTML('beforeend',`<div class="day-actions"><button class="iconbtn" data-day="${day}">Ôºã</button><button class="iconbtn" data-day="${day}" data-edit>‚úé</button></div>`);
    const cell=document.createElement('div'); cell.className='timeline-cell';

    const blocks = processDayValue(dayVal, templates);
    blocks.forEach(b=>{
      const top=(b.start-START*60)*PX_PER_MIN; const h=(b.end-b.start)*PX_PER_MIN;
      const el=document.createElement('div'); el.className=`block ${colorClass(b.name)}`;
      el.style.top=top+'px'; el.style.height=Math.max(16,h)+'px';
      el.innerHTML=`${b.name}<span class="time">${m2t(b.start)} ‚Äì ${m2t(b.end)}</span>`;
      el.dataset.day = day;
      el.dataset.adv = adv;
      el.dataset.start = m2t(b.start);
      el.dataset.end = m2t(b.end);
      el.dataset.activity = b.name;
      el.addEventListener('click', onBlockClick);
      cell.appendChild(el);
    });

    col.appendChild(cell); grid.appendChild(col);
  });
  $$('.day-actions .iconbtn').forEach(b=>b.onclick=()=>openAssign(b.dataset.day));
}

function renderTeamDayCalendar(){
  resetGrid();
  document.getElementById('hours').innerHTML=hoursHTML();

  const grid=$('#calGrid'); const ws=$('#weekStart').value; const day=$('#teamDay').value||'Monday';
  const cols=1+ADVISORS.length; const head=document.createElement('div'); head.className='day-head'; head.style.gridColumn=`1 / span ${cols}`; head.style.height='56px';
  if(ws){ const s=new Date(ws); const idx=DAYS.indexOf(day); s.setDate(s.getDate()+idx); head.innerHTML=`<small>${s.toLocaleDateString('en-GB',{month:'long'})}</small>${day}<span style="float:right">${s.getDate()}</span>`; }
  grid.appendChild(head);

  const hourCol=document.createElement('div'); hourCol.className='hour-col'; hourCol.innerHTML=hoursHTML(); grid.appendChild(hourCol);

  ADVISORS.forEach(adv=>{
    const col=document.createElement('div'); col.className='day-col';
    col.insertAdjacentHTML('beforeend',`<div class="day-head" style="height:56px">${adv}</div>`);

    const dayVal = rotas[adv]?.[day];
    if(dayHasSegments(dayVal)){
      const totalMins = processDayValue(dayVal, templates).reduce((acc,b)=>acc+(b.end-b.start),0);
      col.insertAdjacentHTML('beforeend',`<div class="day-summary"><span class="badge">Split</span> custom segments<span class="summary-right">${(totalMins/60).toFixed(1)}h</span></div>`);
    } else {
      const tplName = typeof dayVal==='string' ? dayVal : '';
      const tpl=templates[tplName];
      if(!tplName){ col.insertAdjacentHTML('beforeend',`<div class="off">Roster Day Off</div>`); }
      else { col.insertAdjacentHTML('beforeend',`<div class="day-summary"><span class="badge">${tplName}</span> ${tpl.Start} ‚Äì ${tpl.Finish}<span class="summary-right">${((toMin(tpl.Finish)-toMin(tpl.Start))/60)}h</span></div>`); }
    }

    col.insertAdjacentHTML('beforeend',`<div class="day-actions"><button class="iconbtn" data-day="${day}" data-adv="${adv}">Ôºã</button><button class="iconbtn" data-day="${day}" data-adv="${adv}" data-edit>‚úé</button></div>`);
    const cell=document.createElement('div'); cell.className='timeline-cell';

    const blocks = processDayValue(dayVal, templates);
    blocks.forEach(b=>{
      const top=(b.start-START*60)*PX_PER_MIN; const h=(b.end-b.start)*PX_PER_MIN;
      const el=document.createElement('div'); el.className=`block ${colorClass(b.name)}`;
      el.style.top=top+'px'; el.style.height=Math.max(16,h)+'px';
      el.innerHTML=`${b.name}<span class="time">${m2t(b.start)} ‚Äì ${m2t(b.end)}</span>`;
      el.dataset.day = day;
      el.dataset.adv = adv;
      el.dataset.start = m2t(b.start);
      el.dataset.end = m2t(b.end);
      el.dataset.activity = b.name;
      el.addEventListener('click', onBlockClick);
      cell.appendChild(el);
    });

    col.appendChild(cell); grid.appendChild(col);
  });
  $$('.day-actions .iconbtn').forEach(b=>b.onclick=()=>openAssign(b.dataset.day, b.dataset.adv));
}

/* ========= ASSIGN / SPLIT DIALOG ========= */
const assignDlg=$('#assignDlg'), assignSelect=$('#assignSelect'), assignTitle=$('#assignTitle');
const modeTemplate=$('#modeTemplate'), modeSplit=$('#modeSplit'), modeHint=$('#modeHint');
const templateMode=$('#templateMode'), splitMode=$('#splitMode');
const segmentsWrap=$('#segmentsWrap');

const ACTS=['Emails','Mirakl','Social','Meeting','Overtime','Break','Lunch'];

function segmentRowHTML(s, idx){
  const opts = ACTS.map(a=>`<option ${s.activity===a?'selected':''}>${a}</option>`).join('');
  return `<div class="row" data-i="${idx}">
    <select class="seg-act">${opts}</select>
    <input type="time" class="seg-start" value="${s.start||''}">
    <span>‚Äì</span>
    <input type="time" class="seg-end" value="${s.end||''}">
    <button class="del">Delete</button>
  </div>`;
}
function loadSegmentsUI(arr){
  if(!arr || !Array.isArray(arr)) arr=[];
  segmentsWrap.innerHTML = arr.length ? arr.map((s,i)=>segmentRowHTML(s,i)).join('') : '<div class="muted">No segments yet. Add one.</div>';
  $$('#segmentsWrap .row .del').forEach(btn=>{
    btn.onclick=()=>{
      const i=+btn.parentElement.dataset.i;
      const rows=$$('#segmentsWrap .row');
      rows[i].remove();
      $$('#segmentsWrap .row').forEach((r,ix)=>r.dataset.i=ix);
      if($$('#segmentsWrap .row').length===0) segmentsWrap.innerHTML='<div class="muted">No segments yet. Add one.</div>';
      refreshOverlayBlockOptions();
    };
  });
  $$('#segmentsWrap .seg-start, #segmentsWrap .seg-end, #segmentsWrap .seg-act').forEach(inp=>{
    inp.addEventListener('input',()=>refreshOverlayBlockOptions());
    inp.addEventListener('change',()=>refreshOverlayBlockOptions());
  });
  refreshOverlayBlockOptions();
}
function readSegmentsUI(){
  const rows=$$('#segmentsWrap .row');
  const list=rows.map(r=>{
    return {
      activity:r.querySelector('.seg-act').value,
      start:r.querySelector('.seg-start').value,
      end:r.querySelector('.seg-end').value
    };
  }).filter(s=>s.activity && s.start && s.end && toMin(s.end)>toMin(s.start));
  list.sort((a,b)=>toMin(a.start)-toMin(b.start));
  for(let i=1;i<list.length;i++){
    if(toMin(list[i].start)<toMin(list[i-1].end)){
      alert('Segments overlap. Please adjust times.'); return null;
    }
  }
  return list;
}

/* Pick-block list for overlay */
function refreshOverlayBlockOptions(){
  const sel = document.getElementById('ovBlock');
  if(!sel) return;
  const rows=$$('#segmentsWrap .row');
  const blocks = rows.map(r=>{
    const act=r.querySelector('.seg-act').value;
    const s=r.querySelector('.seg-start').value;
    const e=r.querySelector('.seg-end').value;
    return (act && s && e && toMin(e)>toMin(s)) ? {act,s,e} : null;
  }).filter(Boolean);
  if(blocks.length===0){
    sel.innerHTML = `<option value="">(no valid blocks yet)</option>`;
    return;
  }
  sel.innerHTML = blocks.map((b,i)=>`<option value="${i}">${b.act} ‚Äî ${b.s}‚Äì${b.e}</option>`).join('');
  sel.onchange = ()=>{
    const i = +sel.value;
    if(Number.isInteger(i) && blocks[i]){
      document.getElementById('ovStart').value = blocks[i].s;
      document.getElementById('ovEnd').value   = blocks[i].e;
    }
  };
}

/* Overlay helper */
function wireOverlayButtons(){
  document.getElementById('btnInsertOverlay').onclick=()=>{
    const act=document.getElementById('ovActivity').value,
          s=document.getElementById('ovStart').value,
          e=document.getElementById('ovEnd').value;
    if(!s || !e || toMin(e)<=toMin(s)){ alert('Please enter a valid time range.'); return; }
    const cur=readSegmentsUI(); if(!cur) return;
    const updated=insertOverlay(cur, {activity:act,start:s,end:e});
    loadSegmentsUI(updated);
  };
}

function openAssign(day, advisor){
  const adv = advisor || ($('#advisorSelect').value==='__TEAM__' ? ADVISORS[0] : $('#advisorSelect').value);
  assignTitle.textContent=`${day} for ${adv}`;
  modeHint.textContent='';

  assignSelect.innerHTML=`<option value="">‚Äî Day Off ‚Äî</option>`+Object.keys(templates).map(n=>`<option>${n}</option>`).join('');
  const current = rotas[adv]?.[day];

  if(dayHasSegments(current)){
    modeSplit.checked=true; modeTemplate.checked=false;
    templateMode.style.display='none'; splitMode.style.display='block';
    loadSegmentsUI(current.segments);
    wireOverlayButtons();
  } else {
    modeTemplate.checked=true; modeSplit.checked=false;
    templateMode.style.display='block'; splitMode.style.display='none';
    assignSelect.value = (typeof current==='string')? current : '';
    const tplName = assignSelect.value;
    if(tplName) modeHint.textContent=`Current: ${tplName}. Use ‚ÄúConvert to editable segments‚Äù to tweak a small part.`;
  }

  document.getElementById('btnConvertToSplit').onclick=()=>{
    const tplName = assignSelect.value;
    if(!tplName){ alert('Choose a template first.'); return; }
    const segs = toEditableSegments(tplName);
    modeSplit.checked=true; modeTemplate.checked=false;
    templateMode.style.display='none'; splitMode.style.display='block';
    loadSegmentsUI(segs);
    wireOverlayButtons();
  };

  document.getElementById('addSegment').onclick=()=>{
    const wrap=document.getElementById('segmentsWrap');
    const mut=wrap.querySelector('.muted'); if(mut) mut.remove();
    const idx=$$('#segmentsWrap .row').length;
    const div=document.createElement('div'); div.className='row'; div.dataset.i=idx;
    div.innerHTML=`
      <select class="seg-act">${ACTS.map(a=>`<option>${a}</option>`).join('')}</select>
      <input type="time" class="seg-start" value="08:00">
      <span>‚Äì</span>
      <input type="time" class="seg-end" value="12:00">
      <button class="del">Delete</button>`;
    wrap.appendChild(div);
    div.querySelector('.del').onclick=()=>{ div.remove(); if($$('#segmentsWrap .row').length===0) segmentsWrap.innerHTML='<div class="muted">No segments yet. Add one.</div>'; refreshOverlayBlockOptions(); };
    ['input','change'].forEach(evt=>{
      div.querySelector('.seg-start').addEventListener(evt,refreshOverlayBlockOptions);
      div.querySelector('.seg-end').addEventListener(evt,refreshOverlayBlockOptions);
      div.querySelector('.seg-act').addEventListener(evt,refreshOverlayBlockOptions);
    });
    refreshOverlayBlockOptions();
  };

  modeTemplate.onchange = modeSplit.onchange = ()=>{
    const tmpl = modeTemplate.checked;
    templateMode.style.display = tmpl ? 'block':'none';
    splitMode.style.display = tmpl ? 'none':'block';
    if(!tmpl){
      if($$('#segmentsWrap .row').length===0){
        const baseSegs = toEditableSegments(current || assignSelect.value);
        loadSegmentsUI(baseSegs);
        wireOverlayButtons();
      }
    }
  };

  document.getElementById('assignOK').onclick=()=>{
    if(!rotas[adv]) rotas[adv]={};
    if(modeTemplate.checked){
      rotas[adv][day] = assignSelect.value;
    } else {
      const segs=readSegmentsUI(); if(!segs) return;
      rotas[adv][day] = { segments: segs };
    }
    save(); assignDlg.close(); renderCalendar(); populateAssignTable();
  };

  assignDlg.showModal();
}

/* ========= CLICK-A-BLOCK EDITOR ========= */
const blockDlg = $('#blockDlg');
const bmWhole = $('#bmWhole'), bmSub = $('#bmSub');
const blockWhole = $('#blockWhole'), blockSub = $('#blockSub');
const bwActivity=$('#bwActivity'), bwStart=$('#bwStart'), bwEnd=$('#bwEnd');
const bsActivity=$('#bsActivity'), bsStart=$('#bsStart'), bsEnd=$('#bsEnd');
let currentBlockCtx = null; // {adv, day, origActivity, origStart, origEnd}

function onBlockClick(e){
  const el = e.currentTarget;
  const adv = el.dataset.adv;
  const day = el.dataset.day;
  const origActivity = el.dataset.activity;
  const origStart = el.dataset.start; // "HH:MM"
  const origEnd   = el.dataset.end;

  // Ensure the day is in editable segments (auto-convert from template if needed)
  const dayVal = rotas[adv]?.[day];
  if(!dayHasSegments(dayVal)){
    // convert current display (template expansion) into segments
    const segs = toEditableSegments(dayVal || '');
    if(!rotas[adv]) rotas[adv] = {};
    rotas[adv][day] = { segments: segs };
    save();
  }

  currentBlockCtx = {adv, day, origActivity, origStart, origEnd};
  $('#blockTitle').textContent = `Edit ${day} for ${adv}`;
  $('#blockHint').textContent = `Block: ${origActivity} ${origStart}‚Äì${origEnd}`;

  // Default mode: Change part of block (most common)
  bmSub.checked = true; bmWhole.checked = false;
  blockSub.style.display='block'; blockWhole.style.display='none';

  // Prefill both UIs with original values
  ;[bwActivity,bwStart,bwEnd].forEach(()=>{});
  bwActivity.value = ACTS.includes(origActivity)? origActivity : 'Emails';
  bwStart.value = origStart; bwEnd.value = origEnd;

  bsActivity.value = ACTS.includes(origActivity)? origActivity : 'Emails';
  bsStart.value = origStart; bsEnd.value = origEnd;

  // Toggle handlers
  bmWhole.onchange = bmSub.onchange = ()=>{
    const whole = bmWhole.checked;
    blockWhole.style.display = whole ? 'block' : 'none';
    blockSub.style.display   = whole ? 'none'  : 'block';
  };

  // Save action
  $('#blockOK').onclick = ()=>{
    const {adv, day, origActivity, origStart, origEnd} = currentBlockCtx;
    const segs = (rotas[adv][day] && rotas[adv][day].segments) ? JSON.parse(JSON.stringify(rotas[adv][day].segments)) : [];
    const oS = toMin(origStart), oE = toMin(origEnd);

    // find the segment that exactly matches the clicked block
    const idx = segs.findIndex(s=>s.activity===origActivity && s.start===origStart && s.end===origEnd);
    if(idx===-1){ alert('Could not find block to edit.'); return; }

    if(bmWhole.checked){
      // Edit whole block inside original boundaries
      const a = bwActivity.value, s = bwStart.value, e = bwEnd.value;
      if(!s || !e || toMin(e)<=toMin(s)){ alert('Enter a valid time range.'); return; }
      if(toMin(s)<oS || toMin(e)>oE){ alert('You cannot extend beyond the original block.'); return; }

      const leftNeeded  = toMin(s)>oS;
      const rightNeeded = toMin(e)<oE;
      const originals = [...segs];
      originals.splice(idx,1); // remove original

      if(leftNeeded) originals.splice(idx,0,{activity:origActivity,start:m2t(oS),end:s});
      originals.splice(idx+(leftNeeded?1:0),0,{activity:a,start:s,end:e}); // insert edited
      if(rightNeeded) originals.splice(idx+(leftNeeded?1:0)+1,0,{activity:origActivity,start:e,end:m2t(oE)});

      rotas[adv][day] = { segments: mergeAdjacent(originals) };
      save(); blockDlg.close(); renderCalendar(); populateAssignTable();
      return;
    } else {
      // Change part of block: overlay a subrange (must be within original)
      const a = bsActivity.value, s = bsStart.value, e = bsEnd.value;
      if(!s || !e || toMin(e)<=toMin(s)){ alert('Enter a valid sub-range.'); return; }
      if(toMin(s)<oS || toMin(e)>oE){ alert('Sub-range must be inside the original block.'); return; }

      // perform a targeted split on that original block:
      // replace the original segment at idx by left remainder + new + right remainder
      const originals = [...segs];
      originals.splice(idx,1); // remove original
      if(toMin(s)>oS) originals.splice(idx,0,{activity:origActivity,start:m2t(oS),end:s});
      originals.splice(idx+(toMin(s)>oS?1:0),0,{activity:a,start:s,end:e});
      if(toMin(e)<oE) originals.splice(idx+(toMin(s)>oS?1:0)+1,0,{activity:origActivity,start:e,end:m2t(oE)});

      rotas[adv][day] = { segments: mergeAdjacent(originals) };
      save(); blockDlg.close(); renderCalendar(); populateAssignTable();
      return;
    }
  };

  blockDlg.showModal();
}

/* ========= DATE HELPERS ========= */
function setToMonday(d){ const day=d.getDay(); const diff=(day===0?-6:1)-day; d.setDate(d.getDate()+diff); return d; }

/* ========= WIRE ========= */
function wire(){
  $('#btnPrint').onclick=()=>window.print();
  $('#btnGenerate').onclick=()=>{ updateRangeLabel(); renderCalendar(); };
  $('#btnToday').onclick=()=>{ const t=setToMonday(new Date()); $('#weekStart').value=t.toISOString().slice(0,10); updateRangeLabel(); renderCalendar(); };
  $('#prevWeek').onclick=()=>{ const d=new Date($('#weekStart').value||new Date()); d.setDate(d.getDate()-7); $('#weekStart').value=d.toISOString().slice(0,10); updateRangeLabel(); renderCalendar(); };
  $('#nextWeek').onclick=()=>{ const d=new Date($('#weekStart').value||new Date()); d.setDate(d.getDate()+7); $('#weekStart').value=d.toISOString().slice(0,10); updateRangeLabel(); renderCalendar(); };

  $('#btnSave').onclick=()=>{ const blob=new Blob([JSON.stringify({advisors:ADVISORS,templates,rotas,weekStart:$('#weekStart').value},null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='rota.json'; a.click(); };
  $('#btnLoad').onclick=()=>$('#file').click();
  $('#file').addEventListener('change',e=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=ev=>{ try{ const d=JSON.parse(ev.target.result); ADVISORS=d.advisors||ADVISORS; templates=d.templates||templates; rotas=d.rotas||rotas; if(d.weekStart) $('#weekStart').value=d.weekStart; rebuildAdvisorUI(); populateTemplateEditor(); populateAssignTable(); save(); updateRangeLabel(); renderCalendar(); }catch{ alert('Invalid JSON'); } }; r.readAsText(f); });

  $('#btnReset').onclick=()=>{ if(!confirm('Clear all local data?')) return; localStorage.removeItem(STORAGE); location.reload(); };

  $('#btnAddTemplate').onclick=()=>{ const name='Shift'+(Object.keys(templates).length+1); templates[name]={name,Start:'',Finish:'',Break1:'',Lunch:'',Break2:'',Platform:'Emails'}; populateTemplateEditor(); save(); };
  $('#btnLoadDefaults').onclick=()=>{ seedDefaults(); populateTemplateEditor(); populateAssignTable(); save(); renderCalendar(); };

  $('#addAdvisor').onclick=()=>{ const n=$('#newAdvisor').value.trim(); if(!n) return; if(ADVISORS.includes(n)) return alert('Advisor exists'); ADVISORS.push(n); rotas[n]={}; DAYS.forEach(d=>rotas[n][d]=''); $('#newAdvisor').value=''; rebuildAdvisorUI(); populateAssignTable(); save(); renderCalendar(); };

  $('#advisorSelect').addEventListener('change',()=>{
    const team=$('#advisorSelect').value==='__TEAM__';
    $('#lblTeamDay').style.display= team ? 'inline' : 'none';
    $('#teamDay').style.display= team ? 'inline' : 'none';
    updateRangeLabel(); renderCalendar();
  });
  $('#teamDay').addEventListener('change',()=>{ updateRangeLabel(); renderCalendar(); });

  $('#weekStart').onchange=()=>{ updateRangeLabel(); renderCalendar(); };
}

/* ========= INIT ========= */
(function init(){
  buildColorKey(); load(); if(Object.keys(templates).length===0) seedDefaults();
  rebuildAdvisorUI(); populateTemplateEditor(); populateAssignTable();
  if(!$('#weekStart').value){ const t=setToMonday(new Date()); $('#weekStart').value=t.toISOString().slice(0,10); }
  updateRangeLabel();
  document.getElementById('hours').innerHTML=hoursHTML();
  wire(); renderCalendar();
})();
</script>
</body>
</html>
