<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Professional Team Rota System — Supabase</title>
<style>
  :root{
    --brand:#0d47a1; --accent:#00c853; --ink:#1f2937; --paper:#ffffff; --wash:#f5f7fb; --line:#e4e9f2;
    --timeline-start:7; --timeline-end:20; --timeline-height:800px;
    --color-email:#2ecc71; --color-mirakl:#b1b51e; --color-social:#5e35b1;
    --color-overtime:#e53935; --color-meeting:#ffd700; --color-break:#cfd8dc; --color-lunch:#b0bec5;
    --color-absence:#b0c4de; --color-shrink:#ffd166;
  }
  html,body{height:100%}
  body{margin:0;background:#eef2f6;color:var(--ink);font-family:Inter,Roboto,Segoe UI,system-ui,Arial,Helvetica,sans-serif}
  .topbar{background:var(--brand);color:#fff;padding:14px 18px;display:flex;align-items:center;gap:14px;box-shadow:0 4px 14px rgba(13,71,161,.18)}
  .topbar h1{margin:0;font-size:18px;font-weight:800}
  .layout{display:grid;grid-template-columns:1fr 360px;gap:18px;max-width:1500px;margin:18px auto;padding:0 16px}
  .panel{background:var(--paper);border:1px solid var(--line);border-radius:12px;box-shadow:0 8px 20px rgba(12,27,74,.06)}
  .panel-header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid var(--line)}
  .panel-header h2{margin:0;font-size:15px}
  .panel-body{padding:12px 14px}
  .muted{color:#64748b}
  .btn{background:var(--accent);color:#fff;border:0;border-radius:10px;padding:9px 12px;font-weight:800;cursor:pointer}
  .btn:hover{filter:brightness(.95)}
  .btn.subtle{background:#e9eef6;color:#0f172a}
  .btn.icon{padding:7px 9px}
  .seg{display:inline-flex;border:1px solid var(--line);border-radius:10px;overflow:hidden}
  .seg button{background:#fff;border:0;padding:8px 12px;cursor:pointer}
  .seg button.active{background:#1e5fe0;color:#fff}
  .input, select, input[type=date]{padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#fff}
  .collapsible[open] .chev{transform:rotate(90deg)} .chev{transition:transform .2s}

  /* Template editor */
  .template-row{display:grid;grid-template-columns:140px 1fr 140px 1fr;gap:10px 14px;align-items:center;padding:12px;border:1px solid var(--line);border-radius:10px;background:#fafcff;margin-bottom:10px}
  .template-row .full{grid-column:1/-1}
  .inline{display:flex;gap:8px;flex-wrap:wrap}
  .danger{background:#dc3545;color:#fff;border:0;border-radius:8px;padding:6px 10px;cursor:pointer}

  .key-row{display:grid;grid-template-columns:18px 120px 1fr;gap:8px;align-items:center;margin-bottom:8px}
  .swatch{width:18px;height:18px;border-radius:3px;border:1px solid var(--line)}

  .table-wrap{overflow:auto}
  table{width:100%;border-collapse:collapse;min-width:900px}
  th,td{border:1px solid var(--line);padding:8px;text-align:center}
  thead th{background:#0d47a1;color:#fff;font-weight:800}
  td.name{position:sticky;left:0;background:#e8f1ff;font-weight:800}

  /* Calendar */
  .calendar{border-top:1px solid var(--line)}
  .cal-grid{display:grid;grid-template-columns:80px repeat(7,1fr);grid-auto-flow:column;overflow:auto}
  .hour-col{border-right:1px solid var(--line);background:#fafcfe}
  .hour{height:calc(var(--timeline-height)/(var(--timeline-end)-var(--timeline-start)));border-bottom:1px solid var(--line);font-size:12px;color:#748099;text-align:right;padding-right:6px;position:relative;box-sizing:border-box}
  .hour span{position:absolute;top:-7px;right:6px;background:#fafcfe;padding:0 4px}

  .day-col{border-left:1px solid var(--line)}
  .day-head{height:56px;border-bottom:1px solid var(--line);display:flex;flex-direction:column;justify-content:center;padding:6px 10px;background:#f6f8fb;font-weight:800}
  .day-head small{font-weight:700;color:#8792a6}
  .day-summary{display:flex;align-items:center;gap:8px;padding:6px 10px;border-bottom:1px solid var(--line)}
  .summary-right{margin-left:auto;color:#5b6b7f;font-size:12px}
  .day-actions{display:flex;gap:6px;border-bottom:1px solid var(--line);padding:6px 10px}
  .iconbtn{border:1px solid var(--line);background:#fff;border-radius:6px;padding:6px 8px;cursor:pointer}
  .off{height:40px;border-bottom:1px solid var(--line);padding:8px 10px;background:repeating-linear-gradient(45deg,#f2f3f7,#f2f3f7 8px,#e8ecf4 8px,#e8ecf4 16px);font-weight:800;color:#8892a0}
  .timeline-cell{position:relative;height:var(--timeline-height);background:
    linear-gradient(#0000,#0000),
    repeating-linear-gradient(180deg,#0000,#0000 calc(100%/(var(--timeline-end) - var(--timeline-start))), var(--line) 0, var(--line) calc(100%/(var(--timeline-end) - var(--timeline-start)) + 1px));}
  .block{position:absolute;left:10px;right:10px;border-radius:6px;padding:3px 6px;font-size:11px;font-weight:800;color:#fff;box-shadow:0 1px 3px rgba(0,0,0,.12);line-height:1.1;cursor:pointer;display:flex;justify-content:space-between;gap:6px;align-items:flex-start}
  .block .time{display:block;font-weight:700;font-size:10px;opacity:.95}

  .c-email{background:var(--color-email)}
  .c-mirakl{background:var(--color-mirakl)}
  .c-social{background:var(--color-social)}
  .c-break{background:var(--color-break);color:#213}
  .c-lunch{background:var(--color-lunch);color:#213}
  .c-overtime{background:var(--color-overtime)}
  .c-absence{background:var(--color-absence)}
  .c-shrink{background:var(--color-shrink);color:#213}

  @media print{.no-print{display:none} .panel{box-shadow:none}}

  /* Dialogs */
  .row{display:flex;gap:8px;align-items:center;margin:6px 0}
  .row .del{background:#ffe2e2;color:#b42318;border:1px solid #f2b8b5;border-radius:6px;padding:4px 8px;cursor:pointer}
  dialog{max-width:780px;width:95%}

  /* Schedules tree (right sidebar) */
  .tree-search{display:flex;gap:8px;margin-bottom:8px}
  .tree{max-height:70vh;overflow:auto;border:1px solid var(--line);border-radius:10px;padding:6px;background:#fff}
  .tree details{padding:3px 4px;border-radius:6px}
  .tree summary{list-style:none;cursor:pointer;font-weight:800;display:flex;align-items:center;gap:6px}
  .tree summary .twisty{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border:1px solid var(--line);border-radius:4px;background:#f5f7fb;font-weight:900}
  .tree summary::-webkit-details-marker{display:none}
  .tree .node{display:flex;gap:6px;align-items:center;padding:2px 2px}
  .chip{display:inline-flex;align-items:center;gap:6px;background:#eef2ff;border:1px solid #d6dcff;border-radius:999px;padding:3px 8px;font-size:12px}
  .node-actions button{border:1px solid var(--line);background:#fff;border-radius:6px;padding:3px 6px;cursor:pointer;font-size:11px}

  /* Planner styles */
  .planner {
    border: 1px solid var(--line);
    border-radius: 12px;
    overflow: hidden;
  }
  .planner__header {
    display: flex;
    background: #f6f8fb;
    border-bottom: 1px solid var(--line);
    position: sticky;
    top: 0;
    z-index: 2;
  }
  .planner__name-col {
    width: var(--name-w, 260px);
    min-width: var(--name-w, 260px);
    padding: 7px 10px;
    font-weight: 800;
    border-right: 1px solid var(--line);
  }
  .planner__hours {
    flex: 1;
    display: grid;
    grid-template-columns: repeat(14, 1fr);
  }
  .planner__hour {
    padding: 6px 0;
    border-left: 1px solid var(--line);
    font-size: 12px;
    color: #68758a;
    text-align: center;
  }
  .planner__body {
    display: flex;
    flex-direction: column;
  }
  .planner__row {
    display: flex;
    border-bottom: 1px solid var(--line);
    position: relative;
    height: 44px;
  }
  .planner__row:last-child { border-bottom: 0; }
  .planner__row:nth-child(odd) { background: #fbfdff; }
  .planner__name {
    width: var(--name-w, 260px);
    min-width: var(--name-w, 260px);
    padding: 8px 10px;
    border-right: 1px solid var(--line);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .planner__timeline {
    position: relative;
    flex: 1;
    height: 44px;
    background: linear-gradient(#f6f8fb 1px, transparent 1px) 0 0 / 60px 44px;
  }
  .planner__bar {
    position: absolute;
    height: 20px;
    top: 12px;
    border-radius: 3px;
    z-index: 3;
    opacity: 0.95;
    cursor: pointer;
    transition: opacity 0.15s;
  }
  .planner__bar:hover { opacity: 1; }
  .planner__guide {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 1px;
    background: rgba(0,0,0,.2);
    pointer-events: none;
    z-index: 10;
  }
  .planner__tooltip {
    position: fixed;
    pointer-events: none;
    z-index: 50;
    padding: 6px 8px;
    background: #111827;
    color: #fff;
    border-radius: 6px;
    font-size: 12px;
    transform: translate(-50%, -120%);
    white-space: nowrap;
  }

  /* Enhanced planner styles */
  .planner{margin-top:16px;border:1px solid var(--line,#e6e6f4);border-radius:8px;background:#fff}
  .planner__header,.planner__row{display:grid;grid-template-columns:240px 1fr;align-items:center}
  .planner__header{position:sticky;top:0;background:#f8fafc;z-index:2;padding:8px;border-bottom:1px solid var(--line,#e6e6f4)}
  .planner__col--name{font-weight:600;padding-left:8px}
  .planner__body{position:relative;overflow:auto;max-height:64vh}
  .planner__row{height:44px;border-bottom:1px solid #f0f2f7}
  .planner__name{display:flex;align-items:center;gap:8px;padding:0 8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .planner__badge{font-size:12px;line-height:18px;padding:0 6px;border-radius:6px;background:#eef2f7;color:#374151}
  .time-scale{position:relative;height:24px}
  .time-scale .tick{position:absolute;top:0;font-size:11px;transform:translateX(-50%);color:#6b7280}
  .grid{position:relative;height:100%}
  .grid .vline{position:absolute;top:0;bottom:0;width:1px;background:#e8ebf2}
  .grid .guide{position:absolute;top:0;bottom:0;width:1px;background:#4fa3ff;opacity:.8;pointer-events:none;z-index:3}
  .bar{position:absolute;top:8px;height:28px;border-radius:6px;opacity:.95;cursor:pointer}
  .bar.is-work{background:var(--work,#6b8e23)}
  .bar.is-lunch{background:var(--lunch,#bfe9ff)}
  .bar.is-break{background:var(--break,#dfe5ee)}
  .bar.is-meeting{background:var(--meeting,#ffd54d)}
  .bar:hover{outline:2px solid rgba(0,0,0,.08)}
  .tooltip{position:absolute;background:#111827;color:#fff;font-size:12px;padding:6px 8px;border-radius:6px;white-space:pre;transform:translate(-50%,-110%);pointer-events:none;z-index:4}

  /* Hide old palette panel */
  .colours-card,.palette,.color-panel{display:none!important}

</style>

<!-- Supabase client library -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="topbar">
    <h1>Professional Team Rota System</h1>
    <div class="seg" style="margin-left:auto">
      <button class="active" id="segWeek">Week</button>
      <button id="segMonth" disabled class="muted">Month</button>
    </div>
    <button class="btn subtle no-print" id="btnPrint">🖨️ Print</button>
  </div>

  <div class="layout">
    <!-- Main column -->
    <div style="display:flex;flex-direction:column;gap:18px">
      <!-- Controls -->
      <div class="panel">
        <div class="panel-body" style="display:flex;flex-wrap:wrap;gap:10px 12px;align-items:center">
          <label>Week start (Monday)</label>
          <input type="date" id="weekStart" class="input"/>
          <label>View</label>
          <select id="advisorSelect" class="input"></select>
          <label id="lblTeamDay" class="muted" style="display:none">Day</label>
          <select id="teamDay" class="input" style="display:none">
            <option>Monday</option><option>Tuesday</option><option>Wednesday</option><option>Thursday</option>
            <option>Friday</option><option>Saturday</option><option>Sunday</option>
          </select>
          <button class="btn" id="btnGenerate">Generate</button>
          <button class="btn subtle" id="btnPublish">Publish</button>
          <span class="muted" id="rangeLabel" style="margin-left:auto"></span>
        </div>
      </div>

      <!-- Collapsible Settings / Templates / Assignment -->
      <details class="panel collapsible no-print" id="settingsBox" open>
        <summary class="panel-header" style="cursor:pointer">
          <h2>Settings / Templates</h2><span class="chev">▶</span>
        </summary>
        <div class="panel-body">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:18px;align-items:start">
            <div>
              <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
                <button class="btn subtle" id="btnAddTemplate">➕ Add Template</button>
                <button class="btn subtle" id="btnLoadDefaults">↺ Load Sample Templates</button>
              </div>
              <div id="templateEditor"></div>
            </div>
            <div>
              <h3 style="margin:6px 0">🎨 Colours</h3>
              <div id="colorKey"></div>
              <div style="display:flex;gap:8px;margin-top:8px">
                <button class="btn subtle" id="btnSave">💾 Save JSON</button>
                <input type="file" id="file" accept=".json" style="display:none"/>
                <button class="btn subtle" id="btnLoad">📂 Load JSON</button>
                <button class="btn danger" id="btnReset">🧹 Clear (local cache)</button>
              </div>
            </div>
          </div>

          <div style="margin-top:16px">
            <h3 style="margin:6px 0">📅 Master Assignment (Team)</h3>
            <div class="table-wrap">
              <table id="assignTable">
                <thead>
                  <tr><th rowspan="2">Advisor</th><th colspan="7">Select Shift Template</th></tr>
                  <tr id="dateHeaders"></tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div class="muted" style="margin-top:8px">
              Blank until you select a Team Leader or advisors in the <strong>Schedules</strong> panel.
            </div>
          </div>
        </div>
      </details>

      <!-- Team Planner -->
      <section id="teamPlanner" class="planner">
        <div class="planner__header">
          <div class="planner__col--name">Name</div>
          <div class="planner__col--time" id="timeHeader"></div>
        </div>
        <div class="planner__body" id="plannerBody"></div>
      </section>

      <!-- Calendar -->
      <div class="panel">
        <div class="panel-header"><h2 id="calTitle">Advisor Week (Calendar)</h2>
          <div style="display:flex;gap:6px;align-items:center">
            <button class="btn subtle icon" id="prevWeek">◀</button>
            <button class="btn subtle icon" id="btnToday">Today</button>
            <button class="btn subtle icon" id="nextWeek">▶</button>
          </div>
        </div>
        <div class="panel-body calendar">
          <div class="cal-grid" id="calGrid">
            <div class="hour-col"><div id="hours"></div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right sidebar: Schedules -->
    <div class="panel">
      <div class="panel-header"><h2>Schedules</h2></div>
      <div class="panel-body">
        <div class="tree-search">
          <input id="treeSearch" class="input" placeholder="Select sites / leaders / advisors…" style="flex:1"/>
          <button class="btn subtle" id="btnClearSel">Clear</button>
        </div>
        <div class="tree" id="tree"></div>
        <div style="margin-top:10px;display:flex;flex-wrap:wrap;gap:6px" id="activeChips"></div>
      </div>
    </div>
  </div>


  <!-- Publish confirmation dialog -->
  <dialog id="publishDlg" style="border:1px solid var(--line);border-radius:12px;padding:12px 14px;">
    <div style="font-weight:800;margin-bottom:6px">Publish changes</div>
    <div class="muted" id="publishSummary" style="margin-bottom:8px"></div>
    <div id="publishList" style="max-height:260px;overflow:auto;border:1px solid var(--line);border-radius:10px;padding:8px;background:#fff"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:14px">
      <button id="publishOK" class="btn">Publish</button>
      <button onclick="publishDlg.close()" class="btn subtle">Cancel</button>
    </div>
  </dialog>


  <!-- Assign / Split dialog -->
  <dialog id="assignDlg" style="border:1px solid var(--line);border-radius:12px;padding:12px 14px;">
    <div style="font-weight:800;margin-bottom:6px"><span id="assignTitle">Assign</span></div>
    <div class="row"><label><input type="radio" name="mode" value="template" id="modeTemplate"> Use template</label>
      <label><input type="radio" name="mode" value="split" id="modeSplit"> Use split segments</label>
      <span class="muted" id="modeHint" style="margin-left:6px"></span>
    </div>
    <div id="templateMode">
      <select id="assignSelect" style="width:100%"></select>
      <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
        <button class="btn subtle" id="btnConvertToSplit">Convert this template to editable segments</button>
        <span class="muted">Fast way to tweak just part of the shift.</span>
      </div>
    </div>
    <div id="splitMode" style="display:none">
      <div id="segmentsWrap"></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn subtle" id="addSegment">＋ Add segment</button>
        <span class="muted">Each segment = Code + Start–End.</span>
      </div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:14px">
      <button id="assignOK" class="btn">Save</button>
      <button onclick="assignDlg.close()" class="btn subtle">Cancel</button>
    </div>
  </dialog>

  <!-- Click-a-block Editor -->
  <dialog id="blockDlg" style="border:1px solid var(--line);border-radius:12px;padding:12px 14px;">
    <div style="font-weight:800;margin-bottom:6px"><span id="blockTitle">Edit block</span></div>
    <div class="row"><label><input type="radio" name="blockmode" value="whole" id="bmWhole"> Edit block</label>
      <label><input type="radio" name="blockmode" value="sub" id="bmSub"> Change part of block</label>
      <span class="muted" id="blockHint" style="margin-left:6px"></span></div>
    <div id="blockWhole">
      <div class="row"><label style="min-width:90px">Code</label><select id="bwCode"></select></div>
      <div class="row"><label style="min-width:90px">Start–End</label><input type="time" id="bwStart"> <span>–</span> <input type="time" id="bwEnd"></div>
      <div class="muted">If you shrink the block, we keep the before/after so no gaps appear.</div>
    </div>
    <div id="blockSub" style="display:none">
      <div class="row"><label style="min-width:90px">New code</label><select id="bsCode"></select></div>
      <div class="row"><label style="min-width:90px">Sub-range</label><input type="time" id="bsStart"> <span>–</span> <input type="time" id="bsEnd"></div>
      <div class="muted">We split into left remainder + your new code + right remainder. Neighbours stay the same.</div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:14px">
      <button id="blockOK" class="btn">Save</button>
      <button onclick="blockDlg.close()" class="btn subtle">Cancel</button>
    </div>
  </dialog>

  <script>
/* =========================
   Supabase configuration
   ========================= */
const SUPABASE_URL = "https://oypdnjxhjpgpwmkltzmk.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95cGRuanhoanBncHdta2x0em1rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4Nzk0MTEsImV4cCI6MjA3NTQ1NTQxMX0.Hqf1L4RHpIPUD4ut2uVsiGDsqKXvAjdwKuotmme4_Is";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ===== App State ===== */
const DAYS=['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
let ORG = { sites:{} };
let TEMPLATES = {};
let ADVISORS_LIST = [];
let ADVISOR_BY_NAME = new Map();
let ADVISOR_BY_ID = new Map();
let ROTAS = new Map();
let selectedAdvisors = new Set();

/* ===== Helpers ===== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const pad=n=>String(n).padStart(2,'0');
const fmt=(t)=>t?t.slice(0,5):''; // HH:MM from HH:MM:SS
function setToMonday(d){ const day=d.getDay(); const diff=(day===0?-6:1)-day; d.setDate(d.getDate()+diff); return d; }
function toMin(t){ if(!t) return null; const [h,m]=t.split(':').map(Number); return h*60+m; }
function m2t(m){ return `${pad(Math.floor(m/60))}:${pad(m%60)}`; }

const css=getComputedStyle(document.documentElement);
const START=+css.getPropertyValue('--timeline-start')||7;
const END=+css.getPropertyValue('--timeline-end')||20;
const HEIGHT=+css.getPropertyValue('--timeline-height').replace('px','')||800;
const PX_PER_MIN = HEIGHT/((END-START)*60);

/* Add planner time helpers */
const DAY_START=6*60,DAY_END=20*60;
function m2hmm(m){const h=Math.floor(m/60),mm=String(m%60).padStart(2,'0');return`${h}:${mm}`;}
function spanPct(s,e){const span=DAY_END-DAY_START;return{
  left: Math.max(0,(s-DAY_START)/span*100),
  width: Math.max(0,Math.min(100,(e-s)/span*100))
};}
function renderTimeHeader(el){
  if(!el) return; el.innerHTML='';
  const w=document.createElement('div'); w.className='time-scale';
  for(let m=DAY_START;m<=DAY_END;m+=60){
    const t=document.createElement('div'); t.className='tick';
    t.style.left=`${((m-DAY_START)/(DAY_END-DAY_START))*100}%`;
    t.textContent=m2hmm(m);
    w.appendChild(t);
  }
  el.appendChild(w);
}

/* ===== Horizontal planner: build rows from current state + render ===== */
function _plannerNames() {
  const teamMode = ($('#advisorSelect').value === '__TEAM_SELECTED__' || $('#advisorSelect').value === '__TEAM_ALL__');
  if (teamMode) {
    const all = $('#advisorSelect').value === '__TEAM_ALL__';
    return all ? ADVISORS_LIST.map(a => a.name) : [...selectedAdvisors];
  }
  const v = $('#advisorSelect').value || '';
  if (v.startsWith && v.startsWith('advisor::')) {
    const id = v.split('::')[1];
    return [ADVISOR_BY_ID.get(id) || ''];
  }
  return v ? [v] : [...selectedAdvisors];
}

function _codeType(code) {
  const k = (code || '').toLowerCase();
  if (/\blunch\b/.test(k))   return {type:'lunch',   cls:'is-lunch'};
  if (/\bbreak\b/.test(k))   return {type:'break',   cls:'is-break'};
  if (/\bmeeting\b/.test(k)) return {type:'meeting', cls:'is-meeting'};
  return {type:'work', cls:'is-work'};
}

function buildPlannerRowsFromState() {
  const ws   = $('#weekStart').value;
  const day  = $('#teamDay').value || 'Monday';
  const list = _plannerNames().filter(Boolean).sort((a,b)=>a.localeCompare(b));
  const rows = [];

  list.forEach(name => {
    const id   = ADVISOR_BY_NAME.get(name);
    if (!id) return;
    const key  = `${id}::${ws}`;
    const data = ROTAS.get(key) || {};
    const blocks = processDayValue(data[day]); // -> [{label,start(min),end(min)}]

    const segments = blocks.map(b => {
      const m = _codeType(b.label);
      return { type: m.type, code: b.label, start: b.start, end: b.end };
    });

    rows.push({ name, badge:'', segments });
  });

  return rows;
}

function renderPlanner(rows) {
  console.log('renderPlanner rows=', Array.isArray(rows) ? rows.length : rows);
  const body = document.getElementById('plannerBody');
  if (!body) return;

  if (!rows || !rows.length) {
    body.innerHTML = '<div class="muted" style="padding:10px">Nothing to render for current selection.</div>';
    return;
  }

  const hdr = document.getElementById('timeHeader');
  if (hdr) { hdr.innerHTML = ''; renderTimeHeader(hdr); }

  body.innerHTML = '';
  rows.forEach(row => {
    const wrap = document.createElement('div');
    wrap.className = 'planner__row';

    const nameCell = document.createElement('div');
    nameCell.className = 'planner__name';
    nameCell.innerHTML = row.badge ? `<span class="planner__badge">${row.badge}</span> ${row.name}` : row.name;

    const tl = document.createElement('div');
    tl.className = 'planner__timeline';

    (row.segments || []).forEach(seg => {
      const span = DAY_END - DAY_START;
      const left = Math.max(0, (seg.start - DAY_START*60) / (span*60) * 100);
      const width = Math.max(0, Math.min(100, (seg.end - seg.start) / (span*60) * 100));
      if (width <= 0) return;

      const bar = document.createElement('div');
      bar.className = `bar planner__bar ${seg.type ? 'is-' + seg.type : ''}`;
      bar.style.left  = `${left}%`;
      bar.style.width = `${width}%`;
      bar.title = `${seg.code} ${m2t(seg.start)}–${m2t(seg.end)}`;

      bar.addEventListener('click', () => {
        const ev = {
          currentTarget: {
            dataset: {
              adv: row.name,
              day: ($('#teamDay').value || 'Monday'),
              code: seg.code,
              start: m2t(seg.start),
              end:   m2t(seg.end)
            }
          }
        };
        onBlockClick(ev);
      });

      tl.appendChild(bar);
    });

    wrap.appendChild(nameCell);
    wrap.appendChild(tl);
    body.appendChild(wrap);
  });
}
  /* ===== Wire buttons ===== */
  function wire(){
    // Publish button
    $('#btnPublish').onclick = openPublishDialog;
    $('#btnPrint').onclick=()=>window.print();
    $('#btnGenerate').onclick=()=>{ updateRangeLabel(); renderCalendar(); };
    $('#btnToday').onclick=()=>{ const t=setToMonday(new Date()); $('#weekStart').value=t.toISOString().slice(0,10); updateRangeLabel(); fetchRotasForWeek($('#weekStart').value).then(()=>{ renderCalendar(); populateAssignTable(); }); };
    $('#prevWeek').onclick=()=>{ const d=new Date($('#weekStart').value||new Date()); d.setDate(d.getDate()-7); $('#weekStart').value=d.toISOString().slice(0,10); updateRangeLabel(); fetchRotasForWeek($('#weekStart').value).then(()=>{ renderCalendar(); populateAssignTable(); }); };
    $('#nextWeek').onclick=()=>{ const d=new Date($('#weekStart').value||new Date()); d.setDate(d.getDate()+7); $('#weekStart').value=d.toISOString().slice(0,10); updateRangeLabel(); fetchRotasForWeek($('#weekStart').value).then(()=>{ renderCalendar(); populateAssignTable(); }); };

    $('#btnSave').onclick=()=>{ 
      const exportObj = { org:ORG, templates:TEMPLATES, weekStart:$('#weekStart').value };
      const blob=new Blob([JSON.stringify(exportObj,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='rota-export.json'; a.click();
    };
    $('#btnLoad').onclick=()=>$('#file').click();
    $('#file').addEventListener('change',async e=>{
      const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=async ev=>{
        try{
          const data=JSON.parse(ev.target.result);
          alert('Loaded JSON. This importer restores Templates locally; manage Sites/Leaders/Advisors in the Schedules panel.');
          if(data.templates){
            for(const t of Object.values(data.templates)){
              await sb.from('templates').upsert({
                name:t.name, work_code:t.work_code||'Admin',
                start_time:t.start_time||null, finish_time:t.finish_time||null,
                break1:t.break1||null, lunch:t.lunch||null, break2:t.break2||null
              }, { onConflict:'name' });
            }
          }
        }catch{ alert('Invalid JSON'); }
      }; r.readAsText(f);
    });

    $('#btnReset').onclick=()=>{ if(!confirm('Clear only local cache (does not delete Supabase data)?')) return; ROTAS.clear(); sessionStorage.clear(); localStorage.clear(); location.reload(); };

    // NEW: View change logic (supports leader picks)
    $('#advisorSelect').addEventListener('change', ()=>{ 
      const v = $('#advisorSelect').value;

      if(v.startsWith && v.startsWith('leader::')){
        const leaderId = v.split('::')[1];
        const names = getLeaderTeamNames(leaderId);
        selectedAdvisors = new Set(names);
        refreshChips();
        populateAssignTable();
        $('#advisorSelect').value = '__TEAM_SELECTED__'; // switch to Team view
      }

      updateViewSelector();
      updateRangeLabel();
      renderCalendar();
    });

    $('#teamDay').addEventListener('change',()=>{ updateRangeLabel(); renderCalendar(); });
    $('#weekStart').onchange=()=>{ updateRangeLabel(); fetchRotasForWeek($('#weekStart').value).then(()=>{ renderCalendar(); populateAssignTable(); }); };

    $('#treeSearch').addEventListener('input',rebuildTree);
    $('#btnClearSel').onclick=()=>{ selectedAdvisors.clear(); rebuildTree(); refreshChips(); populateAssignTable(); renderCalendar(); };
  }

  /* ===== Realtime ===== */
  function subscribeRealtime(){
    sb.channel('any-changes')
      .on('postgres_changes', { event:'*', schema:'public', table:'sites' },   ()=> loadOrg().then(()=>{ rebuildTree(); rebuildAdvisorDropdown(); }))
      .on('postgres_changes', { event:'*', schema:'public', table:'leaders' }, ()=> loadOrg().then(()=>{ rebuildTree(); rebuildAdvisorDropdown(); }))
      .on('postgres_changes', { event:'*', schema:'public', table:'advisors'}, ()=> loadOrg().then(()=>{ rebuildTree(); rebuildAdvisorDropdown(); }))
      .on('postgres_changes', { event:'*', schema:'public', table:'templates'},()=> loadTemplates().then(()=>{ populateTemplateEditor(); renderCalendar(); }))
      .on('postgres_changes', { event:'*', schema:'public', table:'rotas' },   ()=>{ 
        const ws=$('#weekStart').value; fetchRotasForWeek(ws).then(()=>{ renderCalendar(); populateAssignTable(); });
      })
      .subscribe();
  }

  /* ===== INIT ===== */
  (async function init(){
    buildColorKey();
    const t=setToMonday(new Date()); $('#weekStart').value=t.toISOString().slice(0,10);
    setHours();
    try{
      await loadOrg();
      await loadTemplates();
      await fetchRotasForWeek($('#weekStart').value);
    } catch(e){ console.warn(e); alert('Error loading initial data: '+e.message); }
    rebuildAdvisorDropdown();
    rebuildTree();
    refreshChips();
    populateTemplateEditor();
    populateAssignTable();
    updateRangeLabel();
    renderCalendar();
    wire();
    subscribeRealtime();
    // Publish dialog actions
    $('#publishOK').onclick = doPublish;
})();

/* Generate button + initial header render */
(function () {
  const btn = document.getElementById('btnGenerate');

  if (btn) {
    btn.addEventListener('click', async () => {
      $('#btnGenerate').onclick = async () => {
        try {
          const rows = buildPlannerRowsFromState();
          if (!rows || !rows.length) {
            showInfo?.('Nothing to render for selected filter');
            const c = document.getElementById('plannerBody');
            if (c) c.innerHTML = '';
            return;
          }
          renderPlanner(rows);
          showInfo?.('Schedule generated.');
        } catch (err) {
          showError?.(`Generate failed: ${err?.message ?? err}`);
          console.error(err);
        }
      };
    });
  }
  renderTimeHeader?.(document.getElementById('timeHeader'));
})();
</script>
</body>
</html>