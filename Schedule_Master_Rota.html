<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Professional Team Rota System</title>
<style>
  :root{
    --brand:#0d47a1; --accent:#00c853; --ink:#1f2937; --paper:#ffffff; --wash:#f5f7fb; --line:#e4e9f2;
    --timeline-start:7; --timeline-end:20; --timeline-height:800px;
    --color-email:#2ecc71; --color-mirakl:#b1b51e; --color-social:#5e35b1;
    --color-overtime:#e53935; --color-meeting:#ffd700; --color-break:#cfd8dc; --color-lunch:#b0bec5;
    --color-absence:#b0c4de; --color-shrink:#ffd166;
  }
  html,body{height:100%}
  body{margin:0;background:#eef2f6;color:var(--ink);font-family:Inter,Roboto,Segoe UI,system-ui,Arial,Helvetica,sans-serif}
  .topbar{background:var(--brand);color:#fff;padding:14px 18px;display:flex;align-items:center;gap:14px;box-shadow:0 4px 14px rgba(13,71,161,.18)}
  .topbar h1{margin:0;font-size:18px;font-weight:800}
  .layout{display:grid;grid-template-columns:1fr 360px;gap:18px;max-width:1500px;margin:18px auto;padding:0 16px}
  .panel{background:var(--paper);border:1px solid var(--line);border-radius:12px;box-shadow:0 8px 20px rgba(12,27,74,.06)}
  .panel-header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid var(--line)}
  .panel-header h2{margin:0;font-size:15px}
  .panel-body{padding:12px 14px}
  .muted{color:#64748b}
  .btn{background:var(--accent);color:#fff;border:0;border-radius:10px;padding:9px 12px;font-weight:800;cursor:pointer}
  .btn:hover{filter:brightness(.95)}
  .btn.subtle{background:#e9eef6;color:#0f172a}
  .btn.icon{padding:7px 9px}
  .seg{display:inline-flex;border:1px solid var(--line);border-radius:10px;overflow:hidden}
  .seg button{background:#fff;border:0;padding:8px 12px;cursor:pointer}
  .seg button.active{background:#1e5fe0;color:#fff}
  .input, select, input[type=date]{padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#fff}
  .collapsible[open] .chev{transform:rotate(90deg)} .chev{transition:transform .2s}

  /* Template editor ‚Äì realigned grid */
  .template-row{
    display:grid;
    grid-template-columns:140px 1fr 140px 1fr;
    gap:10px 14px;
    align-items:center;
    padding:12px;
    border:1px solid var(--line);
    border-radius:10px;
    background:#fafcff;
    margin-bottom:10px
  }
  .template-row .full{grid-column:1/-1}
  .inline{display:flex;gap:8px;flex-wrap:wrap}
  .danger{background:#dc3545;color:#fff;border:0;border-radius:8px;padding:6px 10px;cursor:pointer}
  .key-row{display:grid;grid-template-columns:18px 120px 1fr;gap:8px;align-items:center;margin-bottom:8px}
  .swatch{width:18px;height:18px;border-radius:3px;border:1px solid var(--line)}
  .table-wrap{overflow:auto}
  table{width:100%;border-collapse:collapse;min-width:900px}
  th,td{border:1px solid var(--line);padding:8px;text-align:center}
  thead th{background:#0d47a1;color:#fff;font-weight:800}
  td.name{position:sticky;left:0;background:#e8f1ff;font-weight:800}

  /* Calendar */
  .calendar{border-top:1px solid var(--line)}
  .cal-grid{display:grid;grid-template-columns:80px repeat(7,1fr);grid-auto-flow:column;overflow:auto}
  .hour-col{border-right:1px solid var(--line);background:#fafcfe}
  .hour{height:calc(var(--timeline-height)/(var(--timeline-end)-var(--timeline-start)));border-bottom:1px solid var(--line);font-size:12px;color:#748099;text-align:right;padding-right:6px;position:relative;box-sizing:border-box}
  .hour span{position:absolute;top:-7px;right:6px;background:#fafcfe;padding:0 4px}
  .day-col{border-left:1px solid var(--line)}
  .day-head{height:56px;border-bottom:1px solid var(--line);display:flex;flex-direction:column;justify-content:center;padding:6px 10px;background:#f6f8fb;font-weight:800}
  .day-head small{font-weight:700;color:#8792a6}
  .day-summary{display:flex;align-items:center;gap:8px;padding:6px 10px;border-bottom:1px solid var(--line)}
  .summary-right{margin-left:auto;color:#5b6b7f;font-size:12px}
  .day-actions{display:flex;gap:6px;border-bottom:1px solid var(--line);padding:6px 10px}
  .iconbtn{border:1px solid var(--line);background:#fff;border-radius:6px;padding:6px 8px;cursor:pointer}
  .off{height:40px;border-bottom:1px solid var(--line);padding:8px 10px;background:repeating-linear-gradient(45deg,#f2f3f7,#f2f3f7 8px,#e8ecf4 8px,#e8ecf4 16px);font-weight:800;color:#8892a0}
  .timeline-cell{position:relative;height:var(--timeline-height);background:
    linear-gradient(#0000,#0000),
    repeating-linear-gradient(180deg,#0000,#0000 calc(100%/(var(--timeline-end) - var(--timeline-start))), var(--line) 0, var(--line) calc(100%/(var(--timeline-end) - var(--timeline-start)) + 1px));}
  .block{position:absolute;left:10px;right:10px;border-radius:6px;padding:3px 6px;font-size:11px;font-weight:800;color:#fff;box-shadow:0 1px 3px rgba(0,0,0,.12);line-height:1.1;cursor:pointer;display:flex;justify-content:space-between;gap:6px;align-items:flex-start}
  .block .time{display:block;font-weight:700;font-size:10px;opacity:.95}

  /* Colour families by code */
  .c-email{background:var(--color-email)}
  .c-mirakl{background:var(--color-mirakl)}
  .c-social{background:var(--color-social)}
  .c-break{background:var(--color-break);color:#213}
  .c-lunch{background:var(--color-lunch);color:#213}
  .c-overtime{background:var(--color-overtime)}
  .c-absence{background:var(--color-absence)}
  .c-shrink{background:var(--color-shrink);color:#213}

  @media print{.no-print{display:none} .panel{box-shadow:none}}

  /* Dialogs */
  .row{display:flex;gap:8px;align-items:center;margin:6px 0}
  .row .del{background:#ffe2e2;color:#b42318;border:1px solid #f2b8b5;border-radius:6px;padding:4px 8px;cursor:pointer}
  .modebar{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  .overlaybar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:8px 0;padding:8px;border:1px dashed var(--line);border-radius:8px;background:#f9fbff}

  dialog{max-width:780px;width:95%}

  /* Schedules tree (right sidebar) */
  .tree-search{display:flex;gap:8px;margin-bottom:8px}
  .tree{max-height:70vh;overflow:auto;border:1px solid var(--line);border-radius:10px;padding:6px;background:#fff}
  .tree details{padding:3px 4px;border-radius:6px}
  .tree summary{list-style:none;cursor:pointer;font-weight:800}
  .tree summary::-webkit-details-marker{display:none}
  .tree .node{display:flex;gap:6px;align-items:center;padding:2px 2px}
  .chip{display:inline-flex;align-items:center;gap:6px;background:#eef2ff;border:1px solid #d6dcff;border-radius:999px;padding:3px 8px;font-size:12px}
  .node-actions button{border:1px solid var(--line);background:#fff;border-radius:6px;padding:3px 6px;cursor:pointer;font-size:11px}
</style>
</head>
<body>
  <div class="topbar">
    <h1>Professional Team Rota System</h1>
    <div class="seg" style="margin-left:auto">
      <button class="active" id="segWeek">Week</button>
      <button id="segMonth" disabled class="muted">Month</button>
    </div>
    <button class="btn subtle no-print" id="btnPrint">üñ®Ô∏è Print</button>
  </div>

  <div class="layout">
    <!-- Main column -->
    <div style="display:flex;flex-direction:column;gap:18px">
      <!-- Rota controls -->
      <div class="panel">
        <div class="panel-body" style="display:flex;flex-wrap:wrap;gap:10px 12px;align-items:center">
          <label>Week start (Monday)</label>
          <input type="date" id="weekStart" class="input"/>
          <label>View</label>
          <select id="advisorSelect" class="input"></select>
          <label id="lblTeamDay" class="muted" style="display:none">Day</label>
          <select id="teamDay" class="input" style="display:none">
            <option>Monday</option><option>Tuesday</option><option>Wednesday</option><option>Thursday</option>
            <option>Friday</option><option>Saturday</option><option>Sunday</option>
          </select>
          <button class="btn" id="btnGenerate">Generate</button>
          <span class="muted" id="rangeLabel" style="margin-left:auto"></span>
        </div>
      </div>

      <!-- Collapsible Settings / Templates / Assignment -->
      <details class="panel collapsible no-print" id="settingsBox" open>
        <summary class="panel-header" style="cursor:pointer">
          <h2>Settings / Templates</h2><span class="chev">‚ñ∂</span>
        </summary>
        <div class="panel-body">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:18px;align-items:start">
            <div>
              <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
                <button class="btn subtle" id="btnAddTemplate">‚ûï Add Template</button>
                <button class="btn subtle" id="btnLoadDefaults">‚Ü∫ Load Sample Templates</button>
              </div>
              <div id="templateEditor"></div>
            </div>
            <div>
              <h3 style="margin:6px 0">üé® Colours</h3>
              <div id="colorKey"></div>
              <div style="display:flex;gap:8px;margin-top:8px">
                <button class="btn subtle" id="btnSave">üíæ Save JSON</button>
                <input type="file" id="file" accept=".json" style="display:none"/>
                <button class="btn subtle" id="btnLoad">üìÇ Load JSON</button>
                <button class="btn danger" id="btnReset">üßπ Clear</button>
              </div>
            </div>
          </div>

          <div style="margin-top:16px">
            <h3 style="margin:6px 0">üìÖ Master Assignment (Team)</h3>
            <div class="table-wrap">
              <table id="assignTable">
                <thead>
                  <tr><th rowspan="2">Advisor</th><th colspan="7">Select Shift Template</th></tr>
                  <tr id="dateHeaders"></tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div class="muted" style="margin-top:8px">
              Blank until you select a Team Leader or advisors in the **Schedules** panel.
            </div>
          </div>
        </div>
      </details>

      <!-- Advisor Week Calendar or Team Day -->
      <div class="panel">
        <div class="panel-header"><h2 id="calTitle">Advisor Week (Calendar)</h2>
          <div style="display:flex;gap:6px;align-items:center">
            <button class="btn subtle icon" id="prevWeek">‚óÄ</button>
            <button class="btn subtle icon" id="btnToday">Today</button>
            <button class="btn subtle icon" id="nextWeek">‚ñ∂</button>
          </div>
        </div>
        <div class="panel-body calendar">
          <div class="cal-grid" id="calGrid">
            <div class="hour-col"><div id="hours"></div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right sidebar: Schedules tree -->
    <div class="panel">
      <div class="panel-header"><h2>Schedules</h2></div>
      <div class="panel-body">
        <div class="tree-search">
          <input id="treeSearch" class="input" placeholder="Select sites / leaders / advisors‚Ä¶" style="flex:1"/>
          <button class="btn subtle" id="btnClearSel">Clear</button>
        </div>
        <div class="tree" id="tree"></div>
        <div style="margin-top:10px;display:flex;flex-wrap:wrap;gap:6px" id="activeChips"></div>
      </div>
    </div>
  </div>

  <!-- Assign / Split dialog -->
  <dialog id="assignDlg" style="border:1px solid var(--line);border-radius:12px;padding:12px 14px;">
    <div style="font-weight:800;margin-bottom:6px">
      <span id="assignTitle">Assign</span>
    </div>

    <div class="modebar">
      <label><input type="radio" name="mode" value="template" id="modeTemplate"> Use template</label>
      <label><input type="radio" name="mode" value="split" id="modeSplit"> Use split segments</label>
      <span class="muted" id="modeHint" style="margin-left:6px"></span>
    </div>

    <div id="templateMode">
      <select id="assignSelect" style="width:100%"></select>
      <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
        <button class="btn subtle" id="btnConvertToSplit">Convert this template to editable segments</button>
        <span class="muted">Fast way to tweak just part of the shift.</span>
      </div>
    </div>

    <div id="splitMode" style="display:none">
      <div class="overlaybar">
        <strong>Pick block to split:</strong>
        <select id="ovBlock" style="min-width:220px"></select>
        <strong>Insert code:</strong>
        <select id="ovCode"></select>
        <input type="time" id="ovStart" value="13:00">
        <span>‚Äì</span>
        <input type="time" id="ovEnd" value="13:30">
        <button class="btn subtle" id="btnInsertOverlay">Insert</button>
      </div>

      <div id="segmentsWrap"></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn subtle" id="addSegment">Ôºã Add segment</button>
        <span class="muted">Each segment = Code + Start‚ÄìEnd.</span>
      </div>
    </div>

    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:14px">
      <button id="assignOK" class="btn">Save</button>
      <button onclick="assignDlg.close()" class="btn subtle">Cancel</button>
    </div>
  </dialog>

  <!-- Click-a-block Editor -->
  <dialog id="blockDlg" style="border:1px solid var(--line);border-radius:12px;padding:12px 14px;">
    <div style="font-weight:800;margin-bottom:6px">
      <span id="blockTitle">Edit block</span>
    </div>

    <div class="modebar">
      <label><input type="radio" name="blockmode" value="whole" id="bmWhole"> Edit block</label>
      <label><input type="radio" name="blockmode" value="sub" id="bmSub"> Change part of block</label>
      <span class="muted" id="blockHint" style="margin-left:6px"></span>
    </div>

    <div id="blockWhole">
      <div class="row">
        <label style="min-width:90px">Code</label>
        <select id="bwCode"></select>
      </div>
      <div class="row">
        <label style="min-width:90px">Start‚ÄìEnd</label>
        <input type="time" id="bwStart"> <span>‚Äì</span> <input type="time" id="bwEnd">
      </div>
      <div class="muted">You can‚Äôt extend beyond the original block. If you shrink it, we keep the before/after so no gaps appear.</div>
    </div>

    <div id="blockSub" style="display:none">
      <div class="row">
        <label style="min-width:90px">New code</label>
        <select id="bsCode"></select>
      </div>
      <div class="row">
        <label style="min-width:90px">Sub-range</label>
        <input type="time" id="bsStart"> <span>‚Äì</span> <input type="time" id="bsEnd">
      </div>
      <div class="muted">We split into left remainder + your new code + right remainder. Neighbours stay the same.</div>
    </div>

    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:14px">
      <button id="blockOK" class="btn">Save</button>
      <button onclick="blockDlg.close()" class="btn subtle">Cancel</button>
    </div>
  </dialog>

<script>
/* ========= DATA & CONSTANTS ========= */
const DAYS=['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
let ADVISORS=['Luke Pashley','Ameena Malik','Carrie-Ann Raw','Danielle Smith','Farwa Shaheen','Gemma Emmett','Laura Stockburn','Millie Walsh','Tunis Foley'];

/* Purpose codes */
const CODE_GROUPS = {
  "Activity":[
    "2nd Line","Admin","BH Email","BH Social","BH WhatsApp","DEB Email","DEB Social","DEB WhatsApp","Ebay",
    "KM Email","KM Social","KM WhatsApp","Mirakl","Mixing","PayPlus","PLT Email","PLT Social","PLT WhatsApp",
    "QA","Overtime"
  ],
  "Absence":[ "AL","Break","Lunch","Sick","Split Shift","RDO","Maternity","LTS" ],
  "Shrinkage":[ "121","ATL","Coaching","Huddle","ITI","Projects","Team Meeting","Training" ]
};
const ALL_CODES = Object.entries(CODE_GROUPS).flatMap(([grp,codes])=>codes.map(c=>({group:grp, code:c})));

/* Sites ‚Üí Leaders ‚Üí Advisors (seed per request) */
let org = { sites: {
  "Admin": {leaders:{}},
  "Boohoo": {leaders:{}},
  "Debenhams": {leaders:{"Stacey-Leigh Carter": []}},
  "Karen Millen": {leaders:{}},
  "PayPlus": {leaders:{}},
  "PLT": {leaders:{}},
  "Quality": {leaders:{}}
}};

/* Selected advisors for ‚ÄúTeam (Selected)‚Äù */
let selectedAdvisors = new Set();

/* Templates with WorkCode */
let templates={};
let rotas={};
const STORAGE='rota_v13_master_blank_leader_checkbox_workcode';

/* CSS timings */
const css=getComputedStyle(document.documentElement);
const START=+css.getPropertyValue('--timeline-start')||7;
const END=+css.getPropertyValue('--timeline-end')||20;
const HEIGHT=+css.getPropertyValue('--timeline-height').replace('px','')||800;
const PX_PER_MIN=HEIGHT/((END-START)*60);

const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const pad=n=>String(n).padStart(2,'0');
const toMin=t=>{ if(!t) return null; const [h,m]=t.split(':').map(Number); return h*60+m; };
const m2t=m=>`${pad(Math.floor(m/60))}:${pad(m%60)}`;

function save(){ localStorage.setItem(STORAGE, JSON.stringify({advisors:ADVISORS,templates,rotas,weekStart:$('#weekStart').value, org})); }
function load(){ try{ const d=JSON.parse(localStorage.getItem(STORAGE)||'null'); if(!d) return; ADVISORS=d.advisors||ADVISORS; templates=d.templates||templates; rotas=d.rotas||rotas; if(d.weekStart) $('#weekStart').value=d.weekStart; if(d.org) org=d.org; }catch{} }

/* ========= FIRST-RUN SEED ========= */
function ensureSeedHierarchy(){
  const s = org.sites || (org.sites={});
  if(!s["Debenhams"]) s["Debenhams"]={leaders:{"Stacey-Leigh Carter":[]}};
  if(!s["Debenhams"].leaders["Stacey-Leigh Carter"]) s["Debenhams"].leaders["Stacey-Leigh Carter"]=[];
  const team = s["Debenhams"].leaders["Stacey-Leigh Carter"];
  // Place existing advisors into Stacey‚Äôs team if not already present in any team
  ADVISORS.forEach(name=>{
    let found=false;
    Object.values(s).forEach(siteObj=>{
      Object.values(siteObj.leaders).forEach(arr=>{ if(arr.includes(name)) found=true; });
    });
    if(!found) team.push(name);
  });
}

/* ========= UI HELPERS ========= */
function resetGrid(){ $('#calGrid').innerHTML = '<div class="hour-col"><div id="hours"></div></div>'; }
function buildColorKey(){
  const defs=[['email','Email','--color-email'],['mirakl','Mirakl','--color-mirakl'],['social','Social','--color-social'],['overtime','Overtime','--color-overtime'],['break','Break','--color-break'],['lunch','Lunch','--color-lunch'],['absence','Absence','--color-absence'],['shrink','Shrinkage','--color-shrink']];
  const el=$('#colorKey');
  el.innerHTML = defs.map(([k,l,cssVar])=>{
    const v=getComputedStyle(document.documentElement).getPropertyValue(cssVar).trim();
    return `<div class="key-row"><span class="swatch" style="background:${v}"></span><strong>${l}</strong><input type="text" data-k="${cssVar}" value="${v}"></div>`;
  }).join('');
  $$('#colorKey input').forEach(inp=>inp.addEventListener('input',()=>{ document.documentElement.style.setProperty(inp.dataset.k, inp.value); save(); renderCalendar(); }));
}

/* ========= TEMPLATE SEED ========= */
function seedDefaults(){
  templates={
    'Early':  {name:'Early',  WorkCode:'DEB Email', Start:'07:00', Finish:'16:00', Break1:'09:15', Lunch:'12:00', Break2:'15:15'},
    'Middle': {name:'Middle', WorkCode:'Mirakl',    Start:'11:00', Finish:'20:00', Break1:'11:30', Lunch:'15:30', Break2:'17:45'},
    'Late':   {name:'Late',   WorkCode:'PLT Social',Start:'12:00', Finish:'21:00', Break1:'13:15', Lunch:'17:00', Break2:'19:15'}
  };
  ADVISORS.forEach(a=>{ if(!rotas[a]) rotas[a]={}; DAYS.forEach(d=>{ if(!(d in rotas[a])) rotas[a][d]=''; }); });
}

/* ========= TEMPLATE EDITOR ========= */
function codeSelectGroupedHTML(val=''){
  return Object.entries(CODE_GROUPS).map(([grp,codes])=>
    `<optgroup label="${grp}">${codes.map(c=>`<option ${val===c?'selected':''}>${c}</option>`).join('')}</optgroup>`
  ).join('');
}
function templateRow(t,key){
  return `<div class="template-row" data-k="${key}">
    <label>Name</label>
    <input data-f="name" type="text" value="${t.name}" style="width:140px">

    <label>New code</label>
    <select data-f="WorkCode">${codeSelectGroupedHTML(t.WorkCode||'Admin')}</select>

    <label>Start / Finish</label>
    <div class="inline">
      <input data-f="Start" type="time" value="${t.Start||''}" title="Start">
      <input data-f="Finish" type="time" value="${t.Finish||''}" title="Finish">
    </div>

    <label>Breaks</label>
    <div class="inline">
      <input data-f="Break1" type="time" value="${t.Break1||''}" title="Break 1 (15m)">
      <input data-f="Lunch"  type="time" value="${t.Lunch||''}"  title="Lunch (30m)">
      <input data-f="Break2" type="time" value="${t.Break2||''}" title="Break 2 (15m)">
    </div>

    <div class="full" style="display:flex;justify-content:flex-end">
      <button class="danger" data-act="del">Delete</button>
    </div>
  </div>`;
}
function populateTemplateEditor(){
  const ed=$('#templateEditor'); const keys=Object.keys(templates);
  ed.innerHTML = keys.length? keys.map(k=>templateRow(templates[k],k)).join('') : '<div class="muted">No templates. Add or load samples.</div>';
  $$('#templateEditor .template-row').forEach(row=>{
    const key=row.dataset.k;
    $$('input,select',row).forEach(inp=>{
      const f=inp.dataset.f; if(!f) return;
      inp.addEventListener('input',()=>{
        if(f==='name'){
          const nn=inp.value.trim(); if(!nn||nn===key) return;
          templates[nn]={...templates[key],name:nn}; delete templates[key];
          // update assignments referencing old name
          ADVISORS.forEach(a=>DAYS.forEach(d=>{ if(rotas[a][d]===key) rotas[a][d]=nn; }));
          populateTemplateEditor(); populateAssignTable(); save(); renderCalendar();
        } else { templates[key][f]=inp.value; save(); renderCalendar(); }
      });
    });
    row.querySelector('[data-act="del"]').onclick=()=>{ delete templates[key]; populateTemplateEditor(); populateAssignTable(); save(); renderCalendar(); };
  });
}

/* ========= ASSIGNMENT TABLE ========= */
function populateAssignTable(){
  const head=$('#dateHeaders'), body=$('#assignTable tbody');
  head.innerHTML=DAYS.map(d=>`<th data-day="${d}">${d.slice(0,3)}<br><span class="muted" data-date></span></th>`).join('');
  const opts=Object.keys(templates).map(n=>`<option value="${n}">${n}</option>`).join('');
  body.innerHTML='';
  // Blank unless advisors selected
  const list = selectedAdvisors.size ? ADVISORS.filter(a=>selectedAdvisors.has(a)) : [];
  if(list.length===0){
    body.innerHTML='<tr><td colspan="8" class="muted" style="text-align:left;padding:10px">Select a Team Leader (checkbox) or specific advisors in the <strong>Schedules</strong> panel to populate this table.</td></tr>';
    return;
  }
  list.forEach(a=>{
    const tr=document.createElement('tr');
    const name=document.createElement('td'); name.className='name'; name.textContent=a; tr.appendChild(name);
    DAYS.forEach(d=>{
      const td=document.createElement('td'); const sel=document.createElement('select');
      sel.innerHTML=`<option value="">-- Day Off --</option>${opts}`;
      const val = (rotas[a] && typeof rotas[a][d]==='string') ? rotas[a][d] : '';
      sel.value = val;
      sel.onchange=()=>{ if(!rotas[a]) rotas[a]={}; rotas[a][d]=sel.value; save(); renderCalendar(); };
      td.appendChild(sel); tr.appendChild(td);
    });
    body.appendChild(tr);
  });
}

/* ========= TREE (Sites ‚Üí Leaders ‚Üí Advisors) ========= */
function rebuildTree(){
  const t=$('#tree'); const q=$('#treeSearch').value.trim().toLowerCase();
  const contains=(str)=>!q||str.toLowerCase().includes(q);

  function advisorNode(name){
    const chk = selectedAdvisors.has(name) ? 'checked' : '';
    return `<div class="node">
      <input type="checkbox" data-adv="${name}" ${chk}/>
      <span>${name}</span>
      <div class="node-actions" style="margin-left:auto;display:flex;gap:6px">
        <button data-rename-adv="${name}">‚úé</button>
        <button data-remove-adv="${name}">üóë</button>
      </div>
    </div>`;
  }

  function leaderBlock(site, leader, arr){
    if(q && !contains(leader) && !arr.some(a=>contains(a))) return '';
    const allTeamSelected = arr.length>0 && arr.every(a=>selectedAdvisors.has(a));
    return `<details>
      <summary>
        <div class="node" style="width:100%">
          <label style="display:flex;align-items:center;gap:6px">
            <input type="checkbox" data-leader="${site}::${leader}" ${allTeamSelected?'checked':''}/>
            <span>üë§ ${leader}</span>
          </label>
          <div class="node-actions" style="margin-left:auto;display:flex;gap:6px">
            <button data-add-adv="${site}::${leader}">+ Advisor</button>
            <button data-rename-lead="${site}::${leader}">‚úé</button>
            <button data-remove-lead="${site}::${leader}">üóë</button>
          </div>
        </div>
      </summary>
      ${arr.map(advisorNode).join('')}
    </details>`;
  }

  function siteBlock(site,obj){
    const leaders=obj.leaders||{};
    const blocks = Object.entries(leaders).map(([leader,arr])=>leaderBlock(site,leader,arr||[])).filter(Boolean);
    if(q && !contains(site) && blocks.join('')==='') return '';
    return `<details open>
      <summary class="node"><strong>üìÅ ${site}</strong>
        <div class="node-actions" style="margin-left:auto;display:flex;gap:6px">
          <button data-add-lead="${site}">+ Leader</button>
          <button data-rename-site="${site}">‚úé</button>
          <button data-remove-site="${site}">üóë</button>
        </div>
      </summary>
      ${blocks.join('')}
    </details>`;
  }

  t.innerHTML = Object.entries(org.sites).map(([site,obj])=>siteBlock(site,obj)).filter(Boolean).join('') || '<div class="muted">No sites yet.</div>';

  // Leader checkbox (select/deselect entire team)
  $$('#tree [data-leader]').forEach(cb=>{
    cb.onchange=()=>{
      const [site,leader]=cb.dataset.leader.split('::');
      const team=(org.sites[site].leaders[leader]||[]);
      team.forEach(name=> cb.checked ? selectedAdvisors.add(name) : selectedAdvisors.delete(name));
      $('#advisorSelect').value='__TEAM_SELECTED__';
      refreshChips(); populateAssignTable(); updateRangeLabel(); renderCalendar(); save();
    };
  });

  // Wire advisor checkbox changes
  $$('#tree [data-adv]').forEach(ch=>{
    ch.onchange=()=>{ const n=ch.dataset.adv; ch.checked?selectedAdvisors.add(n):selectedAdvisors.delete(n); refreshChips(); populateAssignTable(); renderCalendar(); save(); };
  });

  // Site actions
  $$('#tree [data-add-lead]').forEach(b=>b.onclick=()=>{ const site=b.dataset.addLead; const name=prompt('Leader name'); if(!name) return; org.sites[site].leaders[ name ] = org.sites[site].leaders[ name ] || []; save(); rebuildTree(); });
  $$('#tree [data-rename-site]').forEach(b=>b.onclick=()=>{ const site=b.dataset.renameSite; const nn=prompt('Rename site', site); if(!nn||nn===site) return; org.sites[nn]=org.sites[site]; delete org.sites[site]; save(); rebuildTree(); });
  $$('#tree [data-remove-site]').forEach(b=>b.onclick=()=>{ const site=b.dataset.removeSite; if(!confirm(`Delete site ${site}?`)) return; delete org.sites[site]; save(); rebuildTree(); });

  // Leader actions
  $$('#tree [data-add-adv]').forEach(b=>b.onclick=()=>{ const [site,leader]=b.dataset.addAdv.split('::'); const n=prompt('Advisor name'); if(!n) return; org.sites[site].leaders[leader] = org.sites[site].leaders[leader] || []; if(!org.sites[site].leaders[leader].includes(n)) org.sites[site].leaders[leader].push(n); if(!ADVISORS.includes(n)) { ADVISORS.push(n); rotas[n]={}; DAYS.forEach(d=>rotas[n][d]=''); } save(); rebuildTree(); rebuildAdvisorDropdown(); populateAssignTable(); renderCalendar(); });
  $$('#tree [data-rename-lead]').forEach(b=>b.onclick=()=>{ const [site,leader]=b.dataset.renameLead.split('::'); const nn=prompt('Rename leader', leader); if(!nn||nn===leader) return; org.sites[site].leaders[nn]=org.sites[site].leaders[leader]; delete org.sites[site].leaders[leader]; save(); rebuildTree(); });
  $$('#tree [data-remove-lead]').forEach(b=>b.onclick=()=>{ const [site,leader]=b.dataset.removeLead.split('::'); if(!confirm(`Remove leader ${leader}?`)) return; delete org.sites[site].leaders[leader]; save(); rebuildTree(); });

  // Advisor actions
  $$('#tree [data-rename-adv]').forEach(b=>b.onclick=()=>{ const old=b.dataset.renameAdv; const nn=prompt('Rename advisor', old); if(!nn||nn===old) return;
    const idx=ADVISORS.indexOf(old); if(idx>-1) ADVISORS[idx]=nn;
    rotas[nn]=rotas[old]||{}; delete rotas[old];
    Object.values(org.sites).forEach(s=>Object.entries(s.leaders).forEach(([_,arr])=>{
      const i=arr.indexOf(old); if(i>-1) arr[i]=nn;
    }));
    if(selectedAdvisors.has(old)){ selectedAdvisors.delete(old); selectedAdvisors.add(nn); }
    save(); rebuildTree(); rebuildAdvisorDropdown(); populateAssignTable(); renderCalendar();
  });
  $$('#tree [data-remove-adv]').forEach(b=>b.onclick=()=>{ const name=b.dataset.removeAdv; if(!confirm(`Remove ${name} from tree? (rota data kept)`)) return;
    Object.values(org.sites).forEach(s=>Object.entries(s.leaders).forEach(([_,arr])=>{
      const i=arr.indexOf(name); if(i>-1) arr.splice(i,1);
    }));
    selectedAdvisors.delete(name); save(); rebuildTree(); refreshChips(); populateAssignTable(); renderCalendar();
  });
}

function refreshChips(){
  const box=$('#activeChips'); box.innerHTML='';
  if(!selectedAdvisors.size){ box.innerHTML='<span class="muted">No advisors selected.</span>'; return; }
  selectedAdvisors.forEach(a=>{
    const span=document.createElement('span'); span.className='chip'; span.textContent=a;
    const x=document.createElement('button'); x.textContent='√ó'; x.style.border='none'; x.style.background='transparent'; x.style.cursor='pointer';
    x.onclick=()=>{ selectedAdvisors.delete(a); rebuildTree(); refreshChips(); populateAssignTable(); renderCalendar(); };
    span.appendChild(x); box.appendChild(span);
  });
}

/* ========= DROPDOWN ========= */
function rebuildAdvisorDropdown(){
  const sel=$('#advisorSelect');
  sel.innerHTML = `<option value="__TEAM_SELECTED__">Team (Selected)</option><option value="__TEAM_ALL__">Team (All)</option>` + ADVISORS.map(a=>`<option>${a}</option>`).join('');
}

/* ========= HOURS ========= */
function hoursHTML(){ let h=''; for(let i=START;i<=END;i++){ h+=`<div class="hour"><span>${pad(i)}:00</span></div>`; } return h; }

/* ========= COLOUR FROM CODE ========= */
function classForCode(code){
  const k=(code||'').toLowerCase();
  if(/\blunch\b/.test(k)) return 'c-lunch';
  if(/\bbreak\b/.test(k)) return 'c-break';
  if(/\bovertime\b/.test(k)) return 'c-overtime';
  if(/\bmirakl\b/.test(k)) return 'c-mirakl';
  if(/\bsocial\b/.test(k)) return 'c-social';
  if(/\bemail\b/.test(k)) return 'c-email';
  if(['al','sick','rdo','maternity','lts','split shift'].some(w=>k.includes(w))) return 'c-absence';
  if(['121','atl','coaching','huddle','iti','projects','team meeting','training'].some(w=>k.includes(w))) return 'c-shrink';
  return 'c-email';
}

/* ========= PROCESS DAY ========= */
function processTemplateToSegments(t){
  if(!t||!t.Start||!t.Finish) return [];
  const s=toMin(t.Start), e=toMin(t.Finish); if(e<=s) return [];
  const ev=[{t:s,type:'start'},{t:e,type:'end'}];
  // Lunch is 30 mins
  [['Break1',15,'Break'],['Lunch',30,'Lunch'],['Break2',15,'Break']].forEach(([k,d,label])=>{ if(t[k]) ev.push({t:toMin(t[k]),type:'pause',d,label}); });
  ev.sort((a,b)=>a.t-b.t||((a.type==='end')-(b.type==='end')));
  const out=[]; let cur=s;
  for(const evn of ev){
    if(evn.t>cur) out.push({code: t.WorkCode || 'Admin', start:m2t(cur), end:m2t(evn.t)}); // default work code from template
    if(evn.type==='pause'){ out.push({code:evn.label, start:m2t(evn.t), end:m2t(evn.t+evn.d)}); cur=evn.t+evn.d; }
  }
  return out;
}
function dayHasSegments(v){ return v && typeof v==='object' && Array.isArray(v.segments); }
function processDayValue(dayValue){
  if(dayHasSegments(dayValue)){
    return dayValue.segments
      .filter(s=>s.code && s.start && s.end)
      .map(s=>({label:s.code, start:toMin(s.start), end:toMin(s.end)}))
      .filter(b=>b.end>b.start)
      .sort((a,b)=>a.start-b.start);
  }
  if(typeof dayValue==='string' && templates[dayValue]){
    return processTemplateToSegments(templates[dayValue]).map(s=>({label:s.code, start:toMin(s.start), end:toMin(s.end)}));
  }
  return [];
}
function toEditableSegments(dayValueOrTemplateName){
  if(dayHasSegments(dayValueOrTemplateName)) return JSON.parse(JSON.stringify(dayValueOrTemplateName.segments));
  if(typeof dayValueOrTemplateName==='string' && templates[dayValueOrTemplateName]){
    return processTemplateToSegments(templates[dayValueOrTemplateName]);
  }
  return [];
}
function mergeAdjacent(segs){
  const s=[...segs].sort((a,b)=>toMin(a.start)-toMin(b.start));
  const out=[];
  for(const x of s){
    if(!out.length){ out.push({...x}); continue; }
    const p=out[out.length-1];
    if(p.code===x.code && toMin(p.end)===toMin(x.start)){ p.end=x.end; }
    else out.push({...x});
  }
  return out;
}
function insertOverlay(segments, newSeg){
  const ns = { code:newSeg.code, start:toMin(newSeg.start), end:toMin(newSeg.end) };
  if(!(ns.code && ns.start!=null && ns.end!=null && ns.end>ns.start)) return segments;
  const out=[];
  for(const s of segments){
    const a=toMin(s.start), b=toMin(s.end);
    if(b<=ns.start || a>=ns.end){ out.push({...s}); continue; }
    if(a<ns.start){ out.push({code:s.code,start:m2t(a),end:m2t(ns.start)}); }
    if(b>ns.end){ out.push({code:s.code,start:m2t(ns.end),end:m2t(b)}); }
  }
  out.push({code:ns.code,start:m2t(ns.start),end:m2t(ns.end)});
  return mergeAdjacent(out);
}

/* ========= RENDERERS ========= */
function updateRangeLabel(){
  const ws=$('#weekStart').value; const adv=$('#advisorSelect').value;
  if(!ws){ $('#rangeLabel').textContent=''; return; }
  const s=new Date(ws+'T00:00:00'); const e=new Date(s); e.setDate(e.getDate()+6);
  const f=d=>d.toLocaleDateString('en-GB',{day:'2-digit',month:'2-digit',year:'numeric'});
  if(adv==='__TEAM_SELECTED__' || adv==='__TEAM_ALL__'){
    const idx=DAYS.indexOf($('#teamDay').value||'Monday'); const d=new Date(s); d.setDate(d.getDate()+idx);
    $('#rangeLabel').textContent=d.toLocaleDateString('en-GB',{weekday:'long',day:'2-digit',month:'2-digit',year:'numeric'});
    $('#calTitle').textContent=(adv==='__TEAM_ALL__'?'Team (All)':'Team (Selected)')+' ‚Äì Single Day';
  } else {
    $('#rangeLabel').textContent=`${f(s)} ‚Äì ${f(e)}`;
    $('#calTitle').textContent='Advisor Week (Calendar)';
  }
  $$('#dateHeaders [data-date]').forEach((span,i)=>{ const d=new Date(s); d.setDate(d.getDate()+i); span.textContent=d.toLocaleDateString('en-GB',{month:'short',day:'numeric'}); });
}

function resetHourCol(){ document.getElementById('hours').innerHTML=hoursHTML(); }

function renderCalendar(){
  resetGrid(); resetHourCol();
  const advVal=$('#advisorSelect').value||ADVISORS[0];
  if(advVal==='__TEAM_SELECTED__' || advVal==='__TEAM_ALL__'){ renderTeamDayCalendar(advVal==='__TEAM_ALL__'); return; }

  const grid=$('#calGrid'); const ws=$('#weekStart').value; const s=ws?new Date(ws+'T00:00:00'):null; const adv=advVal;

  DAYS.forEach((day,idx)=>{
    const col=document.createElement('div'); col.className='day-col';
    let month='‚Äî', num=''; if(s){ const d=new Date(s); d.setDate(d.getDate()+idx); month=d.toLocaleDateString('en-GB',{month:'long'}); num=d.getDate(); }
    col.insertAdjacentHTML('beforeend',`<div class="day-head"><small>${month}</small>${day}<span style="float:right">${num}</span></div>`);

    const dayVal = rotas[adv]?.[day];
    if(dayHasSegments(dayVal)){
      const totalMins = processDayValue(dayVal).reduce((acc,b)=>acc+(b.end-b.start),0);
      col.insertAdjacentHTML('beforeend',`<div class="day-summary"><span class="muted">Custom segments</span><span class="summary-right">${(totalMins/60).toFixed(1)}h</span></div>`);
    } else {
      const tplName = typeof dayVal==='string' ? dayVal : '';
      const tpl=templates[tplName];
      if(!tplName){ col.insertAdjacentHTML('beforeend',`<div class="off">Roster Day Off</div>`); }
      else { col.insertAdjacentHTML('beforeend',`<div class="day-summary"><span class="muted">${tplName}</span> ${tpl.Start} ‚Äì ${tpl.Finish}<span class="summary-right">${((toMin(tpl.Finish)-toMin(tpl.Start))/60)}h</span></div>`); }
    }

    col.insertAdjacentHTML('beforeend',`<div class="day-actions"><button class="iconbtn" data-day="${day}">Ôºã</button><button class="iconbtn" data-day="${day}" data-edit>‚úé</button></div>`);
    const cell=document.createElement('div'); cell.className='timeline-cell';

    const blocks = processDayValue(dayVal);
    blocks.forEach(b=>{
      const top=(b.start-START*60)*PX_PER_MIN; const h=(b.end-b.start)*PX_PER_MIN;
      const el=document.createElement('div'); el.className=`block ${classForCode(b.label)}`;
      el.style.top=top+'px'; el.style.height=Math.max(16,h)+'px';
      el.innerHTML=`<div>${b.label}<span class="time">${m2t(b.start)} ‚Äì ${m2t(b.end)}</span></div>`;
      el.dataset.day = day; el.dataset.adv = adv; el.dataset.start = m2t(b.start); el.dataset.end = m2t(b.end); el.dataset.code=b.label;
      el.addEventListener('click', onBlockClick);
      cell.appendChild(el);
    });

    col.appendChild(cell); grid.appendChild(col);
  });
  $$('.day-actions .iconbtn').forEach(b=>b.onclick=()=>openAssign(b.dataset.day));
}

function renderTeamDayCalendar(showAll){
  resetGrid(); resetHourCol();
  const grid=$('#calGrid'); const ws=$('#weekStart').value; const day=$('#teamDay').value||'Monday';
  const list = showAll ? ADVISORS : (selectedAdvisors.size? [...selectedAdvisors] : []);
  // If no selection and not "all", show empty with hour column
  if(list.length===0){
    const head=document.createElement('div'); head.className='day-head'; head.style.gridColumn='1 / span 2'; head.style.height='56px';
    if(ws){ const s=new Date(ws); const idx=DAYS.indexOf(day); s.setDate(s.getDate()+idx); head.innerHTML=`<small>${s.toLocaleDateString('en-GB',{month:'long'})}</small>${day}<span style="float:right">${s.getDate()}</span>`; }
    grid.appendChild(head);
    const hourCol=document.createElement('div'); hourCol.className='hour-col'; hourCol.innerHTML=hoursHTML(); grid.appendChild(hourCol);
    return;
  }

  const cols=1+list.length; const head=document.createElement('div'); head.className='day-head'; head.style.gridColumn=`1 / span ${cols}`; head.style.height='56px';
  if(ws){ const s=new Date(ws); const idx=DAYS.indexOf(day); s.setDate(s.getDate()+idx); head.innerHTML=`<small>${s.toLocaleDateString('en-GB',{month:'long'})}</small>${day}<span style="float:right">${s.getDate()}</span>`; }
  grid.appendChild(head);
  const hourCol=document.createElement('div'); hourCol.className='hour-col'; hourCol.innerHTML=hoursHTML(); grid.appendChild(hourCol);

  list.forEach(adv=>{
    const col=document.createElement('div'); col.className='day-col';
    col.insertAdjacentHTML('beforeend',`<div class="day-head" style="height:56px">${adv}</div>`);
    const dayVal = rotas[adv]?.[day];
    if(dayHasSegments(dayVal)){
      const totalMins = processDayValue(dayVal).reduce((acc,b)=>acc+(b.end-b.start),0);
      col.insertAdjacentHTML('beforeend',`<div class="day-summary"><span class="muted">Custom segments</span><span class="summary-right">${(totalMins/60).toFixed(1)}h</span></div>`);
    } else {
      const tplName = typeof dayVal==='string' ? dayVal : '';
      const tpl=templates[tplName];
      if(!tplName){ col.insertAdjacentHTML('beforeend',`<div class="off">Roster Day Off</div>`); }
      else { col.insertAdjacentHTML('beforeend',`<div class="day-summary"><span class="muted">${tplName}</span> ${tpl.Start} ‚Äì ${tpl.Finish}<span class="summary-right">${((toMin(tpl.Finish)-toMin(tpl.Start))/60)}h</span></div>`); }
    }
    col.insertAdjacentHTML('beforeend',`<div class="day-actions"><button class="iconbtn" data-day="${day}" data-adv="${adv}">Ôºã</button><button class="iconbtn" data-day="${day}" data-adv="${adv}" data-edit>‚úé</button></div>`);
    const cell=document.createElement('div'); cell.className='timeline-cell';
    const blocks = processDayValue(dayVal);
    blocks.forEach(b=>{
      const top=(b.start-START*60)*PX_PER_MIN; const h=(b.end-b.start)*PX_PER_MIN;
      const el=document.createElement('div'); el.className=`block ${classForCode(b.label)}`;
      el.style.top=top+'px'; el.style.height=Math.max(16,h)+'px';
      el.innerHTML=`<div>${b.label}<span class="time">${m2t(b.start)} ‚Äì ${m2t(b.end)}</span></div>`;
      el.dataset.day = day; el.dataset.adv = adv; el.dataset.start = m2t(b.start); el.dataset.end = m2t(b.end); el.dataset.code=b.label;
      el.addEventListener('click', onBlockClick);
      cell.appendChild(el);
    });
    col.appendChild(cell); grid.appendChild(col);
  });
  $$('.day-actions .iconbtn').forEach(b=>b.onclick=()=>openAssign(b.dataset.day, b.dataset.adv));
}

/* ========= ASSIGN / SPLIT DIALOG ========= */
const assignDlg=$('#assignDlg'), assignSelect=$('#assignSelect'), assignTitle=$('#assignTitle');
const modeTemplate=$('#modeTemplate'), modeSplit=$('#modeSplit'), modeHint=$('#modeHint');
const templateMode=$('#templateMode'), splitMode=$('#splitMode');
const segmentsWrap=$('#segmentsWrap');

function segmentRowHTML(s, idx){
  return `<div class="row" data-i="${idx}">
    <select class="seg-code">${codeSelectGroupedHTML(s.code||'')}</select>
    <input type="time" class="seg-start" value="${s.start||''}">
    <span>‚Äì</span>
    <input type="time" class="seg-end" value="${s.end||''}">
    <button class="del">Delete</button>
  </div>`;
}
function loadSegmentsUI(arr){
  if(!arr || !Array.isArray(arr)) arr=[];
  segmentsWrap.innerHTML = arr.length ? arr.map((s,i)=>segmentRowHTML(s,i)).join('') : '<div class="muted">No segments yet. Add one.</div>';
  $$('#segmentsWrap .row .del').forEach(btn=>{
    btn.onclick=()=>{
      btn.parentElement.remove();
      if($$('#segmentsWrap .row').length===0) segmentsWrap.innerHTML='<div class="muted">No segments yet. Add one.</div>';
      refreshOverlayBlockOptions();
    };
  });
  $$('#segmentsWrap .seg-start, #segmentsWrap .seg-end, #segmentsWrap .seg-code').forEach(inp=>{
    ['input','change'].forEach(ev=>inp.addEventListener(ev,refreshOverlayBlockOptions));
  });
  refreshOverlayBlockOptions();
}
function readSegmentsUI(){
  const rows=$$('#segmentsWrap .row');
  const list=rows.map(r=>{
    return { code:r.querySelector('.seg-code').value, start:r.querySelector('.seg-start').value, end:r.querySelector('.seg-end').value };
  }).filter(s=>s.code && s.start && s.end && toMin(s.end)>toMin(s.start));
  list.sort((a,b)=>toMin(a.start)-toMin(b.start));
  for(let i=1;i<list.length;i++){
    if(toMin(list[i].start)<toMin(list[i-1].end)){
      alert('Segments overlap. Please adjust times.'); return null;
    }
  }
  return list;
}

/* Overlay picks */
function refreshOverlayBlockOptions(){
  const sel = document.getElementById('ovBlock');
  if(!sel) return;
  const rows=$$('#segmentsWrap .row');
  const blocks = rows.map(r=>{
    const code=r.querySelector('.seg-code').value;
    const s=r.querySelector('.seg-start').value;
    const e=r.querySelector('.seg-end').value;
    return (code && s && e && toMin(e)>toMin(s)) ? {code,s,e} : null;
  }).filter(Boolean);
  if(blocks.length===0){
    sel.innerHTML = `<option value="">(no valid blocks yet)</option>`;
    return;
  }
  sel.innerHTML = blocks.map((b,i)=>`<option value="${i}">${b.code} ‚Äî ${b.s}‚Äì${b.e}</option>`).join('');
  sel.onchange = ()=>{
    const i = +sel.value;
    if(Number.isInteger(i) && blocks[i]){
      $('#ovStart').value = blocks[i].s;
      $('#ovEnd').value   = blocks[i].e;
      $('#ovCode').value = blocks[i].code;
    }
  };
}
function buildOverlaySelects(){
  $('#ovCode').innerHTML = codeSelectGroupedHTML();
}
function wireOverlayButtons(){
  $('#btnInsertOverlay').onclick=()=>{
    const code=$('#ovCode').value, s=$('#ovStart').value, e=$('#ovEnd').value;
    if(!s || !e || toMin(e)<=toMin(s)){ alert('Please enter a valid time range.'); return; }
    const cur=readSegmentsUI(); if(!cur) return;
    const updated=insertOverlay(cur, {code,start:s,end:e});
    loadSegmentsUI(updated);
  };
}

function openAssign(day, advisor){
  const adv = advisor || ($('#advisorSelect').value.startsWith('__TEAM_') ? (selectedAdvisors.values().next().value || ADVISORS[0]) : $('#advisorSelect').value);
  assignTitle.textContent=`${day} for ${adv}`;
  modeHint.textContent='';
  buildOverlaySelects();

  assignSelect.innerHTML=`<option value="">‚Äî Day Off ‚Äî</option>`+Object.keys(templates).map(n=>`<option>${n}</option>`).join('');
  const current = rotas[adv]?.[day];

  if(dayHasSegments(current)){
    modeSplit.checked=true; modeTemplate.checked=false;
    $('#templateMode').style.display='none'; $('#splitMode').style.display='block';
    loadSegmentsUI(current.segments);
    wireOverlayButtons();
  } else {
    modeTemplate.checked=true; modeSplit.checked=false;
    $('#templateMode').style.display='block'; $('#splitMode').style.display='none';
    assignSelect.value = (typeof current==='string')? current : '';
    const tplName = assignSelect.value;
    if(tplName) modeHint.textContent=`Current: ${tplName}. Use ‚ÄúConvert to editable segments‚Äù to tweak a small part.`;
  }

  $('#btnConvertToSplit').onclick=()=>{
    const tplName = assignSelect.value;
    if(!tplName){ alert('Choose a template first.'); return; }
    const segs = toEditableSegments(tplName);
    modeSplit.checked=true; modeTemplate.checked=false;
    $('#templateMode').style.display='none'; $('#splitMode').style.display='block';
    loadSegmentsUI(segs);
    wireOverlayButtons();
  };

  $('#addSegment').onclick=()=>{
    const wrap=$('#segmentsWrap'); const mut=wrap.querySelector('.muted'); if(mut) mut.remove();
    const div=document.createElement('div'); div.className='row';
    div.innerHTML= `${'<select class="seg-code">'+codeSelectGroupedHTML('Admin')+'</select>'}
      <input type="time" class="seg-start" value="08:00"> <span>‚Äì</span> <input type="time" class="seg-end" value="12:00">
      <button class="del">Delete</button>`;
    wrap.appendChild(div);
    div.querySelector('.del').onclick=()=>{ div.remove(); if($$('#segmentsWrap .row').length===0) $('#segmentsWrap').innerHTML='<div class="muted">No segments yet. Add one.</div>'; refreshOverlayBlockOptions(); };
    ['input','change'].forEach(evt=>{
      div.querySelector('.seg-start').addEventListener(evt,refreshOverlayBlockOptions);
      div.querySelector('.seg-end').addEventListener(evt,refreshOverlayBlockOptions);
      div.querySelector('.seg-code').addEventListener(evt,refreshOverlayBlockOptions);
    });
    refreshOverlayBlockOptions();
  };

  modeTemplate.onchange = modeSplit.onchange = ()=>{
    const tmpl = modeTemplate.checked;
    $('#templateMode').style.display = tmpl ? 'block':'none';
    $('#splitMode').style.display = tmpl ? 'none':'block';
    if(!tmpl && $$('#segmentsWrap .row').length===0){
      const baseSegs = toEditableSegments(current || assignSelect.value);
      loadSegmentsUI(baseSegs);
      wireOverlayButtons();
    }
  };

  $('#assignOK').onclick=()=>{
    if(!rotas[adv]) rotas[adv]={};
    if(modeTemplate.checked){
      rotas[adv][day] = assignSelect.value;
    } else {
      const segs=readSegmentsUI(); if(!segs) return;
      rotas[adv][day] = { segments: segs };
    }
    save(); assignDlg.close(); renderCalendar(); populateAssignTable();
  };

  assignDlg.showModal();
}

/* ========= BLOCK CLICK EDITOR ========= */
const blockDlg = $('#blockDlg');
const bmWhole = $('#bmWhole'), bmSub = $('#bmSub');
const blockWhole = $('#blockWhole'), blockSub = $('#blockSub');
const bwStart=$('#bwStart'), bwEnd=$('#bwEnd'), bwCode=$('#bwCode');
const bsStart=$('#bsStart'), bsEnd=$('#bsEnd'), bsCode=$('#bsCode');
let currentBlockCtx = null;

function buildBlockSelects(){
  const codes = codeSelectGroupedHTML();
  [bwCode, bsCode].forEach(sel=> sel.innerHTML=codes);
}

function onBlockClick(e){
  const el = e.currentTarget;
  const adv = el.dataset.adv, day = el.dataset.day;
  const origStart = el.dataset.start, origEnd   = el.dataset.end, origCode=el.dataset.code||'';

  const dayVal = rotas[adv]?.[day];
  if(!dayHasSegments(dayVal)){
    const segs = toEditableSegments(dayVal || '');
    if(!rotas[adv]) rotas[adv] = {};
    rotas[adv][day] = { segments: segs };
    save();
  }

  currentBlockCtx = {adv, day, origStart, origEnd, origCode};
  $('#blockTitle').textContent = `Edit ${day} for ${adv}`;
  $('#blockHint').textContent = `Block: ${origCode} ${origStart}‚Äì${origEnd}`;

  buildBlockSelects();

  bmSub.checked = true; bmWhole.checked = false;
  blockSub.style.display='block'; blockWhole.style.display='none';

  bwCode.value = origCode || 'Admin';
  bwStart.value = origStart; bwEnd.value = origEnd;

  bsCode.value = origCode || 'Admin';
  bsStart.value = origStart; bsEnd.value = origEnd;

  bmWhole.onchange = bmSub.onchange = ()=>{
    const whole = bmWhole.checked;
    blockWhole.style.display = whole ? 'block' : 'none';
    blockSub.style.display   = whole ? 'none'  : 'block';
  };

  $('#blockOK').onclick = ()=>{
    const {adv, day, origStart, origEnd, origCode} = currentBlockCtx;
    const segs = (rotas[adv][day] && rotas[adv][day].segments) ? JSON.parse(JSON.stringify(rotas[adv][day].segments)) : [];
    const oS = toMin(origStart), oE = toMin(origEnd);
    const idx = segs.findIndex(s=>s.start===origStart && s.end===origEnd && (s.code||'')===origCode);
    if(idx===-1){ alert('Could not find block to edit.'); return; }

    if(bmWhole.checked){
      const c=bwCode.value, s = bwStart.value, e = bwEnd.value;
      if(!s || !e || toMin(e)<=toMin(s)){ alert('Enter a valid time range.'); return; }
      if(toMin(s)<oS || toMin(e)>oE){ alert('You cannot extend beyond the original block.'); return; }
      const leftNeeded  = toMin(s)>oS, rightNeeded = toMin(e)<oE;
      const originals = [...segs]; originals.splice(idx,1);
      if(leftNeeded) originals.splice(idx,0,{code:origCode,start:m2t(oS),end:s});
      originals.splice(idx+(leftNeeded?1:0),0,{code:c,start:s,end:e});
      if(rightNeeded) originals.splice(idx+(leftNeeded?1:0)+1,0,{code:origCode,start:e,end:m2t(oE)});
      rotas[adv][day] = { segments: mergeAdjacent(originals) };
      save(); blockDlg.close(); renderCalendar(); populateAssignTable();
      return;
    } else {
      const c=bsCode.value, s = bsStart.value, e = bsEnd.value;
      if(!s || !e || toMin(e)<=toMin(s)){ alert('Enter a valid sub-range.'); return; }
      if(toMin(s)<oS || toMin(e)>oE){ alert('Sub-range must be inside the original block.'); return; }
      const originals = [...segs]; originals.splice(idx,1);
      if(toMin(s)>oS) originals.splice(idx,0,{code:origCode,start:m2t(oS),end:s});
      originals.splice(idx+(toMin(s)>oS?1:0),0,{code:c,start:s,end:e});
      if(toMin(e)<oE) originals.splice(idx+(toMin(s)>oS?1:0)+1,0,{code:origCode,start:e,end:m2t(oE)});
      rotas[adv][day] = { segments: mergeAdjacent(originals) };
      save(); blockDlg.close(); renderCalendar(); populateAssignTable();
      return;
    }
  };

  blockDlg.showModal();
}

/* ========= DATES & VIEW ========= */
function setToMonday(d){ const day=d.getDay(); const diff=(day===0?-6:1)-day; d.setDate(d.getDate()+diff); return d; }
function updateViewSelector(){
  const team = $('#advisorSelect').value;
  const showTeam = team==='__TEAM_SELECTED__' || team==='__TEAM_ALL__';
  $('#lblTeamDay').style.display = showTeam ? 'inline' : 'none';
  $('#teamDay').style.display     = showTeam ? 'inline' : 'none';
}

/* ========= WIRE ========= */
function wire(){
  $('#btnPrint').onclick=()=>window.print();
  $('#btnGenerate').onclick=()=>{ updateRangeLabel(); renderCalendar(); };
  $('#btnToday').onclick=()=>{ const t=setToMonday(new Date()); $('#weekStart').value=t.toISOString().slice(0,10); updateRangeLabel(); renderCalendar(); };
  $('#prevWeek').onclick=()=>{ const d=new Date($('#weekStart').value||new Date()); d.setDate(d.getDate()-7); $('#weekStart').value=d.toISOString().slice(0,10); updateRangeLabel(); renderCalendar(); };
  $('#nextWeek').onclick=()=>{ const d=new Date($('#weekStart').value||new Date()); d.setDate(d.getDate()+7); $('#weekStart').value=d.toISOString().slice(0,10); updateRangeLabel(); renderCalendar(); };

  $('#btnSave').onclick=()=>{ const blob=new Blob([JSON.stringify({advisors:ADVISORS,templates,rotas,weekStart:$('#weekStart').value, org},null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='rota.json'; a.click(); };
  $('#btnLoad').onclick=()=>$('#file').click();
  $('#file').addEventListener('change',e=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=ev=>{ try{ const d=JSON.parse(ev.target.result); ADVISORS=d.advisors||ADVISORS; templates=d.templates||templates; rotas=d.rotas||rotas; if(d.weekStart) $('#weekStart').value=d.weekStart; if(d.org) org=d.org; rebuildTree(); rebuildAdvisorDropdown(); populateTemplateEditor(); populateAssignTable(); save(); updateRangeLabel(); renderCalendar(); }catch{ alert('Invalid JSON'); } }; r.readAsText(f); });

  $('#btnReset').onclick=()=>{ if(!confirm('Clear all local data?')) return; localStorage.removeItem(STORAGE); location.reload(); };

  $('#btnAddTemplate').onclick=()=>{ const name='Shift'+(Object.keys(templates).length+1); templates[name]={name,WorkCode:'Admin',Start:'',Finish:'',Break1:'',Lunch:'',Break2:''}; populateTemplateEditor(); save(); };
  $('#btnLoadDefaults').onclick=()=>{ seedDefaults(); populateTemplateEditor(); populateAssignTable(); save(); renderCalendar(); };

  $('#advisorSelect').addEventListener('change',()=>{ updateViewSelector(); updateRangeLabel(); renderCalendar(); });
  $('#teamDay').addEventListener('change',()=>{ updateRangeLabel(); renderCalendar(); });
  $('#weekStart').onchange=()=>{ updateRangeLabel(); renderCalendar(); };

  $('#treeSearch').addEventListener('input',rebuildTree);
  $('#btnClearSel').onclick=()=>{ selectedAdvisors.clear(); rebuildTree(); refreshChips(); populateAssignTable(); renderCalendar(); };
}

/* ========= INIT ========= */
(function init(){
  buildColorKey(); load(); if(Object.keys(templates).length===0) seedDefaults();
  ensureSeedHierarchy();
  rebuildAdvisorDropdown(); populateTemplateEditor(); populateAssignTable();
  if(!$('#weekStart').value){ const t=setToMonday(new Date()); $('#weekStart').value=t.toISOString().slice(0,10); }
  updateViewSelector(); updateRangeLabel();
  document.getElementById('hours').innerHTML=hoursHTML();
  rebuildTree(); refreshChips();
  wire(); renderCalendar();
})();
</script>
</body>
</html>

