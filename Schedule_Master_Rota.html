<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Professional Team Rota System — Master</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net"/>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>

<style>
:root{
  --brand:#0d47a1; --accent:#00c853; --ink:#111827; --muted:#6b7280;
  --paper:#ffffff; --wash:#f6f9ff; --line:#e6ebf4;

  /* timeline window (Calabrio-style) */
  --start:06;
  --end:20;
  --row-h:36px;
  --bar-h:14px;
  --name-w:260px;
}

*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:#eef2f6;color:var(--ink);font:13px/1.35 Inter,Segoe UI,Roboto,system-ui,Arial,sans-serif}

/* Topbar */
.topbar{position:sticky;top:0;z-index:5;display:flex;gap:10px;align-items:center;padding:10px 14px;background:var(--brand);color:#fff;box-shadow:0 2px 10px rgba(13,71,161,.18)}
.topbar h1{margin:0;font:700 16px/1 Inter}
.badge{background:#113a8f;border:1px solid #1a4fb3;color:#e6efff;border-radius:999px;padding:4px 8px;font-weight:700}

.frame{max-width:1500px;margin:14px auto;padding:0 14px;display:grid;grid-template-columns:1fr 320px;gap:14px}

/* Controls */
.controls{grid-column:1/-1;background:var(--paper);border:1px solid var(--line);border-radius:12px;padding:10px 12px;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.controls .grow{flex:1}
select,input[type="date"],input[type="text"]{border:1px solid var(--line);background:#fff;border-radius:9px;padding:8px 10px}
.btn{border:0;border-radius:9px;padding:8px 12px;font-weight:800;cursor:pointer}
.btn.primary{background:var(--accent);color:#fff}
.btn.ghost{background:#eaf2ff;color:#0d47a1;border:1px solid #cfe0ff}
.right{margin-left:auto;display:flex;gap:8px;align-items:center}

/* Panels */
.panel{background:var(--paper);border:1px solid var(--line);border-radius:12px}
.panel-h{display:flex;justify-content:space-between;align-items:center;padding:9px 12px;border-bottom:1px solid var(--line)}
.panel-h h2{margin:0;font:700 14px/1 Inter}
.panel-b{padding:10px 12px}

/* Schedules tree */
.tree-search{display:flex;gap:8px;margin-bottom:8px}
.tree{max-height:68vh;overflow:auto;border:1px solid var(--line);border-radius:10px;padding:6px;background:#fff}
.tree details{padding:3px 4px;border-radius:6px}
.tree summary{list-style:none;cursor:pointer;font-weight:700;display:flex;gap:6px;align-items:center}
.tree summary::-webkit-details-marker{display:none}
.twisty{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border:1px solid var(--line);border-radius:4px;background:#f5f7fb;font-weight:900}
.node{display:flex;gap:6px;align-items:center;padding:2px 2px}
.chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
.chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);background:#fff;border-radius:999px;padding:4px 8px}

/* Templates & Assignment (vertical, templates on top) */
.templates-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
  gap: 12px;
  margin-bottom: 16px;
}
.template {
  border: 1px solid var(--line);
  border-radius: 8px;
  padding: 12px;
  background: var(--wash);
}
.template-row {
  display: grid;
  grid-template-columns: 120px 1fr;
  gap: 12px;
  align-items: center;
  margin-bottom: 8px;
}
.template-row:last-of-type {
  margin-bottom: 12px;
}
.template-row > label {
  font-weight: 500;
  color: var(--ink);
}
.template input,
.template select {
  width: 100%;
  height: 32px;
  padding: 0 8px;
  border: 1px solid var(--line);
  border-radius: 6px;
  background: white;
}
.template-row .field-group {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}
.template-row .break-group {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
}
.template-actions {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
}
.btn-duplicate {
  background: var(--wash);
  color: var(--brand);
  border: 1px solid var(--line);
}
.btn-delete {
  background: #fff1f0;
  color: #cf1322;
  border: 1px solid #ffa39e;
}

/* Updated timeline colors */
.c-email, .c-mirakl, .c-work { background:#6b8e23 !important }
.c-lunch { background:#8ddaf2 !important }
.c-break { background:#e0e0e0 !important }
.c-meet { background:#ffcc00 !important }

/* Timeline */
.timeline{grid-column:1/-1}
.legend{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:8px}
.legend .dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px;border:1px solid rgba(0,0,0,.08)}
.tl{border:1px solid var(--line);border-radius:12px;overflow:hidden}
.tl-head{display:flex;background:#f6f8fb;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:2}
.tl-name-col{width:var(--name-w);min-width:var(--name-w);padding:7px 10px;font-weight:800;border-right:1px solid var(--line)}
.tl-hours{flex:1;display:grid;grid-template-columns:repeat(calc(var(--end) - var(--start)),1fr)}
.tl-hours div{padding:6px 0;border-left:1px solid var(--line);font-size:12px;color:#68758a;text-align:center}
.tl-body{display:flex;flex-direction:column}
.row{display:flex;border-bottom:1px solid var(--line)}
.row:last-child{border-bottom:none}
.row:nth-child(odd){background:#fbfdff}
.rname{width:var(--name-w);min-width:var(--name-w);padding:8px 10px;border-right:1px solid var(--line);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:flex;align-items:center;gap:8px}
.rline{position:relative;flex:1;height:var(--row-h)}
.bar{position:absolute;height:var(--bar-h);top:calc((var(--row-h) - var(--bar-h))/2);border-radius:2px;padding:0 2px;box-shadow:0 1px 2px rgba(0,0,0,.10)}

/* No text in bars – info via tooltip */

/* Mouse guide line */
.time-guide {
  position: absolute;
  top: 0;
  bottom: 0;
  width: 1px;
  background: rgba(0,0,0,.2);
  pointer-events: none;
  z-index: 10;
}
.time-label {
  position: absolute;
  top: -20px;
  transform: translateX(-50%);
  background: var(--ink);
  color: white;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 11px;
  font-weight: 500;
}
.bar-edit {
  position: absolute;
  background: white;
  border: 1px solid var(--line);
  border-radius: 8px;
  padding: 12px;
  min-width: 240px;
  box-shadow: 0 4px 12px rgba(0,0,0,.15);
  z-index: 100;
}
.bar-edit .row {
  display: grid;
  grid-template-columns: 80px 1fr;
  gap: 8px;
  align-items: center;
  margin-bottom: 8px;
  background: none;
  border: 0;
}
.bar-edit .actions {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
  margin-top: 12px;
}

/* Enhanced timeline colors */
.c-work { background:#6b8e23 !important }
.c-lunch { background:#8ddaf2 !important }
.c-break { background:#e0e0e0 !important }
.c-meeting { background:#ffcc00 !important }
.c-overtime { background:#ff5722 !important }
.c-social { background:#9c27b0 !important }

/* Timeline */
.timeline{grid-column:1/-1}
.legend{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:8px}
.legend .dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px;border:1px solid rgba(0,0,0,.08)}
.tl{border:1px solid var(--line);border-radius:12px;overflow:hidden}
.tl-head{display:flex;background:#f6f8fb;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:2}
.tl-name-col{width:var(--name-w);min-width:var(--name-w);padding:7px 10px;font-weight:800;border-right:1px solid var(--line)}
.tl-hours{flex:1;display:grid;grid-template-columns:repeat(calc(var(--end) - var(--start)),1fr)}
.tl-hours div{padding:6px 0;border-left:1px solid var(--line);font-size:12px;color:#68758a;text-align:center}
.tl-body{display:flex;flex-direction:column}
.row{display:flex;border-bottom:1px solid var(--line)}
.row:last-child{border-bottom:none}
.row:nth-child(odd){background:#fbfdff}
.rname{width:var(--name-w);min-width:var(--name-w);padding:8px 10px;border-right:1px solid var(--line);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:flex;align-items:center;gap:8px}
.rline{position:relative;flex:1;height:var(--row-h)}
.bar{position:absolute;height:var(--bar-h);top:calc((var(--row-h) - var(--bar-h))/2);border-radius:2px;padding:0 2px;box-shadow:0 1px 2px rgba(0,0,0,.10)}

/* No text in bars – info via tooltip */

/* Mouse guide line */
.time-guide {
  position: absolute;
  top: 0;
  bottom: 0;
  width: 1px;
  background: rgba(0,0,0,.2);
  pointer-events: none;
  z-index: 10;
}
.time-label {
  position: absolute;
  top: -20px;
  transform: translateX(-50%);
  background: var(--ink);
  color: white;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 11px;
  font-weight: 500;
}
.bar-edit {
  position: absolute;
  background: white;
  border: 1px solid var(--line);
  border-radius: 8px;
  padding: 12px;
  min-width: 240px;
  box-shadow: 0 4px 12px rgba(0,0,0,.15);
  z-index: 100;
}
.bar-edit .row {
  display: grid;
  grid-template-columns: 80px 1fr;
  gap: 8px;
  align-items: center;
  margin-bottom: 8px;
  background: none;
  border: 0;
}
.bar-edit .actions {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
  margin-top: 12px;
}

/* Tooltip */
.tooltip{position:fixed;pointer-events:none;z-index:50;padding:6px 8px;background:#111827;color:#fff;border-radius:6px;font-weight:700;font-size:12px;transform:translate(-50%,-120%);white-space:nowrap}
.hidden{display:none}

/* Timeline fixes */
.rline {
  position: relative;
  height: 44px !important;
  min-height: 44px;
  background: linear-gradient(#f6f8fb 1px, transparent 1px) 0 0 / 60px 44px;
}
.bar {
  position: absolute;
  height: 20px;
  top: 12px;
  border-radius: 3px;
  z-index: 3;
  opacity: 0.95;
  cursor: pointer;
  transition: opacity 0.15s;
}
.bar:hover { opacity: 1 }

/* Template grid fixes */
.templates-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 16px;
  margin: 0 0 20px;
}
.template {
  border: 1px solid var(--line);
  border-radius: 8px;
  padding: 12px;
  background: var(--wash);
}
</style>
</head>

<body>
  <div class="topbar">
    <h1>Professional Team Rota System</h1>
    <span class="badge">Master</span>
    <div class="right">
      <button class="btn ghost" id="btnAuth">Sign in</button>
    </div>
  </div>

  <div class="frame">

    <!-- Controls -->
    <div class="controls">
      <label>Site</label>
      <select id="siteSel"></select>

      <label>Leader</label>
      <select id="leaderSel"></select>

      <label>View</label>
      <select id="viewSel">
        <option value="TEAM_ALL">Team (All)</option>
        <option value="TEAM_SELECTED">Team (Selected)</option>
      </select>

      <label>Week</label>
      <input type="date" id="weekInput"/>

      <div class="right">
        <button class="btn ghost" id="prevW">◀</button>
        <button class="btn ghost" id="todayW">Today</button>
        <button class="btn ghost" id="nextW">▶</button>
        <button class="btn primary" id="btnGenerate">Generate</button>
        <button class="btn primary" id="btnPublish">Publish</button>
      </div>
    </div>

    <!-- Left: Templates + Assignment (vertical) -->
    <div class="panel">
      <div class="panel-h">
        <h2>Templates & Master Assignment</h2>
        <div class="actions">
          <button class="btn ghost" id="btnAddTemplate">+ Add Template</button>
          <button class="btn ghost" id="btnLoadSamples">↺ Load Sample Templates</button>
        </div>
      </div>
      <div class="panel-b">
        <!-- Templates -->
        <div id="templWrap" class="templates-grid"></div>

        <!-- Assignment -->
        <div id="assignWrap" style="margin-top:10px">
          <table id="assignTbl">
            <thead>
              <tr><th class="name">Advisor</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th><th>Sun</th></tr>
            </thead>
            <tbody id="assignBody">
              <tr><td colspan="8" style="text-align:left;color:var(--muted)">Pick a Leader / advisors on the right to populate this table.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Right: Schedules pickers -->
    <div class="panel">
      <div class="panel-h"><h2>Schedules</h2></div>
      <div class="panel-b">
        <div class="tree-search">
          <input class="grow" id="treeSearch" placeholder="Search leaders/advisors…"/>
          <button class="btn ghost" id="btnClearSel">Clear</button>
        </div>
        <div id="tree" class="tree"></div>
        <div id="chips" class="chips"></div>
      </div>
    </div>

    <!-- Bottom full-width: Team Week -->
    <div class="panel timeline">
      <div class="panel-h">
        <h2>Team Week</h2>
        <div class="legend">
          <span><i class="dot" style="background:#7f8b2b"></i>Work</span>
          <span><i class="dot" style="background:#96e8ee"></i>Lunch</span>
          <span><i class="dot" style="background:#d9dce3"></i>Break</span>
          <span><i class="dot" style="background:#ffd700"></i>Meeting</span>
        </div>
      </div>
      <div class="panel-b">
        <div class="tl">
          <div class="tl-head">
            <div class="tl-name-col">Name</div>
            <div class="tl-hours" id="tlHours"></div>
          </div>
          <div class="tl-body" id="tlBody"></div>
        </div>
      </div>
    </div>

  </div>

  <!-- Tooltip -->
  <div id="tip" class="tooltip hidden"></div>

  <!-- Add mouse guide element -->
  <div class="time-guide" id="timeGuide"></div>

  <!-- Message banner -->
  <div id="msgBanner" aria-live="polite" style="position:fixed;top:0;left:0;right:0;background:#fff3cd;color:#856404;padding:8px;text-align:center;z-index:1000;display:none"></div>

<script>
/* ========= Supabase ========= */
const SUPABASE_URL="https://oypdnjxhjpgpwmkltzmk.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95cGRuanhoanBncHdta2x0em1rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4Nzk0MTEsImV4cCI6MjA3NTQ1NTQxMX0.Hqf1L4RHpIPUD4ut2uVsiGDsqKXvAjdwKuotmme4_Is";
const sb=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

/* ========= State ========= */
const DAYS=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
const DEBUG = false;
const state = {
  sites: [],
  leaders: [],
  advisors: [],
  selectedSite: null,
  selectedLeader: null,
  selectedNames: new Set(),
  templates: {},
  assigned: new Map()  // `${advisorId}-${dayIndex}` -> templateName
};

const slug = s => String(s||'').trim().toLowerCase().replace(/\s+/g,'-');

/* ========= Helpers ========= */
const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));
const pad=n=>String(n).padStart(2,"0");
function isoLocal(d){return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;}
function toMonday(d){const x=new Date(d.getFullYear(),d.getMonth(),d.getDate()); const day=x.getDay(); x.setDate(x.getDate() + (day===0?-6:1-day)); x.setHours(0,0,0,0); return x;}
function addDays(d,n){const x=new Date(d); x.setDate(x.getDate()+n); return x;}
function toMin(t){if(!t)return null; const [h,m]=t.split(":").map(Number); return h*60+m;}
function m2hhmm(m){return `${pad((m/60|0))}:${pad(m%60)}`;}
function clsFor(code){const k=(code||"").toLowerCase(); if(k.includes("lunch"))return"c-lunch"; if(k.includes("break"))return"c-break"; if(k.includes("overtime"))return"c-ot"; if(k.includes("meeting")||k.includes("coach")||k.includes("121")||k.includes("training")||k.includes("team"))return"c-meet"; if(k.includes("social"))return"c-social"; if(k.includes("mirakl")||k.includes("email")||k.includes("work"))return"c-mirakl"; return"c-mirakl";}
function spanPct(start,end){const S=+getComputedStyle(document.documentElement).getPropertyValue("--start")||6; const E=+getComputedStyle(document.documentElement).getPropertyValue("--end")||20; const total=(E-S)*60; const s=(start-S*60)/total*100; const w=(end-start)/total*100; return {left:Math.max(0,s),width:Math.max(0,Math.min(100-s,w))};}
const TEMPLATE_BADGE = n => /early/i.test(n) ? "EA" : /middle/i.test(n) ? "MD" : /late/i.test(n) ? "LT" : "";

/* ========= Auth ========= */
$('#btnAuth').onclick=async()=>{
  const {data:{user}}=await sb.auth.getUser();
  if(user){ await sb.auth.signOut(); $('#btnAuth').textContent='Sign in'; alert('Signed out'); return; }
  const email=prompt('Enter your work email to receive a magic sign-in link'); if(!email) return;
  const {error}=await sb.auth.signInWithOtp({ email, options:{ emailRedirectTo: location.href.split('#')[0] }});
  if(error) alert(error.message); else alert('Magic link sent.');
};
(async()=>{ const {data:{user}}=await sb.auth.getUser(); sessionUser=user; $('#btnAuth').textContent=user?'Signed in':'Sign in'; })();

/* ========= Load org ========= */
async function loadOrganizations() {
  try {
    console.time('loadOrg');
    const [sites, leaders, advisors] = await Promise.all([
      sb.from('sites').select('id,name').order('name'),
      sb.from('leaders').select('id,name,site_id').order('name'),
      sb.from('advisors').select('id,name,leader_id').order('name')
    ]);
    console.timeEnd('loadOrg');

    if (sites.data?.length) {
      return {
        sites: sites.data,
        leaders: leaders.data || [],
        advisors: advisors.data || []
      };
    }
  } catch (err) {
    console.error('Remote org load failed:', err);
  }

  // Try DOM fallback
  const domOrg = loadOrganizationsFromDOM();
  if (domOrg.leaders.length || domOrg.advisors.length) {
    showInfo('Using organization data from page.');
    return domOrg;
  }

  // Final fallback to seed data
  showInfo('Using sample organization data.');
  return {
    sites: [{ id: 'default', name: 'Default Site' }],
    leaders: [
      { id: 'team-1', name: 'Team 1', site_id: 'default' },
      { id: 'team-2', name: 'Team 2', site_id: 'default' }
    ],
    advisors: [
      { id: 'adv-1', name: 'Advisor 1', leader_id: 'team-1' },
      { id: 'adv-2', name: 'Advisor 2', leader_id: 'team-1' },
      { id: 'adv-3', name: 'Advisor 3', leader_id: 'team-2' }
    ]
  };
}

function loadOrganizationsFromDOM() {
  const org = { sites: [], leaders: [], advisors: [] };
  
  // Try reading site from select
  const siteSelect = $('#siteSel');
  if (siteSelect?.value) {
    org.sites.push({ 
      id: slug(siteSelect.value), 
      name: siteSelect.selectedOptions[0]?.text || siteSelect.value 
    });
  }

  // Read tree structure
  $$('#tree details').forEach(detail => {
    const leaderName = detail.querySelector('summary label')?.textContent?.trim();
    if (!leaderName) return;

    const leaderId = slug(leaderName);
    org.leaders.push({
      id: leaderId,
      name: leaderName,
      site_id: org.sites[0]?.id || 'default'
    });

    // Get advisors under this leader
    detail.querySelectorAll('.node span').forEach(span => {
      const name = span.textContent.trim();
      if (name) {
        org.advisors.push({
          id: slug(name),
          name: name,
          leader_id: leaderId
        });
      }
    });
  });

  return org;
}

/* Replace loadOrg() with resilient version */
async function loadOrg() {
  const org = await loadOrganizations();
  
  state.sites = org.sites;
  state.leaders = org.leaders;
  state.advisors = org.advisors;

  if (!state.leaders.length || !state.advisors.length) {
    showInfo('Organization data incomplete. Using available data for rendering.');
  }

  // Set initial selections
  if (state.sites.length) {
    const deb = state.sites.find(s => /debenhams/i.test(s.name));
    state.selectedSite = deb?.id || state.sites[0].id;
  }

  const siteLeaders = state.leaders.filter(l => String(l.site_id) === String(state.selectedSite));
  state.selectedLeader = siteLeaders[0]?.id || null;

  // Rebuild UI (never skip)
  refreshDropdowns();
  buildTree();
  refreshChips();
  rebuildAssignTable();
  renderTimeline();
}

/* Refresh dropdown cascading */
function refreshDropdowns() {
  const siteSel = $('#siteSel');
  const leaderSel = $('#leaderSel');

  // Sites dropdown
  siteSel.innerHTML = state.sites
    .map(s => `<option value="${s.id}"${s.id === state.selectedSite ? ' selected' : ''}>${s.name}</option>`)
    .join('');

  // Leaders for selected site
  const siteLeaders = state.leaders
    .filter(l => String(l.site_id) === String(state.selectedSite))
    .sort((a,b) => a.name.localeCompare(b.name));

  leaderSel.innerHTML = siteLeaders
    .map(l => `<option value="${l.id}"${l.id === state.selectedLeader ? ' selected' : ''}>${l.name}</option>`)
    .join('');

  // Wire up change handlers
  siteSel.onchange = () => {
    state.selectedSite = siteSel.value;
    state.selectedNames.clear();
    
    // Update leader selection
    const nextLeaders = state.leaders.filter(l => String(l.site_id) === String(state.selectedSite));
    state.selectedLeader = nextLeaders[0]?.id || null;
    
    refreshDropdowns();
    buildTree();
    refreshChips();
    rebuildAssignTable();
    renderTimeline();
  };

  leaderSel.onchange = () => {
    state.selectedLeader = leaderSel.value;
    state.selectedNames.clear();
    
    buildTree();
    refreshChips();
    rebuildAssignTable();
    renderTimeline();
  };

  $('#viewSel').onchange = () => {
    rebuildAssignTable();
    renderTimeline();
  };
}

/* ========= Right tree ========= */
function buildTree() {
  const t = $('#tree');
  const q = $('#treeSearch').value.trim().toLowerCase();
  
  const listLeaders = state.leaders
    .filter(l => String(l.site_id) === String(state.selectedSite))
    .sort((a,b) => a.name.localeCompare(b.name));

  function advRow(a) {
    if (q && !a.name.toLowerCase().includes(q)) return '';
    const checked = state.selectedNames.has(a.name) ? 'checked' : '';
    return `<div class="node"><input type="checkbox" data-adv="${a.id}" data-name="${a.name}" ${checked}/> <span>${a.name}</span></div>`;
  }

  t.innerHTML = listLeaders.map(ld => {
    const team = state.advisors.filter(a => String(a.leader_id) === String(ld.id)).sort((a,b) => a.name.localeCompare(b.name));
    if (q && !(ld.name.toLowerCase().includes(q) || team.some(a => a.name.toLowerCase().includes(q)))) return '';
    const allChecked = team.length && team.every(a => state.selectedNames.has(a.name));
    return `<details open>
      <summary><span class="twisty">${allChecked ? '−' : '+'}</span>
        <label style="display:flex;align-items:center;gap:6px">
          <input type="checkbox" data-leader="${ld.id}" ${allChecked ? 'checked' : ''}/> ${ld.name}
          <span style="color:var(--muted)">(${team.length})</span>
        </label>
      </summary>
      ${team.map(advRow).join('')}
    </details>`;
  }).join('') || `<div style="color:var(--muted)">No leaders in this site.</div>`;

  $$('#tree [data-leader]').forEach(cb => {
    cb.onchange = () => {
      const id = cb.dataset.leader;
      state.advisors.filter(a => String(a.leader_id) === String(id)).forEach(a => {
        cb.checked ? state.selectedNames.add(a.name) : state.selectedNames.delete(a.name);
      });
      refreshChips();
      rebuildAssignTable();
      renderTimeline();
      buildTree();
    };
  });
  $$('#tree [data-adv]').forEach(cb => {
    cb.onchange = () => { 
      const nm = cb.dataset.name; 
      cb.checked ? state.selectedNames.add(nm) : state.selectedNames.delete(nm); 
      refreshChips(); 
      rebuildAssignTable(); 
      renderTimeline(); 
    };
  });
}
$('#treeSearch').oninput=()=>buildTree();
$('#btnClearSel').onclick=()=>{ state.selectedNames.clear(); refreshChips(); buildTree(); rebuildAssignTable(); renderTimeline(); };

function refreshChips(){
  const c=$('#chips');
  c.innerHTML=[...state.selectedNames].sort((a,b)=>a.localeCompare(b)).map(n=>`<span class="chip">${n}<button class="btn ghost" data-x="${n}">×</button></span>`).join('');
  $$('#chips [data-x]').forEach(b=>b.onclick=()=>{ state.selectedNames.delete(b.dataset.x); buildTree(); refreshChips(); rebuildAssignTable(); renderTimeline(); });
}

/* ========= Templates ========= */
async function loadTemplates(){
  const {data,error}=await sb.from('templates').select('*');
  if(error){ console.error(error); return; }
  state.templates={}; (data||[]).forEach(t=>state.templates[t.name]=t);
  renderTemplates(); rebuildAssignTable();
}
function groupCodeSelect(val=''){
  const groups={
    "Activity":["DEB Email","Mirakl","PLT Social","Admin","2nd Line","QA","Overtime"],
    "Absence":["AL","Sick","RDO","Maternity","LTS","Split Shift","Break","Lunch"],
    "Shrinkage":["121","ATL","Coaching","Huddle","ITI","Projects","Team Meeting","Training","Meeting"]
  };
  return Object.entries(groups).map(([g,c])=>`<optgroup label="${g}">${c.mapx=>`<option ${val===x?'selected':''}>${x}</option>`).join('')}</optgroup>`).join('');
}
function renderTemplates(){
  const w=$('#templWrap');
  const names=Object.keys(state.templates).sort();
  if(!names.length){ w.innerHTML=`<div style="color:var(--muted)">No templates yet. Add one or load samples.</div>`; return; }
  w.innerHTML = names.map(n=>{
    const t=state.templates[n];
    return `<div class="template" data-name="${n}">
  <div class="template-row">
    <label>Name</label>
    <input data-f="name" value="${t.name}">
  </div>
  <div class="template-row">
    <label>New code</label>
    <select data-f="work_code">${groupCodeSelect(t.work_code||'DEB Email')}</select>
  </div>
  <div class="template-row">
    <label>Start / Finish</label>
    <div class="field-group">
      <input type="time" data-f="start_time" value="${(t.start_time||'').slice(0,5)}">
      <input type="time" data-f="finish_time" value="${(t.finish_time||'').slice(0,5)}">
    </div>
  </div>
  <div class="template-row">
    <label>Breaks</label>
    <div class="break-group">
      <input type="time" data-f="break1" value="${(t.break1||'').slice(0,5)}" title="Break 1 (15m)">
      <input type="time" data-f="lunch" value="${(t.lunch||'').slice(0,5)}" title="Lunch (30m)">
      <input type="time" data-f="break2" value="${(t.break2||'').slice(0,5)}" title="Break 2 (15m)">
    </div>
  </div>
  <div class="template-actions">
    <button class="btn btn-duplicate" data-dup="${n}">Duplicate</button>
    <button class="btn btn-delete" data-del="${n}">Delete</button>
  </div>
</div>`;
  }).join('');

  // Bind updates
  $$('#templWrap .template').forEach(box=>{
    const orig=box.dataset.name;
    box.querySelector('[data-dup]').onclick=async()=>{
      const nn=prompt('Duplicate as…', orig+' Copy'); if(!nn) return;
      const src=state.templates[orig]; const row=Object.assign({},src,{name:nn});
      const {error}=await sb.from('templates').upsert(row,{onConflict:'name'});
      if(error) alert(error.message); else loadTemplates();
    };
    box.querySelector('[data-del]').onclick=async()=>{
      if(!confirm(`Delete template "${orig}"?`)) return;
      const {error}=await sb.from('templates').delete().eq('name',orig);
      if(error) alert(error.message); else loadTemplates();
    };
    $$('input,select',box).forEach(inp=>{
      const f=inp.dataset.f; if(!f) return;
      inp.onchange=async()=>{
        const row=Object.assign({}, state.templates[orig]); row[f]=inp.value||null;
        if(f==='name' && row.name && row.name!==orig){
          await sb.from('templates').delete().eq('name', orig);
          const {error}=await sb.from('templates').insert([row]);
          if(error) alert(error.message); else loadTemplates();
        }else{
          const {error}=await sb.from('templates').update(row).eq('name', orig);
          if(error) alert(error.message);
        }
      };
    });
  });
}
$('#btnAddTemplate').onclick=async()=>{
  const name=prompt('Template name','Early'); if(!name) return;
  const row={name,work_code:'DEB Email',start_time:'07:00',finish_time:'16:00',break1:'09:15',lunch:'12:00',break2:'15:15'};
  const {error}=await sb.from('templates').upsert(row,{onConflict:'name'});
  if(error) alert(error.message); else loadTemplates();
};
$('#btnLoadSamples').onclick=async()=>{
  const sample=[
    {name:'Early',  work_code:'DEB Email', start_time:'07:00', finish_time:'16:00', break1:'09:15', lunch:'12:00', break2:'15:15'},
    {name:'Middle', work_code:'Mirakl',    start_time:'11:00', finish_time:'20:00', break1:'11:30', lunch:'15:30', break2:'17:45'},
    {name:'Late',   work_code:'PLT Social',start_time:'12:00', finish_time:'21:00', break1:'13:15', lunch:'17:00', break2:'19:15'},
  ];
  for(const r of sample){ await sb.from('templates').upsert(r,{onConflict:'name'}); }
  loadTemplates();
};

/* ========= Assignment ========= */
function rebuildAssignTable(){
  const body=$('#assignBody');
  const lid=$('#leaderSel').value;
  const team=state.advisors.filter(a=>String(a.leader_id)===String(lid)).sort((a,b)=>a.name.localeCompare(b.name));
  const rows = ($('#viewSel').value==='TEAM_SELECTED' && state.selectedNames.size)? team.filter(a=>state.selectedNames.has(a.name)) : team;

  if(!rows.length){ body.innerHTML='<tr><td colspan="8" style="text-align:left;color:var(--muted)">Pick advisors on the right.</td></tr>'; return; }

  const opts = `<option value="">(none)</option>` + Object.keys(state.templates).sort().map(n=>`<option>${n}</option>`).join('');
  body.innerHTML = rows.map(adv=>{
    const tds = DAYS.map((_,di)=>{
      const key=`${adv.id}-${di}`; const cur=state.assigned.get(key)||'';
      return `<td><select data-assign="${adv.id}" data-di="${di}">${opts.replace(`>${cur}<`,` selected>${cur}<`)}</select></td>`;
    }).join('');
    return `<tr><td class="name">${adv.name}</td>${tds}</tr>`;
  }).join('');

  $$('#assignBody select[data-assign]').forEach(sel=>{
    sel.onchange=()=>{ const k=`${sel.dataset.assign}-${sel.dataset.di}`; if(sel.value) state.assigned.set(k,sel.value); else state.assigned.delete(k); };
  });
}

/* ========= Generate & Render ========= */
$('#btnGenerate').onclick=()=>renderTimeline(true);

/* Debug flag */
// DEBUG already declared above

/* Time parsing */
function parseMinutes(time) {
  if (!time) return null;
  
  // Handle "7" -> "07:00"
  if (/^\d{1,2}$/.test(time)) time = `${time.padStart(2,'0')}:00`;
  
  const match = time.match(/^(\d{1,2}):(\d{2})$/);
  if (!match) {
    DEBUG && console.warn(`Invalid time format: ${time}`);
    return null;
  }
  
  const h = parseInt(match[1]), m = parseInt(match[2]);
  if (isNaN(h) || isNaN(m) || h < 0 || h > 23 || m < 0 || m > 59) {
    DEBUG && console.warn(`Invalid time values: ${h}:${m}`);
    return null;
  }
  
  return h * 60 + m;
}

/* Segment building */
function buildSegments(template) {
  const s = parseMinutes(template.start_time);
  const e = parseMinutes(template.finish_time);
  if (!s || !e) {
    DEBUG && console.warn('Invalid start/end time in template:', template);
    return [];
  }

  const breaks = [
    { time: parseMinutes(template.break1), dur: 15, type: 'Break' },
    { time: parseMinutes(template.lunch), dur: 30, type: 'Lunch' },
    { time: parseMinutes(template.break2), dur: 15, type: 'Break' }
  ].filter(b => b.time !== null).sort((a,b) => a.time - b.time);
  
  const segs = [];
  let lastEnd = s;
  
  breaks.forEach(br => {
    if (lastEnd < br.time) {
      segs.push({
        type: 'Work',
        code: template.work_code,
        start: lastEnd,
        end: br.time
      });
    }
    segs.push({
      type: br.type,
      code: br.type,
      start: br.time,
      end: br.time + br.dur
    });
    lastEnd = br.time + br.dur;
  });
  
  if (lastEnd < e) {
    segs.push({
      type: 'Work',
      code: template.work_code,
      start: lastEnd,
      end: e
    });
  }
  
  return segs;
}

/* Timeline rendering */
function renderTimeline(fromAssignments=false) {
  const body = $('#tlBody');
  body.innerHTML = '';
  
  const lid = $('#leaderSel').value;
  const team = state.advisors.filter(a => String(a.leader_id) === String(lid))
    .sort((a,b) => a.name.localeCompare(b.name));
  
  const rows = ($('#viewSel').value === 'TEAM_SELECTED' && state.selectedNames.size)
    ? team.filter(a => state.selectedNames.has(a.name))
    : team;
    
  if (!rows.length) {
    DEBUG && console.warn('No rows to render');
    return;
  }
  
  rows.forEach(adv => {
    const r = document.createElement('div');
    r.className = 'row';
    r.style.height = '44px';
    r.style.position = 'relative';
    r.style.overflow = 'visible';
    
    // Get badge
    let badge = '';
    for(let di=0; di<7; di++) {
      const tName = state.assigned.get(`${adv.id}-${di}`);
      if(tName) {
        badge = TEMPLATE_BADGE(tName);
        break;
      }
    }
    
    r.innerHTML = `
      <div class="rname">
        ${adv.name}
        ${badge ? `<span class="badge-sm">${badge}</span>` : ''}
      </div>
      <div class="rline" data-row="${adv.id}"></div>
    `;
    
    body.appendChild(r);
    
    // Add segments for each day
    DAYS.forEach((_, di) => {
      const tName = state.assigned.get(`${adv.id}-${di}`);
      if (!tName || !state.templates[tName]) return;
      
      const segs = buildSegments(state.templates[tName]);
      if (!segs.length) {
        DEBUG && console.warn(`No segments for ${adv.name} on day ${di}`);
        return;
      }
      
      segs.forEach(seg => {
        const start = seg.start + di*1440;
        const end = seg.end + di*1440;
        const p = spanPct(start, end);
        
        const el = document.createElement('div');
        el.className = `bar ${clsFor(seg.code)}`;
        el.style.left = `${p.left}%`;
        el.style.width = `${p.width}%`;
        el.dataset.type = seg.type;
        el.dataset.code = seg.code;
        el.dataset.start = seg.start;
        el.dataset.end = seg.end;
        el.dataset.tt = `${seg.code}\n${seg.type}\n${m2hhmm(seg.start)}–${m2hhmm(seg.end)}`;
        
        r.lastElementChild.appendChild(el);
      });
    });
  });

  initTimeGuide();
  initBarEdit();
  drawNowLine();
}

// Make renderer globally available
window.renderTimeline = renderTimeline;

/* Add data loading functions */
async function loadSites() {
  console.time('loadSites');
  const {data, error} = await sb.from('sites').select('id,name').order('name');
  console.timeEnd('loadSites');
  
  if (error) {
    console.error('Failed to load sites:', error);
    showMessage('Failed to load sites');
    return [];
  }
  
  if (!data?.length) {
    console.warn('No sites found');
    showMessage('No sites found');
    return [];
  }
  
  console.log('First 3 sites:', data.slice(0,3));
  return data;
}

async function loadLeaders(siteId) {
  console.time('loadLeaders');
  const {data, error} = await sb.from('leaders')
    .select('id,name,site_id')
    .eq('site_id', siteId)
    .order('name');
  console.timeEnd('loadLeaders');
  
  if (error) {
    console.error('Failed to load leaders:', error);
    showMessage(`Failed to load leaders for site ${siteId}`);
    return [];
  }
  
  if (!data?.length) {
    console.warn(`No leaders found for site ${siteId}`);
    showMessage(`No leaders found for site ${siteId}`);
    return [];
  }
  
  console.log('First 3 leaders:', data.slice(0,3));
  return data;
}

async function loadTeams(leaderId) {
  console.time('loadTeams');
  const {data, error} = await sb.from('advisors')
    .select('id,name,leader_id')
    .eq('leader_id', leaderId)
    .order('name');
  console.timeEnd('loadTeams');
  
  if (error) {
    console.error('Failed to load team:', error);
    showMessage(`Failed to load team for leader ${leaderId}`);
    return [];
  }
  
  if (!data?.length) {
    console.warn(`No team found for leader ${leaderId}`);
    showMessage(`No team found for leader ${leaderId}`);
    return [];
  }
  
  console.log('First 3 team members:', data.slice(0,3));
  return data;
}

async function loadAssignments(leaderId, weekStart) {
  console.time('loadAssignments');
  const {data, error} = await sb.from('rotas')
    .select('advisor_id,week_start,data')
    .eq('week_start', weekStart)
    .eq('leader_id', leaderId);
  console.timeEnd('loadAssignments');
  
  if (error) {
    console.error('Failed to load assignments:', error);
    showMessage('Failed to load assignments');
    return [];
  }
  
  if (!data?.length) {
    console.warn('No assignments found');
    showMessage('No assignments found for this week');
    return [];
  }
  
  console.log('First 3 assignments:', data.slice(0,3));
  return data;
}

function showMessage(text, timeout = 3000) {
  const banner = $('#msgBanner');
  banner.textContent = text;
  banner.style.display = 'block';
  setTimeout(() => banner.style.display = 'none', timeout);
}

function showError(msg) {
  const el = document.getElementById('msgBanner');
  if (el) {
    el.textContent = msg;
    el.style.display = 'block';
    el.style.background = '#fff3cd';
    el.style.color = '#856404';
    el.setAttribute('data-type', 'error');
  }
  console.error(msg);
}

function showInfo(msg) {
  const el = document.getElementById('msgBanner');
  if (el) {
    el.textContent = msg;
    el.style.display = 'block';
    el.style.background = '#d4edda';
    el.style.color = '#155724';
    el.setAttribute('data-type', 'info');
  }
  console.info(msg);
}

/* Week parsing */
function parseWeekInput() {
  const input = $('#weekInput').value;
  if (!input) {
    const now = new Date();
    return {
      year: now.getFullYear(),
      month: now.getMonth() + 1,
      day: now.getDate(),
      weekStartDate: toMonday(now)
    };
  }
  try {
    const [y,m,d] = input.split('-').map(Number);
    const date = new Date(y, m-1, d);
    if (isNaN(date.getTime())) throw new Error('Invalid date');
    return {
      year: y,
      month: m,
      day: d,
      weekStartDate: toMonday(date)
    };
  } catch (err) {
    showError('Invalid week selected. Using current week.');
    return parseWeekInput(); // recurse to get default
  }
}

/* DOM fallbacks */
function loadAssignmentsFromDOM() {
  const assignments = [];
  const rows = $$('#assignTbl tr').slice(1); // skip header
  
  rows.forEach(row => {
    const advisorName = row.querySelector('.name').textContent;
    const daySelects = row.querySelectorAll('select[data-assign]');
    
    daySelects.forEach((sel, day) => {
      const templateName = sel.value;
      if (templateName && templateName !== '(none)') {
        assignments.push({
          advisorId: advisorName,
          day,
          templateName,
          site: $('#siteSel').value,
          leader: $('#leaderSel').value
        });
      }
    });
  });
  
  return assignments;
}

function loadTemplatesFromDOM() {
  const templates = [];
  $$('.template').forEach(card => {
    const template = {
      name: card.querySelector('[data-f="name"]').value,
      work_code: card.querySelector('[data-f="work_code"]').value,
      start_time: card.querySelector('[data-f="start_time"]').value,
      finish_time: card.querySelector('[data-f="finish_time"]').value,
      breaks: [
        card.querySelector('[data-f="break1"]').value,
        card.querySelector('[data-f="lunch"]').value,
        card.querySelector('[data-f="break2"]').value
      ].filter(t => t)
    };
    if (template.name && template.start_time && template.finish_time) {
      templates.push(template);
    }
  });
  return templates;
}

/* Enhanced loaders with fallbacks */
async function loadTemplates() {
  try {
    console.time('loadTemplates');
    const {data, error} = await sb.from('templates').select('*');
    console.timeEnd('loadTemplates');
    
    if (error) throw error;
    if (!data?.length) {
      showInfo('No templates in database, using local templates.');
      return loadTemplatesFromDOM();
    }
    
    return data;
  } catch (err) {
    showError(`Templates load failed: ${err.message}`);
    return loadTemplatesFromDOM();
  }
}

async function loadAssignments() {
  try {
    console.time('loadAssignments');
    const week = parseWeekInput();
    const {data, error} = await sb.from('rotas')
      .select('advisor_id,week_start,data')
      .eq('week_start', isoLocal(week.weekStartDate))
      .eq('leader_id', $('#leaderSel').value);
    console.timeEnd('loadAssignments');
    
    if (error) throw error;
    if (!data?.length) {
      return loadAssignmentsFromDOM();
    }
    
    return data;
  } catch (err) {
    showError(`Assignments load failed: ${err.message}`);
    return loadAssignmentsFromDOM();
  }
}

/* Row building */
function buildRowsFrom(assignments, templates) {
  const rows = new Map(); // advisorId -> row
  
  assignments.forEach(assignment => {
    const template = templates.find(t => t.name === assignment.templateName);
    if (!template) return;
    
    let row = rows.get(assignment.advisorId);
    if (!row) {
      row = {
        advisorId: assignment.advisorId,
        name: assignment.advisorId,
        segments: []
      };
      rows.set(assignment.advisorId, row);
    }
    
    const daySegments = buildSegments(template).map(seg => ({
      ...seg,
      day: assignment.day
    }));
    
    row.segments.push(...daySegments);
  });
  
  const result = Array.from(rows.values());
  console.log(`Built ${result.length} rows with ${result.reduce((sum,r) => sum + r.segments.length, 0)} segments`);
  return result;
}

// Replace Generate button handler
$('#btnGenerate').onclick = async () => {
  try {
    const templates = await loadTemplates().catch(() => loadTemplatesFromDOM());
    if (!templates.length) {
      showError('No templates available. Add some templates first.');
      return;
    }
    
    const assignments = await loadAssignments().catch(() => loadAssignmentsFromDOM());
    if (!assignments.length) {
      showInfo('No assignments found for this week.');
      $('#tlBody').innerHTML = '';
      return;
    }
    
    const rows = buildRowsFrom(assignments, templates);
    if (!rows.length) {
      showInfo('Nothing to render for selected filters.');
      $('#tlBody').innerHTML = '';
      return;
    }
    
    renderTimeline(rows);
    showInfo('Schedule generated.');
    
  } catch (err) {
    showError(`Generate failed: ${err.message}`);
    console.error(err);
  }
};

(async function init() {
  try {
    await loadOrg();
    await loadTemplates();
  } catch (err) {
    showError('Initialization error: ' + err.message);
    console.error('Init failed:', err);
  }
})();
</script>
</body>
</html>
