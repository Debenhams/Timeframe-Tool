<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Professional Team Rota System ‚Äî Supabase</title>

  <!-- Full-width, tidy base -->
  <style>
    :root{
      --brand:#0d47a1; --accent:#00c853; --ink:#1f2937; --paper:#ffffff; --wash:#f5f7fb; --line:#e4e9f2;
      --timeline-start:7; --timeline-end:20; --timeline-height:800px;
      --color-email:#2ecc71; --color-mirakl:#b1b51e; --color-social:#5e35b1;
      --color-overtime:#e53935; --color-meeting:#ffd700; --color-break:#cfd8dc; --color-lunch:#b0bec5;
      --color-absence:#b0c4de; --color-shrink:#ffd166;
    }
    html,body{height:100%}
    body{
      margin:0; background:#ffffff; color:var(--ink);
      font-family:Inter,Roboto,Segoe UI,system-ui,Arial,Helvetica,sans-serif;
    }
    .topbar{
      background:var(--brand); color:#fff; padding:14px 18px;
      display:flex; align-items:center; gap:14px;
      box-shadow:0 4px 14px rgba(13,71,161,.18)
    }
    .topbar h1{margin:0; font-size:18px; font-weight:800}
    /* Full-width content with small safe padding */
    .layout{
      display:grid; grid-template-columns:1fr 360px; gap:18px;
      max-width:none; width:100%; margin:18px auto; padding:0 12px;
      box-sizing:border-box;
    }
    .panel{background:var(--paper); border:1px solid var(--line); border-radius:12px; box-shadow:0 8px 20px rgba(12,27,74,.06)}
    .panel-header{display:flex; align-items:center; justify-content:space-between; padding:10px 14px; border-bottom:1px solid var(--line)}
    .panel-header h2{margin:0; font-size:15px}
    .panel-body{padding:12px 14px}
    .muted{color:#64748b}
    .btn{background:var(--accent); color:#fff; border:0; border-radius:10px; padding:9px 12px; font-weight:800; cursor:pointer}
    .btn:hover{filter:brightness(.95)}
    .btn.subtle{background:#e9eef6; color:#0f172a}
    .btn.icon{padding:7px 9px}
    .input, select, input[type=date]{padding:8px 10px; border:1px solid var(--line); border-radius:10px; background:#fff}
    .seg{display:inline-flex; border:1px solid var(--line); border-radius:10px; overflow:hidden}
    .seg button{background:#fff; border:0; padding:8px 12px; cursor:pointer}
    .seg button.active{background:#1e5fe0; color:#fff}

    /* Hide (but keep in DOM) */
    .visually-hidden{display:none!important}

    /* Tables */
    .table-wrap{overflow:auto}
    table{width:100%; border-collapse:collapse; min-width:900px}
    th,td{border:1px solid var(--line); padding:8px; text-align:center}
    thead th{background:#0d47a1; color:#fff; font-weight:800}
    td.name{position:sticky; left:0; background:#e8f1ff; font-weight:800}

    /* Planner header/body containers (horizontal) */
    .planner{border:1px solid var(--line); border-radius:12px; overflow:hidden; margin-top:16px; background:#fff}
    .planner__header{display:flex; background:#f6f8fb; border-bottom:1px solid var(--line); position:sticky; top:0; z-index:2}
    .planner__col--name{width:260px; min-width:260px; padding:7px 10px; font-weight:800; border-right:1px solid var(--line)}
    .planner__col--time{flex:1}
    .planner__body{display:flex; flex-direction:column}
    .planner__row{display:flex; border-bottom:1px solid var(--line); position:relative; height:44px}
    .planner__row:nth-child(odd){background:#fbfdff}
    .planner__name{width:260px; min-width:260px; padding:8px 10px; border-right:1px solid var(--line); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; display:flex; align-items:center; gap:8px}
    .planner__timeline{position:relative; flex:1; height:44px; background:linear-gradient(#f6f8fb 1px,transparent 1px) 0 0/60px 44px}
    .planner__bar{position:absolute; height:20px; top:12px; border-radius:3px; z-index:3; opacity:.95; cursor:pointer; transition:opacity .15s}
    .planner__bar:hover{opacity:1}
    .planner__badge{font-size:12px; line-height:18px; padding:0 6px; border-radius:6px; background:#eef2f7; color:#374151}

    /* time header scale */
    .time-scale{position:relative; height:24px}
    .time-scale .tick{position:absolute; top:0; font-size:11px; transform:translateX(-50%); color:#6b7280}

    /* color classes kept for bars */
    .c-email{background:var(--color-email)}
    .c-mirakl{background:var(--color-mirakl)}
    .c-social{background:var(--color-social)}
    .c-break{background:var(--color-break); color:#213}
    .c-lunch{background:var(--color-lunch); color:#213}
    .c-overtime{background:var(--color-overtime)}
    .c-absence{background:var(--color-absence)}
    .c-shrink{background:var(--color-shrink); color:#213}
  </style>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <!-- Top bar -->
  <div class="topbar">
    <h1>Professional Team Rota System</h1>
    <div class="seg" style="margin-left:auto">
      <button class="active" id="segWeek">Week</button>
      <button id="segMonth" disabled class="muted">Month</button>
    </div>
    <button class="btn subtle no-print" id="btnPrint">üñ®Ô∏è Print</button>
  </div>

  <div class="layout">
    <!-- MAIN COLUMN -->
    <div style="display:flex; flex-direction:column; gap:18px">

      <!-- Controls -->
      <div class="panel">
        <div class="panel-body" style="display:flex; flex-wrap:wrap; gap:10px 12px; align-items:center">
          <label>Week start (Monday)</label>
          <input type="date" id="weekStart" class="input"/>

          <label>View</label>
          <select id="advisorSelect" class="input"></select>

          <label id="lblTeamDay" class="muted">Day</label>
          <select id="teamDay" class="input">
            <option>Monday</option><option>Tuesday</option><option>Wednesday</option><option>Thursday</option>
            <option>Friday</option><option>Saturday</option><option>Sunday</option>
          </select>

          <button class="btn" id="btnGenerate">Generate</button>
          <button class="btn subtle" id="btnPublish">Publish</button>

          <span class="muted" id="rangeLabel" style="margin-left:auto"></span>
        </div>
      </div>

      <!-- Settings / Patterns & New Pattern -->
      <details class="panel collapsible" id="settingsBox" open>
        <summary class="panel-header" style="cursor:pointer">
          <h2>Shift Patterns & Settings</h2><span class="chev">‚ñ∂</span>
        </summary>
        <div class="panel-body">
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:18px; align-items:start">
            <!-- Patterns dropdown (loads ~50 from Supabase) -->
            <div>
              <h3 style="margin:6px 0">üìö Shift Patterns</h3>
              <div class="row" style="display:flex; gap:8px; align-items:center; margin:6px 0 12px">
                <select id="patternSelect" class="input" style="min-width:260px"></select>
                <button class="btn subtle" id="btnUsePattern">Use Pattern</button>
              </div>
              <div id="patternInfo" class="muted"></div>

              <!-- Colours (kept in DOM, hidden) -->
              <h3 class="visually-hidden" style="margin:16px 0 6px">üé® Colours</h3>
              <div id="colorKey" class="visually-hidden"></div>
            </div>

            <!-- Create new pattern -->
            <div>
              <h3 style="margin:6px 0">‚ûï Create New Pattern</h3>
              <div id="newPatternForm" style="display:grid; grid-template-columns:140px 1fr; gap:8px 12px; align-items:center">
                <label>Name</label> <input id="npName" class="input" placeholder="e.g. Early A"/>
                <label>Platform</label>
                <select id="npCode" class="input"></select>
                <label>Start‚ÄìFinish</label>
                <div style="display:flex; gap:8px">
                  <input id="npStart" type="time" class="input" value="07:00"/>
                  <input id="npEnd" type="time" class="input" value="16:00"/>
                </div>
                <label>Breaks</label>
                <div style="display:flex; gap:8px">
                  <input id="npBreak1" type="time" class="input" placeholder="Break 1 (15m)"/>
                  <input id="npLunch"  type="time" class="input" placeholder="Lunch (30m)"/>
                  <input id="npBreak2" type="time" class="input" placeholder="Break 2 (15m)"/>
                </div>
                <div style="grid-column:1/-1; display:flex; gap:8px; justify-content:flex-end; margin-top:4px">
                  <button class="btn" id="btnCreatePattern">Create</button>
                </div>
              </div>
            </div>
          </div>

          <!-- 6-Week Rotation Builder -->
          <div style="margin-top:22px">
            <h3 style="margin:6px 0">üîÅ 6-Week Rotation (Prototype)</h3>
            <div class="row" style="display:flex; gap:8px; align-items:center; margin-bottom:8px">
              <label for="rotName">Rotation name</label>
              <input id="rotName" class="input" placeholder="e.g. Debenhams Team A ‚Äî 6wk"/>
              <button class="btn subtle" id="btnSaveRotation">Save Rotation</button>
              <span class="muted" id="rotSaveMsg"></span>
            </div>
            <div class="table-wrap">
              <table id="rotTable">
                <thead><tr>
                  <th>Week 1</th><th>Week 2</th><th>Week 3</th>
                  <th>Week 4</th><th>Week 5</th><th>Week 6</th>
                </tr></thead>
                <tbody><tr id="rotRow">
                  <td><select class="rotSel"></select></td>
                  <td><select class="rotSel"></select></td>
                  <td><select class="rotSel"></select></td>
                  <td><select class="rotSel"></select></td>
                  <td><select class="rotSel"></select></td>
                  <td><select class="rotSel"></select></td>
                </tr></tbody>
              </table>
            </div>
            <div style="margin-top:8px">
              <label>Saved rotations</label>
              <select id="rotList" class="input" style="min-width:260px"></select>
              <button class="btn subtle" id="btnLoadRotation">Load</button>
              <button class="btn subtle" id="btnDeleteRotation">Delete</button>
            </div>
          </div>

          <!-- Master Assignment (kept as-is so current code keeps working) -->
          <div style="margin-top:22px">
            <h3 style="margin:6px 0">üìÖ Master Assignment (Team)</h3>
            <div class="table-wrap">
              <table id="assignTable">
                <thead>
                  <tr><th rowspan="2">Advisor</th><th colspan="7">Select Shift Template</th></tr>
                  <tr id="dateHeaders"></tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div class="muted" style="margin-top:8px">
              Select a Team Leader or advisors (via top View menu) to populate this table.
            </div>
          </div>
        </div>
      </details>

      <!-- Horizontal Planner -->
      <section id="teamPlanner" class="planner">
        <div class="planner__header">
          <div class="planner__col--name">Name</div>
          <div class="planner__col--time" id="timeHeader"></div>
        </div>
        <div class="planner__body" id="plannerBody"></div>
      </section>

      <!-- Vertical Calendar (kept) -->
      <div class="panel">
        <div class="panel-header">
          <h2 id="calTitle">Advisor Week (Calendar)</h2>
          <div style="display:flex; gap:6px; align-items:center">
            <button class="btn subtle icon" id="prevWeek">‚óÄ</button>
            <button class="btn subtle icon" id="btnToday">Today</button>
            <button class="btn subtle icon" id="nextWeek">‚ñ∂</button>
          </div>
        </div>
        <div class="panel-body">
          <div class="cal-grid" id="calGrid">
            <div class="hour-col"><div id="hours"></div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT SIDEBAR: kept in DOM but hidden -->
    <aside class="panel visually-hidden" id="rightSidebar">
      <div class="panel-header"><h2>Schedules</h2></div>
      <div class="panel-body">
        <div class="tree-search">
          <input id="treeSearch" class="input" placeholder="Select sites / leaders / advisors‚Ä¶" style="flex:1"/>
          <button class="btn subtle" id="btnClearSel">Clear</button>
        </div>
        <div class="tree" id="tree"></div>
        <div style="margin-top:10px; display:flex; flex-wrap:wrap; gap:6px" id="activeChips"></div>
      </div>
    </aside>
  </div>

  <!-- Publish dialog (unchanged) -->
  <dialog id="publishDlg" style="border:1px solid var(--line); border-radius:12px; padding:12px 14px;">
    <div style="font-weight:800; margin-bottom:6px">Publish changes</div>
    <div class="muted" id="publishSummary" style="margin-bottom:8px"></div>
    <div id="publishList" style="max-height:260px; overflow:auto; border:1px solid var(--line); border-radius:10px; padding:8px; background:#fff"></div>
    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:14px">
      <button id="publishOK" class="btn">Publish</button>
      <button onclick="publishDlg.close()" class="btn subtle">Cancel</button>
    </div>
  </dialog>

  <!-- Assign / Split dialog (kept) -->
  <dialog id="assignDlg" style="border:1px solid var(--line); border-radius:12px; padding:12px 14px;">
    <div style="font-weight:800; margin-bottom:6px"><span id="assignTitle">Assign</span></div>
    <div class="row"><label><input type="radio" name="mode" value="template" id="modeTemplate"> Use template</label>
      <label><input type="radio" name="mode" value="split" id="modeSplit"> Use split segments</label>
      <span class="muted" id="modeHint" style="margin-left:6px"></span>
    </div>
    <div id="templateMode">
      <select id="assignSelect" style="width:100%"></select>
      <div style="display:flex; gap:8px; align-items:center; margin-top:8px">
        <button class="btn subtle" id="btnConvertToSplit">Convert this template to editable segments</button>
        <span class="muted">Fast way to tweak just part of the shift.</span>
      </div>
    </div>
    <div id="splitMode" style="display:none">
      <div id="segmentsWrap"></div>
      <div style="display:flex; gap:8px; margin-top:8px">
        <button class="btn subtle" id="addSegment">Ôºã Add segment</button>
        <span class="muted">Each segment = Code + Start‚ÄìEnd.</span>
      </div>
    </div>
    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:14px">
      <button id="assignOK" class="btn">Save</button>
      <button onclick="assignDlg.close()" class="btn subtle">Cancel</button>
    </div>
  </dialog>

  <!-- Block Editor (kept) -->
  <dialog id="blockDlg" style="border:1px solid var(--line); border-radius:12px; padding:12px 14px;">
    <div style="font-weight:800; margin-bottom:6px"><span id="blockTitle">Edit block</span></div>
    <div class="row">
      <label><input type="radio" name="blockmode" value="whole" id="bmWhole"> Edit block</label>
      <label><input type="radio" name="blockmode" value="sub" id="bmSub"> Change part of block</label>
      <span class="muted" id="blockHint" style="margin-left:6px"></span>
    </div>
    <div id="blockWhole">
      <div class="row"><label style="min-width:90px">Code</label><select id="bwCode"></select></div>
      <div class="row"><label style="min-width:90px">Start‚ÄìEnd</label><input type="time" id="bwStart"> <span>‚Äì</span> <input type="time" id="bwEnd"></div>
      <div class="muted">If you shrink the block, we keep the before/after so no gaps appear.</div>
    </div>
    <div id="blockSub" style="display:none">
      <div class="row"><label style="min-width:90px">New code</label><select id="bsCode"></select></div>
      <div class="row"><label style="min-width:90px">Sub-range</label><input type="time" id="bsStart"> <span>‚Äì</span> <input type="time" id="bsEnd"></div>
      <div class="muted">We split into left remainder + your new code + right remainder. Neighbours stay the same.</div>
    </div>
    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:14px">
      <button id="blockOK" class="btn">Save</button>
      <button onclick="blockDlg.close()" class="btn subtle">Cancel</button>
    </div>
  </dialog>

  <!-- Minimal inline glue so the new bits show something immediately.
       Your deeper logic stays in src/planner.js and src/init.js -->
  <script>
    // Supabase client (reuse existing keys if they‚Äôre already defined elsewhere)
    const SUPABASE_URL = window.SUPABASE_URL || "https://oypdnjxhjpgpwmkltzmk.supabase.co";
    const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95cGRuanhoanBncHdta2x0em1rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4Nzk0MTEsImV4cCI6MjA3NTQ1NTQxMX0.Hqf1L4RHpIPUD4ut2uVsiGDsqKXvAjdwKuotmme4_Is";
    window.sb = window.sb || supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Simple platform list fallback (if you don‚Äôt have a separate table)
    const FALLBACK_PLATFORMS = ["Admin","DEB Email","DEB Social","Mirakl","PLT Email","PLT Social","Break","Lunch","Overtime"];

    async function loadPlatformsInto(selectEl){
      try {
        // Try optional 'platforms' table: {name:text}
        const { data, error } = await sb.from('platforms').select('name').order('name');
        const list = (!error && Array.isArray(data) && data.length) ? data.map(x=>x.name) : FALLBACK_PLATFORMS;
        selectEl.innerHTML = list.map(n=>`<option>${n}</option>`).join('');
      } catch { selectEl.innerHTML = FALLBACK_PLATFORMS.map(n=>`<option>${n}</option>`).join(''); }
    }

    async function loadTemplatesInto(selectEl){
      try{
        const { data } = await sb.from('templates').select('*').order('name',{ascending:true});
        const list = (data||[]).map(t=>t.name);
        selectEl.innerHTML = list.map(n=>`<option>${n}</option>`).join('');
      }catch{ selectEl.innerHTML = '<option value="">No patterns found</option>'; }
    }

    function showPatternInfo(name){
      const info = document.getElementById('patternInfo');
      if(!name){ info.textContent=''; return; }
      // Fetch that template and show summary
      sb.from('templates').select('*').eq('name',name).maybeSingle().then(({data})=>{
        if(!data){ info.textContent = ''; return; }
        const fmt = (t)=> (t||'').toString().slice(0,5);
        info.textContent = `${name}: ${fmt(data.start_time)}‚Äì${fmt(data.finish_time)}  ‚Ä¢  Breaks: ${fmt(data.break1)||'‚Äì'} / ${fmt(data.lunch)||'‚Äì'} / ${fmt(data.break2)||'‚Äì'}  ‚Ä¢  Platform: ${data.work_code||'Admin'}`;
      });
    }

    async function createPattern(){
      const name = document.getElementById('npName').value.trim();
      const code = document.getElementById('npCode').value;
      const s = document.getElementById('npStart').value || null;
      const e = document.getElementById('npEnd').value || null;
      const b1= document.getElementById('npBreak1').value || null;
      const ln= document.getElementById('npLunch').value || null;
      const b2= document.getElementById('npBreak2').value || null;
      if(!name || !s || !e){ alert('Name, Start, Finish are required.'); return; }
      const { error } = await sb.from('templates').upsert([{ name, work_code:code, start_time:s, finish_time:e, break1:b1, lunch:ln, break2:b2 }], { onConflict:'name' });
      if(error){ alert('Save failed: '+error.message); return; }
      // refresh dropdowns
      await loadTemplatesInto(document.getElementById('patternSelect'));
      document.querySelectorAll('.rotSel').forEach(loadTemplatesInto);
      alert('Pattern saved.');
    }

    // Rotation persistence: Supabase 'rotations' if available; else localStorage
    async function saveRotation(){
      const name = document.getElementById('rotName').value.trim();
      if(!name){ alert('Give this rotation a name'); return; }
      const weeks = [...document.querySelectorAll('#rotRow .rotSel')].map(s=>s.value||null);
      let ok=false;
      try{
        const { error } = await sb.from('rotations').upsert([{ name, weeks }], { onConflict:'name' });
        if(!error) ok=true;
      }catch{}
      if(!ok){
        const all = JSON.parse(localStorage.getItem('rotations')||'{}');
        all[name]=weeks; localStorage.setItem('rotations', JSON.stringify(all));
      }
      document.getElementById('rotSaveMsg').textContent = 'Saved.';
      await loadRotationList();
    }

    async function loadRotationList(){
      const listEl = document.getElementById('rotList');
      let rows=[];
      try{
        const { data, error } = await sb.from('rotations').select('name').order('name');
        if(!error) rows = data||[];
      }catch{}
      if(!rows.length){
        const all = JSON.parse(localStorage.getItem('rotations')||'{}');
        rows = Object.keys(all).map(n=>({name:n}));
      }
      listEl.innerHTML = rows.map(r=>`<option>${r.name}</option>`).join('');
    }

    async function loadRotation(){
      const name = document.getElementById('rotList').value;
      if(!name) return;
      let weeks=null;
      try{
        const { data } = await sb.from('rotations').select('*').eq('name',name).maybeSingle();
        if(data) weeks=data.weeks;
      }catch{}
      if(!weeks){
        const all = JSON.parse(localStorage.getItem('rotations')||'{}');
        weeks = all[name] || null;
      }
      if(Array.isArray(weeks)){
        document.querySelectorAll('#rotRow .rotSel').forEach((s,i)=>{ s.value = weeks[i]||''; });
      }
    }

    async function deleteRotation(){
      const name = document.getElementById('rotList').value;
      if(!name) return;
      let ok=false;
      try{ const { error } = await sb.from('rotations').delete().eq('name',name); if(!error) ok=true; }catch{}
      if(!ok){
        const all = JSON.parse(localStorage.getItem('rotations')||'{}');
        delete all[name]; localStorage.setItem('rotations', JSON.stringify(all));
      }
      await loadRotationList();
    }

    // Boot the new UI bits quickly; deeper app boot stays in src/init.js
    document.addEventListener('DOMContentLoaded', async()=>{
      // Hide palette explicitly (defensive)
      const key = document.getElementById('colorKey');
      if(key){ key.classList.add('visually-hidden'); const prev = key.previousElementSibling; if(prev) prev.classList.add('visually-hidden'); }
      // Hide right sidebar
      document.getElementById('rightSidebar')?.classList.add('visually-hidden');

      // Populate platform + pattern dropdowns
      await loadPlatformsInto(document.getElementById('npCode'));
      await loadTemplatesInto(document.getElementById('patternSelect'));
      document.querySelectorAll('.rotSel').forEach(loadTemplatesInto);
      await loadRotationList();

      // UI wiring
      document.getElementById('patternSelect').addEventListener('change', e=> showPatternInfo(e.target.value));
      document.getElementById('btnUsePattern').addEventListener('click', ()=>{
        const v = document.getElementById('patternSelect').value;
        if(v){ showPatternInfo(v); alert(`Pattern selected: ${v}`); }
      });
      document.getElementById('btnCreatePattern').addEventListener('click', createPattern);
      document.getElementById('btnSaveRotation').addEventListener('click', saveRotation);
      document.getElementById('btnLoadRotation').addEventListener('click', loadRotation);
      document.getElementById('btnDeleteRotation').addEventListener('click', deleteRotation);
    });
  </script>

  <!-- Your split code (keep these paths the same as your repo) -->
  <script src="src/planner.js"></script>
  <script src="src/init.js"></script>
</body>
</html>