<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Professional Team Rota System</title>
<style>
/* --------------------- VARIABLES --------------------- */
:root {
    --primary-color: #0d47a1;
    --secondary-color: #f5f5f5;
    --accent-color: #00c853;
    --text-light: #ffffff;
    --text-dark: #212121;
    --border-color: #e0e0e0;
    --timeline-height: 1000px;

    --color-emails: #2ecc71;
    --color-mirakl: #ffb300;
    --color-social: #5e35b1;
    --color-overtime: #e53935;
    --color-meeting: #ffd700;
    --color-break: #90a4ae;
    --color-lunch: #ff8f00;
    --color-dayoff: #f4f4f4;
}

/* --------------------- BASE --------------------- */
* { box-sizing: border-box; }
body {
    margin: 0;
    font-family: 'Roboto', sans-serif;
    background: var(--secondary-color);
    color: var(--text-dark);
}
.header {
    background: var(--primary-color);
    color: var(--text-light);
    padding: 28px 36px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.18);
}
.header h1 { margin: 0; font-size: 1.9rem; font-weight: 700; }
.container { padding: 28px; max-width: 1400px; margin: 0 auto; }

/* Controls */
.controls-panel {
    background: var(--text-light);
    padding: 14px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    margin-bottom: 18px;
    display: flex;
    gap: 12px;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
}
input, select { padding: 8px 10px; border: 1px solid var(--border-color); border-radius: 6px; }
button { background: var(--accent-color); color: var(--text-light); border: none; padding: 8px 14px; border-radius: 8px; cursor: pointer; font-weight: 600; }
button.secondary { background: #1976d2; }
button.danger { background: #dc3545; }
.button-group { display: flex; gap: 8px; }
.hidden { display: none !important; }

/* Template Editor */
.template-row {
    display: flex; gap: 10px; align-items: center; padding: 10px;
    border-radius: 6px; border: 1px solid #cfd8dc; background: var(--secondary-color);
    flex-wrap: wrap; margin-bottom: 10px;
}
.template-row input[type="time"]{width:110px}
.template-row input[type="text"]{width:120px}
.template-row select{width:130px;padding:6px}

/* Master Table */
.master-table-container { overflow: auto; background: var(--text-light); border-radius: 8px; padding: 0; margin-bottom: 16px; box-shadow:0 4px 12px rgba(0,0,0,0.05); }
table.master-table { width: 100%; border-collapse: collapse; min-width: 760px; }
table.master-table th, table.master-table td { border:1px solid var(--border-color); padding:8px; text-align:center; }
table.master-table th { background: var(--primary-color); color: var(--text-light); font-weight: 600; }
td.advisor-name-cell { text-align:left; font-weight:700; background:#e3f2fd; color: var(--text-dark); width:200px; }

/* Timeline */
#timeline-container { background: var(--text-light); padding: 12px; border-radius: 8px; box-shadow: 0 8px 16px rgba(0,0,0,0.08); overflow:auto; }
.timeline-grid { display:grid; position: relative; gap:0; align-items:start; }
.time-axis{ padding-right:10px; text-align:right; border-right:1px solid var(--border-color); position:relative; background:var(--text-light); }
.time-label{ position:absolute; font-size:0.8em; transform:translateY(-50%); left:0; width:100%; padding-right:6px; color:#616161; border-bottom:1px dashed #e0e0e0; }
.advisor-header{ padding:10px 6px; text-align:center; font-weight:700; background:var(--primary-color); color:var(--text-light); position:sticky; top:0; z-index:20; border:1px solid var(--border-color); }
.day-cell{ position:relative; border:1px solid var(--border-color); height: var(--timeline-height); overflow:hidden; background:transparent; }
.activity-block{ position:absolute; left:6%; width:88%; color:var(--text-light); padding:4px 2px; border-radius:6px; font-size:0.75em; display:flex; flex-direction:column; align-items:center; justify-content:center; box-shadow:0 1px 3px rgba(0,0,0,0.15); font-weight:600; cursor:help; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.activity-time{ font-size:0.7em; font-weight:400; display:block; opacity:0.95; }
.day-off-label{ position:absolute; top:50%; transform:translateY(-50%); width:100%; text-align:center; color:#bdbdbd; font-size:1.05em; font-weight:700; }

/* Color key */
.color-key-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.color-input-group{display:flex;gap:8px;align-items:center;}
.color-example{display:inline-block;width:18px;height:18px;border-radius:4px;border:1px solid rgba(0,0,0,0.08);}

/* Print */
@media print{ .header,.controls-panel,button{display:none !important} body{background:#fff} }

/* Small screens */
@media(max-width:820px){ .controls-panel{flex-direction:column;align-items:stretch} .template-row{flex-direction:column;align-items:stretch} }
</style>
</head>
<body>
<div class="header"><h1>Professional Team Rota System</h1></div>
<div class="container">

<div class="controls-panel">
<div style="display:flex;gap:12px;align-items:center">
<label style="font-weight:700">Week Start Date (Monday):</label>
<input id="start-date" type="date" onchange="updateDates()" />
</div>
<div class="button-group">
<button onclick="saveData(true)">üíæ Save & Download</button>
<button class="secondary" onclick="toggleSettings()">‚öôÔ∏è Settings/Templates</button>
<button onclick="renderTimeline()">üöÄ Generate Timeline</button>
</div>
</div>

<div id="settings-area" class="controls-panel hidden" style="align-items:flex-start">
<div style="width:50%">
<h2>üõ†Ô∏è Shift Template Builder</h2>
<div id="template-editor" style="padding:10px"></div>
<div style="margin-top:8px">
<button onclick="addTemplate()">‚ûï Add New Template</button>
<button class="danger" onclick="resetTemplates()" style="margin-left:8px">Reset Templates</button>
</div>
</div>
<div style="width:45%">
<h2>üé® Activity Color Key</h2>
<div class="color-key-grid" style="padding:10px;background:var(--secondary-color);border-radius:6px" id="color-key"></div>
</div>
</div>

<h2>üìä Timeline View</h2>
<div style="margin-bottom:10px">
<label>Select View:</label>
<select id="view-select" onchange="renderTimeline()">
<option value="team-day">Team Day Rota</option>
<option value="advisor-week">Single Advisor Week</option>
<option value="advisor-day">Single Advisor Day</option>
</select>
<select id="advisor-select" onchange="renderTimeline()" class="hidden"></select>
</div>
<div id="timeline-container"><div class="timeline-grid" id="timeline-grid"><p style="padding:20px;text-align:center;color:var(--text-dark)">No schedule generated yet.</p></div></div>
<div style="margin-top:12px">
<button onclick="printTimeline()">üñ®Ô∏è Download/Print Timeline</button>
</div>
</div>

<script>
/* =================================
   CONFIG
================================= */
const ADVISORS=[];
const DAYS=['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
const BREAK_SLOTS=['Break1','Lunch','Break2'];
const PLATFORM_ACTIVITIES=['Emails','Mirakl','Social','Overtime','Meeting'];
let shiftTemplates={};
let masterRotaData={};
const STORAGE_KEY='ultraFastRotasV5';
const START_HOUR=7, END_HOUR=20;
const TIMELINE_HEIGHT_PX=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--timeline-height'))||1000;
const HEIGHT_PER_HOUR = TIMELINE_HEIGHT_PX/(END_HOUR-START_HOUR);
const HEIGHT_PER_MINUTE=HEIGHT_PER_HOUR/60;

/* ===========================
   UTILITIES
=========================== */
function clamp(n,a,b){return Math.min(b,Math.max(a,n));}
function toggleSettings(){document.getElementById('settings-area').classList.toggle('hidden');}
function escapeHtml(str){return str?String(str).replace(/[&<>"]/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s])):'';}
function escapeJs(str){return str?String(str).replace(/'/g,"\\'") : '' ;}
function timeToPosition(time){if(!time) return null; const [h,m]=time.split(':').map(Number); const px=(h*60+m - START_HOUR*60)*HEIGHT_PER_MINUTE; return clamp(px,0,TIMELINE_HEIGHT_PX);}

/* ===========================
   TEMPLATE MANAGEMENT
=========================== */
function addTemplate(){
 const idx=Object.keys(shiftTemplates).length+1;
 const t={name:`Shift${idx}`,Start:'09:00',Finish:'17:30',Break1:'11:30',Lunch:'13:00',Break2:'15:30',Platform:'Emails'};
 shiftTemplates[t.name]=t;
 populateTemplateEditor(); saveToLocalStorage(); renderTimeline();
}
function resetTemplates(){if(!confirm('Reset templates and rotas?')) return; shiftTemplates={}; masterRotaData={}; populateTemplateEditor(); saveToLocalStorage(); renderTimeline();}
function populateTemplateEditor(){
 const editor=document.getElementById('template-editor'); editor.innerHTML='';
 Object.keys(shiftTemplates).forEach(k=>{
 const t=shiftTemplates[k];
 const row=document.createElement('div'); row.className='template-row';
 row.innerHTML=`<label>Name</label><input type='text' value='${escapeHtml(t.name)}' oninput="updateTemplate('${escapeJs(k)}','name',this.value)" />
<label>Shift</label><input type='time' value='${t.Start}' onchange="updateTemplate('${escapeJs(t.name)}','Start',this.value)" /><input type='time' value='${t.Finish}' onchange="updateTemplate('${escapeJs(t.name)}','Finish',this.value)" />
<label>Breaks</label><input type='time' value='${t.Break1}' onchange="updateTemplate('${escapeJs(t.name)}','Break1',this.value)" /><input type='time' value='${t.Lunch}' onchange="updateTemplate('${escapeJs(t.name)}','Lunch',this.value)" /><input type='time' value='${t.Break2}' onchange="updateTemplate('${escapeJs(t.name)}','Break2',this.value)" />
<label>Platform</label><select onchange="updateTemplate('${escapeJs(t.name)}','Platform',this.value)">${PLATFORM_ACTIVITIES.map(p=>`<option ${t.Platform===p?'selected':''} value='${p}'>${p}</option>`).join('')}</select>
<button class='danger' onclick="deleteTemplate('${escapeJs(t.name)}')">X</button>`;
 editor.appendChild(row);
 });
 populateColorKey();
}
function updateTemplate(old,key,value){
 if(!shiftTemplates[old]) return;
 if(key==='name'){let newName=value.trim()||old; if(newName!==old){shiftTemplates[newName]={...shiftTemplates[old],name:newName}; delete shiftTemplates[old]; masterRotaData=Object.fromEntries(Object.entries(masterRotaData).map(([a,d])=>[a,Object.fromEntries(Object.entries(d).map(([day,obj])=>[day,{...obj,template:obj.template===old?newName:obj.template}]))]));}}
 else{shiftTemplates[old][key]=value;}
 populateTemplateEditor(); saveToLocalStorage(); renderTimeline();}
function deleteTemplate(name){if(!shiftTemplates[name]) return;if(!confirm('Delete template?')) return;delete shiftTemplates[name]; populateTemplateEditor(); renderTimeline();}
function populateColorKey(){
 const keyDiv=document.getElementById('color-key'); keyDiv.innerHTML='';
 ['emails','mirakl','social','overtime','meeting','break','lunch'].forEach(act=>{
 const div=document.createElement('div'); div.className='color-input-group';
 div.innerHTML=`<span class='color-example' data-activity='${act}' style='background:${getComputedStyle(document.documentElement).getPropertyValue('--color-'+act)}'></span>
 <label>${act.charAt(0).toUpperCase()+act.slice(1)}:</label>
 <input type='text' value='${getComputedStyle(document.documentElement).getPropertyValue('--color-'+act)}' oninput='updateColors()' />`;
 keyDiv.appendChild(div);
 });
}
function updateColors(){document.querySelectorAll('#color-key input').forEach(inp=>{const act=inp.previousElementSibling.getAttribute('data-activity'); document.documentElement.style.setProperty('--color-'+act,inp.value);}); renderTimeline();}

/* ===========================
   MASTER ROTA
=========================== */
function ensureMasterRota(){ADVISORS.forEach(a=>{if(!masterRotaData[a]) masterRotaData[a]={}; DAYS.forEach(d=>{if(!masterRotaData[a][d]) masterRotaData[a][d]={template:'';});});}
)
}
function saveAssignment(advisor,day,template){if(!masterRotaData[advisor]) masterRotaData[advisor]={}; masterRotaData[advisor][day]={template:template}; saveToLocalStorage(); renderTimeline();}

/* ===========================
   TIMELINE RENDER
=========================== */
function processTemplate(template){if(!template||!template.Start||!template.Finish) return[];
 const events=[{time:template.Start,type:'start'},{time:template.Finish,type:'finish'}];
 BREAK_SLOTS.forEach(b=>{if(template[b]) events.push({time:template[b],type:b,duration:b==='Lunch'?45:15});});
 events.sort((a,b)=>a.time.localeCompare(b.time));
 let cursor=template.Start; const activities=[];
 events.forEach(ev=>{
 if(ev.time>cursor&&ev.type!=='finish'){activities.push({activity:template.Platform,start:cursor,end:ev.time});}
 if(ev.duration){const temp=new Date(`2000-01-01T${ev.time}:00`); temp.setMinutes(temp.getMinutes()+ev.duration); activities.push({activity:ev.type==='Break1'||ev.type==='Break2'?'Break':ev.type,start:ev.time,end:temp.toTimeString().substring(0,5)}); cursor=temp.toTimeString().substring(0,5);} else cursor=ev.time;
 });
 return activities.filter(a=>timeToPosition(a.start)!==null && timeToPosition(a.end)!==null && timeToPosition(a.end)-timeToPosition(a.start)>=4);
}
function renderTimeline(){
 const grid=document.getElementById('timeline-grid'); grid.innerHTML='';
 const view=document.getElementById('view-select').value;
 const advisorSel=document.getElementById('advisor-select');
 advisorSel.classList.add('hidden');
 if(view!=='team-day') advisorSel.classList.remove('hidden');
 ensureMasterRota();
 if(ADVISORS.length===0){grid.innerHTML='<p style="padding:20px;text-align:center;color:#333">No advisors available</p>'; return;}
 let advisorsToShow=[];
 if(view==='team-day'){advisorsToShow=ADVISORS;} else if(advisorSel.value){advisorsToShow=[advisorSel.value];} else{advisorsToShow=[ADVISORS[0]];}
 grid.style.gridTemplateColumns=`80px repeat(${advisorsToShow.length},
