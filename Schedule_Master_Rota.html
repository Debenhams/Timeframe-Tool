<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Professional Team Rota System</title>
<style>
/* --- THEME & VARIABLES --- */
:root {
    --primary-color: #0d47a1;
    --secondary-color: #fafafa;
    --background-dark: #263238;
    --accent-color: #00c853;
    --text-dark: #212121;
    --text-light: #ffffff;
    --border-color: #e0e0e0;
    --timeline-start: 7;
    --timeline-end: 20;
    --timeline-height: 1000px;

    --color-emails: #2ecc71;
    --color-mirakl: #ffb300;
    --color-social: #5e35b1;
    --color-overtime: #e53935;
    --color-meeting: #ffd700;
    --color-break: #90a4ae;
    --color-lunch: #ff8f00;
    --color-dayoff: #f4f4f4;
}

/* --- BASE & LAYOUT --- */
body { font-family: 'Roboto', sans-serif; margin:0; padding:0; background-color:var(--secondary-color); color:var(--text-dark); }
.header { background-color:var(--primary-color); color:var(--text-light); padding:30px 40px; box-shadow:0 4px 10px rgba(0,0,0,0.2);}
.header h1 { margin:0; font-size:2.4em; font-weight:700;}
.container { padding:40px; max-width:100%; margin:auto;}
h2 { border-bottom:2px solid var(--border-color); padding-bottom:10px; margin-top:30px; color:var(--primary-color);}

/* --- CONTROLS & DATA --- */
.controls-panel { background-color:var(--text-light); padding:20px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1); margin-bottom:20px; display:flex; flex-wrap:wrap; justify-content:space-between;}
input[type="date"], input[type="text"], input[type="time"], select { padding:8px 10px; border:1px solid var(--border-color); border-radius:4px; box-sizing:border-box; transition:border-color 0.2s;}
input:focus, select:focus { border-color:var(--primary-color);}
button { background-color:var(--accent-color); color:var(--text-light); border:none; padding:10px 20px; border-radius:6px; cursor:pointer; font-weight:600; transition: background-color 0.2s;}
button:hover { background-color:#00a040;}
.button-group { display:flex; gap:10px;}
.hidden { display:none !important; }

/* --- TEMPLATE EDITOR --- */
.template-row { display:flex; align-items:center; gap:15px; padding:10px; border:1px solid #cfd8dc; background-color:var(--secondary-color); border-radius:4px; margin-bottom:10px; flex-wrap:wrap;}
.template-row input, .template-row select { padding:5px;}
.template-row button { background-color:#dc3545; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;}
.template-row label { font-size:0.9em; font-weight:600;}
.template-row .time-block { display:flex; gap:5px;}

/* --- MASTER ROTA GRID --- */
.master-table-container { overflow-x:auto; background-color:var(--text-light); border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.05); margin-bottom:30px;}
.master-table { width:100%; border-collapse:collapse; min-width:800px;}
.master-table th, .master-table td { border:1px solid var(--border-color); padding:8px; text-align:center;}
.master-table th { background-color:var(--primary-color); color:var(--text-light); font-weight:600;}
.master-table td.advisor-name-cell { text-align:left; font-weight:700; background-color:#e3f2fd; color:var(--text-dark);}
.master-table select { width:95%; padding:6px;}

/* --- TIMELINE GRID --- */
#team-timeline-container { background-color:var(--text-light); padding:10px; border-radius:8px; box-shadow:0 8px 16px rgba(0,0,0,0.1); overflow-x:auto;}
.master-timeline-grid { display:grid; position:relative;}
.time-axis { grid-column:1; padding-right:10px; text-align:right; border-right:1px solid var(--border-color); height: var(--timeline-height); position:relative; z-index:10; background-color: var(--text-light);}
.time-label { position:absolute; font-size:0.8em; transform:translateY(-50%); left:0; width:100%; padding-right:5px; color:#757575; border-bottom:1px dashed #cfd8dc;}
.advisor-header { grid-row:1; padding:10px 0; text-align:center; font-weight:700; background-color:var(--primary-color); color:var(--text-light); border:1px solid var(--border-color); border-left:none; position:sticky; top:0; z-index:20;}
.day-cell { position:relative; border:1px solid var(--border-color); border-top:none; height:var(--timeline-height); overflow:hidden;}
.activity-block { position:absolute; width:90%; left:5%; color:var(--text-light); padding:5px; box-sizing:border-box; border-radius:4px; font-size:0.75em; overflow:hidden; text-shadow:0 0 1px rgba(0,0,0,0.5); cursor:help; box-shadow:0 1px 3px rgba(0,0,0,0.2); font-weight:600; z-index:5; display:flex; flex-direction:column; justify-content:center; align-items:center;}
.activity-time { font-size:0.7em; font-weight:normal; display:block;}
.day-off-label { position:absolute; top:50%; transform:translateY(-50%); width:100%; text-align:center; color:#bdbdbd; font-size:1.2em; font-weight:600;}

/* --- PRINT --- */
@media print { .header, .controls-panel, .master-table-container, button { display:none !important;} .container { padding:0 !important;} .master-timeline-grid { page-break-inside:avoid;} .time-axis { height:auto !important;} .day-cell { height:1000px !important; page-break-inside:avoid;} body { background-color:white !important;} }
</style>
</head>
<body>
<div class="header"><h1>Professional Team Rota System</h1></div>
<div class="container">
    <div class="controls-panel">
        <div style="display:flex; gap:15px; align-items:center;">
            <label for="start-date-input" style="font-weight:700;">Week Start Date (Monday):</label>
            <input type="date" id="start-date-input" onchange="updateDates()">
        </div>
        <div class="button-group">
            <button onclick="downloadData(collectFullData())">üíæ Save & Download Data</button>
            <button onclick="toggleSettings()">‚öôÔ∏è Toggle Settings/Templates</button>
            <button onclick="generateAllSchedules()">üöÄ Generate Timeline View</button>
        </div>
    </div>

    <div id="settings-area" class="controls-panel hidden">
        <div style="width:55%;">
            <h2 style="color:var(--text-dark);">üõ†Ô∏è Shift Template Builder</h2>
            <div id="template-editor" style="padding:10px;"></div>
            <button onclick="addTemplate()">‚ûï Add New Shift Template</button>
        </div>
        <div style="width:40%;">
            <h2 style="color:var(--text-dark);">üé® Activity Color Key</h2>
            <div class="color-key-grid" style="padding:10px; background-color:var(--secondary-color); border-radius:4px;">
                <div class="color-input-group"><span class="color-example" data-activity="emails" style="background-color:var(--color-emails);"></span> <label>Emails:</label> <input type="text" id="color-emails" value="#2ecc71" oninput="updateColors()"></div>
                <div class="color-input-group"><span class="color-example" data-activity="mirakl" style="background-color:var(--color-mirakl);"></span> <label>Mirakl:</label> <input type="text" id="color-mirakl" value="#ffb300" oninput="updateColors()"></div>
                <div class="color-input-group"><span class="color-example" data-activity="social" style="background-color:var(--color-social);"></span> <label>Social:</label> <input type="text" id="color-social" value="#5e35b1" oninput="updateColors()"></div>
                <div class="color-input-group"><span class="color-example" data-activity="meeting" style="background-color:var(--color-meeting);"></span> <label>Meeting:</label> <input type="text" id="color-meeting" value="#ffd700" oninput="updateColors()"></div>
                <div class="color-input-group"><span class="color-example" data-activity="overtime" style="background-color:var(--color-overtime);"></span> <label>Overtime:</label> <input type="text" id="color-overtime" value="#e53935" oninput="updateColors()"></div>
                <div class="color-input-group"><span class="color-example" data-activity="break" style="background-color:var(--color-break);"></span> <label>Break:</label> <input type="text" id="color-break" value="#90a4ae" oninput="updateColors()"></div>
                <div class="color-input-group"><span class="color-example" data-activity="lunch" style="background-color:var(--color-lunch);"></span> <label>Lunch:</label> <input type="text" id="color-lunch" value="#ff8f00" oninput="updateColors()"></div>
            </div>
            <div class="button-group" style="margin-top:15px;">
                <input type="file" id="load-file" accept=".json" onchange="loadData(event)" style="display:none;">
                <button onclick="document.getElementById('load-file').click()">üìÇ Load Data from File</button>
            </div>
        </div>
    </div>

    <h2>üìÖ Master Rota Assignment Grid</h2>
    <div class="master-table-container">
        <table class="master-table" id="master-rota-table">
            <thead>
                <tr>
                    <th rowspan="2" class="advisor-name-cell" style="width:150px;">Advisor</th>
                    <th colspan="7">Select Shift Template</th>
                </tr>
                <tr id="date-headers"></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <button onclick="generateAllSchedules()" style="margin-top:20px;">üöÄ Generate Timeline View</button>

    <h2 style="margin-top:40px;">üìä Team Weekly Timeline Schedule</h2>
    <div id="team-timeline-container">
        <div class="master-timeline-grid" id="master-timeline-grid">
            <p style="padding:20px; text-align:center; color:var(--text-dark);">Select your shifts in the grid above and click 'Generate Timeline View' to see the schedule.</p>
        </div>
    </div>
    <button onclick="printGeneratedSchedule()" style="margin-top:20px;">üñ®Ô∏è Download Team Rota (PDF)</button>
</div>

<script>
// --- CONFIG ---
const ADVISOR_NAMES = ['Luke Pashley','Ameena Malik','Carrie-Ann Raw','Danielle Smith','Farwa Shaheen','Gemma Emmett','Laura Stockburn','Millie Walsh','Tunis Foley'];
const DAYS_FULL = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
const PLATFORM_ACTIVITIES = ['Emails','Mirakl','Social','Overtime','Meeting'];
const BREAK_SLOTS = ['Break1','Lunch','Break2'];
const STORAGE_KEY = 'ultraFastRotasV4';
let masterRotaData = {};
let shiftTemplates = {};

// --- TIMELINE CONSTANTS ---
const START_HOUR = 7;
const END_HOUR = 20;
const TOTAL_HOURS = END_HOUR - START_HOUR;
const TIMELINE_HEIGHT_PX = 1000;
const HEIGHT_PER_HOUR = TIMELINE_HEIGHT_PX / TOTAL_HOURS;
const HEIGHT_PER_MINUTE = HEIGHT_PER_HOUR / 60;

// --- INIT ---
function initApp(){
    ADVISOR_NAMES.forEach(name=>{
        masterRotaData[name]={};
        DAYS_FULL.forEach(day=>{masterRotaData[name][day]={template:''};});
    });
    populateTemplateEditor();
    populateMasterTable();
    loadDataFromStorage();
}

// --- UTIL ---
function toggleSettings(){document.getElementById('settings-area').classList.toggle('hidden');}
function timeToPosition(time){
    if(!time) return 0;
    const [h,m] = time.split(':').map(Number);
    const totalMinutes=(h*60)+m;
    const offsetMinutes=totalMinutes-START_HOUR*60;
    return offsetMinutes*HEIGHT_PER_MINUTE;
}
function getColorMap(){
    const map={};
    document.querySelectorAll('#settings-area input[type="text"]').forEach(input=>{
        if(input.id.startsWith('color-')) map[input.id.replace('color-','')]=input.value;
    });
    return map;
}

// --- TEMPLATE LOGIC ---
function addTemplate(){
    const name='Shift'+(Object.keys(shiftTemplates).length+1);
    shiftTemplates[name]={name,Start:'',Finish:'',Break1:'',Lunch:'',Break2:'',Platform:'Emails'};
    populateTemplateEditor();
    populateMasterTable();
    saveToLocalStorage();
}
function deleteTemplate(name){
    delete shiftTemplates[name];
    populateTemplateEditor();
    populateMasterTable();
    saveToLocalStorage();
}
function updateTemplate(oldName,key,value){
    const template=shiftTemplates[oldName];
    if(key==='name' && value!==oldName && value!==''){
        shiftTemplates[value]={...template,name:value};
        delete shiftTemplates[oldName];
        populateTemplateEditor();
        populateMasterTable();
    } else { template[key]=value; }
    saveToLocalStorage();
}
function populateTemplateEditor(){
    const editor=document.getElementById('template-editor');
    editor.innerHTML='';
    Object.keys(shiftTemplates).forEach(k=>{
        const t=shiftTemplates[k];
        const row=document.createElement('div');
        row.className='template-row';
        row.innerHTML=`
            <label>Name:</label><input type="text" value="${t.name}" oninput="updateTemplate('${k}','name',this.value)" style="width:100px;">
            <label>Shift:</label><input type="time" value="${t.Start}" oninput="updateTemplate('${t.name}','Start',this.value)">
            <input type="time" value="${t.Finish}" oninput="updateTemplate('${t.name}','Finish',this.value)">
            <label>Breaks:</label><div class="time-block">
                <input type="time" value="${t.Break1}" oninput="updateTemplate('${t.name}','Break1',this.value)">
                <input type="time" value="${t.Lunch}" oninput="updateTemplate('${t.name}','Lunch',this.value)">
                <input type="time" value="${t.Break2}" oninput="updateTemplate('${t.name}','Break2',this.value)">
            </div>
            <label>Platform:</label>
            <select onchange="updateTemplate('${t.name}','Platform
