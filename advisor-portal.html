<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WFM Advisor Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
  
  <style>
    /* === VARIABLES & CONFIGURATION (Refined Professional Style) === */
    :root {
      /* Professional Palette */
      --brand-primary: #3B82F6; /* A professional blue */
      --brand-accent: #10B981; /* Accent green */
      
      /* Neutrals - Clean and high contrast */
      --color-text: #1F2937;
      --color-text-muted: #6B7280;
      --color-bg: #F3F4F6; /* Light gray background for depth */
      --color-panel-bg: #FFFFFF; /* White background for panels/grids */
      --color-border: #E5E7EB;
      --color-hover-bg: #F9FAFB;

       /* Sidebar (Dark) - Kept exactly as requested in the prompt */
      --sidebar-bg: #111827;
      --sidebar-text: #D1D5DB;
      --sidebar-text-hover: #FFFFFF;
      --sidebar-border: #1F2937;
      --sidebar-width: 240px;
      
      /* Font and UI elements */
      --font-family: 'Inter', Arial, Helvetica, sans-serif;
      --border-radius: 8px; /* Slightly rounded corners */
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 6px rgba(0,0,0,0.1);

      /* Schedule Colors (Using a professional, accessible palette) */
      --color-shift-summary: #059669; /* Emerald Green for summary */
      /* Colors for activities will be pulled directly from the database */

      /* Debenhams Branding (For Login Screen - Kept as is) */
      --debenhams-teal: #70E6D6;
      --debenhams-dark: #000000;
      --login-bg: #000000;
      --login-text: #FFFFFF;
      --login-text-muted: #9CA3AF;
      --login-input-bg: #1F2937;
      --login-input-border: #374151;
      --login-button-green: #22C55E;

      /* Time Grid Configuration (My Schedule) */
      --timegrid-row-height: 26px; /* (48px per hour) */

      /* Daily Timeline Configuration (Team Schedule) */
      --timeline-name-col: 200px;
      --timeline-row-height: 36px;
    }

    /* === BASE STYLES & LAYOUT === */
    
    /* Modern Slim Scrollbar (App Feel) */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(156, 163, 175, 0.5); border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(107, 114, 128, 0.8); }

    html, body {
        height: 100%;
        margin: 0;
        overflow: hidden;
    }
    *{box-sizing:border-box}
    body{
        background:var(--color-bg);
        color:var(--color-text);
        font:14px/1.5 var(--font-family);
        display: flex;
    }

    /* === AUTHENTICATION OVERLAY (Kept as is) === */
    
    /* Hide main application components initially */
    .app-sidebar, .app-main-content {
      display: none;
    }

    /* Reveal them when the 'authenticated' class is added to the body by JS */
    body.authenticated .app-sidebar {
      display: flex;
    }
    body.authenticated .app-main-content {
        display: flex;
    }

    /* Hide the auth overlay when authenticated */
    body.authenticated #auth-overlay {
        display: none;
    }

    /* Auth Styling (Condensed for Brevity, matches Planner CSS) */
    .auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; display: flex; }
    .auth-container { display: flex; width: 100%; height: 100%; overflow: hidden; }
    .auth-banner { width: 75%; background-color: var(--debenhams-teal); display: flex; justify-content: center; align-items: center; position: relative; }
    .auth-banner::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; opacity: 0.7; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Cdefs%3E%3Cstyle%3E.bee%7Bfill:none;stroke:rgba(255,255,255,0.35);stroke-width:2;%7D%3C/style%3E%3C/defs%3E%3Cg transform='translate(50 50) rotate(5)'%3E%3Cpolygon class='bee' points='0,-12 12,-6 12,6 0,12 -12,6 -12,-6'/%3E%3Cline class='bee' x1='-6' y1='-9' x2='-6' y2='9'/%3E%3Cline class='bee' x1='0' y1='-12' x2='0' y2='12'/%3E%3Cline class='bee' x1='6' y1='-9' x2='6' y2='9'/%3E%3Cpolygon class='bee' points='0,-12 18,-30 30,-18 12,-6'/%3E%3Cpolygon class='bee' points='0,-12 -18,-30 -30,-18 -12,-6'/%3E%3C/g%3E%3C/svg%3E"); background-size: 90px 90px; }
    .banner-content { position: relative; z-index: 1; text-align: center; color: var(--debenhams-dark); }
    .dg-main-text { font-size: 72px; font-weight: 700; letter-spacing: -2px; line-height: 1; display: block; }
    .dg-sub-text { font-size: 28px; font-weight: 600; text-transform: uppercase; margin-top: 5px; display: block; }
    .dg-tagline { font-size: 24px; font-weight: 400; text-transform: uppercase; margin-top: 50px; }
    .auth-form-panel { width: 25%; padding: 60px; display: flex; flex-direction: column; justify-content: center; background-color: var(--login-bg); color: var(--login-text); }
    .auth-title { font-size: 24px; font-weight: 600; margin-bottom: 16px; margin-top: 0; }
    .auth-form-panel p, .auth-form label { color: var(--login-text-muted); font-size: 14px; }
    .auth-motto { margin-top: 8px; margin-bottom: 60px; }
    .auth-welcome { margin-bottom: 24px; }
    .form-group { margin-bottom: 16px; }
    .auth-form .form-input { width: 100%; padding: 12px 16px; font-size: 16px; background-color: var(--login-input-bg); border: 1px solid var(--login-input-border); color: var(--login-text); border-radius: var(--border-radius); font-family: var(--font-family); }
    .auth-form .form-input:focus { outline: none; border-color: #FFF; box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.2); }
    .btn-login { padding: 12px 18px; font-size: 16px; font-weight: 600; background-color: var(--login-button-green); color: white; border: none; border-radius: 30px !important; cursor: pointer; margin-top: 16px; width: 100%; }
    .btn-login:hover { background-color: #16A34A; }
    .btn-login:disabled { opacity: 0.6; cursor: not-allowed; }
    .auth-notice { margin-top: 24px; padding: 12px; border-radius: var(--border-radius); display: none; font-size: 14px; }
    .auth-notice.error { background-color: #FEE2E2; color: #991B1B; border: 1px solid #FCA5A5; }
    .auth-notice.success { background-color: #ECFDF5; color: #065F46; border: 1px solid #A7F3D0; }
    .auth-footer { margin-top: auto; padding-top: 24px; font-size: 12px; color: var(--login-text-muted); border-top: 1px solid var(--login-input-border); }

    /* Forgot Password Styling */
    .auth-link {
        color: var(--login-text-muted);
        cursor: pointer;
        text-decoration: underline;
        font-size: 13px;
        display: block;
        margin-top: 8px;
    }
    .auth-link:hover {
        color: var(--login-text);
    }

    @media (max-width: 992px) {
      .auth-banner { width: 50%; }
      .auth-form-panel { width: 50%; padding: 40px; }
    }
    @media (max-width: 768px) {
      .auth-container { flex-direction: column; }
      .auth-banner, .auth-form-panel { width: 100%; }
      .auth-banner { min-height: 30vh; height: auto; }
      .dg-main-text { font-size: 48px; }
    }


    /* === APPLICATION LAYOUT (Sidebar/Main) === */
    
    /* --- Sidebar (Kept unchanged as requested) --- */
    .app-sidebar {
        width: var(--sidebar-width);
        background-color: var(--sidebar-bg);
        color: var(--sidebar-text);
        flex-direction: column;
        flex-shrink: 0;
        border-right: 1px solid var(--sidebar-border);
        height: 100vh;
        overflow-y: auto;
    }

    .sidebar-header {
        padding: 20px 24px;
        font-size: 16px;
        font-weight: 700;
        color: white;
        border-bottom: 1px solid var(--sidebar-border);
    }

    .sidebar-profile {
        padding: 16px 24px;
        border-bottom: 1px solid var(--sidebar-border);
        background-color: rgba(255, 255, 255, 0.03);
    }
    #advisorName {
        font-weight: 600;
        color: white;
        display: block;
    }
    #userEmail, #teamName {
        font-size: 13px;
        color: var(--sidebar-text);
        display: block;
    }

    .sidebar-nav {
        display: flex;
        flex-direction: column;
        padding: 16px;
        gap: 4px;
        flex-grow: 1;
    }

    .nav-link {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 16px;
        font-size: 14px;
        font-weight: 500;
        color: var(--sidebar-text);
        background-color: transparent;
        border: none;
        border-radius: 8px; 
        cursor: pointer;
        text-align: left;
        transition: background-color 0.15s, color 0.15s;
    }

    .nav-link:hover:not(.disabled) {
        background-color: rgba(255, 255, 255, 0.05);
        color: var(--sidebar-text-hover);
    }

    .nav-link.active {
        background-color: rgba(255, 255, 255, 0.1);
        color: white;
    }

    .nav-link.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .nav-link.disabled .coming-soon-tag {
        font-style: italic;
        font-size: 10px;
        margin-left: auto;
        background: var(--brand-accent);
        padding: 2px 6px;
        border-radius: 4px;
        color: white;
    }

    .nav-separator {
        margin: 16px 16px 8px 16px;
        font-size: 12px;
        font-weight: 600;
        color: #6B7280;
        text-transform: uppercase;
    }

    .sidebar-footer {
        padding: 16px;
        border-top: 1px solid var(--sidebar-border);
        margin-top: auto;
    }

    /* --- Main Content (Advisor "Morning Mist" Look) --- */
    .app-main-content {
        flex-grow: 1;
        flex-direction: column;
        overflow: hidden;
        height: 100vh;
        /* Subtle "Morning Mist" Gradient: White to Pale Blue */
        background: linear-gradient(to bottom right, #F9FAFB, #F0F9FF); 
    }

    /* Top Bar within Main Content (Clean White) */
    .top-bar {
        background-color: var(--color-panel-bg);
        border-bottom: 1px solid var(--color-border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 24px;
        flex-shrink: 0;
        box-shadow: var(--shadow-sm);
    }

    /* Content Area (Scrollable) */
    .content-area {
        flex-grow: 1;
        overflow: hidden; 
        padding: 24px; /* Padding around the content */
        display: flex;
        flex-direction: column;
    }

    /* Constrain max width to prevent stretching on large screens */
    .content-area-constrained {
        max-width: 1600px;
        margin: 0 auto;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .tab-content {
        display: none;
        height: 100%;
        width: 100%;
        background-color: var(--color-panel-bg);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md);
        border: 1px solid var(--color-border);
        overflow: hidden; /* Contain content within the white card */
    }

    .tab-content.active {
        display: flex;
        flex-direction: column;
    }

    /* Add internal padding for placeholder tabs */
    #tab-time-off, #tab-shift-swap, #tab-metrics {
        padding: 24px;
        overflow-y: auto;
    }


    /* === COMPONENTS (Refined) === */
    
    .btn{
        background:var(--brand-primary);
        color:#fff;
        border:0;
        padding:10px 16px;
        border-radius:var(--border-radius);
        font-weight:600;
        cursor:pointer; 
        transition: background 0.2s; 
        font-family: var(--font-family);
        font-size: 14px;
        box-shadow: var(--shadow-sm);
    }
    .btn:hover{background: #2563EB;}
    .btn:disabled{opacity: 0.6; cursor: not-allowed;}
    
    /* Glassy Secondary Button (Prev/Next) */
    .btn.secondary {
        background: rgba(255, 255, 255, 0.5); /* See-through */
        color: var(--color-text);
        border: 1px solid rgba(255, 255, 255, 0.6); /* Subtle rim */
        backdrop-filter: blur(4px);
        transition: all 0.2s ease;
    }
    .btn.secondary:hover {
        background: rgba(255, 255, 255, 0.95); /* Opaque on hover */
        transform: translateY(-2px); /* Lift */
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    
    /* Sidebar Ghost Button (Kept unchanged) */
    .btn.ghost{background:transparent;color:var(--sidebar-text);border:1px solid var(--sidebar-border); box-shadow: none;}
    .btn.ghost:hover{background: rgba(255,255,255,0.1); color: white;}
    
    input[type="date"], .form-input, .form-select, .auth-form .form-input {
        border:1px solid var(--color-border);
        border-radius:var(--border-radius);
        padding:10px 12px; 
        font-family: var(--font-family);
        font-size: 14px;
        box-shadow: var(--shadow-sm);
    }
    input[type="date"]:focus, .form-input:focus, .form-select:focus {
        outline: none;
        border-color: var(--brand-primary);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    input[type="date"] { min-width: 200px; }
    
    /* Notices (Used for realtime updates) */
    .notice-container {
        position: absolute;
        top: 90px; /* Position below top bar */
        left: 50%;
        transform: translateX(-50%);
        z-index: 100;
    }
    .notice{padding:12px 20px;border-radius:var(--border-radius); box-shadow: var(--shadow-md);}
    .notice.success{background:#D1FAE5;border:1px solid #A7F3D0;color:#065F46;}
    .notice.info{background:#DBEAFE;border:1px solid #93C5FD;color:#1E40AF;}
    .notice.danger{background:#FEE2E2;border:1px solid #FCA5A5;color:#991B1B;}

    .tag{background:var(--color-hover-bg);color:var(--color-text);border-radius:999px;padding:4px 12px;font-weight:600; font-size: 12px; display: inline-block;}
    
    .bar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;}

    /* === MY ROTA VIEW (Vertical Time Grid - Refined) === */
    
    /* The container for the entire schedule view */
    .schedule-container {
        display: flex;
        flex-direction: column;
        /* Floating Glass Panel Effect */
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.6);
        border-radius: 16px; /* Modern rounded corners */
        box-shadow: 0 10px 30px rgba(0,0,0,0.04); /* Soft float shadow */
        overflow: hidden; /* Clips the corners */
        
        flex-grow: 1;
        min-width: 900px;
        height: 100%;
    }

    /* 1. Top Summary Section */
    .summary-grid {
        display: grid;
        /* REMOVED 80px column */
        grid-template-columns: repeat(7, 1fr); 
        border-bottom: 2px solid var(--color-border);
 flex-shrink: 0; /* Prevent summary from shrinking */
        padding-right: 17px;
 /* Compensate for the scrollbar on the grid below */
    }

    .summary-header {
        grid-column: 1 / span 8;
        padding: 12px 16px;
        background-color: var(--color-hover-bg);
        border-bottom: 1px solid var(--color-border);
        font-weight: 600;
        font-size: 16px;
    }

    .summary-day {
        padding: 8px;
        text-align: center;
        border-right: 1px solid var(--color-border);
        display: flex;
        flex-direction: column;
    }

    .summary-day:last-child {
        border-right: none;
    }
    
    .summary-day-name {
        font-size: 13px;
        font-weight: 600;
        color: var(--color-text-muted);
    }
    .summary-day-date {
        font-size: 16px;
        font-weight: 700;
        margin-bottom: 10px;
    }

    /* Glassy Summary Tile */
    .summary-block {
        background: linear-gradient(135deg, #10B981, #059669); /* Rich Green Gradient */
        color: white;
        padding: 10px 8px;
        font-size: 13px;
        font-weight: 600;
        flex-grow: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 12px; /* Soft corners */
        box-shadow: 0 4px 6px rgba(16, 185, 129, 0.25), inset 0 1px 0 rgba(255,255,255,0.3); /* Depth */
        line-height: 1.3;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        border: 1px solid rgba(255,255,255,0.1);
        cursor: default;
    }
    .summary-block:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(16, 185, 129, 0.3); }

    /* Etched Glass RDO */
    .summary-rdo {
        background-color: rgba(243, 244, 246, 0.5); /* Semi-transparent */
        color: var(--color-text-muted);
        padding: 10px 5px;
        font-size: 13px;
        flex-grow: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 12px;
        border: 1px dashed var(--color-border);
        /* Striped Texture */
        background-image: repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(0,0,0,0.02) 5px, rgba(0,0,0,0.02) 10px);
    }

    /* 2. Detailed Time Grid Section */
    .time-grid-wrapper {
        flex-grow: 1;
        overflow-y: scroll; /* Allow vertical scrolling for time */
        position: relative;
    }

    .time-grid {
        display: grid;
        /* REMOVED 80px column */
        grid-template-columns: repeat(7, 1fr);
        position: relative;
        width: 100%;
 }


    /* Day Columns (The background grid cells providing horizontal lines) */
    .day-column-cell {
        border-bottom: 1px solid #F3F4F6; /* Lighter dotted line for half hours */
        height: var(--timegrid-row-height);
    }

    /* Solid line for hour marks */
.day-column-cell.hour-mark {
    border-bottom: 1px solid var(--color-border);
}

    /* Containers for the absolutely positioned events */
    .day-column-events {
        position: relative;
        grid-row: 1 / span 100; /* Span many rows */
        pointer-events: none; 
        /* Add the vertical border here */
        border-right: 1px solid var(--color-border); 
    }
    
    .day-column-events:last-child {
        border-right: none;
    }

    /* === MY SCHEDULE: Activity Blocks (Positioned Events) === */
    /* This rule applies to ALL blocks ONLY in the My Schedule tab */
    #tab-my-schedule .activity-block {
        position: absolute;
        left: 2px;
        right: 2px; 
        padding: 3px 6px;
        font-size: 11px;
        overflow: hidden;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-sm);
        border: 1px solid rgba(0,0,0,0.1);
        line-height: 1.2;
        
        /* FIX 1: This enables the mouse hover for the tooltip */
        pointer-events: auto; 
        
        /* FIX 2: This centers ALL text (DEB Email, Break, etc.) */
        display: flex;
        flex-direction: column; /* Stacks title/time vertically */
        align-items: center;     /* Horizontal center */
        justify-content: center;  /* Vertical center */
        text-align: center;
    }

    /* This rule applies to ALL titles (DEB Email, Break...) */
    #tab-my-schedule .activity-title {
        font-weight: 600;
        display: block;
    }

    /* This rule makes ALL times visible by default */
    #tab-my-schedule .activity-time {
        display: block;
        font-size: 10px;
        opacity: 0.85;
    }
    
    /* --- Overrides for Break/Lunch ONLY --- */
    
    /* This HIDES the time ONLY for Break/Lunch */
    #tab-my-schedule .is-simple-block .activity-time {
        display: none;
    }
    
    /* FIX 3: This NUDGES the text down ONLY for Break/Lunch */
    #tab-my-schedule .is-simple-block .activity-title {
        padding-top: 2px; /* Nudge text down slightly */
    }


    /* === TEAM SCHEDULE VIEW (Grid + Gantt) === */

    /* Controls for switching views */
    .view-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 24px;
        border-bottom: 1px solid var(--color-border);
    }

    .view-toggle-group { display: flex; border: 1px solid var(--color-border); border-radius: var(--border-radius); overflow: hidden; box-shadow: var(--shadow-sm); }

    .btn-toggle {
        padding: 8px 16px;
        font-size: 14px;
        font-weight: 500;
        background-color: var(--color-panel-bg);
        color: var(--color-text-muted);
        border: none;
        cursor: pointer;
    }

    .btn-toggle.active { background-color: var(--brand-primary); color: white; }

    .day-selector-group {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    #teamScheduleContainer {
        overflow: auto;
        flex-grow: 1;
    }

    /* --- Weekly Grid View (Premium Floating Rows) --- */
    .team-grid {
        width: 100%;
        border-collapse: separate; /* Essential for rounded rows */
        border-spacing: 0 6px; /* Space between advisor rows */
        padding-right: 12px;
    }
    
    /* Glassy Header */
    .team-grid th {
        padding: 16px;
        text-align: center; /* Centered Dates */
        font-weight: 700;
        color: var(--color-text-muted);
        position: sticky;
        top: 0;
        z-index: 15;
        background: rgba(249, 250, 251, 0.9);
        backdrop-filter: blur(8px);
        border-bottom: 1px solid rgba(0,0,0,0.05);
        border-right: 1px solid rgba(0,0,0,0.03); /* Header Divider */
    }
    .team-grid th:first-child { text-align: left; z-index: 20; } /* Keep name header left */

    /* Floating Rows with Vertical Lines */
    .team-grid td {
        padding: 14px 8px; /* Slightly tighter padding */
        border: none;
        border-right: 1px solid rgba(0,0,0,0.06); /* Vertical Grid Line */
        background: rgba(255,255,255,0.4);
        border-bottom: 1px solid rgba(0,0,0,0.02);
        transition: all 0.2s ease;
        vertical-align: middle;
        text-align: center; /* Center Shifts/RDOs */
    }
    /* Rounded ends for the rows + Stronger Name Divider */
    .team-grid td:first-child { 
        border-radius: 10px 0 0 10px; 
        background: rgba(255,255,255,0.6); 
        font-weight: 600; 
        text-align: left; 
        padding-left: 16px;
        border-right: 2px solid rgba(0,0,0,0.08); /* Stronger divider after name */
    }
    .team-grid td:last-child { 
        border-radius: 0 10px 10px 0; 
        border-right: none; /* No border on the far right */
    }

    /* Hover Spotlight */
    .team-grid tbody tr:hover td {
        background-color: #FFFFFF !important;
        box-shadow: 0 8px 20px rgba(0,0,0,0.06);
        transform: scale(1.005);
        cursor: default;
        border-right-color: rgba(0,0,0,0.03); /* Faint lines on hover */
    }
    
    /* Sticky Name Column for Weekly Grid */
    .team-grid th:first-child {
        left: 0;
        z-index: 20;
    }
    .team-grid td:first-child {
        position: sticky;
        left: 0;
        background-color: #fff;
        z-index: 10;
     }

    .team-grid tbody tr:hover td {
        background-color: var(--color-hover-bg);
    }

    .weekly-shift-time {
        font-size: 14px;
        font-weight: 600;
        color: var(--color-text);
        display: block;
    }
    .weekly-shift-details {
        font-size: 13px;
        color: var(--color-text-muted);
    }
    /* RDO Pill (Structured "Ghost" Look) */
    .weekly-rdo {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 11px;
        font-weight: 700;
        color: #9CA3AF;
        background: rgba(243, 244, 246, 0.6); /* Light Grey */
        border: 1px dashed #D1D5DB; /* Dashed border for "Off" status */
        min-width: 80px; /* Consistent width matching shifts */
        text-align: center;
        box-shadow: inset 0 1px 2px rgba(0,0,0,0.02);
    }

    /* --- Daily Gantt View (Liquid Timeline) --- */
    .timeline-container { position: relative; min-width: 1200px; padding-bottom: 20px; }

    /* Sticky Glass Header */
    .timeline-header {
      display: grid;
      grid-template-columns: var(--timeline-name-col) 1fr;
      background: rgba(249, 250, 251, 0.9); /* Frosted Glass */
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border-bottom: 1px solid rgba(0,0,0,0.05);
      position: sticky;
      top: 0;
      z-index: 15;
    }

    .header-name { 
        padding: 12px 20px;
        border-right: 1px solid var(--color-border);
        font-weight: 600;
        position: sticky;
        left: 0;
        background: inherit; /* Inherit glass effect */
        z-index: 20;
    }

    .header-timeline { position: relative; height: 48px; background: transparent; }

    .time-tick {
      position: absolute;
      font-size: 11px;
      font-weight: 600;
      color: #9CA3AF;
      user-select: none;
      height: 100%;
      padding-left: 6px;
      display: flex;
      align-items: center;
      top: 0;
      background: transparent;
    }

    /* Subtle vertical grid lines */
    .time-tick::after {
        content: '';
        position: absolute;
        left: 0; top: 48px; height: 5000px; width: 1px;
        background-color: rgba(0,0,0,0.03); /* Very faint lines */
        z-index: -1;
    }

    .timeline-body { position: relative; padding-top: 8px; }

    /* Floating Spotlight Rows (Compact Mode) */
    .timeline-row {
      display: grid;
      grid-template-columns: var(--timeline-name-col) 1fr;
      height: 34px; /* Reduced height for tighter density */
      margin-bottom: 2px; /* Reduced gap between advisors */
      align-items: center;
      border-radius: 6px;
      transition: all 0.2s ease;
      border-bottom: 1px solid rgba(0,0,0,0.02); /* Subtle divider */
    }

    /* Alternating colors + Hover Effect */
    .timeline-row:nth-child(odd) { background-color: rgba(255,255,255,0.4); }
    .timeline-row:nth-child(even) { background-color: rgba(249, 250, 251, 0.4); }
    
    .timeline-row:hover { 
        background-color: #FFFFFF !important; 
        transform: none; /* Keep grid neat */
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        z-index: 5;
        border-left: 3px solid var(--brand-primary); /* Highlight indicator */
    }

    /* Floating Row Name */
    .timeline-name { 
        padding: 0 12px;
        display: flex; align-items: center; font-size: 12px; font-weight: 600; color: var(--color-text);
        position: sticky; left: 0; z-index: 10; 
        background: inherit; 
        height: 100%;
    }

    .timeline-track { position: relative; height: 100%; }

    /* The "Tape" Bar (Flatter, Connected Look) */
    .timeline-bar {
        position: absolute;
        top: 4px; bottom: 4px; /* Stretches to fill row mostly */
        height: auto !important; /* Override JS height */
        display: flex;
        align-items: center;
        overflow: hidden;
        border-radius: 3px; /* Sharper corners = Connected look */
        z-index: 25;
        font-size: 10px;
        font-weight: 700;
        padding-left: 6px;
        white-space: nowrap;
        box-shadow: inset 0 1px 0 rgba(255,255,255,0.2);
        border: none;
        transition: all 0.2s;
    }
    /* Differentiate Breaks visually to break up the "Wall of Color" */
    .timeline-bar.is-simple-block {
        opacity: 0.6; /* Breaks recede visually */
        background-image: repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(0,0,0,0.05) 5px, rgba(0,0,0,0.05) 10px);
        box-shadow: none;
    }
    
    .timeline-bar:hover { z-index: 30; transform: scale(1.02); box-shadow: 0 4px 12px rgba(0,0,0,0.15); cursor: pointer; opacity: 1; }

    /* === Placeholder Content === */
    .placeholder-content {
        text-align: center;
        padding: 50px;
        margin: 24px;
        border: 2px dashed var(--color-border);
        border-radius: var(--border-radius);
        color: var(--color-text-muted);
    }

    /* === RESPONSIVE === */
    @media (max-width: 1024px) {
        /* Allow horizontal scrolling of the main container on tablets/mobile if necessary */
         .content-area {
            overflow-x: auto;
        }
        .top-bar {
            padding: 12px 16px;
        }
    }

    @media (max-width: 768px) {
      /* App Layout Responsive (Mobile view - Sidebar hidden) */
      .app-sidebar {
          display: none !important;
      }
      .top-bar {
          flex-direction: column;
          align-items: stretch;
          gap: 10px;
      }
      .bar {
          justify-content: space-between;
          width: 100%;
      }
       /* Ensure the grid structure holds a minimum width on mobile */
       .summary-grid, .time-grid {
            min-width: 800px; 
       }
       .timeline-container {
            min-width: 1000px;
       }
       .content-area {
           padding: 16px;
       }
    }

    /* Hides text for simple blocks on Team Schedule */
    #tab-team-schedule .timeline-bar.is-simple-block span {
        display: none;
    }

/* === FIX: Proportional Stack (No Gaps) === */

/* 1. Remove grid lines as they don't align with stacked view */
#tab-my-schedule .day-column-cell,
#tab-my-schedule .day-column-cell.hour-mark {
    border-bottom: none !important;
}

/* 2. Stack items vertically with NO gap at the top */
#tab-my-schedule .day-column-events {
    display: flex !important;
    flex-direction: column; /* Stack vertically */
    width: 100%;
    height: 100%;
    border-right: 1px solid var(--color-border);
    padding: 0;
    grid-row: 1 / span 100 !important; /* Override grid positioning */
    pointer-events: none;
}

#tab-my-schedule .day-column-events:last-child {
    border-right: none;
}

/* 3. Blocks are "Jelly Pills" (Rounded, Floating, Glossy) */
#tab-my-schedule .activity-block {
    position: relative !important;
    left: auto !important;
    right: auto !important;
    top: auto !important;
    width: 100% !important; /* Slight gap on sides for floating look */
    margin: 0px auto !important; /* Tiny gap between blocks */
    
    /* The Jelly Look */
    border-radius: 8px; /* Rounded pill shape */
    box-shadow: 0 2px 4px rgba(0,0,0,0.05), inset 0 1px 0 rgba(255,255,255,0.4); /* Inner top shine */
    border: 1px solid rgba(0,0,0,0.05); /* Subtle border */
    
    padding: 2px 4px;
    font-size: 11px;
    overflow: hidden;
    line-height: 1.1;
    pointer-events: auto;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    flex-shrink: 0;
    box-sizing: border-box;
    transition: transform 0.1s;
}
#tab-my-schedule .activity-block:hover {
    transform: scale(1.02); /* Pop on hover */
    z-index: 10;
}

/* Explicit Rest Day Indicator (Striped) */
.timeline-rdo-fill {
    position: absolute;
    top: 2px; bottom: 2px; left: 0; width: 100%; /* Add gap for row separation */
    display: flex;
    align-items: center;
    justify-content: center;
    
    /* Cleaner Diagonal Pattern */
    background-color: rgba(249, 250, 251, 0.5);
    background-image: repeating-linear-gradient(
        45deg,
        rgba(0, 0, 0, 0.04) 0px,
        rgba(0, 0, 0, 0.04) 1px,
        transparent 1px,
        transparent 8px
    );
    color: #9CA3AF; 
    font-weight: 700; 
    font-size: 11px; 
    letter-spacing: 2px;
    user-select: none;
    z-index: 0;
    border-radius: 6px;
}

/* === INTERACTIVE POLISH === */

/* Glass Tooltip (Replaces Browser Default) */
[data-tooltip] { position: relative; }

[data-tooltip]:hover::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 100%; 
    left: 50%;
    transform: translate(-50%, -8px); /* Float above */
    background: rgba(15, 23, 42, 0.9); /* Dark Glass */
    backdrop-filter: blur(4px);
    color: white;
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 500;
    white-space: nowrap;
    z-index: 100;
    pointer-events: none;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    border: 1px solid rgba(255,255,255,0.1);
    animation: tooltipPop 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

@keyframes tooltipPop {
    from { opacity: 0; transform: translate(-50%, 0); }
    to { opacity: 1; transform: translate(-50%, -8px); }
}

/* === DIRECTOR COMMAND CENTER (Premium Glass & Neon) === */
    
    .dir-dashboard {
        display: flex;
        flex-direction: column;
        gap: 24px;
        padding: 24px; /* Increased padding */
        height: 100%;
        overflow-y: auto;
        
        /* THE AURORA MESH BACKGROUND */
        background-color: #F8FAFC; /* Fallback */
        background-image: 
            radial-gradient(at 0% 0%, rgba(59, 130, 246, 0.15) 0px, transparent 50%),
            radial-gradient(at 100% 0%, rgba(16, 185, 129, 0.15) 0px, transparent 50%),
            radial-gradient(at 100% 100%, rgba(236, 72, 153, 0.05) 0px, transparent 50%),
            radial-gradient(at 0% 100%, rgba(59, 130, 246, 0.1) 0px, transparent 50%);
        background-size: 150% 150%;
        animation: auroraMove 15s ease-in-out infinite alternate;
    }

    @keyframes auroraMove {
        0% { background-position: 0% 0%; }
        100% { background-position: 100% 100%; }
    }

    /* Top Row: Pulse Cards */
    .dir-pulse-row {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 24px;
        flex-shrink: 0;
    }

    /* === NEW PREMIUM CARD STYLES === */
    .dir-card {
        background: rgba(255, 255, 255, 0.65);
        -webkit-backdrop-filter: blur(16px);
        backdrop-filter: blur(16px); /* Standard property added */
        border: 1px solid rgba(255, 255, 255, 0.9);
        border-radius: 20px;
        padding: 24px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.04), 
                    inset 0 0 0 1px rgba(255, 255, 255, 0.5);
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }
    
    .dir-card:hover { 
        transform: translateY(-4px); 
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08);
        background: rgba(255, 255, 255, 0.85);
    }

    /* Subtle sheen animation on hover */
    .dir-card::after {
        content: '';
        position: absolute;
        top: 0; left: -100%;
        width: 50%; height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        transform: skewX(-25deg);
        transition: 0.5s;
    }
    .dir-card:hover::after { left: 150%; transition: 0.7s ease-in-out; }

    .dir-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
    
    .dir-card-title { 
        font-size: 12px; 
        font-weight: 700; 
        color: #64748B; 
        text-transform: uppercase; 
        letter-spacing: 1.5px; 
    }

    /* The "Live" pulsing dot */
    .live-dot {
        width: 8px; height: 8px;
        background-color: #10B981;
        border-radius: 50%;
        box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
        animation: pulse-green 2s infinite;
    }
    .live-dot.red { background-color: #EF4444; animation: pulse-red 2s infinite; }
    
    @keyframes pulse-green {
        0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
        70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); }
        100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
    }
    @keyframes pulse-red {
        0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
        70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); }
        100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }

    .dir-metric-value { 
        font-size: 42px; 
        font-weight: 800; 
        color: #1E293B; 
        line-height: 1;
        letter-spacing: -1px;
        /* FIX: Added standard property definitions below */
        background: -webkit-linear-gradient(45deg, #1E293B, #475569);
        background: linear-gradient(45deg, #1E293B, #475569);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    
    .dir-metric-sub { 
        font-size: 12px; 
        color: #64748B; 
        font-weight: 600; 
        margin-top: 8px; 
        display: flex; 
        align-items: center; 
        gap: 6px; 
        padding-top: 8px;
        border-top: 1px solid rgba(0,0,0,0.05);
    }
    .dir-metric-sub.down { color: #EF4444; }

    /* Middle Section: Brand Health Grid */
    .dir-section-title { 
        font-size: 20px;
        font-weight: 700; color: #334155; margin-bottom: 16px; margin-top: 8px; display: flex; align-items: center; gap: 12px; }
    
    .dir-brand-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)) !important;
        gap: 24px;
        width: 100% !important;
        box-sizing: border-box;
        padding-bottom: 40px;
    }

    .dir-brand-card {
        background: white;
        border-radius: 16px;
        padding: 20px;
        border: 1px solid #E2E8F0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    .dir-brand-card:hover { border-color: var(--brand-primary);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }

    .dir-brand-header { display: flex; justify-content: space-between;
        align-items: center; }
    .dir-brand-name { font-weight: 700; font-size: 16px; color: #0F172A;
    }
    
    /* Status Lights */
    .dir-status-light { height: 10px;
        width: 10px; border-radius: 50%; background: #CBD5E1; box-shadow: 0 0 8px rgba(0,0,0,0.1); }
    .dir-status-light.green { background: #10B981;
        box-shadow: 0 0 8px rgba(16, 185, 129, 0.4); }
    .dir-status-light.amber { background: #F59E0B;
        box-shadow: 0 0 8px rgba(245, 158, 11, 0.4); }
    .dir-status-light.red { background: #EF4444;
        box-shadow: 0 0 8px rgba(239, 68, 68, 0.4); }

    .dir-progress-bar { height: 6px; width: 100%; background: #F1F5F9;
        border-radius: 3px; overflow: hidden; }
    .dir-progress-fill { height: 100%; background: var(--brand-primary); border-radius: 3px; width: 0%;
        transition: width 1s ease-out; }
    
    .dir-stat-row { display: flex; justify-content: space-between; font-size: 12px;
        color: #64748B; font-weight: 500; }
  /* === DIRECTOR GOD MODE MODAL (Fixed Layout) === */
#directorEditModal {
    display: none; 
    align-items: center; 
    justify-content: center; 
    backdrop-filter: blur(4px);
    z-index: 10000;
}

#directorEditModal .modal-content {
    margin: auto;
    background: white;
    width: 400px; /* Fixed neat width */
    border-radius: 20px; /* Apple-style corners */
    box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    padding: 0;
    overflow: hidden;
    position: relative;
    top: auto; /* Reset position */
    right: auto; /* Reset position */
    height: auto; /* Reset height */
    border: 1px solid rgba(0,0,0,0.1);
    animation: popIn 0.2s ease-out;
}

@keyframes popIn {
    from { transform: scale(0.95); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

#directorEditModal .modal-header {
    background: #F8FAFC;
    padding: 16px 24px;
    border-bottom: 1px solid #E2E8F0;
}

#directorEditModal .modal-body {
    padding: 24px;
}
/* The "Now" Laser Indicator */
    .now-line {
        position: absolute;
        left: 0; 
        width: 100%; 
        border-top: 2px solid #EF4444; /* Red Laser */
        box-shadow: 0 0 8px rgba(239, 68, 68, 0.6); /* Glow */
        z-index: 50;
        pointer-events: none;
    }
    /* "NOW" Label */
    .now-line::after {
        content: 'NOW';
        position: absolute;
        left: -35px; top: -10px;
        background: #EF4444; color: white;
        font-size: 10px; font-weight: 700;
        padding: 2px 6px; border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    /* Team Grid Avatar (Initials Circle) */
    .avatar-cell { display: flex; align-items: center; }
    .avatar-circle {
        width: 32px; height: 32px;
        background: linear-gradient(135deg, #DBEAFE, #BFDBFE);
        color: #1E40AF;
        border-radius: 50%;
        display: inline-flex; align-items: center; justify-content: center;
        font-weight: 700; font-size: 11px;
        margin-right: 12px;
        border: 2px solid #FFFFFF;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    /* Team Grid Shift Pill */
    .grid-shift-pill {
        background: rgba(255, 255, 255, 0.6);
        border: 1px solid rgba(0,0,0,0.05);
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 600;
        display: inline-block;
        color: var(--color-text);
        box-shadow: 0 1px 2px rgba(0,0,0,0.03);
    }
  </style>
</head>
<body>

  <div id="auth-overlay" class="auth-overlay">
    <div class="auth-container">
      <div class="auth-banner">
        <div class="banner-content">
            <span class="dg-main-text">Debenhams</span>
            <span class="dg-sub-text">GROUP</span>
            <div class="dg-tagline">
                FASHION. BEAUTY. LIFESTYLE.<br>
                <strong>FOR EVERYONE.</strong>
            </div>
        </div>
      </div>
      <div class="auth-form-panel">
        <h2 class="auth-title">Advisor Portal</h2>
        <p class="auth-motto">Powered by WFM Intelligence</p>

        <div id="signInView">
            <form id="auth-form" class="auth-form">
                <p class="auth-welcome">Welcome. Please sign in.</p>

                <div class="form-group">
                    <label for="emailInput">Email Address</label>
                    <input type="email" id="emailInput" class="form-input" placeholder="Enter your work email" autofocus>
                </div>
               
                <div class="form-group">
                    <label for="passwordInput">Password</label>
                    <input type="password" id="passwordInput" class="form-input" placeholder="Enter your password">
                    <div style="display:flex; justify-content:space-between; margin-top:8px;">
                        <span class="auth-link" onclick="toggleAuthView('forgot')">Forgot Password?</span>
                        <span class="auth-link" onclick="toggleAuthView('signup')" style="color: var(--brand-primary); font-weight:600;">First Time Login?</span>
                    </div>
                </div>
            
                <button type="submit" id="signInBtn" class="btn-login">Sign In</button>
            </form>
        </div>

        <div id="signUpView" style="display:none;">
             <form id="signup-form" class="auth-form">
                <p class="auth-welcome"><strong>Setup Account</strong><br>Enter your email and create a new password.</p>

                <div class="form-group">
                    <label for="signupEmailInput">Email Address</label>
                    <input type="email" id="signupEmailInput" class="form-input" placeholder="Enter your work email">
                </div>
                <div class="form-group">
                    <label for="signupPasswordInput">Create Password</label>
                    <input type="password" id="signupPasswordInput" class="form-input" placeholder="Min 6 characters">
                </div>
           
                <button type="submit" id="signUpBtn" class="btn-login">Create Account</button>
                <span class="auth-link" onclick="toggleAuthView('signin')">Back to Sign In</span>
            </form>
        </div>

        <div id="forgotPasswordView" style="display:none;">
             <form id="forgot-password-form" class="auth-form">
                <p class="auth-welcome">Reset Password. Enter your email to receive a reset link.</p>

                <div class="form-group">
                    <label for="resetEmailInput">Email Address</label>
                    <input type="email" id="resetEmailInput" class="form-input" placeholder="Enter your work email">
                </div>
                <button type="submit" id="sendResetBtn" class="btn-login">Send Reset Link</button>
                <span class="auth-link" onclick="toggleAuthView('signin')">Back to Sign In</span>
            </form>
        </div>
          
        <div id="updatePasswordView" style="display:none;">
             <form id="update-password-form" class="auth-form">
                <p class="auth-welcome">Set New Password.</p>

                <div class="form-group">
                    <label for="newPasswordInput">New Password</label>
                    <input type="password" id="newPasswordInput" class="form-input" placeholder="Enter your new password">
                </div>
                <button type="submit" id="updatePasswordBtn" class="btn-login">Update Password</button>
            </form>
        </div>

        <div id="authNotice" class="auth-notice"></div>

        <div class="auth-footer">
            WFM Advisor Portal (v6-Redesign)
        </div>
      </div>
    </div>
  </div>

  <aside class="app-sidebar">
    <div class="sidebar-header">
        WFM Advisor
    </div>
    <div class="sidebar-profile">
        <span id="advisorName">Loading...</span>
        <span id="teamName" style="display:none;"></span>
    </div>
    <nav class="sidebar-nav" id="main-navigation">
        
        <div class="nav-separator">SCHEDULE</div>

        <button class="nav-link active" data-tab="tab-my-schedule" title="My Schedule">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
            <span>My Schedule</span>
        </button>

        <button class="nav-link" data-tab="tab-team-schedule" id="teamToggleBtn" title="Team Schedule">
             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
            <span>Team Schedule</span>
        </button>

         <div class="nav-separator">REQUESTS &amp; BALANCES</div>

         <button class="nav-link disabled" data-tab="tab-time-off" title="Time Off">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19l7-7 3 3-7 7-3-3z"></path><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path></svg>
            <span>Holidays</span>
            <span class="coming-soon-tag">SOON</span>
        </button>

        <button class="nav-link disabled" data-tab="tab-shift-swap" title="Shift Swap">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 17l5-5-5-5M19.8 12H9M8 7l-5 5 5 5"/></svg>
            <span>Shift Swap</span>
            <span class="coming-soon-tag">SOON</span>
        </button>

        <button class="nav-link disabled" data-tab="tab-overtime" title="Overtime">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                <polyline points="17 6 23 6 23 12"></polyline>
            </svg>
            <span>Overtime</span>
            <span class="coming-soon-tag">SOON</span>
        </button>

        <div class="nav-separator">PERFORMANCE</div>
        <button class="nav-link disabled" data-tab="tab-metrics" title="My Metrics">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
            <span>My Metrics</span>
            <span class="coming-soon-tag">SOON</span>
        </button>

    </nav>
    <div class="sidebar-footer">
        <button id="signOutBtn" class="btn ghost" style="width: 100%;">Sign out</button>
    </div>
  </aside>

  <main class="app-main-content">
    
    <div class="top-bar">
        <div class="bar">
          <h1 style="margin: 0; font-size: 20px;" id="viewTitle">My Schedule</h1>
        </div>
        <div class="bar" style="gap: 8px;"> <button id="prevBtn" class="btn secondary">◀</button> <input id="weekStart" type="date" class="form-input" style="text-align:center;" />
          <button id="nextBtn" class="btn secondary">▶</button>
        </div>
    </div>

    <div class="content-area">
      <div class="content-area-constrained">

       <div class="notice-container">
           <div id="realtimeNote" class="notice danger" style="display:none;">
                Live Update: The schedule data was just updated.
           </div>
           <div id="infoNote" class="notice info" style="display:none;"></div>
       </div>

        <div id="tab-my-schedule" class="tab-content active">
            </div>

        <div id="tab-team-schedule" class="tab-content">
            <div class="view-controls">
                <div class="day-selector-group" id="teamDaySelectorGroup" style="display: flex;">
                    <label for="teamDaySelector">Select Day:</label>
                    <select id="teamDaySelector" class="form-select"></select>
                </div>
                <div class="day-selector-group" id="teamSelectorGroup" style="display: none; margin-left: 16px; border-left: 1px solid rgba(0,0,0,0.1); padding-left: 16px;">
                    <label style="margin-right:8px;">View Team:</label>
                    <div style="position:relative;">
                        <button id="teamSelectorBtn" class="form-select" style="text-align:left; min-width:220px; display:flex; justify-content:space-between; align-items:center; background:white; cursor:pointer;">
                            <span>My Team</span> <span style="font-size:10px;">▼</span>
                        </button>
                        <div id="teamSelectorList" style="display:none; position:absolute; top:100%; left:0; width:100%; background:#fff; border:1px solid #E5E7EB; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.15); z-index:50; padding:8px; max-height:400px; overflow-y:auto;"></div>
                    </div>
                </div>
                <div class="view-toggle-group" id="teamViewToggleGroup">
                    <button class="btn-toggle active" data-view="daily">Daily Timeline</button>
                    <button class="btn-toggle" data-view="weekly">Weekly Grid</button>
                </div>
            </div>
             <div id="teamScheduleContainer">
                </div>
        </div>

        <div id="tab-time-off" class="tab-content">
             <div class="placeholder-content">
                <h2>Time Off Management (Coming Soon)</h2>
                <p>View balances and request holidays here in the future.</p>
             </div>
         </div>
         <div id="tab-shift-swap" class="tab-content">
             <div class="placeholder-content">
                <h2>Shift Swap (Coming Soon)</h2>
                <p>Trade shifts with colleagues here in the future.</p>
             </div>
         </div>
          <div id="tab-metrics" class="tab-content">
             <div class="placeholder-content">
                <h2>My Metrics (Coming Soon)</h2>
                <p>View your performance statistics here in the future.</p>
             </div>
         </div>
      </div>
    </div>
  </main>
<div class="modal-backdrop" id="directorEditModal" style="display:none;">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h2 id="dirEditTitle">Edit Shift</h2>
        <button class="btn-icon modal-close" onclick="closeDirectorEditor()">
           <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
      </div>
      <div class="modal-body" style="display:flex; flex-direction:column; gap:16px;">
        
        <input type="hidden" id="dirEditAdvisorId">
        <input type="hidden" id="dirEditDateISO">

        <div class="form-group">
            <label style="font-size:12px; font-weight:600; color:#64748B;">Start Time</label>
            <input type="time" id="dirEditStart" class="form-input" style="font-size:16px; padding:10px;">
        </div>

        <div class="form-group">
            <label style="font-size:12px; font-weight:600; color:#64748B;">End Time</label>
            <input type="time" id="dirEditEnd" class="form-input" style="font-size:16px; padding:10px;">
        </div>

        <div class="form-group">
            <label style="font-size:12px; font-weight:600; color:#64748B;">Reason / Auth</label>
            <input type="text" id="dirEditReason" class="form-input" placeholder="e.g. Authorized by Darren">
        </div>

        <div style="background:#F8FAFC; padding:12px; border-radius:8px; border:1px solid #E2E8F0; font-size:11px; color:#64748B; line-height:1.4;">
            <strong>Note:</strong> Changing times will automatically extend or trim the shift. Breaks will be preserved where possible.
        </div>

        <div style="background:#F1F5F9; padding:12px; border-radius:8px; margin-top:8px; border:1px solid #E2E8F0;">
            
            <div style="display:flex; gap:8px; margin-bottom:8px;">
                <select id="dirAddType" class="form-select" style="flex:2; padding:6px; font-size:12px; height:32px;">
                    <option value="Meeting">Meeting</option>
                    <option value="Training">Training</option>
                    <option value="Admin">Admin</option>
                    <option value="121">121</option>
                    <option value="Break">Break</option>
                </select>
                <input type="time" id="dirAddStart" class="form-input" style="flex:2; padding:6px; font-size:12px; height:32px;">
                <input type="number" id="dirAddDur" class="form-input" placeholder="Mins" value="30" style="flex:1; padding:6px; font-size:12px; height:32px;">
            </div>
            <button class="btn btn-sm btn-secondary" style="width:100%;" onclick="addDirectorActivityToList()">+ Insert Activity</button>
            <ul id="dirActivityList" style="list-style:none; padding:0; margin:8px 0 0 0; font-size:12px; color:#0F172A;"></ul>
        </div>

        <div style="margin-top:16px; border-top:1px solid #eee; padding-top:16px; display:flex; gap:12px;">
            <button type="button" class="btn btn-secondary" onclick="handleDirectorUndo()" id="btnDirectorUndo" disabled style="flex:1; opacity:0.7;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:6px;"><path d="M3 7v6h6"></path><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"></path></svg>
                Undo
            </button>
            <button type="button" class="btn" style="flex:2; background-color: #2563EB;" onclick="handleDirectorSave()" id="btnDirectorSave">Update Schedule</button>
        </div>

      </div>
    </div>
  </div>
<script>
// --- Configuration ---
const SUPABASE_URL = "https://oypdnjxhjpgpwmkltzmk.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95cGRuanhoanBncHdta2x0em1rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4Nzk0MTEsImV4cCI6MjA3NTQ1NTQxMX0.Hqf1L4RHpIPUD4ut2uVsiGDsqKXvAjdwKuotmme4_Is";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// --- DOM Elements (ELS) ---
const ELS = {
    // Auth
    authForm: document.getElementById("auth-form"),
    forgotPasswordForm: document.getElementById("forgot-password-form"),
    updatePasswordForm: document.getElementById("update-password-form"),
    signInView: document.getElementById("signInView"),
    forgotPasswordView: document.getElementById("forgotPasswordView"),
    updatePasswordView: document.getElementById("updatePasswordView"),
    emailInput: document.getElementById("emailInput"),
    resetEmailInput: document.getElementById("resetEmailInput"),
    newPasswordInput: document.getElementById("newPasswordInput"),
    passwordInput: document.getElementById("passwordInput"),
    signInBtn: document.getElementById("signInBtn"),
    sendResetBtn: document.getElementById("sendResetBtn"),
    updatePasswordBtn: document.getElementById("updatePasswordBtn"),
    authNotice: document.getElementById("authNotice"),

    // App Layout & Nav
    mainNavigation: document.getElementById("main-navigation"),
    viewTitle: document.getElementById("viewTitle"),
    
    // Profile/Header
    advisorNamePill: document.getElementById("advisorName"),
    teamNamePill: document.getElementById("teamName"),
    weekStartInput: document.getElementById("weekStart"),
    prevBtn: document.getElementById("prevBtn"),
    nextBtn: document.getElementById("nextBtn"),
    signOutBtn: document.getElementById("signOutBtn"),
    teamToggleBtn: document.getElementById("teamToggleBtn"),
    
    // Views
    myRotaGrid: document.getElementById("tab-my-schedule"),
    teamScheduleContainer: document.getElementById("teamScheduleContainer"),
    infoNote: document.getElementById("infoNote"),
    realtimeNote: document.getElementById("realtimeNote"),

    // Team View Controls
    teamViewToggleGroup: document.getElementById("teamViewToggleGroup"),
    teamDaySelectorGroup: document.getElementById("teamDaySelectorGroup"),
    teamDaySelector: document.getElementById("teamDaySelector"),
    teamSelector: document.getElementById("teamSelector"),
    teamSelectorGroup: document.getElementById("teamSelectorGroup"),
};

// --- Constants & Helpers ---
const DAYS = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
// Constants for the My Schedule Time Grid visualization
const TIMEGRID_START_H = 8; // 8 AM
const TIMEGRID_END_H = 21;
// 9 PM
const TIMEGRID_INTERVAL_MIN = 30; // 30 minute slots

// Constants for the Team Daily Gantt visualization (New)
// Using a wider range (05:00-23:00) similar to the planner
const GANTT_START_MIN = 5 * 60; // 05:00
const GANTT_END_MIN = 23 * 60; // 23:00
const GANTT_DURATION_MIN = GANTT_END_MIN - GANTT_START_MIN;


// Get today's date in ISO format for comparison (using local time)
const TODAY_ISO = new Date().toLocaleDateString('en-CA', {year: 'numeric', month: '2-digit', day: '2-digit'});

// Date Helpers
function toMonday(d){
  const x = new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0, 0, 0, 0);
  const dow = x.getDay();
  const diff = (dow === 0 ? -6 : 1 - dow);
  x.setDate(x.getDate() + diff);
  return x;
}
function fmtDateLocal(d){
  return d.toLocaleDateString('en-CA', {year: 'numeric', month: '2-digit', day: '2-digit'});
}
function fmtDateFriendly(d) {
    return d.toLocaleDateString("en-GB", { month: "short", day: "numeric" });
}
function addDays(d,n){ const x=new Date(d.getFullYear(), d.getMonth(), d.getDate()); x.setDate(x.getDate()+n); return x; }
function hhmmToMinutes(t){ 
    if (!t) return 0;
   const [h,m]=(t.split(":")||["0","0"]).map(Number); 
    return h*60+m; 
}

// Robust Minutes to Time formatter
const m2t = (minutes) => {
    if (minutes === null || isNaN(minutes)) return "";
    let roundedMinutes = Math.round(minutes);
    // We generally don't wrap around midnight (1440) unless specifically needed for overnight shifts, 
    // but for a 05:00-23:00 view, it's safer not to wrap.
    // if (roundedMinutes >= 1440) roundedMinutes -= 1440; 
    const h = Math.floor(roundedMinutes / 60);
    const m = roundedMinutes % 60;
    // Handle minute rounding up to the next hour
    if (m === 60) return `${String(h + 1).padStart(2, '0')}:00`;
    return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
};

// Helper: Get contrasting text color (black or white) based on background brightness
function getContrastingTextColor(hexColor) {
    if (!hexColor) return '#1F2937';
    try {
        // Handle CSS variables by trying to compute the style
        if (hexColor.startsWith('var(')) {
            const computedColor = getComputedStyle(document.documentElement).getPropertyValue(hexColor.substring(4, hexColor.length - 1)).trim();
            if (computedColor) {
                hexColor = computedColor;
            } else {
                return '#FFFFFF'; // Default if variable fails
            }
        }

        // Ensure hex format is valid (simple check)
        if (!hexColor.startsWith('#')) {
             // If not a hex code (e.g., a named color), we default to dark text for safety
             return '#1F2937';
        }

        const hex = hexColor.replace('#', '');
        const r = parseInt(hex.length === 3 ? hex.substr(0, 1).repeat(2) : hex.substr(0, 2), 16);
        const g = parseInt(hex.length === 3 ? hex.substr(1, 1).repeat(2) : hex.substr(2, 2), 16);
        const b = parseInt(hex.length === 3 ? hex.substr(2, 1).repeat(2) : hex.substr(4, 2), 16);
        
        const brightness = ((r * 299) + (g * 587) + (b * 114)) / 1000;
        return (brightness > 128) ? '#1F2937' : '#FFFFFF';
    } catch (e) {
        return '#FFFFFF';
    }
};


// Helper: Calculate the length (in weeks) of a rotation pattern
function calculateRotationLength(pattern) {
    let numWeeks = 0;
    if (pattern && pattern.pattern && Object.keys(pattern.pattern).length > 0) {
        const keys = Object.keys(pattern.pattern);
        const weekNumbers = keys.map(k => {
            const match = k.match(/^Week ?(\d+)$/i);
            return match ? parseInt(match[1], 10) : 0;
        });
        const maxWeek = Math.max(0, ...weekNumbers);
        if (maxWeek > 0) {
            numWeeks = maxWeek;
        }
    }
    return numWeeks;
};

// Calculates the effective week number based on the assignment start date
function getEffectiveWeek(weekStartISO, assignment, getPatternByName) {
    try {
        if (!assignment || !assignment.start_date || !weekStartISO) return null;

        const [y1, m1, d1] = assignment.start_date.split('-').map(Number);
        const [y2, m2, d2] = weekStartISO.split('-').map(Number);
        if (isNaN(y1) || isNaN(y2)) return null;

        const startUTC = Date.UTC(y1, m1 - 1, d1);
        const checkUTC = Date.UTC(y2, m2 - 1, d2);
        const diffTime = checkUTC - startUTC;
        if (diffTime < 0) return null; // Check week is before assignment started

        // Calculate 0-based week difference
        const diffWeeks = Math.floor(diffTime / (1000 * 60 * 60 * 24 * 7));

        const pattern = getPatternByName(assignment.rotation_name);
        let numWeeksInRotation = calculateRotationLength(pattern);
        if (numWeeksInRotation === 0) return null;

        // Get the offset, defaulting to 1
const offset = assignment.start_week_offset || 1;

// Calculate total weeks elapsed
const rawWeek = diffWeeks + offset;

// INFINITE LOOP FIX: Wrap around using modulo arithmetic
const effectiveWeek = ((rawWeek - 1) % numWeeksInRotation) + 1;

return effectiveWeek;
    } catch (e) {
        console.error("Error calculating effective week:", e);
        return null;
    }
};

// Helper: Finds the correct key in the pattern data
function findWeekKey(patternData, weekNumber) {
    const keys = Object.keys(patternData);
    return keys.find(k => {
        const match = k.match(/^Week ?(\d+)$/i);
        return match && parseInt(match[1], 10) === weekNumber;
    });
};

// Helper: Debounce function for Realtime stabilization
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
};


// --- Application State ---
const STATE = {
    user: null,
    advisorId: null,
    advisorName: "",
    leaderId: null,
    teamMembers: [],
    teamMemberIds: new Set(),
    monday: toMonday(new Date()),
    definitions: {}, // Centralized store for ALL shift definitions
    components: {}, // Store for schedule components (for structure format)
    currentTab: 'tab-my-schedule',
    currentWeekData: null,
    rotaRealtimeChannel: null,
    
    exceptions: [], // Stores schedule_exceptions
    rotationPatterns: {}, // Stores rotation_patterns by name
    assignments: new Map(), // Stores assignments by advisor_id

    // New State for Team View
    teamViewMode: 'daily', // 'daily' or 'weekly'
    teamViewDayIndex: 0, // 0=Monday, 6=Sunday
};

/* ---- Live Schedule Calculation ---- */

// Converts planner-style structures (using component_id) into display format
function structureToSegments(structure) {
    if (!Array.isArray(structure)) return [];
    // Ensure sorting by start time
    const sortedStructure = structure.sort((a, b) => (a.start_min || 0) - (b.start_min || 0));
    
    return sortedStructure.map(item => {
        const component = STATE.components[item.component_id];
        const code = component ? component.name : "Unknown Activity";
        const startMin = item.start_min || 0;
        
        let endMin = item.end_min;
        // Calculate end time if only duration is provided
        if (endMin === undefined && item.duration_min !== undefined) {
            endMin = startMin + item.duration_min;
        }
        endMin = endMin || 0;
        
        const start = m2t(startMin);
        const end = m2t(endMin);

        // Use the component's defined color if available
        const color = component ? component.color : '#475569';

        return { code, start, end, startMin, endMin, color };
    });
}


// --- The Live Schedule Calculator ---
function calculateLiveSegments(advisorId, dayName, weekStartISO) {
    // Determine the ISO date for the calculation
    const date = addDays(new Date(weekStartISO + "T00:00:00"), DAYS.indexOf(dayName));
    const dateISO = fmtDateLocal(date);

    // 1. Check for an Exception (Priority 1)
    const exception = STATE.exceptions.find(e => e.advisor_id === advisorId && e.exception_date === dateISO);
    if (exception) {
        // Use structureToSegments to convert the exception
        return structureToSegments(exception.structure || []); // Return segments or RDO
    }

    // 2. Check for Rotation (Priority 2)
    const assignment = STATE.assignments.get(advisorId);
    if (!assignment || !assignment.rotation_name) {
        return []; // No assignment = RDO
    }

    // 3. Calculate effective week
    const effectiveWeek = getEffectiveWeek(
        weekStartISO, 
        assignment,
        (name) => STATE.rotationPatterns[name]
    );

    if (effectiveWeek === null) {
        return []; // Not in rotation this week = RDO
    }

    // 4. Find pattern and shift code
    const pattern = STATE.rotationPatterns[assignment.rotation_name];
    if (!pattern || !pattern.pattern) {
        return []; // Pattern missing = RDO
    }

    const weekKey = findWeekKey(pattern.pattern, effectiveWeek);
    const weekPattern = weekKey ? pattern.pattern[weekKey] : {};
    
    // Find shift code by day index (1-7)
    const dayIndex = DAYS.indexOf(dayName) + 1;
    const shiftCode = weekPattern[dayIndex.toString()];

    if (!shiftCode) {
        return []; // No shift code = RDO
    }
    
    // 5. Get Shift Definition
    const definition = STATE.definitions[String(shiftCode).trim()];
    if (!definition || !definition.structure) {
        console.warn(`Shift code ${shiftCode} not found in definitions.`);
        return []; // Definition missing = RDO
    }

    // 6. Return the structure from the definition, converted to segments
    return structureToSegments(definition.structure);
}
  

// --- Initialization & Authentication (UNCHANGED) ---
async function init(){
  // 1. Setup Auth UI Events
  setupAuthUIEvents();

  // 2. Check for Password Recovery Mode
  const hash = window.location.hash;
  if (hash && hash.includes("type=recovery")) {
      toggleAuthView('update');
  }

  // 3. Load Definitions (Crucial before Auth check resolves)
  await Promise.all([loadAllDefinitions(), loadComponents()]);

  // 4. Authentication Check
  await supabase.auth.getSession();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user){
    // If no user and not in recovery mode, show login
    if (!hash || !hash.includes("type=recovery")) {
        document.body.classList.remove('authenticated');
    }
    return;
  }

  // If user exists
  STATE.user = user;
  
  // 5. Identify Advisor and Team
  await identifyAdvisorAndTeam(user);

  // 6. Setup App UI Controls
  setupAppUIEvents();
  
  // 7. Show App, Initial Render, and Start Realtime
  if (ELS.updatePasswordView.style.display !== 'block') {
    showApp();
    await loadAndRender();
    await startRealtime();
  }
}

function showApp() {
    document.body.classList.add('authenticated');
    ELS.advisorNamePill.textContent = STATE.advisorName || "Profile Not Linked";
    ELS.weekStartInput.value = fmtDateLocal(STATE.monday);
    // Initialize Team Day Selector
    updateTeamDaySelector();
}

// Load definitions
async function loadAllDefinitions() {
    const { data } = await supabase.from("shift_definitions").select("*");
    STATE.definitions = {};
    (data || []).forEach(def => {
        if (def.code) {
            STATE.definitions[String(def.code).trim()] = def;
        }
    });
}

// Load components
async function loadComponents() {
    const { data } = await supabase.from("schedule_components").select("id, name, color");
    STATE.components = {};
    (data||[]).forEach(c => STATE.components[c.id] = c);
}


async function identifyAdvisorAndTeam(user) {
    // 1. Identify Advisor ID
    const { data: profile } = await supabase.from("profiles").select("advisor_id").eq("user_id", user.id).maybeSingle();

    if (profile && profile.advisor_id){
        STATE.advisorId = profile.advisor_id;
    } else {
        const { data: adv } = await supabase.from("advisors").select("id").ilike("email", user.email).maybeSingle();
        if (adv) STATE.advisorId = adv.id;
    }

    if (!STATE.advisorId) {
        ELS.teamToggleBtn.disabled = true;
        ELS.teamToggleBtn.classList.add('disabled');
        return;
    }

    // 2. Fetch Advisor Details
    const { data: advisorDetails } = await supabase.from("advisors").select("name, leader_id").eq("id", STATE.advisorId).maybeSingle();

    if (advisorDetails) {
        STATE.advisorName = advisorDetails.name;
        STATE.leaderId = advisorDetails.leader_id;

        // --- NEW LOGIC: NAME-BASED MULTI-TEAM + DIRECTOR ---
        
        // 1. Find ALL Leader IDs that match my Name (Fix for Leaders with 2+ Teams)
        const { data: myLeaderIdentities } = await supabase
            .from("leaders")
            .select("id, name")
            .eq("name", STATE.advisorName); 

        // 2. Check for direct subordinates (Standard check)
        const { data: directSubordinates } = await supabase
            .from("advisors")
            .select("id")
            .eq("leader_id", STATE.advisorId);

        // 3. Check if I am explicitly listed in 'leaders' (Fix for ATLs) + Check Role
        const { data: meAsLeader } = await supabase
            .from("leaders")
            .select("id, role")
            .eq("id", STATE.advisorId)
            .maybeSingle();

        const isDirector = meAsLeader && meAsLeader.role === 'Director';
        // I am a leader if: (I have name matches) OR (I have subordinates) OR (I am in the leaders table)
        const isLeader = (myLeaderIdentities && myLeaderIdentities.length > 0) || (directSubordinates && directSubordinates.length > 0) || !!meAsLeader;

        if (isDirector) {
             // === SCENARIO: DIRECTOR ===
             STATE.isDirector = true;
             STATE.teamMembers = []; // Start empty (He will select from dropdown)
             ELS.teamNamePill.textContent = `Director Mode: ${STATE.advisorName}`;
             ELS.teamNamePill.style.color = '#F59E0B'; // Gold
             ELS.teamNamePill.style.display = '';

             // ** DIRECTOR DROPDOWN (Full Access) **
             const { data: allLeaders } = await supabase
                .from("leaders")
                .select("id, name, sites (name)")
                .order("name");

             if (allLeaders) {
                const listEl = document.getElementById('teamSelectorList');
                const btnEl = document.getElementById('teamSelectorBtn');
                listEl.style.minWidth = '100%'; listEl.style.width = 'max-content'; 

                // 1. Option to "View All Staff" (Special for Director)
                // 1. "Select All" Option
                let html = `
                    <label style="display:flex; align-items:center; padding:8px 12px; cursor:pointer; border-bottom:1px solid #E5E7EB; background:#F9FAFB; position:sticky; top:0; z-index:10;">
                        <input type="checkbox" id="selectAllTeams" style="margin-right:8px;"> 
                        <span style="font-weight:700; font-size:13px; color:#4B5563;">SELECT ALL TEAMS</span>
                    </label>
                `;
                
                // 2. Add All Leaders
                allLeaders.forEach(l => {
                    const siteName = l.sites ? l.sites.name : '';
                    const siteTag = siteName ? `<span style="background:#F3F4F6; color:#6B7280; padding:1px 6px; border-radius:4px; font-size:10px; font-weight:600; margin-left:12px; flex-shrink:0;">${siteName}</span>` : '';

                    html += `<label style="display:flex; align-items:center; justify-content:space-between; padding:8px 12px; cursor:pointer; white-space:nowrap;">
                                <div style="display:flex; align-items:center;">
                                    <input type="checkbox" value="${l.id}" style="margin-right:8px;"> 
                                    <span style="font-size:13px;">${l.name}</span>
                                </div>
                                ${siteTag}
                            </label>`;
                });
                
                listEl.innerHTML = html;
                document.getElementById('teamSelectorGroup').style.display = 'flex';
                
                // Update Button Text Helper
                window.updateTeamBtnText = () => {
                    const checked = listEl.querySelectorAll('input[type="checkbox"]:checked');
                    if (checked.length === 0) btnEl.firstElementChild.textContent = "Select Teams...";
                    else btnEl.firstElementChild.textContent = `${checked.length} Teams Selected`;
                };
             }
             
        } else if (isLeader) {
            // === SCENARIO: TEAM LEADER / ATL ===
            STATE.isDirector = false;
            
            // A. Gather ALL my Leader IDs (Login ID + Any IDs found by Name)
            const myIds = new Set();
            myIds.add(STATE.advisorId); 
            if (myLeaderIdentities) {
                myLeaderIdentities.forEach(identity => myIds.add(identity.id));
            }
            const myIdArray = Array.from(myIds);

            // B. Fetch ALL staff reporting to ANY of my IDs
            const { data: allMyTeams } = await supabase
                .from("advisors")
                .select("id, name")
                .in("leader_id", myIdArray)
                .order('name');

            if (allMyTeams && allMyTeams.length > 0) {
                STATE.teamMembers = allMyTeams;
            } else {
                // ATL with no team yet -> Show myself so grid isn't empty
                STATE.teamMembers = [{ id: STATE.advisorId, name: STATE.advisorName }];
            }
            
            STATE.teamMemberIds = new Set(STATE.teamMembers.map(t => t.id));
            
            ELS.teamNamePill.textContent = `Team: ${STATE.advisorName}`;
            ELS.teamNamePill.style.display = '';

            // ** NEW FEATURE: MULTI-SELECT (FILTERED - HIDES EMPTY TEAMS) **
        
        // 1. Fetch Leaders AND check who actually has staff assigned
        const [ { data: allLeaders }, { data: staffAssignments } ] = await Promise.all([
            supabase.from("leaders").select("id, name, sites (name)").order("name"),
            supabase.from("advisors").select("leader_id") // Get list of used leader IDs
        ]);

        // Create a "Set" of ID's that have at least one team member
        const leadersWithTeam = new Set();
        if (staffAssignments) {
            staffAssignments.forEach(s => leadersWithTeam.add(s.leader_id));
        }

        if (allLeaders) {
            const listEl = document.getElementById('teamSelectorList');
            const btnEl = document.getElementById('teamSelectorBtn');
            
            listEl.style.minWidth = '100%';
            listEl.style.width = 'max-content'; 

            // 1. Add "My Team" (Always show myself)
            const myInfo = allLeaders.find(l => l.id === STATE.advisorId);
            const mySiteName = myInfo && myInfo.sites ? myInfo.sites.name : '';
            const mySiteTag = mySiteName ? `<span style="background:#F3F4F6; color:#6B7280; padding:1px 6px; border-radius:4px; font-size:10px; font-weight:600; margin-left:12px; flex-shrink:0;">${mySiteName}</span>` : '';

            let html = `<label style="display:flex; align-items:center; justify-content:space-between; padding:8px 12px; cursor:pointer; border-bottom:1px solid #f3f4f6; white-space:nowrap;">
                            <div style="display:flex; align-items:center;">
                                <input type="checkbox" value="${STATE.advisorId}" checked style="margin-right:8px;"> 
                                <span style="font-weight:700; font-size:13px;">My Team (Combined)</span>
                            </div>
                            ${mySiteTag}
                        </label>`;
            
            // 2. Add Other Leaders (ONLY if they have a team)
            allLeaders.forEach(l => {
                // Show if: (It's NOT me) AND (They have staff in the Set)
                if (l.id !== STATE.advisorId && leadersWithTeam.has(l.id)) {
                    const siteName = l.sites ? l.sites.name : '';
                    const siteTag = siteName ? `<span style="background:#F3F4F6; color:#6B7280; padding:1px 6px; border-radius:4px; font-size:10px; font-weight:600; margin-left:12px; flex-shrink:0;">${siteName}</span>` : '';

                    html += `<label style="display:flex; align-items:center; justify-content:space-between; padding:8px 12px; cursor:pointer; white-space:nowrap;">
                                <div style="display:flex; align-items:center;">
                                    <input type="checkbox" value="${l.id}" style="margin-right:8px;"> 
                                    <span style="font-size:13px;">${l.name}</span>
                                </div>
                                ${siteTag}
                            </label>`;
                }
            });
            
            listEl.innerHTML = html;
            document.getElementById('teamSelectorGroup').style.display = 'flex';

            window.updateTeamBtnText = () => {
                const checked = listEl.querySelectorAll('input[type="checkbox"]:checked');
                if (checked.length === 0) btnEl.firstElementChild.textContent = "Select Team...";
                else if (checked.length === 1) {
                    const label = checked[0].closest('label');
                    const nameSpan = label.querySelector('span:not([style*="background"])'); 
                    btnEl.firstElementChild.textContent = nameSpan ? nameSpan.textContent : "1 Team Selected";
                }
                else btnEl.firstElementChild.textContent = `${checked.length} Teams Selected`;
            };
        }
            
        } else {
            // === SCENARIO: REGULAR ADVISOR ===
            if (!STATE.leaderId) {
                 ELS.teamToggleBtn.disabled = true;
                 ELS.teamToggleBtn.classList.add('disabled');
                 return;
            }

            const [teamRes, leaderRes] = await Promise.all([
                supabase.from("advisors").select("id, name").eq("leader_id", STATE.leaderId).order('name'),
                supabase.from("leaders").select("name").eq("id", STATE.leaderId).maybeSingle()
            ]);

            if (teamRes.data) {
                STATE.teamMembers = teamRes.data;
                STATE.teamMemberIds = new Set(teamRes.data.map(t => t.id));
            }
            
            if (leaderRes.data) {
                ELS.teamNamePill.textContent = `Team: ${leaderRes.data.name}`;
                ELS.teamNamePill.style.display = '';
            }
        }
    }


    // Enable for Director even if teamMembers is empty initially
    if (STATE.teamMembers.length <= 0 && !STATE.isDirector) {
        ELS.teamToggleBtn.disabled = true;
        ELS.teamToggleBtn.classList.add('disabled');
    } else {
        ELS.teamToggleBtn.disabled = false;
        ELS.teamToggleBtn.classList.remove('disabled');
    }
}

function setupAuthUIEvents() {
    if (ELS.authForm) {
        if (ELS.authForm) ELS.authForm.addEventListener('submit', handleSignInWithPassword);
    if (ELS.forgotPasswordForm) ELS.forgotPasswordForm.addEventListener('submit', handleForgotPasswordRequest);
    if (ELS.updatePasswordForm) ELS.updatePasswordForm.addEventListener('submit', handlePasswordUpdate);
    
    // NEW LISTENER
    const signUpForm = document.getElementById('signup-form');
    if (signUpForm) signUpForm.addEventListener('submit', handleSignUp);
}
}

// Toggle between Auth views
function toggleAuthView(view) {
    ELS.authNotice.style.display = 'none';
    ELS.signInView.style.display = 'none';
    ELS.forgotPasswordView.style.display = 'none';
    ELS.updatePasswordView.style.display = 'none';
    
    // Use getElementById directly since we just added this ID
    const signUpView = document.getElementById('signUpView');
    if(signUpView) signUpView.style.display = 'none';

    if (view === 'forgot') {
        ELS.forgotPasswordView.style.display = 'block';
        if (ELS.emailInput.value) ELS.resetEmailInput.value = ELS.emailInput.value;
        ELS.resetEmailInput.focus();
    } else if (view === 'update') {
        ELS.updatePasswordView.style.display = 'block';
        ELS.newPasswordInput.focus();
    } else if (view === 'signup') {
        if(signUpView) signUpView.style.display = 'block';
        const signUpInput = document.getElementById('signupEmailInput');
        if(signUpInput) signUpInput.focus();
    } else {
        ELS.signInView.style.display = 'block';
        ELS.emailInput.focus();
    }
}

// Expose toggle function to global scope for onclick attribute
window.toggleAuthView = toggleAuthView;


function setupAppUIEvents() {
    ELS.signOutBtn.onclick = handleSignOut;
    ELS.prevBtn.onclick = () => changeWeek(-7);
    ELS.nextBtn.onclick = () => changeWeek(7);
    
    ELS.weekStartInput.onchange = ()=>{
        const d = new Date(ELS.weekStartInput.value + "T00:00:00");
        if (!isNaN(d.getTime())) {
             STATE.monday = toMonday(d);
             // Update Team Day Selector
             updateTeamDaySelector();
             loadAndRender();
        }
    };

    // Navigation Logic (Sidebar)
    ELS.mainNavigation.addEventListener('click', (e) => {
        const target = e.target.closest('.nav-link');
        if (target && !target.classList.contains('active') && !target.classList.contains('disabled')) {
            const tabId = target.dataset.tab;
            switchTab(tabId);
        }
    });

    // Team View Toggle Logic (New)
    ELS.teamViewToggleGroup.addEventListener('click', (e) => {
        const target = e.target.closest('.btn-toggle');
        if (target && !target.classList.contains('active')) {
            const viewMode = target.dataset.view;
            STATE.teamViewMode = viewMode;
            
            ELS.teamViewToggleGroup.querySelectorAll('.btn-toggle').forEach(btn => btn.classList.remove('active'));
            target.classList.add('active');

            // Show/Hide Day Selector
            ELS.teamDaySelectorGroup.style.display = (viewMode === 'daily') ? 'flex' : 'none';
            
            // Re-render team view
            renderViews();
        }
    });

    // Team Day Selector Logic (New)
    ELS.teamDaySelector.addEventListener('change', (e) => {
        STATE.teamViewDayIndex = parseInt(e.target.value, 10);
        if (STATE.teamViewMode === 'daily') {
            renderViews();
        }
    });
    // Listen for clicks on the new "Acknowledge" button
ELS.realtimeNote.addEventListener('click', (e) => {
    if (e.target && e.target.id === 'ackAlertBtn') {
        acknowledgeUpdate();
    }
});
// Team Selector Logic (Multi-Select)
    const teamBtn = document.getElementById('teamSelectorBtn');
    const teamList = document.getElementById('teamSelectorList');

    if (teamBtn && teamList) {
        // Toggle Dropdown
        teamBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            teamList.style.display = teamList.style.display === 'none' ? 'block' : 'none';
        });

        // Close when clicking outside
        document.addEventListener('click', (e) => {
            if (!teamBtn.contains(e.target) && !teamList.contains(e.target)) {
                teamList.style.display = 'none';
            }
        });

        // Handle Checkbox Changes
    
        teamList.addEventListener('change', async (e) => {
            
            // A. Handle "Select All" Logic
            if (e.target.id === 'selectAllTeams') {
                const isChecked = e.target.checked;
                const allBoxes = teamList.querySelectorAll('input[type="checkbox"]:not(#selectAllTeams)');
                allBoxes.forEach(box => box.checked = isChecked);
            } else {
                // If a normal box is unchecked, uncheck the "Select All" master box
                const selectAll = document.getElementById('selectAllTeams');
                if (selectAll && !e.target.checked) selectAll.checked = false;
            }

            // B. Update Button Text
            if (window.updateTeamBtnText) window.updateTeamBtnText(); 
            
            const checkedBoxes = Array.from(teamList.querySelectorAll('input[type="checkbox"]:checked:not(#selectAllTeams)'));
            const selectedIds = checkedBoxes.map(cb => cb.value);

            if (selectedIds.length === 0) {
                 ELS.teamScheduleContainer.innerHTML = `<div class="notice info" style="margin: 24px;">Please select at least one team.</div>`;
                 
                 // FIX: Reset the Header Label when empty
                 if (STATE.isDirector) {
                     ELS.teamNamePill.textContent = `Director Mode: ${STATE.advisorName}`;
                     ELS.teamNamePill.style.color = '#F59E0B'; // Gold
                 } else {
                     ELS.teamNamePill.textContent = `Team: ${STATE.advisorName}`;
                     ELS.teamNamePill.style.color = ''; // Reset to default white
                 }
                 return;
            }

            ELS.teamScheduleContainer.innerHTML = `<div class="notice info" style="margin: 24px;">Loading teams...</div>`;

            // Fetch combined team members
            const { data: newTeam } = await supabase
                .from("advisors")
                .select("id, name")
                .in("leader_id", selectedIds) 
                .order('name');

            if (newTeam) {
                STATE.teamMembers = newTeam;
                STATE.teamMemberIds = new Set(newTeam.map(t => t.id));
                
                if (ELS.teamNamePill) {
                    ELS.teamNamePill.textContent = selectedIds.length > 1 ? `Viewing: ${selectedIds.length} Teams` : `Viewing: ${checkedBoxes[0].closest('label').querySelector('span').textContent}`;
                }
                
                loadAndRender();
            }
        });
    }
}

// (New Helper) Updates the options in the Team Day Selector based on the current week
function updateTeamDaySelector() {
    let html = '';
    let targetIndex = 0; // Default to Monday

    DAYS.forEach((dayName, i) => {
        const date = addDays(STATE.monday, i);
        
        // Check if this specific date matches Today's date
        if (fmtDateLocal(date) === TODAY_ISO) {
            targetIndex = i;
        }

        html += `<option value="${i}">${dayName} (${fmtDateFriendly(date)})</option>`;
    });

    ELS.teamDaySelector.innerHTML = html;
    
    // Set the selection to Today (if found in this week) or Monday (if looking at future/past weeks)
    STATE.teamViewDayIndex = targetIndex;
    ELS.teamDaySelector.value = targetIndex;
}


function switchTab(tabId) {
    STATE.currentTab = tabId;
    // Update navigation active state
    document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
    const activeLink = document.querySelector(`.nav-link[data-tab="${tabId}"]`);
    if (activeLink) activeLink.classList.add('active');

    // Update content visibility
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    const activeTabContent = document.getElementById(tabId);
    if (activeTabContent) activeTabContent.classList.add('active');

    // Update View Title in Header
    if (activeLink) {
         const titleSpan = Array.from(activeLink.children).find(el => el.tagName === 'SPAN' && !el.classList.contains('coming-soon-tag'));
         if (titleSpan) ELS.viewTitle.textContent = titleSpan.textContent;
    }

    // Ensure views are rendered when switching tabs
    renderViews();
}

function changeWeek(days) {
    STATE.monday = addDays(STATE.monday, days);
    ELS.weekStartInput.value = fmtDateLocal(STATE.monday);
    // Update Team Day Selector
    updateTeamDaySelector();
    loadAndRender();
}

// Handle Auth Functions (UNCHANGED)
async function handleSignInWithPassword(event){
  event.preventDefault();
  ELS.authNotice.style.display = 'none';
  const email = ELS.emailInput.value.trim();
  const password = ELS.passwordInput.value;
  
  if (!email || !password) {
    ELS.authNotice.textContent = "Please enter both email and password.";
    ELS.authNotice.className = 'auth-notice error';
    ELS.authNotice.style.display = 'block';
    return;
  }
  
  ELS.signInBtn.disabled = true;
  ELS.signInBtn.textContent = "Signing In...";

  try{
    const { error } = await supabase.auth.signInWithPassword({
      email: email,
      password: password,
    });

    if (error) throw error;

    // Success: Reload the page to trigger init() 
    location.reload();

  }catch(e){ 
    let errorMessage = e.message.includes("Invalid login credentials") ? "Invalid email or password." : e.message;
    ELS.authNotice.textContent = "Error: " + errorMessage;
    ELS.authNotice.className = 'auth-notice error';
    ELS.authNotice.style.display = 'block';
  }
  finally{ 
    ELS.signInBtn.disabled = false;
    ELS.signInBtn.textContent = "Sign In";
  }
}

async function handleForgotPasswordRequest(event) {
    event.preventDefault();
    ELS.authNotice.style.display = 'none';
    const email = ELS.resetEmailInput.value.trim();

    if (!email) {
        ELS.authNotice.textContent = "Please enter your email address.";
        ELS.authNotice.className = 'auth-notice error';
        ELS.authNotice.style.display = 'block';
        return;
    }

    ELS.sendResetBtn.disabled = true;
    ELS.sendResetBtn.textContent = "Sending...";

    try {
        let redirectUrl = undefined;
        if (location.origin && location.origin !== "null" && location.protocol !== 'file:') {
            redirectUrl = location.origin + location.pathname;
        }

        const { error } = await supabase.auth.resetPasswordForEmail(email, {
            redirectTo: redirectUrl,
        });

        if (error) throw error;

        ELS.authNotice.textContent = "Password reset link sent. Please check your email.";
        ELS.authNotice.className = 'auth-notice success';
        ELS.authNotice.style.display = 'block';
        ELS.resetEmailInput.value = '';

    } catch (e) {
        ELS.authNotice.textContent = "Error: " + e.message;
        ELS.authNotice.className = 'auth-notice error';
        ELS.authNotice.style.display = 'block';
    } finally {
        ELS.sendResetBtn.disabled = false;
        ELS.sendResetBtn.textContent = "Send Reset Link";
    }
}

async function handlePasswordUpdate(event) {
    event.preventDefault();
    ELS.authNotice.style.display = 'none';
    const newPassword = ELS.newPasswordInput.value;

    if (!newPassword || newPassword.length < 6) {
        ELS.authNotice.textContent = "Password must be at least 6 characters.";
        ELS.authNotice.className = 'auth-notice error';
        ELS.authNotice.style.display = 'block';
        return;
    }

    ELS.updatePasswordBtn.disabled = true;
    ELS.updatePasswordBtn.textContent = "Updating...";

    try {
        const { error } = await supabase.auth.updateUser({ password: newPassword });

        if (error) throw error;

        ELS.authNotice.textContent = "Password updated successfully. Initializing...";
        ELS.authNotice.className = 'auth-notice success';
        ELS.authNotice.style.display = 'block';
        
        setTimeout(() => location.href = location.pathname, 1000);

    } catch (e) {
        ELS.authNotice.textContent = "Error updating password: " + e.message;
        ELS.authNotice.className = 'auth-notice error';
        ELS.authNotice.style.display = 'block';
    } finally {
        ELS.updatePasswordBtn.disabled = false;
        ELS.updatePasswordBtn.textContent = "Update Password";
    }
}

async function handleSignUp(event) {
    event.preventDefault();
    ELS.authNotice.style.display = 'none';
    
    const email = document.getElementById('signupEmailInput').value.trim();
    const password = document.getElementById('signupPasswordInput').value;
    const btn = document.getElementById('signUpBtn');

    if (!email || !password || password.length < 6) {
        ELS.authNotice.textContent = "Please enter a valid email and a password (min 6 chars).";
        ELS.authNotice.className = 'auth-notice error';
        ELS.authNotice.style.display = 'block';
        return;
    }

    btn.disabled = true;
    btn.textContent = "Creating...";

    try {
        const { data, error } = await supabase.auth.signUp({
            email: email,
            password: password,
            options: {
                // Fix 404: Force the email link to come back to THIS exact page
                emailRedirectTo: window.location.href 
            }
        });

        if (error) throw error;

        // Success message
        ELS.authNotice.innerHTML = "<strong>Success!</strong><br>A confirmation link has been sent to " + email + ".<br>Please check your inbox to log in.";
        ELS.authNotice.className = 'auth-notice success';
        ELS.authNotice.style.display = 'block';
        
        // Clear inputs
        document.getElementById('signupPasswordInput').value = '';

    } catch (e) {
        ELS.authNotice.textContent = "Error: " + e.message;
        ELS.authNotice.className = 'auth-notice error';
        ELS.authNotice.style.display = 'block';
    } finally {
        btn.disabled = false;
        btn.textContent = "Create Account";
    }
}

async function handleSignOut(){
    await stopRealtime();
    
    await supabase.auth.signOut();
    location.href = location.pathname;
}

// --- Main Data Loading Logic (UNCHANGED LOGIC) ---
async function loadAndRender(){
    ELS.infoNote.style.display="none";
    if (!STATE.advisorId){
        const msg = `<div class="notice info" style="margin: 24px;">Your account isn’t linked to an advisor profile. Please contact the planning team.</div>`;
        ELS.myRotaGrid.innerHTML = msg;
        return;
    }
  
    // Show loading indicators
    const loadingMsg = `<div class="notice info" style="margin: 24px;">Loading schedule...</div>`;
    if (STATE.currentTab === 'tab-my-schedule' && (ELS.myRotaGrid.innerHTML.trim() === '' || ELS.myRotaGrid.querySelector('.notice.info'))) {
        ELS.myRotaGrid.innerHTML = loadingMsg;
    }
    if (STATE.currentTab === 'tab-team-schedule' && (ELS.teamScheduleContainer.innerHTML.trim() === '' || ELS.teamScheduleContainer.querySelector('.notice.info'))) {
        ELS.teamScheduleContainer.innerHTML = loadingMsg;
    }


    const mondayISO = fmtDateLocal(STATE.monday);
    const dateRange = Array.from({length: 7}, (_, i) => fmtDateLocal(addDays(STATE.monday, i)));
    
    // Store mondayISO in the state object so our calculator can find it
    STATE.currentWeekData = {
        mondayISO: mondayISO
    };
    
   // 1. Fetch all data in parallel
    try {
        let idsToFetch = [];
        
        if (STATE.isDirector) {
            // DIRECTOR MODE: Fetch ALL advisors to populate the Command Center
            const { data: allAdvisors } = await supabase.from('advisors').select('id');
            if (allAdvisors) idsToFetch = allAdvisors.map(a => a.id);
        } else {
            // STANDARD MODE: Fetch Team + Me
            idsToFetch = Array.from(STATE.teamMemberIds);
            if (STATE.advisorId && !idsToFetch.includes(STATE.advisorId)) {
                idsToFetch.push(STATE.advisorId);
            }
        }

        const [exceptionsRes, patternsRes, assignmentsRes] = await Promise.all([
            // Get exceptions for Team + Me
            supabase.from("schedule_exceptions")
                    .select("advisor_id, exception_date, structure")
                    .in("advisor_id", idsToFetch)
                    .in("exception_date", dateRange),
                    
            // Get all rotation patterns
            supabase.from("rotation_patterns").select("name, pattern"),
            
            // Get history for Team + Me
            supabase.from("rotation_assignments_history")
                     .select("advisor_id, rotation_name, start_date, end_date, start_week_offset")
                     .in("advisor_id", idsToFetch)
                     .lte('start_date', dateRange[6]) 
                     .or(`end_date.is.null,end_date.gte.${mondayISO}`)
        ]);

        // 2. Process and store the data in STATE
        
        // Process Exceptions
        STATE.exceptions = exceptionsRes.data || [];
        
        // Process Patterns
        STATE.rotationPatterns = {};
        (patternsRes.data || []).forEach(p => {
            STATE.rotationPatterns[p.name] = p;
        });

        // Process Assignments (Find the *effective* one for this week)
        STATE.assignments.clear();
        const assignments = assignmentsRes.data || [];
        
        // FIX: Loop through 'idsToFetch' so we process YOUR assignment too
        idsToFetch.forEach(advId => {
            const relevantAssignments = assignments
                .filter(a => a.advisor_id === advId)
                .sort((a, b) => new Date(b.start_date) - new Date(a.start_date)); // Sort by start_date DESC
            
            // Find the *latest* assignment that is active in this week
            // Note: Using UTC dates for reliable comparison
            const effectiveAssignment = relevantAssignments.find(a => {
                const start = new Date(a.start_date + "T00:00:00Z");
                const weekStart = new Date(mondayISO + "T00:00:00Z");

                // Must have started on or before the *end* of this week
                const weekEnd = new Date(dateRange[6] + "T00:00:00Z");
                if (start > weekEnd) return false; 
                
                // If it has an end date, it must end on or after this week's *start*
                if (a.end_date) {
                    const end = new Date(a.end_date + "T00:00:00Z");
                    if (end < weekStart) return false;
                }
                return true;
            });
            
            if (effectiveAssignment) {
                STATE.assignments.set(advId, effectiveAssignment);
            }
        });

    } catch (error) {
        console.error("Error loading live data:", error);
        ELS.infoNote.textContent = "Error loading live schedule data.";
        ELS.infoNote.style.display = "block";
        return;
    }

    // 6. Render views
    renderViews();
}
  

// Renders the views based on the active tab
function renderViews() {
    if (!STATE.currentWeekData) return;

    // === DIRECTOR OVERRIDE ===
    if (STATE.isDirector && STATE.currentTab === 'tab-my-schedule') {
        renderDirectorDashboard();
        calculateDirectorStats(); // <--- This triggers the math
        return;
    }
    // =========================

    if (STATE.currentTab === 'tab-my-schedule') {
        drawMyRotaCalendar();
    } else if (STATE.currentTab === 'tab-team-schedule') {
        if (STATE.teamViewMode === 'weekly') {
            drawTeamScheduleGrid();
        } else {
            drawTeamDailyGantt();
        }
    }
}


// --- My Rota (Calendar View) Rendering (REFINED VISUALS) ---
function drawMyRotaCalendar(){
    // Optimization: Only render if the tab is active
    if (STATE.currentTab !== 'tab-my-schedule') return;
    if (!STATE.currentWeekData) return;

    // 1. Calculate all data needed for the week
    const weekData = DAYS.map((dayName, i) => {
        const date = addDays(STATE.monday, i);
        const dateISO = fmtDateLocal(date);
        // Use the centralized calculator
        const segments = calculateLiveSegments(STATE.advisorId, dayName, STATE.currentWeekData.mondayISO);
        const isToday = dateISO === TODAY_ISO;

        // Determine the summary block content (Top section)
        let summary = { type: 'rdo', text: 'RDO' };
        if (segments.length > 0) {
            const start = segments[0].start;
            const end = segments[segments.length - 1].end;
            // Use getMainActivitySummary to summarize the shift
            const mainActivity = getMainActivitySummary(segments);

          
            // Calculate duration
            const durationMin = segments.reduce((acc, seg) => {
                 return acc + (seg.endMin - seg.startMin);
            }, 0);
            
            // Display hours and minutes
            const durationH = Math.floor(durationMin / 60);
            const durationM = durationMin % 60;
            const durationStr = `${durationH}h ${String(durationM).padStart(2, '0')}m`;
            // Format: Activity \n Start - End \n Duration
            summary = { type: 'shift', text: `${mainActivity}\n${start} - ${end}\n${durationStr}` };
        }

        return { dayName, date, dateISO, segments, isToday, summary };
    });

    // 2. Generate HTML Structure
    let html = `<div class="schedule-container">`;

    // 3. Generate Summary Grid (Top Section)
    const monthName = STATE.monday.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
    
    // Gamification: Week Progress Calculation (1-7)
    const prog = Math.min(100, Math.round(((new Date().getDay()||7)/7)*100));
    
    html += `<div class="summary-grid">
                <div class="summary-header" style="display:flex; justify-content:space-between; align-items:center;">
                    <span>${monthName}</span>
                    <div style="display:flex; align-items:center; gap:8px; opacity:0.8;">
                        <span style="font-size:10px; font-weight:700; color:var(--brand-primary); letter-spacing:0.5px;">WEEK PROGRESS</span>
                        <div style="width:100px; height:6px; background:rgba(0,0,0,0.05); border-radius:10px; overflow:hidden;">
                            <div style="width:${prog}%; height:100%; background:linear-gradient(90deg, #3B82F6, #10B981); border-radius:10px;"></div>
                        </div>
                        <span style="font-size:10px; font-weight:600; color:var(--color-text-muted);">${prog}%</span>
                    </div>
                </div>`;

    weekData.forEach(day => {
        html += `<div class="summary-day">
                    <div class="summary-day-name">${day.dayName.substring(0, 3).toUpperCase()}</div>
                    <div class="summary-day-date">${day.date.getDate()}</div>`;
        
        if (day.summary.type === 'shift') {
            // Use <br> for line breaks in the summary block
            html += `<div class="summary-block">${day.summary.text.replace(/\n/g, '<br>')}</div>`;
        } else {
            html += `<div class="summary-rdo">${day.summary.text}</div>`;
        }
        
        html += `</div>`;
    });

    html += `</div>`; // Close summary-grid

    // 4. Generate Detailed Time Grid (Bottom Section)
    html += `<div class="time-grid-wrapper">
                <div class="time-grid">`;

    // 4a. Generate Grid Cells (Background)
    const startMin = TIMEGRID_START_H * 60;
    const endMin = TIMEGRID_END_H * 60;
    
    // We iterate up to (but not including) endMin for the grid lines
    for (let m = startMin; m < endMin; m += TIMEGRID_INTERVAL_MIN) {
        
        // 'isHourLine' is true when the slot *ends* on the hour (e.g., the 07:30 slot)
        const isHourLine = (m + TIMEGRID_INTERVAL_MIN) % 60 === 0;
        // Apply the 'hour-mark' class based on the line logic
        const hourClass = isHourLine ? 'hour-mark' : '';
        
        // Day Column Background Cells (These provide the horizontal lines)
        for (let i = 0; i < 7; i++) {
            html += `<div class="day-column-cell ${hourClass}"></div>`;
        }
    }

    // 4b. Generate Proportional Stacked Blocks (Size = Time, Position = Stacked)
    const rowHeight = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--timegrid-row-height')) || 24;
    const pixelsPerMinute = rowHeight / TIMEGRID_INTERVAL_MIN;

    weekData.forEach((day, index) => {
        const colIndex = index + 1; 
        html += `<div class="day-column-events" style="grid-column: ${colIndex};">`;

        day.segments.forEach(seg => {
            const color = seg.color || '#475569';
            const textColor = getContrastingTextColor(color);
            const tooltip = `${seg.code}: ${seg.start} - ${seg.end}`;

            // --- CALCULATE EXACT HEIGHT ONLY ---
            const duration = seg.endMin - seg.startMin;
            const heightPx = duration * pixelsPerMinute; 

            let blockClass = 'activity-block';
            const lowerCode = seg.code.toLowerCase();
            if (lowerCode.includes('break') || lowerCode.includes('lunch')) {
                blockClass += ' is-simple-block';
            }

            // Render with EXACT HEIGHT, but NO 'top' position (CSS stacks it)
            // UPDATED: Uses data-tooltip for Glass Hover Effect
            html += `<div class="${blockClass}" data-tooltip="${tooltip}" style="height: ${heightPx}px; background-color: ${color};
color: ${textColor};">
                        <span class="activity-title">${seg.code}</span>
                        <span class="activity-time">${seg.start} - ${seg.end}</span>
                     </div>`;
        });

        html += `</div>`; // Close day-column-events
    });
    // 5. THE NOW LASER: Calculate position
    const now = new Date();
    const currentH = now.getHours();
    const currentM = now.getMinutes();
    const totalMinutes = (currentH * 60) + currentM;
    const startGridMinutes = TIMEGRID_START_H * 60; // 08:00 = 480
    
    // Only draw if we are currently within the grid's visible hours (08:00 - 21:00)
    if (totalMinutes >= startGridMinutes && totalMinutes < (TIMEGRID_END_H * 60)) {
        const minutesSinceStart = totalMinutes - startGridMinutes;
        const topPx = minutesSinceStart * pixelsPerMinute;
        html += `<div class="now-line" style="top: ${topPx}px;"></div>`;
    }

    html += `   </div>
            </div>`; // Close time-grid and wrapper
    html += `</div>`; // Close schedule-container

    ELS.myRotaGrid.innerHTML = html;
}

// Helper to determine the main activity summary (UNCHANGED)
function getMainActivitySummary(segments) {
    const mainActivities = segments.filter(s => {
        const code = s.code.toLowerCase();
        return !code.includes('break') && !code.includes('lunch');
    }).map(s => s.code);
    
    if (mainActivities.length === 0 && segments.length > 0) return "Breaks";
    if (mainActivities.length === 0) return "";
    
    // Use a generic term like "Shift" if mixed
    if (mainActivities.every(val => val === mainActivities[0])) {
        return mainActivities[0];
    } else {
        return "Shift"; // Generic term if mixed
    }
}

// --- Team Schedule (Weekly Grid View) Rendering (REFINED VISUALS) ---
function drawTeamScheduleGrid() {
    // Optimization: Only render if the tab and view mode are active
    if (STATE.currentTab !== 'tab-team-schedule' || STATE.teamViewMode !== 'weekly') return;

    let html = `<table class="team-grid"><thead><tr><th>Advisor</th>`;
    // Header Row
    DAYS.forEach((dayName, i) => {
        const date = addDays(STATE.monday, i);
        html += `<th>${dayName}<br><small>${fmtDateFriendly(date)}</small></th>`;
    });
    html += `</tr></thead><tbody>`;

    // Body Rows
    STATE.teamMembers.forEach(member => {
        // Highlight the current user's row
        const isCurrentUser = member.id === STATE.advisorId;
        // Use a slightly different background color for the current user
        const rowStyle = isCurrentUser ? 'background-color: #E0F2FE !important;' : '';

        // Generate Initials (e.g., "Luke Pashley" -> "LP")
        const initials = member.name.split(' ').map(n => n[0]).join('').substring(0,2).toUpperCase();
        
        // Render Row with Avatar
        html += `<tr style="${rowStyle}">
                    <td>
                        <div class="avatar-cell">
                            <div class="avatar-circle">${initials}</div>
                            <div>
                                <div>${member.name}</div>
                                ${isCurrentUser ? '<div style="font-size:10px; color:var(--brand-primary); font-weight:600;">(You)</div>' : ''}
                            </div>
                        </div>
                    </td>`;
        
        DAYS.forEach(dayName => {
            // This function returns the final segments
            const liveSegments = calculateLiveSegments(member.id, dayName, STATE.currentWeekData.mondayISO);
            html += `<td>${renderTeamGridCell(liveSegments)}</td>`;
        });
        
        html += `</tr>`;
    });

    html += `</tbody></table>`;
    ELS.teamScheduleContainer.innerHTML = html;
}

function renderTeamGridCell(segments) {
    if (segments.length === 0) {
        return `<span class="weekly-rdo">RDO</span>`;
    }

    const start = segments[0].start;
    const end = segments[segments.length - 1].end;

    // Modified to use the new "Grid Shift Pill" style
    return `
        <span class="grid-shift-pill">${start} - ${end}</span>
    `;
}

// --- Team Schedule (Daily Gantt View) Rendering (NEW FEATURE) ---
function drawTeamDailyGantt() {
    // Optimization: Only render if the tab and view mode are active
    if (STATE.currentTab !== 'tab-team-schedule' || STATE.teamViewMode !== 'daily') return;

    const dayIndex = STATE.teamViewDayIndex;
    const dayName = DAYS[dayIndex];
    const mondayISO = STATE.currentWeekData.mondayISO;
    
    // FIX: Calculate specific date for the selected day view
    const specificDate = addDays(new Date(mondayISO + "T00:00:00"), dayIndex);
    const specificDateISO = fmtDateLocal(specificDate);

    // Setup the structure for the Gantt chart
    let html = `
        <div class="timeline-container" id="teamTimelineContainer">
            <div class="timeline-header">
                <div class="header-name">Name</div>
                <div class="header-timeline" id="teamTimeHeader"></div>
            </div>
            <div class="timeline-body" id="teamPlannerBody"></div>
        </div>
    `;
    ELS.teamScheduleContainer.innerHTML = html;

    // Cache dynamic elements
    const ELS_GANTT = {
        timeHeader: document.getElementById('teamTimeHeader'),
        plannerBody: document.getElementById('teamPlannerBody'),
    };

    // Render the time header (05:00 - 23:00)
    renderGanttTimeHeader(ELS_GANTT.timeHeader);

    // Render the rows
    let bodyHtml = '';

    STATE.teamMembers.forEach(member => {
        // Calculate segments for the specific day
        const segments = calculateLiveSegments(member.id, dayName, mondayISO);
        
        // Highlight the current user's row
        const isCurrentUser = member.id === STATE.advisorId;
        const rowStyle = isCurrentUser ? 'background-color: #E0F2FE !important;' : '';

        // Safety: Handle missing names
        const safeName = member.name || "Unknown";
        const initials = safeName.split(' ').map(n => n[0]).join('').substring(0,2).toUpperCase();

        bodyHtml += `
        <div class="timeline-row" style="${rowStyle}">
            <div class="timeline-name">
                <div class="avatar-circle" style="width:24px; height:24px; font-size:9px; margin-right:8px; border:1px solid white;">${initials}</div>
                <span style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                    ${safeName} ${isCurrentUser ? '<span style="color:var(--brand-primary); font-weight:600; margin-left:4px;">(You)</span>' : ''}
                </span>
            </div>
            <div class="timeline-track">
                ${renderGanttSegments(segments, member.id, specificDateISO)}
            </div>
        </div>
        `;
    });
    ELS_GANTT.plannerBody.innerHTML = bodyHtml;
}
// --- DIRECTOR COMMAND CENTER (The UI Structure) ---
function renderDirectorDashboard() {
    // SMART DATE LOGIC:
    // If selected week includes Today, show Today. Otherwise, show the Monday of that week.
    let targetDate = STATE.monday;
    const today = new Date();
    today.setHours(0,0,0,0); // Reset time to midnight for comparison
    const endOfWeek = addDays(STATE.monday, 6);

    if (today >= STATE.monday && today <= endOfWeek) {
        targetDate = today;
    }

    const dateString = targetDate.toLocaleDateString('en-GB', { weekday:'long', day:'numeric', month:'long' });
    // 2. Build the HTML Structure
    let html = `
        <div class="dir-dashboard">
            <div class="dir-section-title">
                Operational Command <span style="font-weight:300; opacity:0.5;">|</span> 
                <span style="font-weight:400; color:#64748B; font-size:16px;">${dateString}</span>
                <span style="margin-left:auto; font-size:11px; font-weight:700; color:#10B981; background:rgba(16,185,129,0.1); padding:4px 10px; border-radius:20px; display:flex; align-items:center; gap:6px;">
                    <div class="live-dot" style="width:6px; height:6px;"></div> LIVE CONNECTION
                </span>
            </div>
            
            <div class="dir-pulse-row">
                <div class="dir-card">
                    <div class="dir-card-header">
                        <div class="dir-card-title">Total Headcount</div>
                        <div class="live-dot"></div>
                    </div>
                    <div class="dir-metric-value" id="dir-val-headcount">--</div>
                    <div class="dir-metric-sub">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                        Scheduled Today
                    </div>
                </div>

                <div class="dir-card">
                    <div class="dir-card-header">
                        <div class="dir-card-title">Live Shrinkage</div>
                        <div class="live-dot red"></div>
                    </div>
                    <div class="dir-metric-value" id="dir-val-shrinkage">--%</div>
                    <div class="dir-metric-sub down">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline><polyline points="17 18 23 18 23 12"></polyline></svg>
                        Sickness / Absence
                    </div>
                </div>

                <div class="dir-card">
                    <div class="dir-card-header">
                        <div class="dir-card-title">Pending Actions</div>
                        <div style="background:#FEF3C7; color:#D97706; font-size:10px; padding:2px 6px; border-radius:4px; font-weight:700;">REQ ATTN</div>
                    </div>
                    <div class="dir-metric-value" id="dir-val-alerts">0</div>
                    <div class="dir-metric-sub">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                        System Alerts
                    </div>
                </div>

                <div class="dir-card">
                    <div class="dir-card-header">
                        <div class="dir-card-title">Live Coverage</div>
                        <div class="live-dot"></div>
                    </div>
                    <div class="dir-metric-value" id="dir-val-coverage">--%</div>
                    <div class="dir-metric-sub" style="color:#10B981;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>
                        Vs. Requirement
                    </div>
                </div>
            </div>

            <div class="dir-section-title">
                Site Performance 
                <span style="font-size:12px; color:#94A3B8; font-weight:400; background:white; padding:2px 8px; border-radius:12px; border:1px solid #E2E8F0;">Real-time</span>
            </div>
            
            <div class="dir-brand-grid" id="dir-brand-grid">
                <div style="grid-column:1/-1; padding:60px; color:#94A3B8; text-align:center; font-style:italic; background:rgba(255,255,255,0.5); border-radius:16px;">
                    <div class="live-dot" style="margin:0 auto 12px auto; background:#CBD5E1; animation:none;"></div>
                    Connecting to live feeds...
                </div>
            </div>
        </div>
    `;

    ELS.myRotaGrid.innerHTML = html;
}

// --- DIRECTOR LOGIC: THE CALCULATOR ---
async function calculateDirectorStats() {
    
    // SMART DATE LOGIC (Must match UI)
    let targetDate = STATE.monday;
    const today = new Date();
    today.setHours(0,0,0,0);
    const endOfWeek = addDays(STATE.monday, 6);

    if (today >= STATE.monday && today <= endOfWeek) {
        targetDate = today;
    }
    
    const targetISO = fmtDateLocal(targetDate); 

    // 1. Fetch Hierarchy Map
    const { data: hierarchy } = await supabase
        .from('advisors')
        .select(`id, leader_id, leaders ( site_id, sites (name) )`);
    
    if (!hierarchy) return;

    // Data Buckets
    let totalStaff = 0;
    let activeHeadcount = 0;
    let shrinkageCount = 0;
    let siteStats = {}; 

    // 2. Loop through EVERY advisor
    hierarchy.forEach(adv => {
        const advId = adv.id;
        let siteName = "Unassigned";
        if (adv.leaders && adv.leaders.sites) siteName = adv.leaders.sites.name;

        if (!siteStats[siteName]) siteStats[siteName] = { total: 0, active: 0, shrinkage: 0 };

        // A. Check Rotation
        const dayName = targetDate.toLocaleDateString('en-US', { weekday: 'long' });
        const segments = calculateLiveSegments(advId, dayName, STATE.currentWeekData.mondayISO);
        const isScheduled = segments.length > 0;
        
        // B. Check Exceptions
        const exception = STATE.exceptions.find(e => e.advisor_id === advId && e.exception_date === targetISO);
        let isSick = false;
        if (exception && exception.structure.length > 0) {
            const compId = exception.structure[0].component_id;
            const comp = STATE.components[compId];
            if (comp && (comp.type === 'Absence' || comp.name.toLowerCase().includes('sick'))) isSick = true;
        }

        // C. Tally Up
        if (isScheduled) {
            totalStaff++;
            siteStats[siteName].total++;
            
            if (isSick) {
                shrinkageCount++;
                siteStats[siteName].shrinkage++;
            } else {
                activeHeadcount++;
                siteStats[siteName].active++;
            }
        }
    });

    // 3. Update Pulse Cards
    const hcEl = document.getElementById('dir-val-headcount');
    if(hcEl) hcEl.textContent = activeHeadcount;
    
    const shrinkagePct = totalStaff > 0 ? Math.round((shrinkageCount / totalStaff) * 100) : 0;
    const shrinkEl = document.getElementById('dir-val-shrinkage');
    if(shrinkEl) {
        shrinkEl.textContent = `${shrinkagePct}%`;
        shrinkEl.style.color = shrinkagePct > 10 ? '#EF4444' : '#1E293B';
    }

    const coveragePct = totalStaff > 0 ? Math.round((activeHeadcount / totalStaff) * 100) : 0;
    const covEl = document.getElementById('dir-val-coverage');
    if(covEl) covEl.textContent = `${coveragePct}%`;

    // 4. Build Brand Grid (FIXED: No Double Divs)
    const gridEl = document.getElementById('dir-brand-grid');
    let gridHtml = '';

    Object.keys(siteStats).sort().forEach(site => {
        const stats = siteStats[site];
        if (stats.total === 0) return; 

        const siteCoverage = Math.round((stats.active / stats.total) * 100);
        
        let statusClass = 'green';
        if (siteCoverage < 85) statusClass = 'amber';
        if (siteCoverage < 70) statusClass = 'red';

        gridHtml += `
            <div class="dir-brand-card" onclick="jumpToSiteSchedule('${site}')">
                <div class="dir-brand-header">
                    <div class="dir-brand-name">${site}</div>
                    <div class="dir-status-light ${statusClass}"></div>
                </div>
                <div class="dir-progress-bar">
                    <div class="dir-progress-fill" style="width: ${siteCoverage}%; background-color: ${statusClass === 'red' ? '#EF4444' : (statusClass === 'amber' ? '#F59E0B' : '#10B981')}"></div>
                </div>
                <div class="dir-stat-row">
                    <span>Headcount</span>
                    <strong>${stats.active} / ${stats.total}</strong>
                </div>
                <div class="dir-stat-row">
                    <span>Shrinkage</span>
                    <span>${stats.shrinkage} staff</span>
                </div>
            </div>
        `;
    });

    if(gridEl) gridEl.innerHTML = gridHtml || '<div style="padding:20px; text-align:center; color:#999;">No scheduled staff found for this date.</div>';
}

function renderGanttTimeHeader(headerElement) {
    const startHour = Math.floor(GANTT_START_MIN / 60);
    const endHour = Math.floor(GANTT_END_MIN / 60);
    const totalHours = GANTT_DURATION_MIN / 60;
    
    let html = '';
    // Loop through each hour in the range
    for (let h = startHour; h <= endHour; h++) {
        const pct = (h - startHour) / totalHours * 100;
        const label = h.toString().padStart(2, '0') + ':00';
        html += `<div class="time-tick" style="left: ${pct}%;">${label}</div>`;
    }
    headerElement.innerHTML = html;
}

function renderGanttSegments(segments, advisorId, dateISO) { // <--- UPDATED ARGUMENTS
    if (!segments || segments.length === 0) {
        return '<div class="timeline-rdo-fill">RDO</div>';
    }
    
    return segments.map(seg => {
        const startPct = ((seg.startMin - GANTT_START_MIN) / GANTT_DURATION_MIN) * 100;
        const widthPct = ((seg.endMin - seg.startMin) / GANTT_DURATION_MIN) * 100;
        
        const color = seg.color || '#475569';
        const textColor = getContrastingTextColor(color);

        let blockClass = 'timeline-bar';
        const lowerCode = seg.code.toLowerCase();
        if (lowerCode.includes('break') || lowerCode.includes('lunch')) {
            blockClass += ' is-simple-block';
        }

        // DIRECTOR TRIGGER: Add onclick event
        let clickAction = '';
        let cursorStyle = '';
        
        if (STATE.isDirector) {
             // Pass the start/end times to the editor
             clickAction = `onclick="event.stopPropagation(); openDirectorEditor('${advisorId}', '${dateISO}', '${seg.start}', '${seg.end}')"`;
             cursorStyle = 'cursor: pointer; pointer-events: auto;';
        }

        return `
        <div class="${blockClass}" ${clickAction} style="left: ${startPct}%; width: ${widthPct}%; background-color: ${color}; color: ${textColor}; ${cursorStyle}" title="${seg.code} (${seg.start} - ${seg.end})">
            <span>${seg.code}</span>
        </div>
        `;
    }).join('');
}


// --- Realtime Updates (Ensuring functionality with Debounce) ---

// This is the NEW function that shows the "sticky" alert
function showUpdateNotification(customMessage) {
    console.log("Showing sticky update notification.");
    // 1. Show the Favicon Badge
    showFaviconBadge();
    // 2. Set the HTML to include the dynamic message and "Okay" button
    ELS.realtimeNote.innerHTML = `
        ${customMessage}
        <button id="ackAlertBtn" class="btn secondary" style="margin-left: 16px; padding: 4px 10px;">Okay</button>
    `;
    // 3. Show the banner
    ELS.realtimeNote.style.display = 'block';
}

// This is the NEW function that runs when "Okay" is clicked
function acknowledgeUpdate() {
    console.log("Alert acknowledged.");

    // 1. Hide the banner
    ELS.realtimeNote.style.display = 'none';

    // 2. Clear the Favicon Badge
    clearFaviconBadge();

    // 3. NOW we reload the schedule to show the change
    loadAndRender();
}


async function startRealtime() {
    if (STATE.rotaRealtimeChannel) {
        return; // Already started
    }

    console.log("Starting Realtime listener...");

    // 1. Get the "Walkie-Talkie" channel
    STATE.rotaRealtimeChannel = supabase.channel('rota-changes-advisor-portal-v3');

    // 2. Listen for the 'schedule_update' event
    STATE.rotaRealtimeChannel.on(
        'broadcast',
        { event: 'schedule_update' },
        (payload) => {
            console.log('Realtime update received:', payload);
            if (payload.payload) {
                const update = payload.payload;
                console.log("Realtime update received:", update.type);

                // --- DIRECTOR & TEAM ALERTS ---
                const isForMyTeam = STATE.teamMemberIds.has(update.advisor_id);
                const isForMe = update.advisor_id == STATE.advisorId;

                // GATEKEEPER: Director gets EVERYTHING. Leaders get Team + Self.
                if (STATE.isDirector || isForMyTeam || isForMe) {
                    console.log("Refreshing data due to relevant update.");
                    
                    // 1. SILENT REFRESH (Runs for EVERYONE, including Director)
                    // This updates the numbers, the grid, and the graphs immediately.
                    loadAndRender();

                    // 2. POP-UP BLOCKER (Specific to Director)
                    // If I am the Director, and it's not MY personal schedule, STOP here.
                    // This ensures the data updated above, but no red banner appears.
                    if (STATE.isDirector && !isForMe) {
                        return; 
                    }

                    // 3. ALERT LOGIC (Only runs for Team Leaders / Advisors / Director's own schedule)
                    // This code is identical to the original logic for TLs and Advisors.
                    if (update.date && update.date === TODAY_ISO) {
                        let msg = isForMe ? 
                            "Live Update: Your schedule changed." : 
                            "Live Update: A team member's schedule changed.";
                        showUpdateNotification(msg);
                    }
                } else {
                    console.log("Ignoring update (irrelevant to current view).");
                }
            }
        }
    );

    // 3. Subscribe to the channel
    STATE.rotaRealtimeChannel.subscribe((status) => {
        if (status === 'SUBSCRIBED') {
            console.log('Realtime connected!');
        } else if (status === 'CHANNEL_ERROR') {
            console.error('Realtime connection error.');
        }
    });
}
// --- Favicon Badge Helpers ---
function showFaviconBadge() {
    try {
        const canvas = document.createElement('canvas');
        canvas.width = 32;
        canvas.height = 32;
        const ctx = canvas.getContext('2d');

        // Draw a red circle
        ctx.fillStyle = '#EF4444'; // Red color
        ctx.beginPath();
        ctx.arc(16, 16, 16, 0, 2 * Math.PI);
        ctx.fill();

        // Draw a white "!"
        ctx.fillStyle = 'white';
        ctx.font = 'bold 24px ' + getComputedStyle(document.body).fontFamily;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('!', 16, 17);

        // Set as favicon
        const link = document.querySelector("link[rel*='icon']") || document.createElement('link');
        link.type = 'image/x-icon';
        link.rel = 'shortcut icon';
        link.href = canvas.toDataURL("image/png");
        document.getElementsByTagName('head')[0].appendChild(link);
    } catch (e) {
        console.warn("Favicon badge not supported or failed to draw.", e);
    }
}

function clearFaviconBadge() {
    const link = document.querySelector("link[rel*='icon']");
    if (link) {
        // Setting to an empty data URL is a common way to "clear" it
        link.href = 'data:,';
    }
}
async function stopRealtime() {
    if (STATE.rotaRealtimeChannel) {
        console.log("Stopping Realtime listener.");
        await supabase.removeChannel(STATE.rotaRealtimeChannel);
        STATE.rotaRealtimeChannel = null;
    }
}
// --- DIRECTOR FEATURE: JUMP TO SITE ---
window.jumpToSiteSchedule = (siteName) => {
    console.log("Jumping to site:", siteName);
    
    // 1. Switch to Team Schedule Tab
    switchTab('tab-team-schedule');

    // 2. Find the Dropdown List
    const list = document.getElementById('teamSelectorList');
    const boxes = list.querySelectorAll('input[type="checkbox"]:not(#selectAllTeams)');
    const selectAll = document.getElementById('selectAllTeams');
    if (selectAll) selectAll.checked = false; // Reset master toggle

    // 3. Loop through all boxes and tick ONLY the ones matching the Site Name
    let count = 0;
    boxes.forEach(box => {
        const label = box.closest('label');
        // Find the grey tag inside the label
        const tag = label.querySelector('span[style*="background"]');
        
        if (tag && tag.textContent.trim() === siteName) {
            box.checked = true;
            count++;
        } else {
            box.checked = false;
        }
    });

    // 4. Update the Button Text manually
    const btn = document.getElementById('teamSelectorBtn');
    if (btn) btn.firstElementChild.textContent = `Viewing: ${siteName} (${count} Teams)`;

    // 5. Trigger the "Change" event to force the grid to reload with new selection
    list.dispatchEvent(new Event('change'));
};
// --- DIRECTOR GOD MODE LOGIC (V7: PLANNER-GRADE CARVING) ---

window.directorUndoState = null;
window.directorPendingInjections = [];

// 1. OPEN THE EDITOR
window.openDirectorEditor = async (advisorId, dateISO, currentStart, currentEnd) => {
    if (!STATE.isDirector) return;
    if (dateISO !== TODAY_ISO) {
        alert("Director Mode: You can only edit the LIVE schedule (Today).");
        return;
    }

    const advisor = STATE.teamMembers.find(m => m.id == advisorId);
    const name = advisor ? advisor.name : "Advisor";

    // Capture State for Undo
    document.getElementById('dirEditTitle').textContent = `Loading ${name}...`;
    
    const { data: currentState } = await supabase
        .from('schedule_exceptions')
        .select('structure, reason')
        .eq('advisor_id', advisorId)
        .eq('exception_date', dateISO)
        .maybeSingle();

    window.directorUndoState = {
        advisor_id: advisorId,
        exception_date: dateISO,
        structure: currentState ? currentState.structure : [],
        reason: currentState ? currentState.reason : ""
    };

    // Reset UI
    window.directorPendingInjections = [];
    document.getElementById('dirActivityList').innerHTML = ''; 
    
    const undoBtn = document.getElementById('btnDirectorUndo');
    undoBtn.disabled = false;
    undoBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:6px;"><path d="M3 7v6h6"></path><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"></path></svg> Undo`;

    // Populate Form
    document.getElementById('dirEditTitle').textContent = `Edit Live: ${name}`;
    document.getElementById('dirEditAdvisorId').value = advisorId;
    document.getElementById('dirEditDateISO').value = dateISO;
    document.getElementById('dirEditStart').value = currentStart;
    document.getElementById('dirEditEnd').value = currentEnd;
    document.getElementById('dirEditReason').value = window.directorUndoState.reason || ""; 

    // Default "Add Activity" time
    const startEl = document.getElementById('dirAddStart');
    if (startEl) startEl.value = currentStart;

    document.getElementById('directorEditModal').style.display = 'flex';
};

window.closeDirectorEditor = () => {
    document.getElementById('directorEditModal').style.display = 'none';
};

// 2. ADD ACTIVITY TO LIST
window.addDirectorActivityToList = () => {
    const type = document.getElementById('dirAddType').value;
    const start = document.getElementById('dirAddStart').value;
    const dur = parseInt(document.getElementById('dirAddDur').value);

    if(!start || !dur) return;

    window.directorPendingInjections.push({ type, start, dur });

    const li = document.createElement('li');
    li.style.marginBottom = '4px';
    li.style.display = 'flex';
    li.style.justifyContent = 'space-between';
    li.innerHTML = `<span><strong>${type}</strong> @ ${start} (${dur}m)</span><span style="color:#EF4444; cursor:pointer;" onclick="this.parentElement.remove(); removeInjection('${start}')">x</span>`;
    document.getElementById('dirActivityList').appendChild(li);
};

window.removeInjection = (startVal) => {
    window.directorPendingInjections = window.directorPendingInjections.filter(i => i.start !== startVal);
};

// 3. HANDLE UNDO
window.handleDirectorUndo = async () => {
    if (!window.directorUndoState) return;
    if (!confirm("Revert to state before editing?")) return;

    const undoBtn = document.getElementById('btnDirectorUndo');
    undoBtn.textContent = "Reverting...";
    
    const { error } = await supabase.from('schedule_exceptions').upsert({
        advisor_id: window.directorUndoState.advisor_id,
        exception_date: window.directorUndoState.exception_date,
        structure: window.directorUndoState.structure,
        reason: window.directorUndoState.reason
    }, { onConflict: 'advisor_id, exception_date' });

    if (!error) {
        // Trigger update
        if (STATE.rotaRealtimeChannel) STATE.rotaRealtimeChannel.send({ type: 'broadcast', event: 'schedule_update', payload: { advisor_id: window.directorUndoState.advisor_id, date: window.directorUndoState.exception_date } });
        await loadAndRender(); 
        closeDirectorEditor(); 
    } else {
        alert("Undo failed: " + error.message);
    }
};

// --- PLANNER-GRADE LOGIC HELPERS ---

// 1. Get Safe ID
function getSafeCompId(name) {
    if (!name) return null;
    const clean = String(name).toLowerCase().trim();
    const comps = Object.values(STATE.components);
    let match = comps.find(c => (c.name || "").toLowerCase() === clean);
    if (!match) match = comps.find(c => (c.type || "").toLowerCase() === clean);
    if (!match) match = comps.find(c => (c.type || "").toLowerCase() === 'activity');
    if (!match && comps.length > 0) match = comps[0];
    return match ? match.id : null;
}

// 2. The "Carve" Logic (Ported from Planner)
function carveTime(baseStructure, injectStart, injectEnd, injectCompId) {
    let newStructure = [];
    
    // Sort base structure first
    baseStructure.sort((a, b) => a.start_min - b.start_min);

    baseStructure.forEach(seg => {
        // Case A: Segment is completely BEFORE injection -> Keep it
        if (seg.end_min <= injectStart) {
            newStructure.push(seg);
        }
        // Case B: Segment is completely AFTER injection -> Keep it
        else if (seg.start_min >= injectEnd) {
            newStructure.push(seg);
        }
        // Case C: Segment Overlaps -> Split it
        else {
            // 1. Part Before (if any)
            if (seg.start_min < injectStart) {
                newStructure.push({ 
                    component_id: seg.component_id, 
                    start_min: seg.start_min, 
                    end_min: injectStart 
                });
            }
            // (The injection itself is handled separately to ensure it's added only once)
            
            // 2. Part After (if any)
            if (seg.end_min > injectEnd) {
                newStructure.push({ 
                    component_id: seg.component_id, 
                    start_min: injectEnd, 
                    end_min: seg.end_min 
                });
            }
        }
    });

    // Add the injection itself
    newStructure.push({ 
        component_id: injectCompId, 
        start_min: injectStart, 
        end_min: injectEnd 
    });

    return newStructure.sort((a, b) => a.start_min - b.start_min);
}

// 4. SAVE (V7: FULL PLANNER LOGIC)
window.handleDirectorSave = async () => {
    const saveBtn = document.getElementById('btnDirectorSave');
    
    try {
        const advisorId = document.getElementById('dirEditAdvisorId').value;
        const dateISO = document.getElementById('dirEditDateISO').value;
        const newStartStr = document.getElementById('dirEditStart').value;
        const newEndStr = document.getElementById('dirEditEnd').value;
        let reason = document.getElementById('dirEditReason').value || "Director Override";
        
        const targetStart = hhmmToMinutes(newStartStr);
        const targetEnd = hhmmToMinutes(newEndStr);

        if (!advisorId || !dateISO || isNaN(targetStart) || isNaN(targetEnd)) {
            alert("Invalid inputs. Check times.");
            return;
        }

        saveBtn.textContent = "Processing..."; 
        saveBtn.disabled = true;

        // 1. Get Current Schedule (The "Raw Material")
        const dayName = new Date(dateISO).toLocaleDateString('en-US', { weekday: 'long' });
        const currentSegments = calculateLiveSegments(advisorId, dayName, STATE.currentWeekData.mondayISO);

        // 2. Convert to Structure Format
        let workStructure = [];
        if (currentSegments && currentSegments.length > 0) {
            currentSegments.forEach(seg => {
                const cId = getSafeCompId(seg.code);
                if (cId) {
                    workStructure.push({ 
                        component_id: cId, 
                        start_min: seg.startMin, 
                        end_min: seg.endMin 
                    });
                }
            });
        } else {
            // If empty, create a base block of "Activity"
            const baseId = getSafeCompId('Activity');
            workStructure.push({ component_id: baseId, start_min: targetStart, end_min: targetEnd });
        }

        // 3. Clip/Extend to New Start/End Times (Outer Bounds)
        let boundedStructure = [];
        // Determine "Base Activity" for filling gaps (find dominant activity)
        // Default to the first segment's type if available, else generic 'Activity'
        let baseFillId = workStructure.length > 0 ? workStructure[0].component_id : getSafeCompId('Activity');

        // A. Fill Gap at Start
        if (workStructure.length > 0 && workStructure[0].start_min > targetStart) {
            boundedStructure.push({ component_id: baseFillId, start_min: targetStart, end_min: workStructure[0].start_min });
        }

        // B. Add existing segments (clipped)
        workStructure.forEach(seg => {
            let s = Math.max(seg.start_min, targetStart);
            let e = Math.min(seg.end_min, targetEnd);
            if (s < e) {
                boundedStructure.push({ component_id: seg.component_id, start_min: s, end_min: e });
            }
        });

        // C. Fill Gap at End
        if (boundedStructure.length > 0) {
            const last = boundedStructure[boundedStructure.length - 1];
            if (last.end_min < targetEnd) {
                // Try to extend last block if it's same type, else add new
                if (last.component_id === baseFillId) {
                    last.end_min = targetEnd;
                } else {
                    boundedStructure.push({ component_id: baseFillId, start_min: last.end_min, end_min: targetEnd });
                }
            }
        } else {
            // If completely empty after clipping, recreate full block
            boundedStructure.push({ component_id: baseFillId, start_min: targetStart, end_min: targetEnd });
        }

        // 4. Apply Injections (The "Carving")
        // We process injections sequentially
        window.directorPendingInjections.forEach(inj => {
            const injStart = hhmmToMinutes(inj.start);
            const injEnd = injStart + inj.dur;
            const injId = getSafeCompId(inj.type);

            if (injId) {
                boundedStructure = carveTime(boundedStructure, injStart, injEnd, injId);
                reason += ` [+${inj.type}]`;
            }
        });

        // 5. Save
        const { error } = await supabase.from('schedule_exceptions').upsert({
            advisor_id: advisorId, 
            exception_date: dateISO, 
            structure: boundedStructure, 
            reason: reason
        }, { onConflict: 'advisor_id, exception_date' });

        if (error) throw error;

        // 6. Broadcast
        if (STATE.rotaRealtimeChannel) {
            STATE.rotaRealtimeChannel.send({ type: 'broadcast', event: 'schedule_update', payload: { advisor_id: advisorId, date: dateISO } });
        }
        
        await loadAndRender(); 
        
        saveBtn.textContent = "Saved!";
        saveBtn.style.backgroundColor = "#10B981"; 
        
        setTimeout(() => {
            closeDirectorEditor(); 
            saveBtn.textContent = "Update Schedule"; 
            saveBtn.style.backgroundColor = "#2563EB"; 
            saveBtn.disabled = false;
        }, 800);

    } catch (err) {
        console.error("Director Save Error:", err);
        alert("Failed to update: " + err.message);
        saveBtn.textContent = "Update Schedule";
        saveBtn.disabled = false;
    }
};

// --- Initialization Trigger ---
document.addEventListener("DOMContentLoaded", init);

</script>
</body>
</html>