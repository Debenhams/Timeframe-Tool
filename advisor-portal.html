<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Advisor Rota — Published</title>
<style>
  :root{
    --brand:#0d47a1; --ink:#1f2937; --paper:#ffffff; --wash:#f5f7fb; --line:#e4e9f2;
  }
  html,body{height:100%}
  body{margin:0;background:#eef2f6;color:var(--ink);font-family:Inter,Roboto,Segoe UI,system-ui,Arial,Helvetica,sans-serif}
  .topbar{background:var(--brand);color:#fff;padding:14px 18px;display:flex;align-items:center;gap:14px;box-shadow:0 4px 14px rgba(13,71,161,.18)}
  .topbar h1{margin:0;font-size:18px;font-weight:800}
  .layout{max-width:1000px;margin:18px auto;padding:0 16px}
  .panel{background:var(--paper);border:1px solid var(--line);border-radius:12px;box-shadow:0 8px 20px rgba(12,27,74,.06);overflow:hidden}
  .panel-header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid var(--line)}
  .panel-body{padding:12px 14px}
  .muted{color:#64748b}
  .btn{background:#e9eef6;color:#0f172a;border:1px solid var(--line);border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
  .btn:hover{filter:brightness(.97)}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid var(--line);padding:10px;text-align:left}
  thead th{background:#f6f8fb}
  .ok{color:#059669;font-weight:700}
  .warn{color:#b45309;font-weight:700}
  .err{color:#b91c1c;font-weight:700}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:#f7fafc;font-size:12px}
</style>
 
<!-- Supabase client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="topbar">
    <h1>Advisor Rota — Published</h1>
    <div style="margin-left:auto;display:flex;gap:6px;align-items:center">
      <button class="btn" id="prevBtn">◀ Prev</button>
      <button class="btn" id="todayBtn">Today</button>
      <button class="btn" id="nextBtn">Next ▶</button>
    </div>
  </div>
 
  <div class="layout">
    <div class="panel">
      <div class="panel-header">
        <div>
          <div id="who" style="font-weight:800">Advisor</div>
          <div class="muted" id="rangeLabel">Week</div>
        </div>
        <div class="muted" id="status">Loading…</div>
      </div>
      <div class="panel-body">
        <div id="notice" class="muted" style="margin-bottom:10px"></div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr><th style="width:160px">Day</th><th>Assignment</th></tr>
            </thead>
            <tbody id="tbody">
              <!-- rows injected -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
 
<script>
/* ========= CONFIG ========= */
const SUPABASE_URL = "https://oypdnjxhjpgpwmkltzmk.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95cGRuanhoanBncHdta2x0em1rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4Nzk0MTEsImV4cCI6MjA3NTQ1NTQxMX0.Hqf1L4RHpIPUD4ut2uVsiGDsqKXvAjdwKuotmme4_Is";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
 
/* ========= UTILS ========= */
const DAYS = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
const $ = sel => document.querySelector(sel);
function pad(n){ return String(n).padStart(2,'0'); }
function mondayOf(d){
  const x = new Date(d); const day = x.getDay(); const diff = (day===0?-6:1)-day; x.setDate(x.getDate()+diff); x.setHours(0,0,0,0); return x;
}
function fmtDate(d){ return d.toLocaleDateString('en-GB',{day:'2-digit',month:'2-digit',year:'numeric'}); }
function getParam(name){ const u=new URL(location.href); return u.searchParams.get(name); }
function setParam(name,val){
  const u = new URL(location.href);
  if(val==null) u.searchParams.delete(name); else u.searchParams.set(name,val);
  history.replaceState(null,'',u.toString());
}
 
/* ========= CORE LOAD ========= */
async function load(){
  $("#status").textContent = "Loading…";
  const weekStr = getParam('week') || mondayOf(new Date()).toISOString().slice(0,10);
  const byId    = getParam('advisor_id');
  const byName  = getParam('name');
 
  // Header info
  const s = new Date(weekStr+"T00:00:00");
  const e = new Date(s); e.setDate(e.getDate()+6);
  $("#rangeLabel").textContent = `${fmtDate(s)} – ${fmtDate(e)}`;
 
  // Resolve advisor id + name
  let advisorId = byId || null;
  let advisorName = byName || null;
 
  if(!advisorId && advisorName){
    const { data: advRow } = await sb.from('advisors')
      .select('id,name')
      .ilike('name', advisorName)
      .maybeSingle();
    advisorId = advRow?.id || null;
    advisorName = advRow?.name || advisorName;
  }
 
  if(advisorId){
    const { data: adv } = await sb.from('advisors').select('name').eq('id', advisorId).maybeSingle();
    advisorName = adv?.name || advisorName;
  }
 
  $("#who").textContent = advisorName ? advisorName : (advisorId ? advisorId : "Advisor");
 
  // 1) Try published
  let rota = null, src = 'rotas_published';
  {
    const { data, error } = await sb
      .from('rotas_published')
      .select('data, week_start')
      .eq('week_start', weekStr)
      .eq(advisorId ? 'advisor_id' : 'name', advisorId ? advisorId : advisorName)
      .maybeSingle();
    if(!error && data){ rota = data; }
  }
 
  // 2) Fallback to draft rotas (only if nothing published)
  if(!rota){
    src = 'rotas (draft)';
    const { data, error } = await sb
      .from('rotas')
      .select('data, week_start, advisor_id')
      .eq('week_start', weekStr)
      .eq(advisorId ? 'advisor_id' : 'advisor_id', advisorId || '')
      .maybeSingle();
 
    if(data){ rota = data; }
  }
 
  // Render
  render(rota?.data || {}, src, !!rota);
}
 
function render(data, src, hasData){
  const tbody = $("#tbody"); tbody.innerHTML = "";
  let any = false;
 
  for(const day of DAYS){
    const cell = document.createElement('tr');
    const left = document.createElement('td'); left.textContent = day;
    const right = document.createElement('td');
 
    const dayVal = data?.[day];
 
    if(!dayVal){
      right.innerHTML = `<span class="pill muted">Day Off</span>`;
    } else if (typeof dayVal === 'string'){
      // Template name
      right.innerHTML = `<span class="pill">${dayVal}</span>`;
      any = true;
    } else if (dayVal && Array.isArray(dayVal.segments)){
      // Custom segments
      const bits = dayVal.segments
        .map(s => `${s.code} <span class="muted">(${s.start}–${s.end})</span>`)
        .join(' &nbsp;•&nbsp; ');
      right.innerHTML = bits || `<span class="pill muted">No segments</span>`;
      any = true;
    } else {
      right.innerHTML = `<span class="pill muted">Unknown</span>`;
    }
 
    cell.append(left,right); tbody.appendChild(cell);
  }
 
  const status = $("#status");
  if(hasData){
    status.innerHTML = `<span class="ok">Loaded from <strong>${src}</strong></span>`;
    $("#notice").textContent = src.startsWith('rotas_published')
      ? ""
      : "No published rota found yet — showing the latest draft. Ask your manager to publish.";
  } else {
    status.innerHTML = `<span class="err">No rota found for this week</span>`;
    $("#notice").textContent = "If this looks wrong, please check your name/advisor_id or speak to your manager.";
  }
}
 
/* ========= NAV ========= */
function go(deltaDays){
  const cur = getParam('week') || mondayOf(new Date()).toISOString().slice(0,10);
  const d = new Date(cur+"T00:00:00");
  d.setDate(d.getDate()+deltaDays);
  const m = mondayOf(d).toISOString().slice(0,10);
  setParam('week', m);
  load();
}
 
$("#prevBtn").onclick = ()=>go(-7);
$("#nextBtn").onclick = ()=>go(+7);
$("#todayBtn").onclick= ()=>{
  setParam('week', mondayOf(new Date()).toISOString().slice(0,10));
  load();
};
 
/* ========= START ========= */
load();
</script>
</body>
</html>
