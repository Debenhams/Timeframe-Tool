<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WFM Advisor Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
  <style>
    /* === VARIABLES & CONFIGURATION (Based on WFM Intelligence Platform Styles) === */
    :root {
      /* Modern Enterprise Palette (Indigo/Emerald) */
      --brand-primary: #4F46E5; /* Indigo 600 */
      --brand-accent: #059669; /* Emerald 600 */
      
      /* Neutrals (Cool Gray) */
      --color-text: #111827;
      --color-text-muted: #6B7280;
      --color-bg: #F9FAFB; 
      --color-panel-bg: #FFFFFF;
      --color-border: #E5E7EB;
      --color-hover-bg: #F3F4F6;
      
      --font-family: 'Inter', system-ui, Segoe UI, Roboto, Arial, sans-serif;
      --border-radius: 8px;

      /* Schedule Colors */
      --emails:#10B981; --mirakl:#F59E0B; --social:#8B5CF6; --whatsapp: #25D366;
      --overtime:#EF4444; --meeting:#3B82F6; --break:#94A3B8; --lunch:#64748B;
      --admin: #6366F1; --default:#475569;

      /* Debenhams Branding (From planner css.txt) */
      --debenhams-teal: #70E6D6;
      --debenhams-dark: #000000;

      /* Login Screen Styling (From planner css.txt) */
      --login-bg: #000000;
      --login-text: #FFFFFF;
      --login-text-muted: #9CA3AF;
      --login-input-bg: #1F2937;
      --login-input-border: #374151;
      --login-button-green: #22C55E;
    }

    /* === BASE STYLES === */
    html, body {
        height: 100%;
        overflow: hidden; /* Prevent scroll on body during auth */
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--color-bg);color:var(--color-text);font:14px/1.5 var(--font-family)}

    /* === AUTHENTICATION OVERLAY (Copied/Adapted from planner css.txt) === */
    
    /* Hide main application components initially */
    #appHeader, #appWrap {
      display: none;
    }

    /* Reveal them when the 'authenticated' class is added to the body by JS */
    body.authenticated #appHeader {
      display: block;
    }
    body.authenticated #appWrap {
        display: block;
    }
    body.authenticated {
        overflow-y: auto; /* Allow scrolling when app is active */
    }

    /* Hide the auth overlay when authenticated */
    body.authenticated #auth-overlay {
        display: none;
    }

    .auth-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 9999;
      display: flex; /* Ensure it's visible when not authenticated */
    }

    .auth-container {
      display: flex;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    /* --- Banner Side (Left) --- */
    .auth-banner {
      width: 75%;
      background-color: var(--debenhams-teal); 
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      overflow: hidden;
    }

    /* Subtle pattern background */
    .auth-banner::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        /* SVG pattern mimicking the geometric style of the banner image (From planner css.txt) */
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Cdefs%3E%3Cstyle%3E.bee%7Bfill:none;stroke:rgba(255,255,255,0.35);stroke-width:2;%7D%3C/style%3E%3C/defs%3E%3Cg transform='translate(50 50) rotate(5)'%3E%3Cpolygon class='bee' points='0,-12 12,-6 12,6 0,12 -12,6 -12,-6'/%3E%3Cline class='bee' x1='-6' y1='-9' x2='-6' y2='9'/%3E%3Cline class='bee' x1='0' y1='-12' x2='0' y2='12'/%3E%3Cline class='bee' x1='6' y1='-9' x2='6' y2='9'/%3E%3Cpolygon class='bee' points='0,-12 18,-30 30,-18 12,-6'/%3E%3Cpolygon class='bee' points='0,-12 -18,-30 -30,-18 -12,-6'/%3E%3C/g%3E%3C/svg%3E");
        background-size: 90px 90px;
        opacity: 0.7;
    }

    .banner-content {
        position: relative;
        z-index: 1;
        padding: 40px;
        text-align: center;
    }

    /* Debenhams Group Logo Recreation */
    .dg-logo {
      color: var(--debenhams-dark);
      margin-bottom: 50px;
    }

    .dg-text {
      text-align: center;
      display: block;
    }

    .dg-main-text {
      font-size: 72px;
      font-weight: 700;
      font-family: var(--font-family);
      letter-spacing: -2px;
      line-height: 1;
      display: block;
    }

    .dg-sub-text {
      font-size: 28px;
      font-weight: 600;
      text-transform: uppercase;
      margin-top: 5px;
      display: block;
    }

    .dg-tagline {
        font-size: 24px;
        font-weight: 400;
        text-transform: uppercase;
        line-height: 1.3;
        color: var(--debenhams-dark);
    }

    /* --- Form Side (Right) --- */
    .auth-form-panel {
      width: 25%;
      padding: 60px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      background-color: var(--login-bg);
      color: var(--login-text);
    }

    .auth-title {
      font-size: 24px;
      font-weight: 600;
      color: var(--login-text); 
      margin-bottom: 16px;
      margin-top: 0;
    }

    .auth-form-panel p {
      color: var(--login-text-muted);
      font-size: 14px;
      margin: 0;
    }

    .auth-motto {
      margin-top: 8px;
      margin-bottom: 60px;
    }

    .auth-welcome {
      margin-bottom: 24px;
    }

    .form-group {
        margin-bottom: 16px;
    }

    .auth-form label {
        display: block;
        font-weight: 500;
        margin-bottom: 8px;
        color: var(--login-text-muted);
    }

    /* Input styles for dark mode */
    .auth-form .form-input {
      width: 100%;
      padding: 12px 16px;
      font-size: 16px;
      background-color: var(--login-input-bg);
      border: 1px solid var(--login-input-border);
      color: var(--login-text);
      border-radius: var(--border-radius);
      font-family: var(--font-family);
    }

    .auth-form .form-input:focus {
      outline: none;
      border-color: #FFFFFF; 
      box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.2);
    }

    .btn-login {
      padding: 12px 18px;
      font-size: 16px;
      font-weight: 600;
      background-color: var(--login-button-green); 
      color: white;
      border: none;
      border-radius: 30px; /* Pill shape */
      cursor: pointer;
      transition: background-color 0.2s;
      margin-top: 16px;
      width: 100%;
    }

    .btn-login:hover {
      background-color: #16A34A;
    }
    .btn-login:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    /* Improved Feedback Messages */
    .auth-notice {
        margin-top: 24px;
        padding: 12px;
        border-radius: var(--border-radius);
        display: none;
        font-size: 14px;
    }
    .auth-notice.success {
        background-color: #ECFDF5;
        color: #065F46;
        border: 1px solid #A7F3D0;
    }
    .auth-notice.error {
        background-color: #FEE2E2;
        color: #991B1B;
        border: 1px solid #FCA5A5;
    }

    .auth-form-panel blockquote {
      margin: 40px 0;
      padding-left: 0;
      border-left: none;
      font-style: italic;
      font-size: 16px;
      color: var(--login-text-muted);
      line-height: 1.6;
    }

    .auth-form-panel blockquote p {
      margin: 0;
    }

    .auth-footer {
        margin-top: auto;
        padding-top: 24px;
        font-size: 12px;
        color: var(--login-text-muted);
        border-top: 1px solid var(--login-input-border);
    }

    /* Responsive adjustments for the password screen (From planner css.txt) */
    @media (max-width: 1200px) {
      .dg-main-text { font-size: 72px; }
      .dg-sub-text { font-size: 28px; }
      .dg-tagline { font-size: 24px; }
    }

    @media (max-width: 992px) {
      .auth-banner { width: 50%; }
      .auth-form-panel { width: 50%; padding: 40px; }
    }

    @media (max-width: 768px) {
      .auth-container { flex-direction: column; height: 100%; }
      .auth-banner, .auth-form-panel { width: 100%; }
      .auth-banner { padding: 40px 0; min-height: 40vh; height: auto; }
      .auth-form-panel { padding: 40px 30px; flex-grow: 1; }
      .dg-main-text { font-size: 64px; }
      .dg-sub-text { font-size: 24px; }
      .dg-tagline { font-size: 20px; }
    }


    /* === APPLICATION STYLES === */
    #appHeader{background:var(--brand-primary);color:#fff;padding:16px 24px;font-weight:600;font-size: 16px;box-shadow: 0 2px 4px rgba(0,0,0,.1);}
    #appWrap{max-width:1400px;margin:24px auto;padding:0 16px}
    
    /* === COMPONENTS === */
    .card{background:var(--color-panel-bg);border:1px solid var(--color-border);border-radius:var(--border-radius);box-shadow:0 1px 3px rgba(0,0,0,.1);padding:20px}
    .btn{background:var(--brand-accent);color:#fff;border:0;padding:10px 14px;border-radius:var(--border-radius);font-weight:600;cursor:pointer; transition: background 0.2s;}
    .btn:hover{background: #067550;}
    .btn:disabled{opacity: 0.6; cursor: not-allowed;}
    .btn.secondary{background:#E0E7FF;color:var(--brand-primary); border: 1px solid #C7D2FE;}
    .btn.secondary:hover{background: #C7D2FE;}
    .btn.ghost{background:#fff;color:var(--color-text-muted);border:1px solid var(--color-border)}
    .btn.ghost:hover{background: var(--color-hover-bg);}
    input[type="date"]{border:1px solid var(--color-border);border-radius:var(--border-radius);padding:10px 12px;min-width:200px; font-family: var(--font-family);}
    .notice{background:#FFFBEB;border:1px solid #FDE68A;color:#92400E;padding:12px;border-radius:var(--border-radius);margin:16px 0}
    .notice.success{background:#ECFDF5;border-color:#A7F3D0;color:#065F46;}
    .tag{background:#E0E7FF;color:var(--brand-primary);border-radius:999px;padding:6px 12px;font-weight:600; font-size: 13px;}
    
    /* === LAYOUT & TOP BAR === */
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px; flex-wrap: wrap; gap: 10px;}
    .bar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;}
    
    /* === VIEW TOGGLE === */
    .view-toggle-group {
        display: flex;
        border: 1px solid var(--color-border);
        border-radius: var(--border-radius);
        overflow: hidden;
        margin-bottom: 20px;
    }
    .btn-toggle {
        padding: 8px 16px;
        font-size: 14px;
        font-weight: 500;
        background-color: var(--color-panel-bg);
        color: var(--color-text-muted);
        border: none;
        cursor: pointer;
        transition: background 0.2s, color 0.2s;
    }
    .btn-toggle:disabled {
        cursor: not-allowed;
        opacity: 0.6;
    }
    .btn-toggle:hover:not(:disabled) {
        background-color: var(--color-hover-bg);
    }
    .btn-toggle.active {
        background-color: var(--brand-primary);
        color: white;
    }

    /* === MY ROTA VIEW (Vertical List Layout) === */
    #myRotaView {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); /* Creates a responsive grid of cards */
        gap: 20px;
    }
    .day-card {
        background: var(--color-panel-bg);
        border: 1px solid var(--color-border);
        border-radius: var(--border-radius);
        padding: 16px;
        box-shadow: 0 1px 2px rgba(0,0,0,.05);
    }
    .day-header {
        border-bottom: 1px solid var(--color-border);
        padding-bottom: 12px;
        margin-bottom: 12px;
    }
    .day-title {
        font-size: 18px;
        font-weight: 700;
        margin: 0;
    }
    .day-date {
        color: var(--color-text-muted);
        font-size: 14px;
    }
    .rdo-note {
        padding: 30px 0;
        text-align: center;
        color: var(--color-text-muted);
        font-style: italic;
    }

    /* Timeline Visualization (Horizontal bar within the day card) */
    .timeline-viz {
        position: relative;
        height: 20px;
        background: #F3F4F6;
        border-radius: 10px;
        margin: 16px 0 8px 0;
        overflow: hidden;
    }
    .timeline-segment {
        position: absolute;
        height: 100%;
    }
    .timeline-labels {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: var(--color-text-muted);
    }

    /* Schedule Details List */
    .schedule-list {
        list-style: none;
        padding: 0;
        margin: 16px 0 0 0;
    }
    .schedule-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 0;
        border-top: 1px dashed var(--color-border);
    }
    .item-time {
        font-weight: 600;
        font-family: monospace;
        flex-shrink: 0;
    }
    .item-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
    }
    .item-name {
        flex-grow: 1;
    }

    /* === TEAM SCHEDULE VIEW (Grid) === */
    #teamScheduleView {
        overflow-x: auto;
        border-top: 1px solid var(--color-border);
        margin-top: 20px;
    }
    .team-grid {
        width: 100%;
        border-collapse: collapse;
        background-color: white;
    }
    .team-grid th, .team-grid td {
        padding: 12px 16px;
        text-align: left;
        border: 1px solid var(--color-border);
        min-width: 150px;
        vertical-align: top;
    }
    .team-grid th {
        background-color: var(--color-hover-bg);
        font-weight: 600;
        color: var(--color-text-muted);
        position: sticky;
        top: 0;
        z-index: 2;
    }
    /* Sticky first column for better navigation */
    .team-grid th:first-child, .team-grid td:first-child {
        position: sticky;
        left: 0;
        background-color: var(--color-panel-bg);
        z-index: 1;
        min-width: 200px;
        box-shadow: 2px 0 5px -2px rgba(0,0,0,0.05);
    }
    .team-grid th:first-child {
      background-color: var(--color-hover-bg);
      z-index: 3;
    }
    .team-grid tbody tr:hover td:first-child,
    .team-grid tbody tr:hover {
        background-color: var(--color-hover-bg);
    }

    .weekly-shift-time {
        font-size: 14px;
        font-weight: 600;
        color: var(--color-text);
        display: block;
    }
    .weekly-shift-details {
        font-size: 12px;
        color: var(--color-text-muted);
    }
    .weekly-rdo {
        font-size: 14px;
        color: #9CA3AF;
        font-weight: 500;
    }

    /* === RESPONSIVE (App View) === */
    @media (max-width: 768px) {
        .topbar {
            flex-direction: column;
            align-items: stretch;
        }
        .bar {
            justify-content: space-between;
        }
        .view-toggle-group {
            width: 100%;
        }
        .btn-toggle {
            flex-grow: 1;
            text-align: center;
        }
    }
  </style>
</head>
<body>

  <div id="auth-overlay" class="auth-overlay">
    <div class="auth-container">
      <div class="auth-banner">
        <div class="banner-content">
            <div class="dg-logo">
                <div class="dg-text">
                    <span class="dg-main-text">Debenhams</span>
                    <span class="dg-sub-text">GROUP</span>
                </div>
            </div>
            <div class="dg-tagline">
                FASHION. BEAUTY. LIFESTYLE.<br>
                <strong>FOR EVERYONE.</strong>
            </div>
        </div>
      </div>
      <div class="auth-form-panel">
        <h2 class="auth-title">Advisor Portal</h2>
        <p class="auth-motto">Powered by WFM Intelligence</p>

        <form id="auth-form" class="auth-form">
            <p class="auth-welcome">Welcome. Please sign in using your work email.</p>

            <div class="form-group">
                <label for="emailInput">Email Address</label>
                <input type="email" id="emailInput" class="form-input" placeholder="Enter your work email" autofocus>
            </div>
            <button type="submit" id="sendLinkBtn" class="btn-login">Send Magic Link</button>
        </form>

        <div id="authNotice" class="auth-notice"></div>

        <blockquote>
          <p>"Clarity and communication are the foundations of great service."</p>
        </blockquote>

        <div class="auth-footer">
            WFM Advisor Portal (v2)
        </div>
      </div>
    </div>
  </div>

  <header id="appHeader">WFM Advisor Portal</header>
  
  <div id="appWrap">
    <div id="appBox" class="card" style="padding: 20px;">
      
      <div class="topbar">
        <div class="bar">
          <span id="userEmail" class="tag"></span>
          <span id="advisorName" class="tag"></span>
          <span id="teamName" class="tag" style="display:none;"></span>
        </div>
        <div class="bar">
          <input id="weekStart" type="date" />
          <button id="prevBtn" class="btn secondary">◀ Prev</button>
          <button id="nextBtn" class="btn secondary">Next ▶</button>
          <button id="signOutBtn" class="btn ghost">Sign out</button>
        </div>
      </div>

       <div id="realtimeNote" class="notice success" style="display:none;">
            Live Update: The schedule for this week was just updated.
       </div>

      <div class="view-toggle-group" id="viewToggleGroup">
            <button class="btn-toggle active" data-view="my-rota">My Rota</button>
            <button class="btn-toggle" data-view="team-schedule" id="teamToggleBtn">Team Schedule</button>
      </div>

      <div id="myRotaView" class="view-container">
          </div>
      
      <div id="teamScheduleView" class="view-container" style="display:none;">
            </div>

      <div id="infoNote" class="notice" style="display:none;"></div>
    </div>
  </div>

<script>
// --- Configuration ---
const SUPABASE_URL = "https://oypdnjxhjpgpwmkltzmk.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95cGRuanhoanBncHdta2x0em1rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4Nzk0MTEsImV4cCI6MjA3NTQ1NTQxMX0.Hqf1L4RHpIPUD4ut2uVsiGDsqKXvAjdwKuotmme4_Is";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// --- DOM Elements (ELS) ---
// Mapped to the new structure
const ELS = {
    // Auth Elements
    authOverlay: document.getElementById("auth-overlay"),
    authForm: document.getElementById("auth-form"),
    emailInput: document.getElementById("emailInput"),
    sendLinkBtn: document.getElementById("sendLinkBtn"),
    authNotice: document.getElementById("authNotice"),

    // App Elements
    appBox: document.getElementById("appBox"),
    userEmailTag: document.getElementById("userEmail"),
    advisorNamePill: document.getElementById("advisorName"),
    teamNamePill: document.getElementById("teamName"),
    weekStartInput: document.getElementById("weekStart"),
    prevBtn: document.getElementById("prevBtn"),
    nextBtn: document.getElementById("nextBtn"),
    signOutBtn: document.getElementById("signOutBtn"),
    myRotaView: document.getElementById("myRotaView"),
    teamScheduleView: document.getElementById("teamScheduleView"),
    viewToggleGroup: document.getElementById("viewToggleGroup"),
    teamToggleBtn: document.getElementById("teamToggleBtn"),
    infoNote: document.getElementById("infoNote"),
    realtimeNote: document.getElementById("realtimeNote"),
};

// --- Constants & Helpers ---
const DAYS = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
// Visualization time range for My Rota view (7 AM to 9 PM)
const VIZ_START_H = 7, VIZ_END_H = 21;
const VIZ_DURATION_MIN = (VIZ_END_H - VIZ_START_H) * 60;

// Date Helpers
function toMonday(d){
  const x = new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0, 0, 0, 0);
  const dow = x.getDay();
  const diff = (dow === 0 ? -6 : 1 - dow);
  x.setDate(x.getDate() + diff);
  return x;
}
function fmtDateLocal(d){
  // en-CA locale provides reliable YYYY-MM-DD format
  return d.toLocaleDateString('en-CA', {year: 'numeric', month: '2-digit', day: '2-digit'});
}
function fmtDateFriendly(d) {
    return d.toLocaleDateString("en-GB", { month: "long", day: "numeric" });
}
function addDays(d,n){ const x=new Date(d.getFullYear(), d.getMonth(), d.getDate()); x.setDate(x.getDate()+n); return x; }
function hhmmToMinutes(t){ 
    if (!t) return 0;
    const [h,m]=(t.split(":")||["0","0"]).map(Number); 
    return h*60+m; 
}

// Map activity codes to colors
function colorForCode(code){
  const k = (code||"").toLowerCase();
  if (k.includes("email")) return "var(--emails)";
  if (k.includes("mirakl")) return "var(--mirakl)";
  if (k.includes("whatsapp")) return "var(--whatsapp)";
  if (k.includes("social")) return "var(--social)";
  if (k.includes("meeting")||k.includes("coach")||k.includes("121")||k.includes("huddle")||k.includes("training")) return "var(--meeting)";
  if (k.includes("overtime")) return "var(--overtime)";
  if (k.includes("break")) return "var(--break)";
  if (k.includes("lunch")) return "var(--lunch)";
  if (k.includes("admin") || k.includes("payplus") || k.includes("qa") || k.includes("2nd line")) return "var(--admin)";
  return "var(--default)";
}

// --- Application State ---
const STATE = {
    user: null,
    advisorId: null,
    advisorName: "",
    leaderId: null,
    teamMembers: [],
    teamMemberIds: new Set(),
    monday: toMonday(new Date()),
    templates: {},
    currentView: 'my-rota',
    currentWeekData: null,
    rotaRealtimeChannel: null,
};

/* ---- Data Normalization ---- */
function tplToSegments(t){
  if(!t || !t.start_time || !t.finish_time) return [];
  const mins = s => { const [h,m]=String(s).slice(0,5).split(":").map(Number); return h*60+m; };
  const m2t = m => `${String(Math.floor(m/60)).padStart(2,"0")}:${String(m%60).padStart(2,"0")}`;
  const s = mins(t.start_time), e = mins(t.finish_time);
  const breaks = [];
  // Assuming standard break durations
  if(t.break1) breaks.push({ at: mins(t.break1), dur: 15, code: "Break" });
  if(t.lunch)  breaks.push({ at: mins(t.lunch),  dur: 30, code: "Lunch" });
  if(t.break2) breaks.push({ at: mins(t.break2), dur: 15, code: "Break" });
  
  const events = [{t:s, type:"start"}, ...breaks.map(b=>({t:b.at, type:"pause", dur:b.dur, code:b.code})), {t:e, type:"end"}]
    .sort((a,b)=>a.t-b.t);
  const out=[]; let cur=s;
  for(const ev of events){
    if(ev.t>cur) out.push({ code: t.work_code || "Activity", start: m2t(cur), end: m2t(ev.t) });
    if(ev.type==="pause"){ out.push({ code:ev.code, start:m2t(ev.t), end:m2t(ev.t+ev.dur) }); cur=ev.t+ev.dur; }
  }
  return out;
}

function normalizeDayValue(dayVal){
  if(dayVal && typeof dayVal==="object" && Array.isArray(dayVal.segments)) return dayVal;
  if(typeof dayVal==="string" && dayVal.trim() !== ""){
    const tpl = STATE.templates[dayVal.trim()];
    if(!tpl) return { segments: [] };
    return { segments: tplToSegments(tpl) };
  }
  return { segments: [] };
}

// --- Initialization & Authentication ---
async function init(){
  // 1. Setup Auth UI Events
  setupAuthUIEvents();

  // 2. Load Templates
  await loadTemplates();

  // 3. Authentication Check
  await supabase.auth.getSession();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user){
    // Show auth overlay if not authenticated
    document.body.classList.remove('authenticated');
    return;
  }

  STATE.user = user;
  
  // 4. Identify Advisor and Team
  await identifyAdvisorAndTeam(user);

  // 5. Setup App UI Controls
  setupAppUIEvents();
  
  // 6. Show App, Initial Render, and Start Realtime
  showApp();
  await loadAndRender();
  await startRealtime();
}

function showApp() {
    // Add 'authenticated' class to body to hide the overlay and show the app content
    document.body.classList.add('authenticated');
    ELS.userEmailTag.textContent = STATE.user.email;
    ELS.advisorNamePill.textContent = STATE.advisorName || (STATE.advisorId ? "ID Linked" : "Not Linked");
    ELS.weekStartInput.value = fmtDateLocal(STATE.monday);
}

async function loadTemplates() {
    const { data, error } = await supabase.from("templates").select("*");
    if (error) {
        console.error("Error loading templates:", error);
    } else {
      (data||[]).forEach(t=>STATE.templates[t.name]=t);
    }
}

async function identifyAdvisorAndTeam(user) {
    // 1. Identify Advisor ID
    const { data: profile } = await supabase.from("profiles").select("advisor_id").eq("user_id", user.id).maybeSingle();

    if (profile && profile.advisor_id){
        STATE.advisorId = profile.advisor_id;
    } else {
        const { data: adv } = await supabase.from("advisors").select("id").ilike("email", user.email).maybeSingle();
        if (adv) STATE.advisorId = adv.id;
    }

    if (!STATE.advisorId) {
        ELS.teamToggleBtn.disabled = true;
        return;
    }

    // 2. Fetch Advisor Details and Leader ID
    const { data: advisorDetails } = await supabase.from("advisors").select("name, leader_id").eq("id", STATE.advisorId).maybeSingle();

    if (advisorDetails) {
        STATE.advisorName = advisorDetails.name;
        STATE.leaderId = advisorDetails.leader_id;
    }

    if (!STATE.leaderId) {
        ELS.teamToggleBtn.disabled = true;
        return;
    }

    // 3. Fetch Team Members and Leader Name
    const [teamRes, leaderRes] = await Promise.all([
        supabase.from("advisors").select("id, name").eq("leader_id", STATE.leaderId).order('name'),
        supabase.from("leaders").select("name").eq("id", STATE.leaderId).maybeSingle()
    ]);

    if (teamRes.data) {
        STATE.teamMembers = teamRes.data;
        STATE.teamMemberIds = new Set(teamRes.data.map(t => t.id));
    }
    
    if (leaderRes.data) {
        ELS.teamNamePill.textContent = `Team: ${leaderRes.data.name}`;
        ELS.teamNamePill.style.display = '';
    }

    if (STATE.teamMembers.length <= 1) {
        ELS.teamToggleBtn.disabled = true;
        ELS.teamToggleBtn.title = "Team view unavailable.";
    }
}

function setupAuthUIEvents() {
    // Use form submission for better accessibility and reliability
    if (ELS.authForm) {
        ELS.authForm.addEventListener('submit', handleSendLink);
    }
}

function setupAppUIEvents() {
    ELS.signOutBtn.onclick = handleSignOut;
    ELS.prevBtn.onclick = () => changeWeek(-7);
    ELS.nextBtn.onclick = () => changeWeek(7);
    
    ELS.weekStartInput.onchange = ()=>{
        const d = new Date(ELS.weekStartInput.value + "T00:00:00");
        if (!isNaN(d.getTime())) {
             STATE.monday = toMonday(d);
             loadAndRender();
             restartRealtime();
        }
    };

    // View Toggle Logic
    ELS.viewToggleGroup.addEventListener('click', (e) => {
        const target = e.target.closest('.btn-toggle');
        if (target && !target.classList.contains('active') && !target.disabled) {
            STATE.currentView = target.dataset.view;
            ELS.viewToggleGroup.querySelectorAll('.btn-toggle').forEach(btn => btn.classList.remove('active'));
            target.classList.add('active');
            renderView();
        }
    });
}

function changeWeek(days) {
    STATE.monday = addDays(STATE.monday, days);
    ELS.weekStartInput.value = fmtDateLocal(STATE.monday);
    loadAndRender();
    restartRealtime();
}

async function handleSendLink(event){
  event.preventDefault(); // Prevent form submission navigation
  ELS.authNotice.style.display = 'none';
  const email = ELS.emailInput.value.trim();
  
  // Basic validation
  if (!email || !email.includes('@')) {
    ELS.authNotice.textContent = "Please enter a valid work email.";
    ELS.authNotice.className = 'auth-notice error';
    ELS.authNotice.style.display = 'block';
    return;
  }
  
  ELS.sendLinkBtn.disabled = true;
  ELS.sendLinkBtn.textContent = "Sending...";

  try{
    // Determine the redirect URL robustly
    let redirectUrl = undefined;
    // Handle local file:// protocol where location.origin might be "null"
    if (location.origin && location.origin !== "null" && location.protocol !== 'file:') {
        redirectUrl = location.origin + location.pathname;
    }
    // If running locally via file://, we omit the redirect URL; the link will still be valid but won't redirect automatically.

    const { error } = await supabase.auth.signInWithOtp({
      email,
      options: redirectUrl ? { emailRedirectTo: redirectUrl } : undefined
    });

    if (error) throw error;

    // Success
    ELS.authNotice.textContent = "Magic link sent. Check your inbox (and spam folder).";
    ELS.authNotice.className = 'auth-notice success';
    ELS.authNotice.style.display = 'block';
    ELS.emailInput.value = ''; // Clear input

  }catch(e){ 
    // Failure
    console.error("Authentication error:", e);
    let errorMessage = e.message;
    // User-friendly messages for common errors
    if (e.message.includes("Rate limit exceeded")) {
        errorMessage = "Too many requests. Please wait 60 seconds and try again.";
    }
    
    ELS.authNotice.textContent = "Error: " + errorMessage + " (Check SMTP configuration if this persists)";
    ELS.authNotice.className = 'auth-notice error';
    ELS.authNotice.style.display = 'block';
  }
  finally{ 
    ELS.sendLinkBtn.disabled = false;
    ELS.sendLinkBtn.textContent = "Send Magic Link";
  }
}

async function handleSignOut(){
    await stopRealtime();
    await supabase.auth.signOut();
    location.href = location.pathname; // Reload page to return to auth screen
}

// --- Main Data Loading Logic ---
async function loadAndRender(){
    ELS.infoNote.style.display="none";
    if (!STATE.advisorId){
        ELS.myRotaView.innerHTML = `<div class="notice">Your account isn’t linked to an advisor profile. Please contact the planning team.</div>`;
        return;
    }
  
    // Show loading state
    ELS.myRotaView.innerHTML = `<div class="notice">Loading schedule data...</div>`;
    ELS.teamScheduleView.innerHTML = `<div class="notice">Loading schedule data...</div>`;

    const mondayISO = fmtDateLocal(STATE.monday);

    // 1. Prepare data structures
    const normalisedMyRota = {};
    const normalisedTeamRotas = {};

    // 2. Identify IDs to fetch
    const advisorIdsToFetch = Array.from(STATE.teamMemberIds);
    if (advisorIdsToFetch.length === 0 && STATE.advisorId) {
        advisorIdsToFetch.push(STATE.advisorId);
    }

    // 3. Fetch all relevant rotas in a single query
    const { data: rotas, error } = await supabase
        .from("rotas_published")
        .select("advisor_id, data")
        .in("advisor_id", advisorIdsToFetch)
        .eq("week_start", mondayISO);

    if (error) {
        console.error("Error loading rotas:", error);
        ELS.infoNote.textContent = "Error loading schedule data.";
        ELS.infoNote.style.display = "block";
    }
                
    // 4. Normalize the fetched data
    (rotas || []).forEach(r => {
        const normalised = {};
        // Check if r.data exists before iteration
        if (r.data) {
            DAYS.forEach(d => {
                normalised[d] = normalizeDayValue(r.data[d]);
            });
        }
        
        if (r.advisor_id === STATE.advisorId) {
            Object.assign(normalisedMyRota, normalised);
        }
        normalisedTeamRotas[r.advisor_id] = normalised;
    });

    // 5. Store normalized data in state
    STATE.currentWeekData = {
        myRota: normalisedMyRota,
        teamRotas: normalisedTeamRotas,
        mondayISO: mondayISO
    };

    // 6. Render the currently active view
    renderView();
}

// Renders the appropriate view
function renderView() {
    if (!STATE.currentWeekData) return;

    if (STATE.currentView === 'my-rota') {
        ELS.myRotaView.style.display = 'grid';
        ELS.teamScheduleView.style.display = 'none';
        drawMyRotaVertical(STATE.currentWeekData.myRota);
    } else if (STATE.currentView === 'team-schedule') {
        ELS.myRotaView.style.display = 'none';
        ELS.teamScheduleView.style.display = 'block';
        drawTeamScheduleGrid(STATE.currentWeekData.teamRotas);
    }
}

// --- My Rota (Vertical View) Rendering ---
function drawMyRotaVertical(rotaData){
  let html = '';
  
  // Check if the object is empty (no rota found for the user for this week)
  if (Object.keys(rotaData).length === 0) {
      ELS.myRotaView.innerHTML = `<div class="notice">No rota published for this week yet.</div>`;
      return;
  }

  DAYS.forEach((dayName, i) => {
    const date = addDays(STATE.monday, i);
    const dayData = rotaData[dayName] || { segments: [] };
    
    html += `<div class="day-card">
                <div class="day-header">
                    <h2 class="day-title">${dayName}</h2>
                    <p class="day-date">${fmtDateFriendly(date)}</p>
                </div>
                ${renderDayContent(dayData.segments)}
            </div>`;
  });

  ELS.myRotaView.innerHTML = html;
}

function renderDayContent(segments) {
    if (segments.length === 0) {
        return `<div class="rdo-note">Rest Day Off (RDO)</div>`;
    }

    // 1. Timeline Visualization
    let vizHtml = `<div class="timeline-viz" title="Visualization from ${VIZ_START_H}:00 to ${VIZ_END_H}:00">`;
    segments.forEach(seg => {
        const startMin = hhmmToMinutes(seg.start);
        const endMin = hhmmToMinutes(seg.end);
        const vizStartMin = VIZ_START_H * 60;

        // Calculate position and width percentage
        const startPct = Math.max(0, ((startMin - vizStartMin) / VIZ_DURATION_MIN) * 100);
        const endPct = Math.min(100, ((endMin - vizStartMin) / VIZ_DURATION_MIN) * 100);
        const widthPct = endPct - startPct;

        if (widthPct > 0) {
            vizHtml += `<div class="timeline-segment" style="left: ${startPct}%; width: ${widthPct}%; background: ${colorForCode(seg.code)};" title="${seg.code} (${seg.start} - ${seg.end})"></div>`;
        }
    });
    vizHtml += `</div>`;
    vizHtml += `<div class="timeline-labels">
                    <span>${VIZ_START_H.toString().padStart(2,'0')}:00</span>
                    <span>${VIZ_END_H.toString().padStart(2,'0')}:00</span>
                </div>`;

    // 2. Detailed List
    let listHtml = `<ul class="schedule-list">`;
    segments.forEach(seg => {
        listHtml += `<li class="schedule-item">
                        <span class="item-time">${seg.start} - ${seg.end}</span>
                        <span class="item-dot" style="background: ${colorForCode(seg.code)};"></span>
                        <span class="item-name">${seg.code}</span>
                    </li>`;
    });
    listHtml += `</ul>`;

    return vizHtml + listHtml;
}

// --- Team Schedule (Grid View) Rendering ---
function drawTeamScheduleGrid(teamRotas) {
    let html = `<table class="team-grid"><thead><tr><th>Advisor</th>`;
    // Header Row
    DAYS.forEach((dayName, i) => {
        const date = addDays(STATE.monday, i);
        html += `<th>${dayName}<br><small>${fmtDateFriendly(date)}</small></th>`;
    });
    html += `</tr></thead><tbody>`;

    // Body Rows
    STATE.teamMembers.forEach(member => {
        const advisorRota = teamRotas[member.id];
        html += `<tr><td>${member.name}</td>`;
        
        if (!advisorRota) {
            DAYS.forEach(() => html += `<td><span class="weekly-rdo">N/A</span></td>`);
        } else {
            DAYS.forEach(dayName => {
                const dayData = advisorRota[dayName] || { segments: [] };
                html += `<td>${renderTeamGridCell(dayData.segments)}</td>`;
            });
        }
        html += `</tr>`;
    });

    html += `</tbody></table>`;
    ELS.teamScheduleView.innerHTML = html;
}

function renderTeamGridCell(segments) {
    if (segments.length === 0) {
        return `<span class="weekly-rdo">RDO</span>`;
    }

    const start = segments[0].start;
    const end = segments[segments.length - 1].end;
    
    // Identify main activities
    const mainActivities = segments.filter(s => {
        const code = s.code.toLowerCase();
        return !code.includes('break') && !code.includes('lunch');
    }).map(s => s.code);
    
    let summary = "Activity";
    if (mainActivities.length > 0) {
        if (mainActivities.every(val => val === mainActivities[0])) {
            summary = mainActivities[0];
        } else {
            summary = "Mixed Activities";
        }
    }

    return `
        <span class="weekly-shift-time">${start} - ${end}</span>
        <span class="weekly-shift-details">${summary}</span>
    `;
}

// --- Real-Time Updates ---

async function startRealtime(){
  if (!STATE.advisorId) return;
  const mondayISO = fmtDateLocal(STATE.monday);
  
  STATE.rotaRealtimeChannel = supabase.channel(`rotas_pub_week_${mondayISO}`)
    .on("postgres_changes", {
      event: "*",
      schema: "public",
      table: "rotas_published",
      filter: `week_start=eq.${mondayISO}`
    }, (payload)=>{
      
      const affectedAdvisorId = payload.new?.advisor_id || payload.old?.advisor_id;
      const isRelevant = STATE.advisorId === affectedAdvisorId || STATE.teamMemberIds.has(affectedAdvisorId);

      if (isRelevant) {
          loadAndRender(); 
          ELS.realtimeNote.style.display = "block";
          setTimeout(()=>ELS.realtimeNote.style.display="none", 5000);
      }
    })
    .subscribe((status) => {
        if (status !== 'SUBSCRIBED') {
            console.warn('Realtime subscription status:', status);
        }
    });
}

async function stopRealtime() {
    if (STATE.rotaRealtimeChannel) {
        await supabase.removeChannel(STATE.rotaRealtimeChannel);
        STATE.rotaRealtimeChannel = null;
    }
}

async function restartRealtime(){
  await stopRealtime();
  await startRealtime();
}

// Initialize the application
document.addEventListener('DOMContentLoaded', init);

</script>
</body>
</html>