<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Advisor Portal — Weekly Rota</title>
<style>
  :root{
    --ink:#1f2937; --paper:#ffffff; --wash:#f6f8fb; --line:#e5e9f2;
    --brand:#0d47a1;
    --color-email:#2ecc71; --color-mirakl:#b1b51e; --color-social:#5e35b1;
    --color-overtime:#e53935; --color-meeting:#ffd700; --color-break:#cfd8dc; --color-lunch:#b0bec5;
    --color-absence:#b0c4de; --color-shrink:#ffd166;
  }
  html,body{height:100%}
  body{margin:0;background:#eef2f6;color:var(--ink);font-family:Inter,Roboto,Segoe UI,system-ui,Arial,Helvetica,sans-serif}
  .topbar{background:var(--brand);color:#fff;padding:14px 18px;display:flex;align-items:center;gap:14px}
  .topbar h1{margin:0;font-size:18px;font-weight:800}
  .wrap{max-width:1100px;margin:18px auto;padding:0 16px;display:flex;flex-direction:column;gap:14px}
  .panel{background:var(--paper);border:1px solid var(--line);border-radius:12px;box-shadow:0 8px 20px rgba(12,27,74,.06)}
  .panel-header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid var(--line)}
  .panel-body{padding:12px 14px}
  .muted{color:#6b7280}
  .btn{background:#e9eef6;color:#0f172a;border:1px solid var(--line);border-radius:10px;padding:8px 11px;font-weight:700;cursor:pointer}
  .btn:hover{filter:brightness(.97)}
  .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:10px}
  .day{border:1px solid var(--line);border-radius:10px;background:#fff;display:flex;flex-direction:column;min-height:140px}
  .day-h{padding:8px 10px;font-weight:800;border-bottom:1px solid var(--line);background:#f6f8fb;display:flex;justify-content:space-between}
  .seg{margin:8px 10px;padding:8px;border-radius:8px;font-size:13px;font-weight:700;color:#0b1320;border:1px solid var(--line);background:#f9fbff}
  .seg .t{font-weight:800}
  .legend{display:flex;gap:8px;flex-wrap:wrap}
  .chip{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--line);background:#fff;border-radius:999px;padding:4px 8px;font-size:12px}
  .sw{width:12px;height:12px;border-radius:3px;border:1px solid var(--line)}
  .err{padding:10px 12px;border-radius:10px;background:#fde8e8;color:#b42318;border:1px solid #f2b8b5;font-weight:700}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="topbar">
    <h1>Advisor Portal</h1>
    <div style="margin-left:auto" id="weekRange" class="muted"></div>
  </div>
 
  <div class="wrap">
    <div class="panel">
      <div class="panel-header">
        <div style="display:flex;gap:10px;align-items:center">
          <button class="btn" id="prev">◀ Previous</button>
          <button class="btn" id="today">This Week</button>
          <button class="btn" id="next">Next ▶</button>
        </div>
        <div class="legend">
          <span class="chip"><span class="sw" style="background:var(--color-email)"></span>Email</span>
          <span class="chip"><span class="sw" style="background:var(--color-mirakl)"></span>Mirakl</span>
          <span class="chip"><span class="sw" style="background:var(--color-social)"></span>Social</span>
          <span class="chip"><span class="sw" style="background:var(--color-break)"></span>Break</span>
          <span class="chip"><span class="sw" style="background:var(--color-lunch)"></span>Lunch</span>
          <span class="chip"><span class="sw" style="background:var(--color-absence)"></span>Absence</span>
          <span class="chip"><span class="sw" style="background:var(--color-shrink)"></span>Shrinkage</span>
          <span class="chip"><span class="sw" style="background:var(--color-overtime)"></span>Overtime</span>
        </div>
      </div>
      <div class="panel-body">
        <div id="notice"></div>
        <div id="grid" class="grid"></div>
      </div>
    </div>
  </div>
 
<script>
/* ========= Supabase ========= */
const SUPABASE_URL  = "https://oypdnjxhjpgpwmkltzmk.supabase.co";
const SUPABASE_KEY  = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95cGRuanhoanBncHdta2x0em1rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4Nzk0MTEsImV4cCI6MjA3NTQ1NTQxMX0.Hqf1L4RHpIPUD4ut2uVsiGDsqKXvAjdwKuotmme4_Is";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
 
/* ========= Helpers ========= */
const DAYS = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
 
function qp(k){ return new URLSearchParams(location.search).get(k); }
const pad = n => String(n).padStart(2,'0');
function toMin(t){ if(!t) return null; const [h,m]=t.split(':').map(Number); return h*60+m; }
function m2t(m){ return `${pad(Math.floor(m/60))}:${pad(m%60)}`; }
 
function startOfWeekMonday(d){
  const dt = new Date(d);
  const day = dt.getDay(); // 0..6 (Sun..Sat)
  const diff = (day === 0 ? -6 : 1) - day; // move to Monday
  dt.setDate(dt.getDate()+diff);
  dt.setHours(0,0,0,0);
  return dt;
}
function mondayISO(any){
  return startOfWeekMonday(any).toISOString().slice(0,10);
}
function formatRangeLabel(mondayISOstr){
  const s = new Date(mondayISOstr+'T00:00:00');
  const e = new Date(s); e.setDate(e.getDate()+6);
  const f = d => d.toLocaleDateString('en-GB',{day:'2-digit',month:'2-digit',year:'numeric'});
  return `${f(s)} – ${f(e)}`;
}
 
function classForCode(code=''){
  const k = code.toLowerCase();
  if(/\blunch\b/.test(k)) return 'background:var(--color-lunch)';
  if(/\bbreak\b/.test(k)) return 'background:var(--color-break)';
  if(/\bovertime\b/.test(k)) return 'background:var(--color-overtime);color:#fff';
  if(/\bmirakl\b/.test(k))  return 'background:var(--color-mirakl);color:#fff';
  if(/\bsocial\b/.test(k))  return 'background:var(--color-social);color:#fff';
  if(/\bemail\b/.test(k))   return 'background:var(--color-email);color:#fff';
  if(['al','sick','rdo','maternity','lts','split shift'].some(w=>k.includes(w))) return 'background:var(--color-absence)';
  if(['121','atl','coaching','huddle','iti','projects','team meeting','training'].some(w=>k.includes(w))) return 'background:var(--color-shrink)';
  return 'background:#f9fbff';
}
 
/* ========= Resolve advisor & week ========= */
async function resolveAdvisorId(){
  const idFromUrl = qp('advisor_id');
  if (idFromUrl) return idFromUrl;
 
  const name = qp('name');
  if (!name) return null;
 
  // exact (case-insensitive)
  let { data, error } = await sb.from('advisors').select('id,name').ilike('name', name).limit(1).maybeSingle();
  if (data && data.id) return data.id;
 
  // loose fallback
  const tidy = name.trim();
  const res = await sb.from('advisors').select('id,name').ilike('name', `%${tidy}%`).limit(1).maybeSingle();
  return (res.data && res.data.id) ? res.data.id : null;
}
 
function resolveWeekStart(){
  const w = qp('week') || qp('week_start');
  return w ? mondayISO(w) : mondayISO(new Date());
}
 
/* ========= Fetch rota (published → draft) ========= */
async function fetchRota(advisorId, weekStartISO){
  // 1. published
  let { data, error } = await sb
    .from('rotas_published')
    .select('data')
    .eq('advisor_id', advisorId)
    .eq('week_start', weekStartISO)
    .maybeSingle();
 
  if (data && data.data) return data.data;
 
  // 2. fallback to draft rotas
  let f = await sb
    .from('rotas')
    .select('data')
    .eq('advisor_id', advisorId)
    .eq('week_start', weekStartISO)
    .maybeSingle();
 
  return (f.data && f.data.data) ? f.data.data : null;
}
 
/* ========= Render ========= */
function processDayValue(dayValue, templates){
  // Day value is either string template name or {segments:[...]}
  if (dayValue && typeof dayValue==='object' && Array.isArray(dayValue.segments)) {
    return dayValue.segments
      .map(s => ({label:s.code, start:s.start, end:s.end}))
      .filter(s => s.start && s.end);
  }
  if (typeof dayValue==='string') {
    // If you want to expand templates client-side, uncomment & provide templates map.
    // For portal we just show label+hours when present in dayValue object.
    return [{label:dayValue, start:null, end:null}];
  }
  return [];
}
 
function renderWeek(rotaData, weekStartISO){
  const grid = document.getElementById('grid');
  grid.innerHTML = '';
 
  // header range
  document.getElementById('weekRange').textContent = formatRangeLabel(weekStartISO);
 
  // build 7 days Monday→Sunday
  const monday = new Date(weekStartISO+'T00:00:00');
 
  for (let i=0;i<7;i++){
    const d = new Date(monday); d.setDate(d.getDate()+i);
    const dayName = DAYS[i];
    const dateStr = d.toLocaleDateString('en-GB',{day:'2-digit',month:'short'});
 
    const dayBox = document.createElement('div');
    dayBox.className = 'day';
 
    const head = document.createElement('div');
    head.className = 'day-h';
    head.innerHTML = `<span>${dayName}</span><span class="muted">${dateStr}</span>`;
    dayBox.appendChild(head);
 
    const dayVal = rotaData[dayName];
    const segs = processDayValue(dayVal);
 
    if (!segs.length){
      const off = document.createElement('div');
      off.className = 'seg';
      off.style.background = '#f2f4f8';
      off.innerHTML = `<span class="t">Day Off</span>`;
      dayBox.appendChild(off);
    } else {
      segs.forEach(s=>{
        const div = document.createElement('div');
        div.className = 'seg';
        div.style = classForCode(s.label||'');
        const time = (s.start && s.end) ? `${s.start}–${s.end}` : '';
        div.innerHTML = `<div>${s.label || ''}</div>${time?`<div class="t">${time}</div>`:''}`;
        dayBox.appendChild(div);
      });
    }
 
    grid.appendChild(dayBox);
  }
}
 
/* ========= Boot ========= */
let currentMonday = resolveWeekStart();
let currentAdvisorId = null;
 
async function loadPage(){
  // normalize to Monday always
  currentMonday = resolveWeekStart();
 
  const n = document.getElementById('notice');
  n.innerHTML = '';
 
  if (!currentAdvisorId){
    currentAdvisorId = await resolveAdvisorId();
  }
  if (!currentAdvisorId){
    n.innerHTML = `<div class="err">Advisor not found. Add <code>?advisor_id=&lt;uuid&gt;</code> or <code>?name=First%20Last</code> to the URL.</div>`;
    document.getElementById('grid').innerHTML = '';
    document.getElementById('weekRange').textContent = formatRangeLabel(currentMonday);
    return;
  }
 
  const data = await fetchRota(currentAdvisorId, currentMonday);
  if (!data){
    n.innerHTML = `<div class="err">No rota found for this week (checked <b>rotas_published</b>, then <b>rotas</b>).</div>`;
    document.getElementById('grid').innerHTML = '';
    document.getElementById('weekRange').textContent = formatRangeLabel(currentMonday);
    return;
  }
 
  renderWeek(data, currentMonday);
}
 
/* ========= Week nav ========= */
document.getElementById('prev').onclick = async()=>{
  const d = new Date(currentMonday+'T00:00:00');
  d.setDate(d.getDate()-7);
  currentMonday = mondayISO(d);
  await loadPage();
};
document.getElementById('next').onclick = async()=>{
  const d = new Date(currentMonday+'T00:00:00');
  d.setDate(d.getDate()+7);
  currentMonday = mondayISO(d);
  await loadPage();
};
document.getElementById('today').onclick = async()=>{
  currentMonday = mondayISO(new Date());
  await loadPage();
};
 
document.addEventListener('DOMContentLoaded', loadPage);
</scr
