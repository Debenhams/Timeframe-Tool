<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WFM Advisor Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
  <style>
    /* === VARIABLES & CONFIGURATION (Based on WFM Intelligence Platform Styles) === */
    :root {
      /* Modern Enterprise Palette (Indigo/Emerald) */
      --brand-primary: #4F46E5; /* Indigo 600 */
      --brand-primary-dark: #4338CA;
      --brand-accent: #059669; /* Emerald 600 */
      
      /* Neutrals (Cool Gray) */
      --color-text: #111827;
      --color-text-muted: #6B7280;
      --color-bg: #F9FAFB; 
      --color-panel-bg: #FFFFFF;
      --color-border: #E5E7EB;
      --color-hover-bg: #F3F4F6;
      
      --font-family: 'Inter', system-ui, Segoe UI, Roboto, Arial, sans-serif;
      --border-radius: 8px;

      /* Schedule Colors (Mapped from common activities in the provided data) */
      --emails:#10B981; /* Emerald 500 */
      --mirakl:#F59E0B; /* Amber 500 */
      --social:#8B5CF6; /* Violet 500 */
      --whatsapp: #25D366; /* Green */
      --overtime:#EF4444; /* Red 500 */
      --meeting:#3B82F6; /* Blue 500 */
      --break:#94A3B8;  /* Slate 400 */
      --lunch:#64748B;  /* Slate 500 */
      --admin: #6366F1; /* Indigo 500 */
      --default:#475569; /* Slate 600 */
    }

    /* === BASE STYLES === */
    *{box-sizing:border-box}
    body{margin:0;background:var(--color-bg);color:var(--color-text);font:14px/1.5 var(--font-family)}
    header{background:var(--brand-primary);color:#fff;padding:16px 24px;font-weight:600;font-size: 16px;box-shadow: 0 2px 4px rgba(0,0,0,.1);}
    .wrap{max-width:1400px;margin:24px auto;padding:0 16px}
    
    /* === COMPONENTS === */
    .card{background:var(--color-panel-bg);border:1px solid var(--color-border);border-radius:var(--border-radius);box-shadow:0 1px 3px rgba(0,0,0,.1);padding:20px}
    .btn{background:var(--brand-accent);color:#fff;border:0;padding:10px 14px;border-radius:var(--border-radius);font-weight:600;cursor:pointer; transition: background 0.2s;}
    .btn:hover{background: #067550;}
    .btn:disabled{opacity: 0.6; cursor: not-allowed;}
    .btn.secondary{background:#E0E7FF;color:var(--brand-primary); border: 1px solid #C7D2FE;}
    .btn.secondary:hover{background: #C7D2FE;}
    .btn.ghost{background:#fff;color:var(--color-text-muted);border:1px solid var(--color-border)}
    .btn.ghost:hover{background: var(--color-hover-bg);}
    input[type="email"],input[type="date"]{border:1px solid var(--color-border);border-radius:var(--border-radius);padding:10px 12px;min-width:200px; font-family: var(--font-family);}
    .notice{background:#FFFBEB;border:1px solid #FDE68A;color:#92400E;padding:12px;border-radius:var(--border-radius);margin:16px 0}
    .notice.success{background:#ECFDF5;border-color:#A7F3D0;color:#065F46;}
    .tag{background:#E0E7FF;color:var(--brand-primary);border-radius:999px;padding:6px 12px;font-weight:600; font-size: 13px;}
    
    /* === LAYOUT & TOP BAR === */
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px; flex-wrap: wrap; gap: 10px;}
    .bar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;}
    
    /* === VIEW TOGGLE === */
    .view-toggle-group {
        display: flex;
        border: 1px solid var(--color-border);
        border-radius: var(--border-radius);
        overflow: hidden;
        margin-bottom: 20px;
    }
    .btn-toggle {
        padding: 8px 16px;
        font-size: 14px;
        font-weight: 500;
        background-color: var(--color-panel-bg);
        color: var(--color-text-muted);
        border: none;
        cursor: pointer;
        transition: background 0.2s, color 0.2s;
    }
    .btn-toggle:disabled {
        cursor: not-allowed;
        opacity: 0.6;
    }
    .btn-toggle:hover:not(:disabled) {
        background-color: var(--color-hover-bg);
    }
    .btn-toggle.active {
        background-color: var(--brand-primary);
        color: white;
    }

    /* === MY ROTA VIEW (Vertical List Layout) === */
    #myRotaView {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); /* Creates a responsive grid of cards */
        gap: 20px;
    }
    .day-card {
        background: var(--color-panel-bg);
        border: 1px solid var(--color-border);
        border-radius: var(--border-radius);
        padding: 16px;
        box-shadow: 0 1px 2px rgba(0,0,0,.05);
    }
    .day-header {
        border-bottom: 1px solid var(--color-border);
        padding-bottom: 12px;
        margin-bottom: 12px;
    }
    .day-title {
        font-size: 18px;
        font-weight: 700;
        margin: 0;
    }
    .day-date {
        color: var(--color-text-muted);
        font-size: 14px;
    }
    .rdo-note {
        padding: 30px 0;
        text-align: center;
        color: var(--color-text-muted);
        font-style: italic;
    }

    /* Timeline Visualization (Horizontal bar within the day card) */
    .timeline-viz {
        position: relative;
        height: 20px;
        background: #F3F4F6;
        border-radius: 10px;
        margin: 16px 0 8px 0;
        overflow: hidden;
    }
    .timeline-segment {
        position: absolute;
        height: 100%;
    }
    .timeline-labels {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: var(--color-text-muted);
    }

    /* Schedule Details List */
    .schedule-list {
        list-style: none;
        padding: 0;
        margin: 16px 0 0 0;
    }
    .schedule-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 0;
        border-top: 1px dashed var(--color-border);
    }
    .item-time {
        font-weight: 600;
        font-family: monospace;
        flex-shrink: 0;
    }
    .item-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
    }
    .item-name {
        flex-grow: 1;
    }

    /* === TEAM SCHEDULE VIEW (Grid) === */
    #teamScheduleView {
        overflow-x: auto;
        border-top: 1px solid var(--color-border);
        margin-top: 20px;
    }
    .team-grid {
        width: 100%;
        border-collapse: collapse;
        background-color: white;
    }
    .team-grid th, .team-grid td {
        padding: 12px 16px;
        text-align: left;
        border: 1px solid var(--color-border);
        min-width: 150px;
        vertical-align: top;
    }
    .team-grid th {
        background-color: var(--color-hover-bg);
        font-weight: 600;
        color: var(--color-text-muted);
        position: sticky;
        top: 0;
        z-index: 2;
    }
    /* Sticky first column for better navigation */
    .team-grid th:first-child, .team-grid td:first-child {
        position: sticky;
        left: 0;
        background-color: var(--color-panel-bg);
        z-index: 1;
        min-width: 200px;
        box-shadow: 2px 0 5px -2px rgba(0,0,0,0.05);
    }
    .team-grid th:first-child {
      background-color: var(--color-hover-bg);
      z-index: 3;
    }
    .team-grid tbody tr:hover td:first-child,
    .team-grid tbody tr:hover {
        background-color: var(--color-hover-bg);
    }

    .weekly-shift-time {
        font-size: 14px;
        font-weight: 600;
        color: var(--color-text);
        display: block;
    }
    .weekly-shift-details {
        font-size: 12px;
        color: var(--color-text-muted);
    }
    .weekly-rdo {
        font-size: 14px;
        color: #9CA3AF;
        font-weight: 500;
    }

    /* === RESPONSIVE === */
    @media (max-width: 768px) {
        .topbar {
            flex-direction: column;
            align-items: stretch;
        }
        .bar {
            justify-content: space-between;
        }
        .view-toggle-group {
            width: 100%;
        }
        .btn-toggle {
            flex-grow: 1;
            text-align: center;
        }
    }
  </style>
</head>
<body>
  <header>WFM Advisor Portal</header>
  <div class="wrap">
    <div id="authBox" class="card" style="display:none; max-width: 450px; margin: 40px auto;">
      <h2 style="margin-top: 0;">Sign In</h2>
      <div class="bar">
        <input id="emailInput" type="email" placeholder="Enter your work email…" style="flex-grow: 1;" />
        <button id="sendLinkBtn" class="btn">Send magic link</button>
      </div>
      <div class="notice">We’ll email you a one-time sign-in link. Check your inbox.</div>
    </div>

    <div id="appBox" class="card" style="display:none; padding: 20px;">
      
      <div class="topbar">
        <div class="bar">
          <span id="userEmail" class="tag"></span>
          <span id="advisorName" class="tag"></span>
          <span id="teamName" class="tag" style="display:none;"></span>
        </div>
        <div class="bar">
          <input id="weekStart" type="date" />
          <button id="prevBtn" class="btn secondary">◀ Prev</button>
          <button id="nextBtn" class="btn secondary">Next ▶</button>
          <button id="signOutBtn" class="btn ghost">Sign out</button>
        </div>
      </div>

       <div id="realtimeNote" class="notice success" style="display:none;">
            Live Update: The schedule for this week was just updated.
       </div>

      <div class="view-toggle-group" id="viewToggleGroup">
            <button class="btn-toggle active" data-view="my-rota">My Rota</button>
            <button class="btn-toggle" data-view="team-schedule" id="teamToggleBtn">Team Schedule</button>
      </div>

      <div id="myRotaView" class="view-container">
          </div>
      
      <div id="teamScheduleView" class="view-container" style="display:none;">
            </div>

      <div id="infoNote" class="notice" style="display:none;"></div>
    </div>
  </div>

<script>
// --- Configuration ---
// Using credentials identified in the provided files (Advisor portal.txt, planner js.txt)
const SUPABASE_URL = "https://oypdnjxhjpgpwmkltzmk.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95cGRuanhoanBncHdta2x0em1rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4Nzk0MTEsImV4cCI6MjA3NTQ1NTQxMX0.Hqf1L4RHpIPUD4ut2uVsiGDsqKXvAjdwKuotmme4_Is";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// --- DOM Elements (ELS) ---
const ELS = {
    authBox: document.getElementById("authBox"),
    appBox: document.getElementById("appBox"),
    emailInput: document.getElementById("emailInput"),
    sendLinkBtn: document.getElementById("sendLinkBtn"),
    userEmailTag: document.getElementById("userEmail"),
    advisorNamePill: document.getElementById("advisorName"),
    teamNamePill: document.getElementById("teamName"),
    weekStartInput: document.getElementById("weekStart"),
    prevBtn: document.getElementById("prevBtn"),
    nextBtn: document.getElementById("nextBtn"),
    signOutBtn: document.getElementById("signOutBtn"),
    myRotaView: document.getElementById("myRotaView"),
    teamScheduleView: document.getElementById("teamScheduleView"),
    viewToggleGroup: document.getElementById("viewToggleGroup"),
    teamToggleBtn: document.getElementById("teamToggleBtn"),
    infoNote: document.getElementById("infoNote"),
    realtimeNote: document.getElementById("realtimeNote"),
};

// --- Constants & Helpers ---
const DAYS = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
// Visualization time range for My Rota view (7 AM to 9 PM, covering standard shifts)
const VIZ_START_H = 7, VIZ_END_H = 21;
const VIZ_DURATION_MIN = (VIZ_END_H - VIZ_START_H) * 60;

// Date Helpers (using local time for visualization consistency)
function toMonday(d){
  const x = new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0, 0, 0, 0);
  const dow = x.getDay();
  const diff = (dow === 0 ? -6 : 1 - dow);
  x.setDate(x.getDate() + diff);
  return x;
}
function fmtDateLocal(d){
  // en-CA locale provides reliable YYYY-MM-DD format
  return d.toLocaleDateString('en-CA', {year: 'numeric', month: '2-digit', day: '2-digit'});
}
function fmtDateFriendly(d) {
    return d.toLocaleDateString("en-GB", { month: "long", day: "numeric" });
}
function addDays(d,n){ const x=new Date(d.getFullYear(), d.getMonth(), d.getDate()); x.setDate(x.getDate()+n); return x; }
function hhmmToMinutes(t){ 
    if (!t) return 0;
    const [h,m]=(t.split(":")||["0","0"]).map(Number); 
    return h*60+m; 
}

// Map activity codes to colors defined in CSS variables
function colorForCode(code){
  const k = (code||"").toLowerCase();
  if (k.includes("email")) return "var(--emails)";
  if (k.includes("mirakl")) return "var(--mirakl)";
  if (k.includes("whatsapp")) return "var(--whatsapp)";
  if (k.includes("social")) return "var(--social)";
  if (k.includes("meeting")||k.includes("coach")||k.includes("121")||k.includes("huddle")||k.includes("training")) return "var(--meeting)";
  if (k.includes("overtime")) return "var(--overtime)";
  if (k.includes("break")) return "var(--break)";
  if (k.includes("lunch")) return "var(--lunch)";
  if (k.includes("admin") || k.includes("payplus") || k.includes("qa") || k.includes("2nd line")) return "var(--admin)";
  return "var(--default)";
}

// --- Application State ---
const STATE = {
    user: null,
    advisorId: null,
    advisorName: "",
    leaderId: null,
    teamMembers: [], // {id, name}
    teamMemberIds: new Set(), // For efficient lookups
    monday: toMonday(new Date()),
    templates: {},
    currentView: 'my-rota', // 'my-rota' or 'team-schedule'
    currentWeekData: null,
    rotaRealtimeChannel: null, // Realtime subscription handler
};

/* ---- Data Normalization (Handles Templates vs Segments) ---- */
// Converts standard templates (e.g., from templates_rows.csv) into detailed segments
function tplToSegments(t){
  if(!t || !t.start_time || !t.finish_time) return [];
  const mins = s => { const [h,m]=String(s).slice(0,5).split(":").map(Number); return h*60+m; };
  const m2t = m => `${String(Math.floor(m/60)).padStart(2,"0")}:${String(m%60).padStart(2,"0")}`;
  const s = mins(t.start_time), e = mins(t.finish_time);
  const breaks = [];
  // Assuming standard break durations based on templates_rows.csv structure
  if(t.break1) breaks.push({ at: mins(t.break1), dur: 15, code: "Break" });
  if(t.lunch)  breaks.push({ at: mins(t.lunch),  dur: 30, code: "Lunch" });
  if(t.break2) breaks.push({ at: mins(t.break2), dur: 15, code: "Break" });
  
  const events = [{t:s, type:"start"}, ...breaks.map(b=>({t:b.at, type:"pause", dur:b.dur, code:b.code})), {t:e, type:"end"}]
    .sort((a,b)=>a.t-b.t);
  const out=[]; let cur=s;
  for(const ev of events){
    // Use the defined work_code from the template
    if(ev.t>cur) out.push({ code: t.work_code || "Activity", start: m2t(cur), end: m2t(ev.t) });
    if(ev.type==="pause"){ out.push({ code:ev.code, start:m2t(ev.t), end:m2t(ev.t+ev.dur) }); cur=ev.t+ev.dur; }
  }
  return out;
}

// Ensures rota data is always in the 'segments' format, regardless of source format
function normalizeDayValue(dayVal){
  // If it already has detailed segments (e.g., complex data from rotas_rows.csv)
  if(dayVal && typeof dayVal==="object" && Array.isArray(dayVal.segments)) return dayVal;
  // If it's a string (template name like 'Early' from rotas_published_rows.csv)
  if(typeof dayVal==="string" && dayVal.trim() !== ""){
    const tpl = STATE.templates[dayVal.trim()];
    if(!tpl) return { segments: [] }; // Template not found
    return { segments: tplToSegments(tpl) };
  }
  return { segments: [] }; // RDO or empty
}

// --- Initialization & Authentication ---
async function init(){
  // 1. Load Templates (necessary for interpreting rotas)
  await loadTemplates();

  // 2. Authentication Check
  await supabase.auth.getSession();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user){
    showAuth();
    return;
  }

  STATE.user = user;
  
  // 3. Identify Advisor and Team
  await identifyAdvisorAndTeam(user);

  // 4. Setup UI Controls
  setupUIEvents();
  
  // 5. Show App, Initial Render, and Start Realtime
  showApp();
  await loadAndRender();
  await startRealtime();
}

function showAuth() {
    ELS.authBox.style.display = "block";
    ELS.appBox.style.display = "none";
}

function showApp() {
    ELS.authBox.style.display = "none";
    ELS.appBox.style.display = "block";
    ELS.userEmailTag.textContent = STATE.user.email;
    ELS.advisorNamePill.textContent = STATE.advisorName || (STATE.advisorId ? "ID Linked" : "Not Linked");
    ELS.weekStartInput.value = fmtDateLocal(STATE.monday);
}

async function loadTemplates() {
    const { data, error } = await supabase.from("templates").select("*");
    if (error) {
        console.error("Error loading templates:", error);
    } else {
      (data||[]).forEach(t=>STATE.templates[t.name]=t);
    }
}

async function identifyAdvisorAndTeam(user) {
    // 1. Identify Advisor ID (Check profiles table, then fallback to email match in advisors table)
    const { data: profile } = await supabase.from("profiles").select("advisor_id").eq("user_id", user.id).maybeSingle();

    if (profile && profile.advisor_id){
        STATE.advisorId = profile.advisor_id;
    } else {
        // Fallback: match by email (case-insensitive)
        const { data: adv } = await supabase.from("advisors").select("id").ilike("email", user.email).maybeSingle();
        if (adv) STATE.advisorId = adv.id;
    }

    if (!STATE.advisorId) {
        ELS.teamToggleBtn.disabled = true;
        return;
    }

    // 2. Fetch Advisor Details and Leader ID
    const { data: advisorDetails } = await supabase.from("advisors").select("name, leader_id").eq("id", STATE.advisorId).maybeSingle();

    if (advisorDetails) {
        STATE.advisorName = advisorDetails.name;
        STATE.leaderId = advisorDetails.leader_id;
    }

    if (!STATE.leaderId) {
        ELS.teamToggleBtn.disabled = true;
        return;
    }

    // 3. Fetch Team Members and Leader Name
    const [teamRes, leaderRes] = await Promise.all([
        supabase.from("advisors").select("id, name").eq("leader_id", STATE.leaderId).order('name'),
        supabase.from("leaders").select("name").eq("id", STATE.leaderId).maybeSingle()
    ]);

    if (teamRes.data) {
        STATE.teamMembers = teamRes.data;
        STATE.teamMemberIds = new Set(teamRes.data.map(t => t.id));
    }
    
    if (leaderRes.data) {
        ELS.teamNamePill.textContent = `Team: ${leaderRes.data.name}`;
        ELS.teamNamePill.style.display = '';
    }

    // Disable team toggle if advisor is alone
    if (STATE.teamMembers.length <= 1) {
        ELS.teamToggleBtn.disabled = true;
        ELS.teamToggleBtn.title = "Team view unavailable.";
    }
}

function setupUIEvents() {
    ELS.sendLinkBtn.onclick = handleSendLink;
    ELS.signOutBtn.onclick = handleSignOut;

    ELS.prevBtn.onclick = () => changeWeek(-7);
    ELS.nextBtn.onclick = () => changeWeek(7);
    
    ELS.weekStartInput.onchange = ()=>{
        // Parse date input safely at local midnight
        const d = new Date(ELS.weekStartInput.value + "T00:00:00");
        if (!isNaN(d.getTime())) {
             STATE.monday = toMonday(d);
             loadAndRender();
             restartRealtime();
        }
    };

    // View Toggle Logic
    ELS.viewToggleGroup.addEventListener('click', (e) => {
        const target = e.target.closest('.btn-toggle');
        if (target && !target.classList.contains('active') && !target.disabled) {
            STATE.currentView = target.dataset.view;
            ELS.viewToggleGroup.querySelectorAll('.btn-toggle').forEach(btn => btn.classList.remove('active'));
            target.classList.add('active');
            renderView(); // Only need to render, data is already loaded
        }
    });
}

// Navigation requires restarting the realtime connection for the new week
function changeWeek(days) {
    STATE.monday = addDays(STATE.monday, days);
    ELS.weekStartInput.value = fmtDateLocal(STATE.monday);
    loadAndRender();
    restartRealtime();
}

async function handleSendLink(){
  const email = ELS.emailInput.value.trim();
  if (!email) return alert("Please enter your work email.");
  ELS.sendLinkBtn.disabled = true;
  try{
    const { error } = await supabase.auth.signInWithOtp({
      email,
      options:{ emailRedirectTo: location.origin + location.pathname }
    });
    if (error) throw error;
    alert("Magic link sent. Check your inbox.");
  }catch(e){ alert("Error: "+e.message); }
  finally{ ELS.sendLinkBtn.disabled = false; }
}

async function handleSignOut(){
    await stopRealtime();
    await supabase.auth.signOut();
    location.href = location.pathname;
}

// --- Main Data Loading Logic ---
// Fetches all necessary data for the current week (My Rota + Team Rotas)
async function loadAndRender(){
    ELS.infoNote.style.display="none";
    if (!STATE.advisorId){
        ELS.myRotaView.innerHTML = `<div class="notice">Your account isn’t linked to an advisor profile. Please contact the planning team.</div>`;
        return;
    }
  
    // Show loading state
    ELS.myRotaView.innerHTML = `<div class="notice">Loading schedule data...</div>`;
    ELS.teamScheduleView.innerHTML = `<div class="notice">Loading schedule data...</div>`;

    const mondayISO = fmtDateLocal(STATE.monday);

    // 1. Prepare data structures
    const normalisedMyRota = {};
    const normalisedTeamRotas = {};

    // 2. Identify IDs to fetch (Self + Team)
    // Use the Set for efficient unique list of IDs
    const advisorIdsToFetch = Array.from(STATE.teamMemberIds);
    if (advisorIdsToFetch.length === 0 && STATE.advisorId) {
        advisorIdsToFetch.push(STATE.advisorId);
    }


    // 3. Fetch all relevant rotas in a single query from rotas_published
    const { data: rotas, error } = await supabase
        .from("rotas_published")
        .select("advisor_id, data")
        .in("advisor_id", advisorIdsToFetch)
        .eq("week_start", mondayISO);

    if (error) {
        console.error("Error loading rotas:", error);
        ELS.infoNote.textContent = "Error loading schedule data.";
        ELS.infoNote.style.display = "block";
    }
                
    // 4. Normalize the fetched data
    (rotas || []).forEach(r => {
        const normalised = {};
        DAYS.forEach(d => {
            normalised[d] = normalizeDayValue(r.data[d]);
        });
        
        if (r.advisor_id === STATE.advisorId) {
            Object.assign(normalisedMyRota, normalised);
        }
        normalisedTeamRotas[r.advisor_id] = normalised;
    });

    // 5. Store normalized data in state
    STATE.currentWeekData = {
        myRota: normalisedMyRota,
        teamRotas: normalisedTeamRotas,
        mondayISO: mondayISO
    };

    // 6. Render the currently active view
    renderView();
}

// Renders the appropriate view based on the current state
function renderView() {
    if (!STATE.currentWeekData) return;

    if (STATE.currentView === 'my-rota') {
        ELS.myRotaView.style.display = 'grid';
        ELS.teamScheduleView.style.display = 'none';
        drawMyRotaVertical(STATE.currentWeekData.myRota);
    } else if (STATE.currentView === 'team-schedule') {
        ELS.myRotaView.style.display = 'none';
        ELS.teamScheduleView.style.display = 'block';
        drawTeamScheduleGrid(STATE.currentWeekData.teamRotas);
    }
}

// --- My Rota (Vertical View) Rendering ---
function drawMyRotaVertical(rotaData){
  let html = '';
  
  if (Object.keys(rotaData).length === 0) {
      ELS.myRotaView.innerHTML = `<div class="notice">No rota published for this week yet.</div>`;
      return;
  }

  DAYS.forEach((dayName, i) => {
    const date = addDays(STATE.monday, i);
    const dayData = rotaData[dayName] || { segments: [] };
    
    html += `<div class="day-card">
                <div class="day-header">
                    <h2 class="day-title">${dayName}</h2>
                    <p class="day-date">${fmtDateFriendly(date)}</p>
                </div>
                ${renderDayContent(dayData.segments)}
            </div>`;
  });

  ELS.myRotaView.innerHTML = html;
}

function renderDayContent(segments) {
    if (segments.length === 0) {
        return `<div class="rdo-note">Rest Day Off (RDO)</div>`;
    }

    // 1. Timeline Visualization (Horizontal Bar)
    let vizHtml = `<div class="timeline-viz" title="Visualization from ${VIZ_START_H}:00 to ${VIZ_END_H}:00">`;
    segments.forEach(seg => {
        const startMin = hhmmToMinutes(seg.start);
        const endMin = hhmmToMinutes(seg.end);
        const vizStartMin = VIZ_START_H * 60;

        // Calculate position and width percentage within the visualization range
        const startPct = Math.max(0, ((startMin - vizStartMin) / VIZ_DURATION_MIN) * 100);
        const endPct = Math.min(100, ((endMin - vizStartMin) / VIZ_DURATION_MIN) * 100);
        const widthPct = endPct - startPct;

        if (widthPct > 0) {
            vizHtml += `<div class="timeline-segment" style="left: ${startPct}%; width: ${widthPct}%; background: ${colorForCode(seg.code)};" title="${seg.code} (${seg.start} - ${seg.end})"></div>`;
        }
    });
    vizHtml += `</div>`;
    // Add labels for the visualization range
    vizHtml += `<div class="timeline-labels">
                    <span>${VIZ_START_H.toString().padStart(2,'0')}:00</span>
                    <span>${VIZ_END_H.toString().padStart(2,'0')}:00</span>
                </div>`;

    // 2. Detailed List
    let listHtml = `<ul class="schedule-list">`;
    segments.forEach(seg => {
        listHtml += `<li class="schedule-item">
                        <span class="item-time">${seg.start} - ${seg.end}</span>
                        <span class="item-dot" style="background: ${colorForCode(seg.code)};"></span>
                        <span class="item-name">${seg.code}</span>
                    </li>`;
    });
    listHtml += `</ul>`;

    return vizHtml + listHtml;
}

// --- Team Schedule (Grid View) Rendering ---
function drawTeamScheduleGrid(teamRotas) {
    let html = `<table class="team-grid"><thead><tr><th>Advisor</th>`;
    // Header Row (Days)
    DAYS.forEach((dayName, i) => {
        const date = addDays(STATE.monday, i);
        html += `<th>${dayName}<br><small>${fmtDateFriendly(date)}</small></th>`;
    });
    html += `</tr></thead><tbody>`;

    // Body Rows (Advisors)
    STATE.teamMembers.forEach(member => {
        const advisorRota = teamRotas[member.id];
        html += `<tr><td>${member.name}</td>`;
        
        if (!advisorRota) {
            // Handle case where rota might not be published for this team member
            DAYS.forEach(() => html += `<td><span class="weekly-rdo">N/A</span></td>`);
        } else {
            DAYS.forEach(dayName => {
                const dayData = advisorRota[dayName] || { segments: [] };
                html += `<td>${renderTeamGridCell(dayData.segments)}</td>`;
            });
        }
        html += `</tr>`;
    });

    html += `</tbody></table>`;
    ELS.teamScheduleView.innerHTML = html;
}

function renderTeamGridCell(segments) {
    if (segments.length === 0) {
        return `<span class="weekly-rdo">RDO</span>`;
    }

    const start = segments[0].start;
    const end = segments[segments.length - 1].end;
    
    // Identify main activities (excluding breaks/lunch) for a summary
    const mainActivities = segments.filter(s => {
        const code = s.code.toLowerCase();
        return !code.includes('break') && !code.includes('lunch');
    }).map(s => s.code);
    
    let summary = "Activity"; // Default
    if (mainActivities.length > 0) {
        // If all main activities are the same, use that name; otherwise use "Mixed".
        if (mainActivities.every(val => val === mainActivities[0])) {
            summary = mainActivities[0];
        } else {
            summary = "Mixed Activities";
        }
    }

    return `
        <span class="weekly-shift-time">${start} - ${end}</span>
        <span class="weekly-shift-details">${summary}</span>
    `;
}

// --- Real-Time Updates ---

// Subscribe to changes for the currently viewed week
async function startRealtime(){
  if (!STATE.advisorId) return;
  const mondayISO = fmtDateLocal(STATE.monday);
  
  // Subscribe to any changes in the rotas_published table where the week_start matches the current view.
  // This covers updates for the individual and the entire team if they are viewing this week.
  STATE.rotaRealtimeChannel = supabase.channel(`rotas_pub_week_${mondayISO}`)
    .on("postgres_changes", {
      event: "*", // INSERT, UPDATE, DELETE
      schema: "public",
      table: "rotas_published",
      filter: `week_start=eq.${mondayISO}`
    }, (payload)=>{
      console.log("Realtime update received.", payload);
      
      // Check if the update affects the current user or their team
      const affectedAdvisorId = payload.new?.advisor_id || payload.old?.advisor_id;
      // Use the Set for efficient checking
      const isRelevant = STATE.advisorId === affectedAdvisorId || STATE.teamMemberIds.has(affectedAdvisorId);

      if (isRelevant) {
          // Refresh the data and view
          loadAndRender(); 
          ELS.realtimeNote.style.display = "block";
          // Hide notification after 5 seconds
          setTimeout(()=>ELS.realtimeNote.style.display="none", 5000);
      }
    })
    .subscribe((status) => {
        if (status !== 'SUBSCRIBED') {
            console.warn('Realtime subscription status:', status);
        }
    });
}

// Stop the realtime connection
async function stopRealtime() {
    if (STATE.rotaRealtimeChannel) {
        await supabase.removeChannel(STATE.rotaRealtimeChannel);
        STATE.rotaRealtimeChannel = null;
    }
}

// Unsubscribe from the previous week and subscribe to the new week
async function restartRealtime(){
  await stopRealtime();
  await startRealtime();
}

// Initialize the application
document.addEventListener('DOMContentLoaded', init);

</script>
</body>
</html>